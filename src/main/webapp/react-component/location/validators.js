/**
 * Copyright (c) Codice Foundation
 *
 * This is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser
 * General Public License as published by the Free Software Foundation, either version 3 of the
 * License, or any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
 * even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details. A copy of the GNU Lesser General Public License
 * is distributed along with this program and can be found at
 * <http://www.gnu.org/licenses/lgpl.html>.
 *
 **/
import * as usng from 'usng.js';
// @ts-expect-error ts-migrate(2554) FIXME: Expected 1 arguments, but got 0.
var converter = new usng.Converter();
import errorMessages from '../../component/location-new/utils/errors';
import { validateGeo } from '../utils/validation';
import _ from 'lodash';
var dmsRegex = new RegExp('^([0-9_]*)Â°([0-9_]*)\'([0-9_]*\\.?[0-9_]*)"$');
function isUPS(input) {
    try {
        converter.deserializeUPS(input);
        return true;
    }
    catch (err) {
        return false;
    }
}
function validateUsngGrid(grid) {
    //corner case for ups zone
    return converter.isUSNG(grid) !== 0 || isUPS(grid);
}
function gridIsBlank(grid) {
    return grid.length === 0;
}
function dmsPointIsBlank(point) {
    return point.lat === '' || point.lon === '';
}
function utmUpsIsBlank(point) {
    return point.easting || point.hemisphere || point.northing || point.zoneNumber
        ? false
        : true;
}
function validateUtmUpsPoint(point) {
    var validation = validateGeo('easting', point);
    return !(validation === null || validation === void 0 ? void 0 : validation.error);
}
function inValidRange(coordinate, maximum) {
    var degrees = parseInt(coordinate.degrees);
    var minutes = parseInt(coordinate.minutes);
    var seconds = parseFloat(coordinate.seconds);
    if (isNaN(seconds)) {
        return false;
    }
    if (degrees > maximum || minutes > 60 || seconds > 60) {
        return false;
    }
    if (degrees === maximum && (minutes > 0 || seconds > 0)) {
        return false;
    }
    return true;
}
function replacePlaceholderWithZeros(numString) {
    if (numString === void 0) { numString = ''; }
    while (numString.includes('_')) {
        if (numString.includes('.')) {
            numString = numString.replace('_', '0');
        }
        else {
            numString = numString.replace('_', '');
            numString = '0' + numString;
        }
    }
    return numString;
}
function parseDmsCoordinate(coordinate) {
    if (coordinate === undefined) {
        return undefined;
    }
    var matches = dmsRegex.exec(coordinate);
    if (!matches) {
        return undefined;
    }
    var degrees = replacePlaceholderWithZeros(matches[1]);
    var minutes = replacePlaceholderWithZeros(matches[2]);
    var seconds = replacePlaceholderWithZeros(matches[3]);
    return { degrees: degrees, minutes: minutes, seconds: seconds };
}
function validateDmsPoint(point) {
    var latitude = parseDmsCoordinate(point.lat);
    var longitude = parseDmsCoordinate(point.lon);
    if (latitude && longitude) {
        return inValidRange(latitude, 90) && inValidRange(longitude, 180);
    }
    return false;
}
function validateDmsLineOrPoly(dms, type) {
    var defaultValue;
    if (!dms || dms.some(dmsPointIsBlank)) {
        return { error: true, message: errorMessages.invalidList, defaultValue: defaultValue };
    }
    var error = false;
    var message = null;
    switch (type) {
        case 'line':
            if (!dms.every(validateDmsPoint)) {
                error = true;
                message = errorMessages.invalidList;
            }
            else if (dms.length < 2) {
                error = true;
                message = errorMessages.tooFewPointsLine;
            }
            break;
        case 'polygon':
            if (!dms.every(validateDmsPoint)) {
                error = true;
                message = errorMessages.invalidList;
            }
            else if (dms.length < 4) {
                error = true;
                message = errorMessages.tooFewPointsPolygon;
            }
            else if (!_.isEqual(dms[0], dms.slice(-1)[0])) {
                error = true;
                message = errorMessages.firstLastPointMismatch;
            }
            break;
    }
    return { error: error, message: message, defaultValue: defaultValue };
}
function validateUsngLineOrPoly(usng, type) {
    var defaultValue;
    if (!usng || usng.some(gridIsBlank)) {
        return { error: true, message: errorMessages.invalidList, defaultValue: defaultValue };
    }
    var error = false;
    var message = null;
    switch (type) {
        case 'line':
            if (!usng.every(validateUsngGrid)) {
                error = true;
                message = errorMessages.invalidList;
            }
            else if (usng.length < 2) {
                error = true;
                message = errorMessages.tooFewPointsLine;
            }
            break;
        case 'polygon':
            if (!usng.every(validateUsngGrid)) {
                error = true;
                message = errorMessages.invalidList;
            }
            else if (usng.length < 4) {
                error = true;
                message = errorMessages.tooFewPointsPolygon;
            }
            else if (!_.isEqual(usng[0], usng.slice(-1)[0])) {
                error = true;
                message = errorMessages.firstLastPointMismatch;
            }
            break;
    }
    return { error: error, message: message, defaultValue: defaultValue };
}
function validateUtmUpsLineOrPoly(utmups, type) {
    var defaultValue;
    if (!utmups || utmups.some(utmUpsIsBlank)) {
        return { error: true, message: errorMessages.invalidList, defaultValue: defaultValue };
    }
    var error = false;
    var message = null;
    switch (type) {
        case 'line':
            if (!utmups.every(validateUtmUpsPoint)) {
                error = true;
                message = errorMessages.invalidList;
            }
            else if (utmups.length < 2) {
                error = true;
                message = errorMessages.tooFewPointsLine;
            }
            break;
        case 'polygon':
            if (!utmups.every(validateUtmUpsPoint)) {
                error = true;
                message = errorMessages.invalidList;
            }
            else if (utmups.length < 4) {
                error = true;
                message = errorMessages.tooFewPointsPolygon;
            }
            else if (!_.isEqual(utmups[0], utmups.slice(-1)[0])) {
                error = true;
                message = errorMessages.firstLastPointMismatch;
            }
            break;
    }
    return { error: error, message: message, defaultValue: defaultValue };
}
export { validateUsngLineOrPoly, validateDmsLineOrPoly, parseDmsCoordinate, validateUtmUpsLineOrPoly, isUPS, };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmFsaWRhdG9ycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9tYWluL3dlYmFwcC9yZWFjdC1jb21wb25lbnQvbG9jYXRpb24vdmFsaWRhdG9ycy50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7SUFhSTtBQUNKLE9BQU8sS0FBSyxJQUFJLE1BQU0sU0FBUyxDQUFBO0FBQy9CLDRFQUE0RTtBQUM1RSxJQUFNLFNBQVMsR0FBRyxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQTtBQUN0QyxPQUFPLGFBQWEsTUFBTSwyQ0FBMkMsQ0FBQTtBQUNyRSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0scUJBQXFCLENBQUE7QUFDakQsT0FBTyxDQUFDLE1BQU0sUUFBUSxDQUFBO0FBRXRCLElBQU0sUUFBUSxHQUFHLElBQUksTUFBTSxDQUFDLDhDQUE4QyxDQUFDLENBQUE7QUErQjNFLFNBQVMsS0FBSyxDQUFDLEtBQWE7SUFDMUIsSUFBSSxDQUFDO1FBQ0gsU0FBUyxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUMvQixPQUFPLElBQUksQ0FBQTtJQUNiLENBQUM7SUFBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1FBQ2IsT0FBTyxLQUFLLENBQUE7SUFDZCxDQUFDO0FBQ0gsQ0FBQztBQUVELFNBQVMsZ0JBQWdCLENBQUMsSUFBWTtJQUNwQywwQkFBMEI7SUFDMUIsT0FBTyxTQUFTLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUE7QUFDcEQsQ0FBQztBQUVELFNBQVMsV0FBVyxDQUFDLElBQVk7SUFDL0IsT0FBTyxJQUFJLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQTtBQUMxQixDQUFDO0FBRUQsU0FBUyxlQUFlLENBQUMsS0FBWTtJQUNuQyxPQUFPLEtBQUssQ0FBQyxHQUFHLEtBQUssRUFBRSxJQUFJLEtB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c0JBQXNCLENBQUE7WUFDaEQsQ0FBQztZQUNELE1BQUs7SUFDVCxDQUFDO0lBQ0QsT0FBTyxFQUFFLEtBQUssT0FBQSxFQUFFLE9BQU8sU0FBQSxFQUFFLFlBQVksY0FBQSxFQUFFLENBQUE7QUFDekMsQ0FBQztBQUVELE9BQU8sRUFDTCxzQkFBc0IsRUFDdEIscUJBQXFCLEVBQ3JCLGtCQUFrQixFQUNsQix3QkFBd0IsRUFDeEIsS0FBSyxHQUNOLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAoYykgQ29kaWNlIEZvdW5kYXRpb25cbiAqXG4gKiBUaGlzIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgTGVzc2VyXG4gKiBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieSB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZVxuICogTGljZW5zZSwgb3IgYW55IGxhdGVyIHZlcnNpb24uXG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dFxuICogZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuIFNlZSB0aGUgR05VXG4gKiBMZXNzZXIgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLiBBIGNvcHkgb2YgdGhlIEdOVSBMZXNzZXIgR2VuZXJhbCBQdWJsaWMgTGljZW5zZVxuICogaXMgZGlzdHJpYnV0ZWQgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0gYW5kIGNhbiBiZSBmb3VuZCBhdFxuICogPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy9sZ3BsLmh0bWw+LlxuICpcbiAqKi9cbmltcG9ydCAqIGFzIHVzbmcgZnJvbSAndXNuZy5qcydcbi8vIEB0cy1leHBlY3QtZXJyb3IgdHMtbWlncmF0ZSgyNTU0KSBGSVhNRTogRXhwZWN0ZWQgMSBhcmd1bWVudHMsIGJ1dCBnb3QgMC5cbmNvbnN0IGNvbnZlcnRlciA9IG5ldyB1c25nLkNvbnZlcnRlcigpXG5pbXBvcnQgZXJyb3JNZXNzYWdlcyBmcm9tICcuLi8uLi9jb21wb25lbnQvbG9jYXRpb24tbmV3L3V0aWxzL2Vycm9ycydcbmltcG9ydCB7IHZhbGlkYXRlR2VvIH0gZnJvbSAnLi4vdXRpbHMvdmFsaWRhdGlvbidcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCdcblxuY29uc3QgZG1zUmVnZXggPSBuZXcgUmVnRXhwKCdeKFswLTlfXSopwrAoWzAtOV9dKilcXCcoWzAtOV9dKlxcXFwuP1swLTlfXSopXCIkJylcblxudHlwZSBEaXJlY3Rpb24gPSAnTicgfCAnUycgfCAnRScgfCAnVydcblxudHlwZSBQb2ludCA9IHtcbiAgbGF0RGlyZWN0aW9uOiBEaXJlY3Rpb25cbiAgbG9uRGlyZWN0aW9uOiBEaXJlY3Rpb25cbiAgbGF0OiBzdHJpbmdcbiAgbG9uOiBzdHJpbmdcbn1cblxudHlwZSBEbXNDb29yZGluYXRlID0ge1xuICBkZWdyZWVzOiBzdHJpbmdcbiAgbWludXRlczogc3RyaW5nXG4gIHNlY29uZHM6IHN0cmluZ1xuICBkaXJlY3Rpb246IERpcmVjdGlvblxufVxuXG50eXBlIFV0bVVwc1BvaW50ID0ge1xuICBlYXN0aW5nOiBudW1iZXJcbiAgbm9ydGhpbmc6IG51bWJlclxuICB6b25lTnVtYmVyOiBudW1iZXJcbiAgaGVtaXNwaGVyZTogJ05PUlRIRVJOJyB8ICdTT1VUSEVSTidcbn1cblxuZXhwb3J0IHR5cGUgVmFsaWRhdGlvblJlc3VsdCA9IHtcbiAgZXJyb3I6IGJvb2xlYW5cbiAgbWVzc2FnZT86IHN0cmluZ1xuICBkZWZhdWx0VmFsdWU/OiBhbnlcbn1cblxuZnVuY3Rpb24gaXNVUFMoaW5wdXQ6IHN0cmluZykge1xuICB0cnkge1xuICAgIGNvbnZlcnRlci5kZXNlcmlhbGl6ZVVQUyhpbnB1dClcbiAgICByZXR1cm4gdHJ1ZVxuICB9IGNhdGNoIChlcnIpIHtcbiAgICByZXR1cm4gZmFsc2VcbiAgfVxufVxuXG5mdW5jdGlvbiB2YWxpZGF0ZVVzbmdHcmlkKGdyaWQ6IHN0cmluZykge1xuICAvL2Nvcm5lciBjYXNlIGZvciB1cHMgem9uZVxuICByZXR1cm4gY29udmVydGVyLmlzVVNORyhncmlkKSAhPT0gMCB8fCBpc1VQUyhncmlkKVxufVxuXG5mdW5jdGlvbiBncmlkSXNCbGFuayhncmlkOiBzdHJpbmcpIHtcbiAgcmV0dXJuIGdyaWQubGVuZ3RoID09PSAwXG59XG5cbmZ1bmN0aW9uIGRtc1BvaW50SXNCbGFuayhwb2ludDogUG9pbnQpIHtcbiAgcmV0dXJuIHBvaW50LmxhdCA9PT0gJycgfHwgcG9pbnQubG9uID09PSAnJ1xufVxuXG5mdW5jdGlvbiB1dG1VcHNJc0JsYW5rKHBvaW50OiBVdG1VcHNQb2ludCkge1xuICByZXR1cm4gcG9pbnQuZWFzdGluZyB8fCBwb2ludC5oZW1pc3BoZXJlIHx8IHBvaW50Lm5vcnRoaW5nIHx8IHBvaW50LnpvbmVOdW1iZXJcbiAgICA/IGZhbHNlXG4gICAgOiB0cnVlXG59XG5cbmZ1bmN0aW9uIHZhbGlkYXRlVXRtVXBzUG9pbnQocG9pbnQ6IFV0bVVwc1BvaW50KSB7XG4gIGNvbnN0IHZhbGlkYXRpb24gPSB2YWxpZGF0ZUdlbygnZWFzdGluZycsIHBvaW50KVxuICByZXR1cm4gIXZhbGlkYXRpb24/LmVycm9yXG59XG5cbmZ1bmN0aW9uIGluVmFsaWRSYW5nZShjb29yZGluYXRlOiBEbXNDb29yZGluYXRlLCBtYXhpbXVtOiBudW1iZXIpIHtcbiAgY29uc3QgZGVncmVlcyA9IHBhcnNlSW50KGNvb3JkaW5hdGUuZGVncmVlcylcbiAgY29uc3QgbWludXRlcyA9IHBhcnNlSW50KGNvb3JkaW5hdGUubWludXRlcylcbiAgY29uc3Qgc2Vjb25kcyA9IHBhcnNlRmxvYXQoY29vcmRpbmF0ZS5zZWNvbmRzKVxuICBpZiAoaXNOYU4oc2Vjb25kcykpIHtcbiAgICByZXR1cm4gZmFsc2VcbiAgfVxuICBpZiAoZGVncmVlcyA+IG1heGltdW0gfHwgbWludXRlcyA+IDYwIHx8IHNlY29uZHMgPiA2MCkge1xuICAgIHJldHVybiBmYWxzZVxuICB9XG4gIGlmIChkZWdyZWVzID09PSBtYXhpbXVtICYmIChtaW51dGVzID4gMCB8fCBzZWNvbmRzID4gMCkpIHtcbiAgICByZXR1cm4gZmFsc2VcbiAgfVxuICByZXR1cm4gdHJ1ZVxufVxuXG5mdW5jdGlvbiByZXBsYWNlUGxhY2Vob2xkZXJXaXRoWmVyb3MobnVtU3RyaW5nID0gJycpIHtcbiAgd2hpbGUgKG51bVN0cmluZy5pbmNsdWRlcygnXycpKSB7XG4gICAgaWYgKG51bVN0cmluZy5pbmNsdWRlcygnLicpKSB7XG4gICAgICBudW1TdHJpbmcgPSBudW1TdHJpbmcucmVwbGFjZSgnXycsICcwJylcbiAgICB9IGVsc2Uge1xuICAgICAgbnVtU3RyaW5nID0gbnVtU3RyaW5nLnJlcGxhY2UoJ18nLCAnJylcbiAgICAgIG51bVN0cmluZyA9ICcwJyArIG51bVN0cmluZ1xuICAgIH1cbiAgfVxuICByZXR1cm4gbnVtU3RyaW5nXG59XG5cbmZ1bmN0aW9uIHBhcnNlRG1zQ29vcmRpbmF0ZShjb29yZGluYXRlOiBzdHJpbmcpIHtcbiAgaWYgKGNvb3JkaW5hdGUgPT09IHVuZGVmaW5lZCkge1xuICAgIHJldHVybiB1bmRlZmluZWRcbiAgfVxuXG4gIGNvbnN0IG1hdGNoZXMgPSBkbXNSZWdleC5leGVjKGNvb3JkaW5hdGUpXG4gIGlmICghbWF0Y2hlcykge1xuICAgIHJldHVybiB1bmRlZmluZWRcbiAgfVxuICBjb25zdCBkZWdyZWVzID0gcmVwbGFjZVBsYWNlaG9sZGVyV2l0aFplcm9zKG1hdGNoZXNbMV0pXG4gIGNvbnN0IG1pbnV0ZXMgPSByZXBsYWNlUGxhY2Vob2xkZXJXaXRoWmVyb3MobWF0Y2hlc1syXSlcbiAgY29uc3Qgc2Vjb25kcyA9IHJlcGxhY2VQbGFjZWhvbGRlcldpdGhaZXJvcyhtYXRjaGVzWzNdKVxuICByZXR1cm4geyBkZWdyZWVzLCBtaW51dGVzLCBzZWNvbmRzIH0gYXMgRG1zQ29vcmRpbmF0ZVxufVxuXG5mdW5jdGlvbiB2YWxpZGF0ZURtc1BvaW50KHBvaW50OiBQb2ludCkge1xuICBjb25zdCBsYXRpdHVkZSA9IHBhcnNlRG1zQ29vcmRpbmF0ZShwb2ludC5sYXQpXG4gIGNvbnN0IGxvbmdpdHVkZSA9IHBhcnNlRG1zQ29vcmRpbmF0ZShwb2ludC5sb24pXG4gIGlmIChsYXRpdHVkZSAmJiBsb25naXR1ZGUpIHtcbiAgICByZXR1cm4gaW5WYWxpZFJhbmdlKGxhdGl0dWRlLCA5MCkgJiYgaW5WYWxpZFJhbmdlKGxvbmdpdHVkZSwgMTgwKVxuICB9XG4gIHJldHVybiBmYWxzZVxufVxuXG5mdW5jdGlvbiB2YWxpZGF0ZURtc0xpbmVPclBvbHkoZG1zOiBQb2ludFtdLCB0eXBlOiAnbGluZScgfCAncG9seWdvbicpIHtcbiAgbGV0IGRlZmF1bHRWYWx1ZVxuICBpZiAoIWRtcyB8fCBkbXMuc29tZShkbXNQb2ludElzQmxhbmspKSB7XG4gICAgcmV0dXJuIHsgZXJyb3I6IHRydWUsIG1lc3NhZ2U6IGVycm9yTWVzc2FnZXMuaW52YWxpZExpc3QsIGRlZmF1bHRWYWx1ZSB9XG4gIH1cbiAgbGV0IGVycm9yID0gZmFsc2VcbiAgbGV0IG1lc3NhZ2UgPSBudWxsXG4gIHN3aXRjaCAodHlwZSkge1xuICAgIGNhc2UgJ2xpbmUnOlxuICAgICAgaWYgKCFkbXMuZXZlcnkodmFsaWRhdGVEbXNQb2ludCkpIHtcbiAgICAgICAgZXJyb3IgPSB0cnVlXG4gICAgICAgIG1lc3NhZ2UgPSBlcnJvck1lc3NhZ2VzLmludmFsaWRMaXN0XG4gICAgICB9IGVsc2UgaWYgKGRtcy5sZW5ndGggPCAyKSB7XG4gICAgICAgIGVycm9yID0gdHJ1ZVxuICAgICAgICBtZXNzYWdlID0gZXJyb3JNZXNzYWdlcy50b29GZXdQb2ludHNMaW5lXG4gICAgICB9XG4gICAgICBicmVha1xuICAgIGNhc2UgJ3BvbHlnb24nOlxuICAgICAgaWYgKCFkbXMuZXZlcnkodmFsaWRhdGVEbXNQb2ludCkpIHtcbiAgICAgICAgZXJyb3IgPSB0cnVlXG4gICAgICAgIG1lc3NhZ2UgPSBlcnJvck1lc3NhZ2VzLmludmFsaWRMaXN0XG4gICAgICB9IGVsc2UgaWYgKGRtcy5sZW5ndGggPCA0KSB7XG4gICAgICAgIGVycm9yID0gdHJ1ZVxuICAgICAgICBtZXNzYWdlID0gZXJyb3JNZXNzYWdlcy50b29GZXdQb2ludHNQb2x5Z29uXG4gICAgICB9IGVsc2UgaWYgKCFfLmlzRXF1YWwoZG1zWzBdLCBkbXMuc2xpY2UoLTEpWzBdKSkge1xuICAgICAgICBlcnJvciA9IHRydWVcbiAgICAgICAgbWVzc2FnZSA9IGVycm9yTWVzc2FnZXMuZmlyc3RMYXN0UG9pbnRNaXNtYXRjaFxuICAgICAgfVxuICAgICAgYnJlYWtcbiAgfVxuICByZXR1cm4geyBlcnJvciwgbWVzc2FnZSwgZGVmYXVsdFZhbHVlIH1cbn1cblxuZnVuY3Rpb24gdmFsaWRhdGVVc25nTGluZU9yUG9seSh1c25nOiBzdHJpbmdbXSwgdHlwZTogJ2xpbmUnIHwgJ3BvbHlnb24nKSB7XG4gIGxldCBkZWZhdWx0VmFsdWVcbiAgaWYgKCF1c25nIHx8IHVzbmcuc29tZShncmlkSXNCbGFuaykpIHtcbiAgICByZXR1cm4geyBlcnJvcjogdHJ1ZSwgbWVzc2FnZTogZXJyb3JNZXNzYWdlcy5pbnZhbGlkTGlzdCwgZGVmYXVsdFZhbHVlIH1cbiAgfVxuICBsZXQgZXJyb3IgPSBmYWxzZVxuICBsZXQgbWVzc2FnZSA9IG51bGxcbiAgc3dpdGNoICh0eXBlKSB7XG4gICAgY2FzZSAnbGluZSc6XG4gICAgICBpZiAoIXVzbmcuZXZlcnkodmFsaWRhdGVVc25nR3JpZCkpIHtcbiAgICAgICAgZXJyb3IgPSB0cnVlXG4gICAgICAgIG1lc3NhZ2UgPSBlcnJvck1lc3NhZ2VzLmludmFsaWRMaXN0XG4gICAgICB9IGVsc2UgaWYgKHVzbmcubGVuZ3RoIDwgMikge1xuICAgICAgICBlcnJvciA9IHRydWVcbiAgICAgICAgbWVzc2FnZSA9IGVycm9yTWVzc2FnZXMudG9vRmV3UG9pbnRzTGluZVxuICAgICAgfVxuICAgICAgYnJlYWtcbiAgICBjYXNlICdwb2x5Z29uJzpcbiAgICAgIGlmICghdXNuZy5ldmVyeSh2YWxpZGF0ZVVzbmdHcmlkKSkge1xuICAgICAgICBlcnJvciA9IHRydWVcbiAgICAgICAgbWVzc2FnZSA9IGVycm9yTWVzc2FnZXMuaW52YWxpZExpc3RcbiAgICAgIH0gZWxzZSBpZiAodXNuZy5sZW5ndGggPCA0KSB7XG4gICAgICAgIGVycm9yID0gdHJ1ZVxuICAgICAgICBtZXNzYWdlID0gZXJyb3JNZXNzYWdlcy50b29GZXdQb2ludHNQb2x5Z29uXG4gICAgICB9IGVsc2UgaWYgKCFfLmlzRXF1YWwodXNuZ1swXSwgdXNuZy5zbGljZSgtMSlbMF0pKSB7XG4gICAgICAgIGVycm9yID0gdHJ1ZVxuICAgICAgICBtZXNzYWdlID0gZXJyb3JNZXNzYWdlcy5maXJzdExhc3RQb2ludE1pc21hdGNoXG4gICAgICB9XG4gICAgICBicmVha1xuICB9XG4gIHJldHVybiB7IGVycm9yLCBtZXNzYWdlLCBkZWZhdWx0VmFsdWUgfVxufVxuXG5mdW5jdGlvbiB2YWxpZGF0ZVV0bVVwc0xpbmVPclBvbHkoXG4gIHV0bXVwczogVXRtVXBzUG9pbnRbXSxcbiAgdHlwZTogJ2xpbmUnIHwgJ3BvbHlnb24nXG4pIHtcbiAgbGV0IGRlZmF1bHRWYWx1ZVxuICBpZiAoIXV0bXVwcyB8fCB1dG11cHMuc29tZSh1dG1VcHNJc0JsYW5rKSkge1xuICAgIHJldHVybiB7IGVycm9yOiB0cnVlLCBtZXNzYWdlOiBlcnJvck1lc3NhZ2VzLmludmFsaWRMaXN0LCBkZWZhdWx0VmFsdWUgfVxuICB9XG4gIGxldCBlcnJvciA9IGZhbHNlXG4gIGxldCBtZXNzYWdlID0gbnVsbFxuICBzd2l0Y2ggKHR5cGUpIHtcbiAgICBjYXNlICdsaW5lJzpcbiAgICAgIGlmICghdXRtdXBzLmV2ZXJ5KHZhbGlkYXRlVXRtVXBzUG9pbnQpKSB7XG4gICAgICAgIGVycm9yID0gdHJ1ZVxuICAgICAgICBtZXNzYWdlID0gZXJyb3JNZXNzYWdlcy5pbnZhbGlkTGlzdFxuICAgICAgfSBlbHNlIGlmICh1dG11cHMubGVuZ3RoIDwgMikge1xuICAgICAgICBlcnJvciA9IHRydWVcbiAgICAgICAgbWVzc2FnZSA9IGVycm9yTWVzc2FnZXMudG9vRmV3UG9pbnRzTGluZVxuICAgICAgfVxuICAgICAgYnJlYWtcbiAgICBjYXNlICdwb2x5Z29uJzpcbiAgICAgIGlmICghdXRtdXBzLmV2ZXJ5KHZhbGlkYXRlVXRtVXBzUG9pbnQpKSB7XG4gICAgICAgIGVycm9yID0gdHJ1ZVxuICAgICAgICBtZXNzYWdlID0gZXJyb3JNZXNzYWdlcy5pbnZhbGlkTGlzdFxuICAgICAgfSBlbHNlIGlmICh1dG11cHMubGVuZ3RoIDwgNCkge1xuICAgICAgICBlcnJvciA9IHRydWVcbiAgICAgICAgbWVzc2FnZSA9IGVycm9yTWVzc2FnZXMudG9vRmV3UG9pbnRzUG9seWdvblxuICAgICAgfSBlbHNlIGlmICghXy5pc0VxdWFsKHV0bXVwc1swXSwgdXRtdXBzLnNsaWNlKC0xKVswXSkpIHtcbiAgICAgICAgZXJyb3IgPSB0cnVlXG4gICAgICAgIG1lc3NhZ2UgPSBlcnJvck1lc3NhZ2VzLmZpcnN0TGFzdFBvaW50TWlzbWF0Y2hcbiAgICAgIH1cbiAgICAgIGJyZWFrXG4gIH1cbiAgcmV0dXJuIHsgZXJyb3IsIG1lc3NhZ2UsIGRlZmF1bHRWYWx1ZSB9XG59XG5cbmV4cG9ydCB7XG4gIHZhbGlkYXRlVXNuZ0xpbmVPclBvbHksXG4gIHZhbGlkYXRlRG1zTGluZU9yUG9seSxcbiAgcGFyc2VEbXNDb29yZGluYXRlLFxuICB2YWxpZGF0ZVV0bVVwc0xpbmVPclBvbHksXG4gIGlzVVBTLFxufVxuIl19