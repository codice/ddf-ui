import { __assign, __read } from "tslib";
/**
 * Adapted from https://github.com/mui-org/material-ui/blob/master/docs/src/pages/customization/color/ColorTool.js
 */
import * as React from 'react';
import { hot } from 'react-hot-loader';
import { rgbToHex, useTheme } from '@mui/material/styles';
import colors from './typed-colors';
import Grid from '@mui/material/Grid';
import Input from '@mui/material/Input';
import Radio from '@mui/material/Radio';
import Tooltip from '@mui/material/Tooltip';
import Typography from '@mui/material/Typography';
import Button from '@mui/material/Button';
import _ from 'lodash';
import CheckIcon from '@mui/icons-material/Check';
import Slider from '@mui/material/Slider';
import user from '../../component/singletons/user-instance';
import { capitalize } from '@mui/material/utils';
var shades = [
    900,
    800,
    700,
    600,
    500,
    400,
    300,
    200,
    100,
    50,
    'A700',
    'A400',
    'A200',
    'A100',
];
var containsShades = function (color, shades) {
    return shades.every(function (shade) { return Object.keys(color).includes(shade.toString()); });
};
var getHues = function () {
    var hues = Object.keys(colors).filter(function (hue) {
        return containsShades(colors[hue], shades);
    });
    return hues.slice(1, 17);
};
var hues = getHues();
/**
 * Costly to update, so let them settle on a color first
 */
var updateTheme = _.debounce(function (state) {
    user.get('user').get('preferences').get('theme').set({
        primary: state.primary,
        secondary: state.secondary,
    });
}, 0);
var getDefaults = function () {
    return __assign({ primary: '#2196f3', secondary: '#f50057' }, user.get('user').get('preferences').get('theme').toJSON());
};
function ColorTool(props) {
    var classes = props.classes;
    var theme = useTheme();
    var defaults = getDefaults();
    var _a = __read(React.useState({
        primary: defaults.primary,
        secondary: defaults.secondary,
        primaryInput: defaults.primary,
        secondaryInput: defaults.secondary,
        primaryHue: 'blue',
        secondaryHue: 'pink',
        primaryShade: 4,
        secondaryShade: 11,
    }), 2), state = _a[0], setState = _a[1];
    var handleChangeColor = function (name) { return function (event) {
        var isRgb = function (string) {
            return /rgb\([0-9]{1,3}\s*,\s*[0-9]{1,3}\s*,\s*[0-9]{1,3}\)/i.test(string);
        };
        var isHex = function (string) {
            return /^#?([0-9a-f]{3})$|^#?([0-9a-f]){6}$/i.test(string);
        };
        var color = event.target.value;
        setState(function (prevState) {
            var _a;
            return (__assign(__assign({}, prevState), (_a = {}, _a["".concat(name, "Input")] = color, _a)));
        });
        var isValidColor = false;
        if (isRgb(color)) {
            isValidColor = true;
        }
        else if (isHex(color)) {
            isValidColor = true;
            if (color.indexOf('#') === -1) {
                color = "#".concat(color);
            }
        }
        if (isValidColor) {
            setState(function (prevState) {
                var _a;
                return (__assign(__assign({}, prevState), (_a = {}, _a[name] = color, _a)));
            });
        }
    }; };
    var handleChangeHue = function (name) { return function (event) {
        var _a;
        var hue = event.target.value;
        var shade = state["".concat(name, "Shade")];
        // @ts-expect-error ts-migrate(7015) FIXME: Element implicitly has an 'any' type because index... Remove this comment to see the full error message
        var color = colors[hue][shades[shade]];
        if (color) {
            setState(__assign(__assign({}, state), (_a = {}, _a["".concat(name, "Hue")] = hue, _a[name] = color, _a["".concat(name, "Input")] = color, _a)));
        }
    }; };
    var handleChangeShade = function (name) { return function (_event, shade) {
        var _a;
        // @ts-expect-error ts-migrate(7053) FIXME: Element implicitly has an 'any' type because expre... Remove this comment to see the full error message
        var color = colors[state["".concat(name, "Hue")]][shades[shade]];
        setState(__assign(__assign({}, state), (_a = {}, _a["".concat(name, "Shade")] = shade, _a[name] = color, _a["".concat(name, "Input")] = color, _a)));
    }; };
    React.useEffect(function () {
        updateTheme(state);
    }, [state]);
    var colorBar = function (color, intent) {
        var background = theme.palette.augmentColor({
            color: {
                main: color,
            },
        });
        return (React.createElement(Grid, { container: true, sx: { marginTop: theme.spacing(2) } }, ['dark', 'main', 'light'].map(function (key) {
            var backgroundColor = background[key];
            return (React.createElement(Tooltip, { placement: "right", title: (function () {
                    switch (key) {
                        case 'dark':
                            return 'Go darker';
                        case 'light':
                            return 'Go lighter';
                        default:
                            return 'Current shade';
                    }
                })(), key: key },
                React.createElement(Button, { sx: {
                        width: 64,
                        height: 64,
                        display: 'flex',
                        justifyContent: 'center',
                        alignItems: 'center',
                        backgroundColor: backgroundColor,
                    }, onClick: function () {
                        var _a;
                        setState(__assign(__assign({}, state), (_a = {}, _a[intent] = rgbToHex(backgroundColor), _a["".concat(intent, "Input")] = rgbToHex(backgroundColor), _a)));
                    } },
                    React.createElement(Typography, { variant: "caption", style: {
                            color: theme.palette.getContrastText(backgroundColor),
                        } }, rgbToHex(backgroundColor)))));
        })));
    };
    var colorPicker = function (intent) {
        var intentInput = state["".concat(intent, "Input")];
        var intentShade = state["".concat(intent, "Shade")];
        var color = state["".concat(intent)];
        return (React.createElement(Grid, { item: true, xs: 12, sm: 6, md: 4, className: "min-w-104" },
            React.createElement(Typography, { component: "label", gutterBottom: true, htmlFor: intent, variant: "h6" }, capitalize(intent)),
            React.createElement(Input, { id: intent, value: intentInput, onChange: handleChangeColor(intent), fullWidth: true }),
            React.createElement("div", { style: {
                    display: 'flex',
                    alignItems: 'center',
                    marginTop: theme.spacing(2),
                    marginBottom: theme.spacing(2),
                } },
                React.createElement(Typography, { id: "".concat(intent, "ShadeSliderLabel") }, "Shade:"),
                React.createElement(Slider, { sx: {
                        width: 'calc(100% - 80px)',
                        marginLeft: theme.spacing(3),
                        marginRight: theme.spacing(3),
                    }, value: intentShade, min: 0, max: 13, step: 1, onChange: handleChangeShade(intent), "aria-labelledby": "".concat(intent, "ShadeSliderLabel") }),
                React.createElement(Typography, null, shades[intentShade])),
            React.createElement("div", { style: { width: 192 } }, hues.map(function (hue) {
                var shade = intent === 'primary'
                    ? shades[state.primaryShade]
                    : shades[state.secondaryShade];
                // @ts-expect-error ts-migrate(7015) FIXME: Element implicitly has an 'any' type because index... Remove this comment to see the full error message
                var backgroundColor = colors[hue][shade];
                return (React.createElement(Tooltip, { placement: "right", title: hue, key: hue },
                    React.createElement(Radio, { sx: { padding: 0 }, color: "default", checked: state[intent] === backgroundColor, onChange: handleChangeHue(intent), value: hue, name: intent, "aria-labelledby": "tooltip-".concat(intent, "-").concat(hue), icon: React.createElement("div", { style: {
                                backgroundColor: backgroundColor,
                                width: 48,
                                height: 48,
                            } }), checkedIcon: React.createElement("div", { style: {
                                backgroundColor: backgroundColor,
                                width: 48,
                                height: 48,
                                border: '1px solid white',
                                color: theme.palette.common.white,
                                display: 'flex',
                                justifyContent: 'center',
                                alignItems: 'center',
                            } },
                            React.createElement(CheckIcon, { style: { fontSize: 30 } })) })));
            })),
            colorBar(color, intent)));
    };
    return (React.createElement(Grid, { container: true, spacing: 5, className: classes === null || classes === void 0 ? void 0 : classes.root },
        colorPicker('primary'),
        colorPicker('secondary')));
}
export default hot(module)(ColorTool);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29sb3ItdG9vbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9tYWluL3dlYmFwcC9yZWFjdC1jb21wb25lbnQvdGhlbWUtc2V0dGluZ3MvY29sb3ItdG9vbC50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOztHQUVHO0FBQ0gsT0FBTyxLQUFLLEtBQUssTUFBTSxPQUFPLENBQUE7QUFDOUIsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGtCQUFrQixDQUFBO0FBQ3RDLE9BQU8sRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sc0JBQXNCLENBQUE7QUFDekQsT0FBTyxNQUFNLE1BQU0sZ0JBQWdCLENBQUE7QUFDbkMsT0FBTyxJQUFJLE1BQU0sb0JBQW9CLENBQUE7QUFDckMsT0FBTyxLQUFLLE1BQU0scUJBQXFCLENBQUE7QUFDdkMsT0FBTyxLQUFLLE1BQU0scUJBQXFCLENBQUE7QUFDdkMsT0FBTyxPQUFPLE1BQU0sdUJBQXVCLENBQUE7QUFDM0MsT0FBTyxVQUFVLE1BQU0sMEJBQTBCLENBQUE7QUFDakQsT0FBTyxNQUFNLE1BQU0sc0JBQXNCLENBQUE7QUFDekMsT0FBTyxDQUFDLE1BQU0sUUFBUSxDQUFBO0FBQ3RCLE9BQU8sU0FBUyxNQUFNLDJCQUEyQixDQUFBO0FBQ2pELE9BQU8sTUFBTSxNQUFNLHNCQUFzQixDQUFBO0FBQ3pDLE9BQU8sSUFBSSxNQUFNLDBDQUEwQyxDQUFBO0FBQzNELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQTtBQUVoRCxJQUFNLE1BQU0sR0FBRztJQUNiLEdBQUc7SUFDSCxHQUFHO0lBQ0gsR0FBRztJQUNILEdBQUc7SUFDSCxHQUFHO0lBQ0gsR0FBRztJQUNILEdBQUc7SUFDSCxHQUFHO0lBQ0gsR0FBRztJQUNILEVBQUU7SUFDRixNQUFNO0lBQ04sTUFBTTtJQUNOLE1BQU07SUFDTixNQUFNO0NBQ1AsQ0FBQTtBQUNELElBQU0sY0FB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UUFBUSxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FDbkIsQ0FDUixDQUFBO0lBQ0gsQ0FBQyxDQUFBO0lBRUQsT0FBTyxDQUNMLG9CQUFDLElBQUksSUFBQyxTQUFTLFFBQUMsT0FBTyxFQUFFLENBQUMsRUFBRSxTQUFTLEVBQUUsT0FBTyxhQUFQLE9BQU8sdUJBQVAsT0FBTyxDQUFFLElBQUk7UUFDakQsV0FBVyxDQUFDLFNBQVMsQ0FBQztRQUN0QixXQUFXLENBQUMsV0FBVyxDQUFDLENBQ3BCLENBQ1IsQ0FBQTtBQUNILENBQUM7QUFFRCxlQUFlLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQWRhcHRlZCBmcm9tIGh0dHBzOi8vZ2l0aHViLmNvbS9tdWktb3JnL21hdGVyaWFsLXVpL2Jsb2IvbWFzdGVyL2RvY3Mvc3JjL3BhZ2VzL2N1c3RvbWl6YXRpb24vY29sb3IvQ29sb3JUb29sLmpzXG4gKi9cbmltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0J1xuaW1wb3J0IHsgaG90IH0gZnJvbSAncmVhY3QtaG90LWxvYWRlcidcbmltcG9ydCB7IHJnYlRvSGV4LCB1c2VUaGVtZSB9IGZyb20gJ0BtdWkvbWF0ZXJpYWwvc3R5bGVzJ1xuaW1wb3J0IGNvbG9ycyBmcm9tICcuL3R5cGVkLWNvbG9ycydcbmltcG9ydCBHcmlkIGZyb20gJ0BtdWkvbWF0ZXJpYWwvR3JpZCdcbmltcG9ydCBJbnB1dCBmcm9tICdAbXVpL21hdGVyaWFsL0lucHV0J1xuaW1wb3J0IFJhZGlvIGZyb20gJ0BtdWkvbWF0ZXJpYWwvUmFkaW8nXG5pbXBvcnQgVG9vbHRpcCBmcm9tICdAbXVpL21hdGVyaWFsL1Rvb2x0aXAnXG5pbXBvcnQgVHlwb2dyYXBoeSBmcm9tICdAbXVpL21hdGVyaWFsL1R5cG9ncmFwaHknXG5pbXBvcnQgQnV0dG9uIGZyb20gJ0BtdWkvbWF0ZXJpYWwvQnV0dG9uJ1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJ1xuaW1wb3J0IENoZWNrSWNvbiBmcm9tICdAbXVpL2ljb25zLW1hdGVyaWFsL0NoZWNrJ1xuaW1wb3J0IFNsaWRlciBmcm9tICdAbXVpL21hdGVyaWFsL1NsaWRlcidcbmltcG9ydCB1c2VyIGZyb20gJy4uLy4uL2NvbXBvbmVudC9zaW5nbGV0b25zL3VzZXItaW5zdGFuY2UnXG5pbXBvcnQgeyBjYXBpdGFsaXplIH0gZnJvbSAnQG11aS9tYXRlcmlhbC91dGlscydcblxuY29uc3Qgc2hhZGVzID0gW1xuICA5MDAsXG4gIDgwMCxcbiAgNzAwLFxuICA2MDAsXG4gIDUwMCxcbiAgNDAwLFxuICAzMDAsXG4gIDIwMCxcbiAgMTAwLFxuICA1MCxcbiAgJ0E3MDAnLFxuICAnQTQwMCcsXG4gICdBMjAwJyxcbiAgJ0ExMDAnLFxuXVxuY29uc3QgY29udGFpbnNTaGFkZXMgPSAoXG4gIGNvbG9yOiBhbnksXG4gIHNoYWRlczogQXJyYXk8c3RyaW5nIHwgbnVtYmVyPlxuKTogYm9vbGVhbiA9PiB7XG4gIHJldHVybiBzaGFkZXMuZXZlcnkoKHNoYWRlKSA9PiBPYmplY3Qua2V5cyhjb2xvcikuaW5jbHVkZXMoc2hhZGUudG9TdHJpbmcoKSkpXG59XG5jb25zdCBnZXRIdWVzID0gKCkgPT4ge1xuICBjb25zdCBodWVzID0gT2JqZWN0LmtleXMoY29sb3JzKS5maWx0ZXIoKGh1ZSkgPT5cbiAgICBjb250YWluc1NoYWRlcyhjb2xvcnNbaHVlXSwgc2hhZGVzKVxuICApXG4gIHJldHVybiBodWVzLnNsaWNlKDEsIDE3KVxufVxuXG5jb25zdCBodWVzID0gZ2V0SHVlcygpXG5cbi8qKlxuICogQ29zdGx5IHRvIHVwZGF0ZSwgc28gbGV0IHRoZW0gc2V0dGxlIG9uIGEgY29sb3IgZmlyc3RcbiAqL1xuY29uc3QgdXBkYXRlVGhlbWUgPSBfLmRlYm91bmNlKChzdGF0ZTogYW55KSA9PiB7XG4gIHVzZXIuZ2V0KCd1c2VyJykuZ2V0KCdwcmVmZXJlbmNlcycpLmdldCgndGhlbWUnKS5zZXQoe1xuICAgIHByaW1hcnk6IHN0YXRlLnByaW1hcnksXG4gICAgc2Vjb25kYXJ5OiBzdGF0ZS5zZWNvbmRhcnksXG4gIH0pXG59LCAwKVxuXG5jb25zdCBnZXREZWZhdWx0cyA9ICgpID0+IHtcbiAgcmV0dXJuIHtcbiAgICBwcmltYXJ5OiAnIzIxOTZmMycsXG4gICAgc2Vjb25kYXJ5OiAnI2Y1MDA1NycsXG4gICAgLi4udXNlci5nZXQoJ3VzZXInKS5nZXQoJ3ByZWZlcmVuY2VzJykuZ2V0KCd0aGVtZScpLnRvSlNPTigpLFxuICB9XG59XG5cbmZ1bmN0aW9uIENvbG9yVG9vbChwcm9wczogYW55KSB7XG4gIGNvbnN0IHsgY2xhc3NlcyB9ID0gcHJvcHNcbiAgY29uc3QgdGhlbWUgPSB1c2VUaGVtZSgpXG4gIGNvbnN0IGRlZmF1bHRzID0gZ2V0RGVmYXVsdHMoKSBhcyB7IHByaW1hcnk6IHN0cmluZzsgc2Vjb25kYXJ5OiBzdHJpbmcgfVxuICBjb25zdCBbc3RhdGUsIHNldFN0YXRlXSA9IFJlYWN0LnVzZVN0YXRlKHtcbiAgICBwcmltYXJ5OiBkZWZhdWx0cy5wcmltYXJ5LFxuICAgIHNlY29uZGFyeTogZGVmYXVsdHMuc2Vjb25kYXJ5LFxuICAgIHByaW1hcnlJbnB1dDogZGVmYXVsdHMucHJpbWFyeSxcbiAgICBzZWNvbmRhcnlJbnB1dDogZGVmYXVsdHMuc2Vjb25kYXJ5LFxuICAgIHByaW1hcnlIdWU6ICdibHVlJyxcbiAgICBzZWNvbmRhcnlIdWU6ICdwaW5rJyxcbiAgICBwcmltYXJ5U2hhZGU6IDQsXG4gICAgc2Vjb25kYXJ5U2hhZGU6IDExLFxuICB9KVxuXG4gIGNvbnN0IGhhbmRsZUNoYW5nZUNvbG9yID0gKG5hbWU6IHN0cmluZykgPT4gKGV2ZW50OiBhbnkpID0+IHtcbiAgICBjb25zdCBpc1JnYiA9IChzdHJpbmc6IHN0cmluZykgPT5cbiAgICAgIC9yZ2JcXChbMC05XXsxLDN9XFxzKixcXHMqWzAtOV17MSwzfVxccyosXFxzKlswLTldezEsM31cXCkvaS50ZXN0KHN0cmluZylcblxuICAgIGNvbnN0IGlzSGV4ID0gKHN0cmluZzogc3RyaW5nKSA9PlxuICAgICAgL14jPyhbMC05YS1mXXszfSkkfF4jPyhbMC05YS1mXSl7Nn0kL2kudGVzdChzdHJpbmcpXG5cbiAgICBsZXQge1xuICAgICAgdGFyZ2V0OiB7IHZhbHVlOiBjb2xvciB9LFxuICAgIH0gPSBldmVudFxuXG4gICAgc2V0U3RhdGUoKHByZXZTdGF0ZSkgPT4gKHtcbiAgICAgIC4uLnByZXZTdGF0ZSxcbiAgICAgIFtgJHtuYW1lfUlucHV0YF06IGNvbG9yLFxuICAgIH0pKVxuXG4gICAgbGV0IGlzVmFsaWRDb2xvciA9IGZhbHNlXG5cbiAgICBpZiAoaXNSZ2IoY29sb3IpKSB7XG4gICAgICBpc1ZhbGlkQ29sb3IgPSB0cnVlXG4gICAgfSBlbHNlIGlmIChpc0hleChjb2xvcikpIHtcbiAgICAgIGlzVmFsaWRDb2xvciA9IHRydWVcbiAgICAgIGlmIChjb2xvci5pbmRleE9mKCcjJykgPT09IC0xKSB7XG4gICAgICAgIGNvbG9yID0gYCMke2NvbG9yfWBcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoaXNWYWxpZENvbG9yKSB7XG4gICAgICBzZXRTdGF0ZSgocHJldlN0YXRlKSA9PiAoe1xuICAgICAgICAuLi5wcmV2U3RhdGUsXG4gICAgICAgIFtuYW1lXTogY29sb3IsXG4gICAgICB9KSlcbiAgICB9XG4gIH1cblxuICBjb25zdCBoYW5kbGVDaGFuZ2VIdWUgPSAobmFtZTogc3RyaW5nKSA9PiAoZXZlbnQ6IGFueSkgPT4ge1xuICAgIGNvbnN0IGh1ZSA9IGV2ZW50LnRhcmdldC52YWx1ZVxuICAgIGNvbnN0IHNoYWRlID0gc3RhdGVbYCR7bmFtZX1TaGFkZWAgYXMgJ3ByaW1hcnlTaGFkZSddXG5cbiAgICAvLyBAdHMtZXhwZWN0LWVycm9yIHRzLW1pZ3JhdGUoNzAxNSkgRklYTUU6IEVsZW1lbnQgaW1wbGljaXRseSBoYXMgYW4gJ2FueScgdHlwZSBiZWNhdXNlIGluZGV4Li4uIFJlbW92ZSB0aGlzIGNvbW1lbnQgdG8gc2VlIHRoZSBmdWxsIGVycm9yIG1lc3NhZ2VcbiAgICBjb25zdCBjb2xvciA9IGNvbG9yc1todWVdW3NoYWRlc1tzaGFkZV1dXG5cbiAgICBpZiAoY29sb3IpIHtcbiAgICAgIHNldFN0YXRlKHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIFtgJHtuYW1lfUh1ZWBdOiBodWUsXG4gICAgICAgIFtuYW1lXTogY29sb3IsXG4gICAgICAgIFtgJHtuYW1lfUlucHV0YF06IGNvbG9yLFxuICAgICAgfSlcbiAgICB9XG4gIH1cblxuICBjb25zdCBoYW5kbGVDaGFuZ2VTaGFkZSA9XG4gICAgKG5hbWU6IHN0cmluZykgPT4gKF9ldmVudDogYW55LCBzaGFkZTogc3RyaW5nIHwgbnVtYmVyKSA9PiB7XG4gICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIHRzLW1pZ3JhdGUoNzA1MykgRklYTUU6IEVsZW1lbnQgaW1wbGljaXRseSBoYXMgYW4gJ2FueScgdHlwZSBiZWNhdXNlIGV4cHJlLi4uIFJlbW92ZSB0aGlzIGNvbW1lbnQgdG8gc2VlIHRoZSBmdWxsIGVycm9yIG1lc3NhZ2VcbiAgICAgIGNvbnN0IGNvbG9yID0gY29sb3JzW3N0YXRlW2Ake25hbWV9SHVlYF1dW3NoYWRlc1tzaGFkZV1dXG4gICAgICBzZXRTdGF0ZSh7XG4gICAgICAgIC4uLnN0YXRlLFxuICAgICAgICBbYCR7bmFtZX1TaGFkZWBdOiBzaGFkZSxcbiAgICAgICAgW25hbWVdOiBjb2xvcixcbiAgICAgICAgW2Ake25hbWV9SW5wdXRgXTogY29sb3IsXG4gICAgICB9KVxuICAgIH1cblxuICBSZWFjdC51c2VFZmZlY3QoKCkgPT4ge1xuICAgIHVwZGF0ZVRoZW1lKHN0YXRlKVxuICB9LCBbc3RhdGVdKVxuXG4gIGNvbnN0IGNvbG9yQmFyID0gKGNvbG9yOiBhbnksIGludGVudDogc3RyaW5nKSA9PiB7XG4gICAgY29uc3QgYmFja2dyb3VuZCA9IHRoZW1lLnBhbGV0dGUuYXVnbWVudENvbG9yKHtcbiAgICAgIGNvbG9yOiB7XG4gICAgICAgIG1haW46IGNvbG9yLFxuICAgICAgfSxcbiAgICB9KVxuXG4gICAgcmV0dXJuIChcbiAgICAgIDxHcmlkIGNvbnRhaW5lciBzeD17eyBtYXJnaW5Ub3A6IHRoZW1lLnNwYWNpbmcoMikgfX0+XG4gICAgICAgIHtbJ2RhcmsnLCAnbWFpbicsICdsaWdodCddLm1hcCgoa2V5KSA9PiB7XG4gICAgICAgICAgY29uc3QgYmFja2dyb3VuZENvbG9yID0gYmFja2dyb3VuZFtrZXkgYXMgJ2xpZ2h0J10gYXMgc3RyaW5nXG4gICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxUb29sdGlwXG4gICAgICAgICAgICAgIHBsYWNlbWVudD1cInJpZ2h0XCJcbiAgICAgICAgICAgICAgdGl0bGU9eygoKSA9PiB7XG4gICAgICAgICAgICAgICAgc3dpdGNoIChrZXkpIHtcbiAgICAgICAgICAgICAgICAgIGNhc2UgJ2RhcmsnOlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ0dvIGRhcmtlcidcbiAgICAgICAgICAgICAgICAgIGNhc2UgJ2xpZ2h0JzpcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdHbyBsaWdodGVyJ1xuICAgICAgICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdDdXJyZW50IHNoYWRlJ1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfSkoKX1cbiAgICAgICAgICAgICAga2V5PXtrZXl9XG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgIDxCdXR0b25cbiAgICAgICAgICAgICAgICBzeD17e1xuICAgICAgICAgICAgICAgICAgd2lkdGg6IDY0LFxuICAgICAgICAgICAgICAgICAgaGVpZ2h0OiA2NCxcbiAgICAgICAgICAgICAgICAgIGRpc3BsYXk6ICdmbGV4JyxcbiAgICAgICAgICAgICAgICAgIGp1c3RpZnlDb250ZW50OiAnY2VudGVyJyxcbiAgICAgICAgICAgICAgICAgIGFsaWduSXRlbXM6ICdjZW50ZXInLFxuICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yLFxuICAgICAgICAgICAgICAgIH19XG4gICAgICAgICAgICAgICAgb25DbGljaz17KCkgPT4ge1xuICAgICAgICAgICAgICAgICAgc2V0U3RhdGUoe1xuICAgICAgICAgICAgICAgICAgICAuLi5zdGF0ZSxcbiAgICAgICAgICAgICAgICAgICAgW2ludGVudF06IHJnYlRvSGV4KGJhY2tncm91bmRDb2xvciksXG4gICAgICAgICAgICAgICAgICAgIFtgJHtpbnRlbnR9SW5wdXRgXTogcmdiVG9IZXgoYmFja2dyb3VuZENvbG9yKSxcbiAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgfX1cbiAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgIDxUeXBvZ3JhcGh5XG4gICAgICAgICAgICAgICAgICB2YXJpYW50PVwiY2FwdGlvblwiXG4gICAgICAgICAgICAgICAgICBzdHlsZT17e1xuICAgICAgICAgICAgICAgICAgICBjb2xvcjogdGhlbWUucGFsZXR0ZS5nZXRDb250cmFzdFRleHQoYmFja2dyb3VuZENvbG9yKSxcbiAgICAgICAgICAgICAgICAgIH19XG4gICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAge3JnYlRvSGV4KGJhY2tncm91bmRDb2xvcil9XG4gICAgICAgICAgICAgICAgPC9UeXBvZ3JhcGh5PlxuICAgICAgICAgICAgICA8L0J1dHRvbj5cbiAgICAgICAgICAgIDwvVG9vbHRpcD5cbiAgICAgICAgICApXG4gICAgICAgIH0pfVxuICAgICAgPC9HcmlkPlxuICAgIClcbiAgfVxuXG4gIGNvbnN0IGNvbG9yUGlja2VyID0gKGludGVudDogJ3ByaW1hcnknIHwgJ3NlY29uZGFyeScpID0+IHtcbiAgICBjb25zdCBpbnRlbnRJbnB1dCA9IHN0YXRlW2Ake2ludGVudH1JbnB1dGAgYXMgJ3ByaW1hcnlJbnB1dCddXG4gICAgY29uc3QgaW50ZW50U2hhZGUgPSBzdGF0ZVtgJHtpbnRlbnR9U2hhZGVgIGFzICdwcmltYXJ5U2hhZGUnXVxuICAgIGNvbnN0IGNvbG9yID0gc3RhdGVbYCR7aW50ZW50fWAgYXMgJ3ByaW1hcnknXVxuXG4gICAgcmV0dXJuIChcbiAgICAgIDxHcmlkIGl0ZW0geHM9ezEyfSBzbT17Nn0gbWQ9ezR9IGNsYXNzTmFtZT1cIm1pbi13LTEwNFwiPlxuICAgICAgICA8VHlwb2dyYXBoeVxuICAgICAgICAgIGNvbXBvbmVudD1cImxhYmVsXCJcbiAgICAgICAgICBndXR0ZXJCb3R0b21cbiAgICAgICAgICBodG1sRm9yPXtpbnRlbnR9XG4gICAgICAgICAgdmFyaWFudD1cImg2XCJcbiAgICAgICAgPlxuICAgICAgICAgIHtjYXBpdGFsaXplKGludGVudCl9XG4gICAgICAgIDwvVHlwb2dyYXBoeT5cbiAgICAgICAgPElucHV0XG4gICAgICAgICAgaWQ9e2ludGVudH1cbiAgICAgICAgICB2YWx1ZT17aW50ZW50SW5wdXR9XG4gICAgICAgICAgb25DaGFuZ2U9e2hhbmRsZUNoYW5nZUNvbG9yKGludGVudCl9XG4gICAgICAgICAgZnVsbFdpZHRoXG4gICAgICAgIC8+XG4gICAgICAgIDxkaXZcbiAgICAgICAgICBzdHlsZT17e1xuICAgICAgICAgICAgZGlzcGxheTogJ2ZsZXgnLFxuICAgICAgICAgICAgYWxpZ25JdGVtczogJ2NlbnRlcicsXG4gICAgICAgICAgICBtYXJnaW5Ub3A6IHRoZW1lLnNwYWNpbmcoMiksXG4gICAgICAgICAgICBtYXJnaW5Cb3R0b206IHRoZW1lLnNwYWNpbmcoMiksXG4gICAgICAgICAgfX1cbiAgICAgICAgPlxuICAgICAgICAgIDxUeXBvZ3JhcGh5IGlkPXtgJHtpbnRlbnR9U2hhZGVTbGlkZXJMYWJlbGB9PlNoYWRlOjwvVHlwb2dyYXBoeT5cbiAgICAgICAgICA8U2xpZGVyXG4gICAgICAgICAgICBzeD17e1xuICAgICAgICAgICAgICB3aWR0aDogJ2NhbGMoMTAwJSAtIDgwcHgpJyxcbiAgICAgICAgICAgICAgbWFyZ2luTGVmdDogdGhlbWUuc3BhY2luZygzKSxcbiAgICAgICAgICAgICAgbWFyZ2luUmlnaHQ6IHRoZW1lLnNwYWNpbmcoMyksXG4gICAgICAgICAgICB9fVxuICAgICAgICAgICAgdmFsdWU9e2ludGVudFNoYWRlfVxuICAgICAgICAgICAgbWluPXswfVxuICAgICAgICAgICAgbWF4PXsxM31cbiAgICAgICAgICAgIHN0ZXA9ezF9XG4gICAgICAgICAgICBvbkNoYW5nZT17aGFuZGxlQ2hhbmdlU2hhZGUoaW50ZW50KSBhcyBhbnl9XG4gICAgICAgICAgICBhcmlhLWxhYmVsbGVkYnk9e2Ake2ludGVudH1TaGFkZVNsaWRlckxhYmVsYH1cbiAgICAgICAgICAvPlxuICAgICAgICAgIDxUeXBvZ3JhcGh5PntzaGFkZXNbaW50ZW50U2hhZGVdfTwvVHlwb2dyYXBoeT5cbiAgICAgICAgPC9kaXY+XG4gICAgICAgIDxkaXYgc3R5bGU9e3sgd2lkdGg6IDE5MiB9fT5cbiAgICAgICAgICB7aHVlcy5tYXAoKGh1ZSkgPT4ge1xuICAgICAgICAgICAgY29uc3Qgc2hhZGUgPVxuICAgICAgICAgICAgICBpbnRlbnQgPT09ICdwcmltYXJ5J1xuICAgICAgICAgICAgICAgID8gc2hhZGVzW3N0YXRlLnByaW1hcnlTaGFkZV1cbiAgICAgICAgICAgICAgICA6IHNoYWRlc1tzdGF0ZS5zZWNvbmRhcnlTaGFkZV1cblxuICAgICAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciB0cy1taWdyYXRlKDcwMTUpIEZJWE1FOiBFbGVtZW50IGltcGxpY2l0bHkgaGFzIGFuICdhbnknIHR5cGUgYmVjYXVzZSBpbmRleC4uLiBSZW1vdmUgdGhpcyBjb21tZW50IHRvIHNlZSB0aGUgZnVsbCBlcnJvciBtZXNzYWdlXG4gICAgICAgICAgICBjb25zdCBiYWNrZ3JvdW5kQ29sb3IgPSBjb2xvcnNbaHVlXVtzaGFkZV0gYXMgc3RyaW5nXG5cbiAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgIDxUb29sdGlwIHBsYWNlbWVudD1cInJpZ2h0XCIgdGl0bGU9e2h1ZX0ga2V5PXtodWV9PlxuICAgICAgICAgICAgICAgIDxSYWRpb1xuICAgICAgICAgICAgICAgICAgc3g9e3sgcGFkZGluZzogMCB9fVxuICAgICAgICAgICAgICAgICAgY29sb3I9XCJkZWZhdWx0XCJcbiAgICAgICAgICAgICAgICAgIGNoZWNrZWQ9e3N0YXRlW2ludGVudF0gPT09IGJhY2tncm91bmRDb2xvcn1cbiAgICAgICAgICAgICAgICAgIG9uQ2hhbmdlPXtoYW5kbGVDaGFuZ2VIdWUoaW50ZW50KX1cbiAgICAgICAgICAgICAgICAgIHZhbHVlPXtodWV9XG4gICAgICAgICAgICAgICAgICBuYW1lPXtpbnRlbnR9XG4gICAgICAgICAgICAgICAgICBhcmlhLWxhYmVsbGVkYnk9e2B0b29sdGlwLSR7aW50ZW50fS0ke2h1ZX1gfVxuICAgICAgICAgICAgICAgICAgaWNvbj17XG4gICAgICAgICAgICAgICAgICAgIDxkaXZcbiAgICAgICAgICAgICAgICAgICAgICBzdHlsZT17e1xuICAgICAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yLFxuICAgICAgICAgICAgICAgICAgICAgICAgd2lkdGg6IDQ4LFxuICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiA0OCxcbiAgICAgICAgICAgICAgICAgICAgICB9fVxuICAgICAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgY2hlY2tlZEljb249e1xuICAgICAgICAgICAgICAgICAgICA8ZGl2XG4gICAgICAgICAgICAgICAgICAgICAgc3R5bGU9e3tcbiAgICAgICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcixcbiAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiA0OCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodDogNDgsXG4gICAgICAgICAgICAgICAgICAgICAgICBib3JkZXI6ICcxcHggc29saWQgd2hpdGUnLFxuICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IHRoZW1lLnBhbGV0dGUuY29tbW9uLndoaXRlLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheTogJ2ZsZXgnLFxuICAgICAgICAgICAgICAgICAgICAgICAganVzdGlmeUNvbnRlbnQ6ICdjZW50ZXInLFxuICAgICAgICAgICAgICAgICAgICAgICAgYWxpZ25JdGVtczogJ2NlbnRlcicsXG4gICAgICAgICAgICAgICAgICAgICAgfX1cbiAgICAgICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICAgIDxDaGVja0ljb24gc3R5bGU9e3sgZm9udFNpemU6IDMwIH19IC8+XG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgIDwvVG9vbHRpcD5cbiAgICAgICAgICAgIClcbiAgICAgICAgICB9KX1cbiAgICAgICAgPC9kaXY+XG4gICAgICAgIHtjb2xvckJhcihjb2xvciwgaW50ZW50KX1cbiAgICAgIDwvR3JpZD5cbiAgICApXG4gIH1cblxuICByZXR1cm4gKFxuICAgIDxHcmlkIGNvbnRhaW5lciBzcGFjaW5nPXs1fSBjbGFzc05hbWU9e2NsYXNzZXM/LnJvb3R9PlxuICAgICAge2NvbG9yUGlja2VyKCdwcmltYXJ5Jyl9XG4gICAgICB7Y29sb3JQaWNrZXIoJ3NlY29uZGFyeScpfVxuICAgIDwvR3JpZD5cbiAgKVxufVxuXG5leHBvcnQgZGVmYXVsdCBob3QobW9kdWxlKShDb2xvclRvb2wpXG4iXX0=