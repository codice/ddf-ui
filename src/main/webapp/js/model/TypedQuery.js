import { __assign, __read } from "tslib";
/**
 * Copyright (c) Codice Foundation
 *
 * This is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser
 * General Public License as published by the Free Software Foundation, either version 3 of the
 * License, or any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
 * even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details. A copy of the GNU Lesser General Public License
 * is distributed along with this program and can be found at
 * <http://www.gnu.org/licenses/lgpl.html>.
 *
 **/
import React from 'react';
import { FilterBuilderClass } from '../../component/filter-builder/filter.structure';
import { useListenTo } from '../../component/selection-checkbox/useBackbone.hook';
import { TypedUserInstance } from '../../component/singletons/TypedUser';
import cql from '../cql';
import UntypedQuery from './Query';
export var DEFAULT_QUERY_OPTIONS = {
    transformDefaults: function (_a) {
        var originalDefaults = _a.originalDefaults;
        return originalDefaults;
    },
    transformFilterTree: function (_a) {
        var originalFilterTree = _a.originalFilterTree;
        return cql.write(originalFilterTree);
    },
    transformCount: function (_a) {
        var originalCount = _a.originalCount;
        return originalCount;
    },
    transformSorts: function (_a) {
        var originalSorts = _a.originalSorts;
        return originalSorts;
    },
    limitToHistoric: false,
    limitToDeleted: false,
    additionalOptions: undefined,
};
export var Query = function (attributes, options) {
    var mergedOptions = __assign(__assign({}, DEFAULT_QUERY_OPTIONS), options);
    return new UntypedQuery(attributes, mergedOptions);
};
function mixinEphemeralFilter(originalCQL) {
    var ephemeralFilter = TypedUserInstance.getEphemeralFilter();
    try {
        if (ephemeralFilter) {
            return new FilterBuilderClass({
                filters: [ephemeralFilter, originalCQL],
                type: 'AND',
            });
        }
        else {
            return originalCQL;
        }
    }
    catch (err) {
        console.error(err);
        return originalCQL;
    }
}
export var DEFAULT_USER_QUERY_OPTIONS = {
    transformDefaults: function (_a) {
        var originalDefaults = _a.originalDefaults;
        return __assign(__assign(__assign({}, originalDefaults), TypedUserInstance.getQuerySettingsJSON()), { count: TypedUserInstance.getResultCount() });
    },
    transformFilterTree: function (_a) {
        var originalFilterTree = _a.originalFilterTree;
        return cql.write(mixinEphemeralFilter(originalFilterTree));
    },
    transformSorts: function (_a) {
        var originalSorts = _a.originalSorts;
        return TypedUserInstance.getEphemeralSorts() || originalSorts;
    },
    transformCount: function (_a) {
        var originalCount = _a.originalCount;
        return TypedUserInstance.getResultCount() || originalCount;
    },
    limitToDeleted: false,
    limitToHistoric: false,
    additionalOptions: undefined,
};
/**
 * This should be used in place of useUserQuery _only_ if you do not intend to listen to changes to user prefs.
 */
export var UserQuery = function (attributes, options) {
    var mergedOptions = __assign(__assign({}, DEFAULT_USER_QUERY_OPTIONS), options);
    return Query(attributes, mergedOptions);
};
export var useQuery = function (_a) {
    var _b = _a === void 0 ? {} : _a, attributes = _b.attributes, options = _b.options;
    var _c = __read(React.useState(Query(attributes, options)), 2), query = _c[0], setQuery = _c[1];
    return [query, setQuery];
};
export var useUserQuery = function (_a) {
    var _b = _a === void 0 ? {} : _a, attributes = _b.attributes, options = _b.options;
    var _c = __read(React.useState(UserQuery(attributes, options)), 2), query = _c[0], setQuery = _c[1];
    useListenTo(TypedUserInstance.getPreferences(), 'change:resultCount', function () {
        query.set('count', TypedUserInstance.getResultCount());
    });
    useListenTo(TypedUserInstance.getPreferences(), 'change:resultFilter', function () {
        query.startSearchFromFirstPage();
    });
    useListenTo(TypedUserInstance.getPreferences(), 'change:resultSort', function () {
        query.startSearchFromFirstPage();
    });
    return [query, setQuery];
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVHlwZWRRdWVyeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9tYWluL3dlYmFwcC9qcy9tb2RlbC9UeXBlZFF1ZXJ5LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7Ozs7SUFhSTtBQUNKLE9BQU8sS0FBbUMsTUFBTSxPQUFPLENBQUE7QUFDdkQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0saURBQWlELENBQUE7QUFDcEYsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHFEQUFxRCxDQUFBO0FBQ2pGLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHNDQUFzQyxDQUFBO0FBQ3hFLE9BQU8sR0FBRyxNQUFNLFFBQVEsQ0FBQTtBQUV4QixPQUFPLFlBQTJCLE1BQU0sU0FBUyxDQUFBO0FBd0RqRCxNQUFNLENBQUMsSUFBTSxxQkFBcUIsR0FBcUM7SUFDckUsaUJBQWlCLEVBQUUsVUFBQyxFQUFvQjtZQUFsQixnQkFBZ0Isc0JBQUE7UUFDcEMsT0FBTyxnQkFBZ0IsQ0FBQTtJQUN6QixDQUFDO0lBQ0QsbUJBQW1CLEVBQUUsVUFBQyxFQUFzQjtZQUFwQixrQkFBa0Isd0JBQUE7UUFDeEMsT0FBTyxHQUFHLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLENBQUE7SUFDdEMsQ0FBQztJQUNELGNBQWMsRUFBRSxVQUFDLEVBQWlCO1lBQWYsYUFBYSxtQkFBQTtRQUM5QixPQUFPLGFBQWEsQ0FBQTtJQUN0QixDQUFDO0lBQ0QsY0FBYyxFQUFFLFVBQUMsRUFBaUI7WUFBZixhQUFhLG1CQUFBO1FBQzlCLE9BQU8sYUFBYSxDQUFBO0lBQ3RCLENBQUM7SUFDRCxlQUFlLEVBQUUsS0FBSztJQUN0QixjQUFjLEVBQUUsS0FBSztJQUNyQixpQkFBaUIsRUFBRSxTQUFTO0NBQzdCLENBQUE7QUFFRCxNQUFNLENBQUMsSUFBTSxLQUFLLEdBQUcsVUFDbkIsVUFBZ0MsRUFDaEMsT0FBc0I7SUFF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b0IsRUFBRTtRQUNwRSxLQUFLLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxpQkFBaUIsQ0FBQyxjQUFjLEVBQUUsQ0FBQyxDQUFBO0lBQ3hELENBQUMsQ0FBQyxDQUFBO0lBQ0YsV0FBVyxDQUFDLGlCQUFpQixDQUFDLGNBQWMsRUFBRSxFQUFFLHFCQUFxQixFQUFFO1FBQ3JFLEtBQUssQ0FBQyx3QkFBd0IsRUFBRSxDQUFBO0lBQ2xDLENBQUMsQ0FBQyxDQUFBO0lBQ0YsV0FBVyxDQUFDLGlCQUFpQixDQUFDLGNBQWMsRUFBRSxFQUFFLG1CQUFtQixFQUFFO1FBQ25FLEtBQUssQ0FBQyx3QkFBd0IsRUFBRSxDQUFBO0lBQ2xDLENBQUMsQ0FBQyxDQUFBO0lBQ0YsT0FBTyxDQUFDLEtBQUssRUFBRSxRQUFRLENBQUMsQ0FBQTtBQUMxQixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAoYykgQ29kaWNlIEZvdW5kYXRpb25cbiAqXG4gKiBUaGlzIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgTGVzc2VyXG4gKiBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieSB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZVxuICogTGljZW5zZSwgb3IgYW55IGxhdGVyIHZlcnNpb24uXG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dFxuICogZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuIFNlZSB0aGUgR05VXG4gKiBMZXNzZXIgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLiBBIGNvcHkgb2YgdGhlIEdOVSBMZXNzZXIgR2VuZXJhbCBQdWJsaWMgTGljZW5zZVxuICogaXMgZGlzdHJpYnV0ZWQgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0gYW5kIGNhbiBiZSBmb3VuZCBhdFxuICogPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy9sZ3BsLmh0bWw+LlxuICpcbiAqKi9cbmltcG9ydCBSZWFjdCwgeyBEaXNwYXRjaCwgU2V0U3RhdGVBY3Rpb24gfSBmcm9tICdyZWFjdCdcbmltcG9ydCB7IEZpbHRlckJ1aWxkZXJDbGFzcyB9IGZyb20gJy4uLy4uL2NvbXBvbmVudC9maWx0ZXItYnVpbGRlci9maWx0ZXIuc3RydWN0dXJlJ1xuaW1wb3J0IHsgdXNlTGlzdGVuVG8gfSBmcm9tICcuLi8uLi9jb21wb25lbnQvc2VsZWN0aW9uLWNoZWNrYm94L3VzZUJhY2tib25lLmhvb2snXG5pbXBvcnQgeyBUeXBlZFVzZXJJbnN0YW5jZSB9IGZyb20gJy4uLy4uL2NvbXBvbmVudC9zaW5nbGV0b25zL1R5cGVkVXNlcidcbmltcG9ydCBjcWwgZnJvbSAnLi4vY3FsJ1xuaW1wb3J0IHsgUXVlcnlBdHRyaWJ1dGVzVHlwZSwgU29ydFR5cGUgfSBmcm9tICcuL1F1ZXJ5LnNoYXJlZC10eXBlcydcbmltcG9ydCBVbnR5cGVkUXVlcnksIHsgUXVlcnlUeXBlIH0gZnJvbSAnLi9RdWVyeSdcblxuLyoqXG4gKiBNYWlubHkgdXNlZCBieSBsYXp5IHF1ZXJ5IHJlc3VsdHMsIHNpbmNlIGl0IGdldHMgcGFzc2VkIGEgZnVuY3Rpb24gdGhhdCBhZGRzIGluIHRoZSBxdWVyeSByZWYgZm9yIGl0XG4gKi9cbmV4cG9ydCB0eXBlIFRyYW5zZm9ybVNvcnRzQ29tcG9zZWRGdW5jdGlvblR5cGUgPSAoe1xuICBvcmlnaW5hbFNvcnRzLFxufToge1xuICBvcmlnaW5hbFNvcnRzOiBTb3J0VHlwZVtdXG59KSA9PiBTb3J0VHlwZVtdXG5cbmV4cG9ydCB0eXBlIFRyYW5zZm9ybVNvcnRzRnVuY3Rpb25UeXBlID0gKHtcbiAgb3JpZ2luYWxTb3J0cyxcbiAgcXVlcnlSZWYsXG59OiB7XG4gIG9yaWdpbmFsU29ydHM6IFNvcnRUeXBlW11cbiAgcXVlcnlSZWY6IEJhY2tib25lLk1vZGVsPGFueT5cbn0pID0+IFNvcnRUeXBlW11cblxuZXhwb3J0IHR5cGUgUXVlcnlPcHRpb25zID0ge1xuICAvKipcbiAgICogUGFzcyBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUgZGVmYXVsdHMgdG8gdXNlXG4gICAqL1xuICB0cmFuc2Zvcm1EZWZhdWx0cz86ICh7XG4gICAgb3JpZ2luYWxEZWZhdWx0cyxcbiAgICBxdWVyeVJlZixcbiAgfToge1xuICAgIG9yaWdpbmFsRGVmYXVsdHM6IFF1ZXJ5QXR0cmlidXRlc1R5cGVcbiAgICBxdWVyeVJlZjogQmFja2JvbmUuTW9kZWw8YW55PlxuICB9KSA9PiBRdWVyeUF0dHJpYnV0ZXNUeXBlXG4gIC8qKlxuICAgKiAgUGFzcyBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUgY3FsIGdpdmVuIGEgZmlsdGVyIHRyZWUsIGFsbG93aW5nIHN1Y2ggdGhpbmdzIGFzIG1peGluZyBpbiBlcGhlbWVyYWwgZmlsdGVyc1xuICAgKi9cbiAgdHJhbnNmb3JtRmlsdGVyVHJlZT86ICh7XG4gICAgb3JpZ2luYWxGaWx0ZXJUcmVlLFxuICAgIHF1ZXJ5UmVmLFxuICB9OiB7XG4gICAgb3JpZ2luYWxGaWx0ZXJUcmVlOiBGaWx0ZXJCdWlsZGVyQ2xhc3NcbiAgICBxdWVyeVJlZjogQmFja2JvbmUuTW9kZWw8YW55PlxuICB9KSA9PiBzdHJpbmdcbiAgLyoqXG4gICAqIFBhc3MgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlIHNvcnRzIHRvIHVzZSwgYWxsb3dpbmcgc3VjaCB0aGluZ3MgYXMgc3Vic3RpdHV0aW5nIGVwaGVtZXJhbCBzb3J0c1xuICAgKi9cbiAgdHJhbnNmb3JtU29ydHM/OiBUcmFuc2Zvcm1Tb3J0c0Z1bmN0aW9uVHlwZVxuICB0cmFuc2Zvcm1Db3VudD86ICh7XG4gICAgb3JpZ2luYWxDb3VudCxcbiAgICBxdWVyeVJlZixcbiAgfToge1xuICAgIG9yaWdpbmFsQ291bnQ6IG51bWJlclxuICAgIHF1ZXJ5UmVmOiBCYWNrYm9uZS5Nb2RlbDxhbnk+XG4gIH0pID0+IG51bWJlclxuICBsaW1pdFRvRGVsZXRlZD86IGJvb2xlYW5cbiAgbGltaXRUb0hpc3RvcmljPzogYm9vbGVhblxuICBhZGRpdGlvbmFsT3B0aW9ucz86IGFueVxufVxuXG5leHBvcnQgY29uc3QgREVGQVVMVF9RVUVSWV9PUFRJT05TOiBSZWFkb25seTxSZXF1aXJlZDxRdWVyeU9wdGlvbnM+PiA9IHtcbiAgdHJhbnNmb3JtRGVmYXVsdHM6ICh7IG9yaWdpbmFsRGVmYXVsdHMgfSkgPT4ge1xuICAgIHJldHVybiBvcmlnaW5hbERlZmF1bHRzXG4gIH0sXG4gIHRyYW5zZm9ybUZpbHRlclRyZWU6ICh7IG9yaWdpbmFsRmlsdGVyVHJlZSB9KSA9PiB7XG4gICAgcmV0dXJuIGNxbC53cml0ZShvcmlnaW5hbEZpbHRlclRyZWUpXG4gIH0sXG4gIHRyYW5zZm9ybUNvdW50OiAoeyBvcmlnaW5hbENvdW50IH0pID0+IHtcbiAgICByZXR1cm4gb3JpZ2luYWxDb3VudFxuICB9LFxuICB0cmFuc2Zvcm1Tb3J0czogKHsgb3JpZ2luYWxTb3J0cyB9KSA9PiB7XG4gICAgcmV0dXJuIG9yaWdpbmFsU29ydHNcbiAgfSxcbiAgbGltaXRUb0hpc3RvcmljOiBmYWxzZSxcbiAgbGltaXRUb0RlbGV0ZWQ6IGZhbHNlLFxuICBhZGRpdGlvbmFsT3B0aW9uczogdW5kZWZpbmVkLFxufVxuXG5leHBvcnQgY29uc3QgUXVlcnkgPSAoXG4gIGF0dHJpYnV0ZXM/OiBRdWVyeUF0dHJpYnV0ZXNUeXBlLFxuICBvcHRpb25zPzogUXVlcnlPcHRpb25zXG4pID0+IHtcbiAgY29uc3QgbWVyZ2VkT3B0aW9uczogUmVxdWlyZWQ8UXVlcnlPcHRpb25zPiA9IHtcbiAgICAuLi5ERUZBVUxUX1FVRVJZX09QVElPTlMsXG4gICAgLi4ub3B0aW9ucyxcbiAgfVxuICByZXR1cm4gbmV3IFVudHlwZWRRdWVyeShhdHRyaWJ1dGVzLCBtZXJnZWRPcHRpb25zKVxufVxuXG5mdW5jdGlvbiBtaXhpbkVwaGVtZXJhbEZpbHRlcihcbiAgb3JpZ2luYWxDUUw6IEZpbHRlckJ1aWxkZXJDbGFzc1xuKTogRmlsdGVyQnVpbGRlckNsYXNzIHtcbiAgY29uc3QgZXBoZW1lcmFsRmlsdGVyID0gVHlwZWRVc2VySW5zdGFuY2UuZ2V0RXBoZW1lcmFsRmlsdGVyKClcbiAgdHJ5IHtcbiAgICBpZiAoZXBoZW1lcmFsRmlsdGVyKSB7XG4gICAgICByZXR1cm4gbmV3IEZpbHRlckJ1aWxkZXJDbGFzcyh7XG4gICAgICAgIGZpbHRlcnM6IFtlcGhlbWVyYWxGaWx0ZXIsIG9yaWdpbmFsQ1FMXSxcbiAgICAgICAgdHlwZTogJ0FORCcsXG4gICAgICB9KVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gb3JpZ2luYWxDUUxcbiAgICB9XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGNvbnNvbGUuZXJyb3IoZXJyKVxuICAgIHJldHVybiBvcmlnaW5hbENRTFxuICB9XG59XG5cbmV4cG9ydCBjb25zdCBERUZBVUxUX1VTRVJfUVVFUllfT1BUSU9OUzogUmVhZG9ubHk8UmVxdWlyZWQ8UXVlcnlPcHRpb25zPj4gPSB7XG4gIHRyYW5zZm9ybURlZmF1bHRzOiAoeyBvcmlnaW5hbERlZmF1bHRzIH0pID0+IHtcbiAgICByZXR1cm4ge1xuICAgICAgLi4ub3JpZ2luYWxEZWZhdWx0cyxcbiAgICAgIC4uLlR5cGVkVXNlckluc3RhbmNlLmdldFF1ZXJ5U2V0dGluZ3NKU09OKCksXG4gICAgICBjb3VudDogVHlwZWRVc2VySW5zdGFuY2UuZ2V0UmVzdWx0Q291bnQoKSxcbiAgICB9XG4gIH0sXG4gIHRyYW5zZm9ybUZpbHRlclRyZWU6ICh7IG9yaWdpbmFsRmlsdGVyVHJlZSB9KSA9PiB7XG4gICAgcmV0dXJuIGNxbC53cml0ZShtaXhpbkVwaGVtZXJhbEZpbHRlcihvcmlnaW5hbEZpbHRlclRyZWUpKVxuICB9LFxuICB0cmFuc2Zvcm1Tb3J0czogKHsgb3JpZ2luYWxTb3J0cyB9KSA9PiB7XG4gICAgcmV0dXJuIFR5cGVkVXNlckluc3RhbmNlLmdldEVwaGVtZXJhbFNvcnRzKCkgfHwgb3JpZ2luYWxTb3J0c1xuICB9LFxuICB0cmFuc2Zvcm1Db3VudDogKHsgb3JpZ2luYWxDb3VudCB9KSA9PiB7XG4gICAgcmV0dXJuIFR5cGVkVXNlckluc3RhbmNlLmdldFJlc3VsdENvdW50KCkgfHwgb3JpZ2luYWxDb3VudFxuICB9LFxuICBsaW1pdFRvRGVsZXRlZDogZmFsc2UsXG4gIGxpbWl0VG9IaXN0b3JpYzogZmFsc2UsXG4gIGFkZGl0aW9uYWxPcHRpb25zOiB1bmRlZmluZWQsXG59XG5cbi8qKlxuICogVGhpcyBzaG91bGQgYmUgdXNlZCBpbiBwbGFjZSBvZiB1c2VVc2VyUXVlcnkgX29ubHlfIGlmIHlvdSBkbyBub3QgaW50ZW5kIHRvIGxpc3RlbiB0byBjaGFuZ2VzIHRvIHVzZXIgcHJlZnMuXG4gKi9cbmV4cG9ydCBjb25zdCBVc2VyUXVlcnkgPSAoXG4gIGF0dHJpYnV0ZXM/OiBRdWVyeUF0dHJpYnV0ZXNUeXBlLFxuICBvcHRpb25zPzogUXVlcnlPcHRpb25zXG4pID0+IHtcbiAgY29uc3QgbWVyZ2VkT3B0aW9uczogUmVxdWlyZWQ8UXVlcnlPcHRpb25zPiA9IHtcbiAgICAuLi5ERUZBVUxUX1VTRVJfUVVFUllfT1BUSU9OUyxcbiAgICAuLi5vcHRpb25zLFxuICB9XG4gIHJldHVybiBRdWVyeShhdHRyaWJ1dGVzLCBtZXJnZWRPcHRpb25zKVxufVxuXG5leHBvcnQgY29uc3QgdXNlUXVlcnkgPSAoe1xuICBhdHRyaWJ1dGVzLFxuICBvcHRpb25zLFxufToge1xuICBhdHRyaWJ1dGVzPzogUXVlcnlBdHRyaWJ1dGVzVHlwZVxuICBvcHRpb25zPzogUXVlcnlPcHRpb25zXG59ID0ge30pOiBbUXVlcnlUeXBlLCBEaXNwYXRjaDxTZXRTdGF0ZUFjdGlvbjxRdWVyeVR5cGU+Pl0gPT4ge1xuICBjb25zdCBbcXVlcnksIHNldFF1ZXJ5XSA9IFJlYWN0LnVzZVN0YXRlKFF1ZXJ5KGF0dHJpYnV0ZXMsIG9wdGlvbnMpKVxuICByZXR1cm4gW3F1ZXJ5LCBzZXRRdWVyeV1cbn1cblxuZXhwb3J0IGNvbnN0IHVzZVVzZXJRdWVyeSA9ICh7XG4gIGF0dHJpYnV0ZXMsXG4gIG9wdGlvbnMsXG59OiB7XG4gIGF0dHJpYnV0ZXM/OiBRdWVyeUF0dHJpYnV0ZXNUeXBlXG4gIG9wdGlvbnM/OiBRdWVyeU9wdGlvbnNcbn0gPSB7fSk6IFtRdWVyeVR5cGUsIERpc3BhdGNoPFNldFN0YXRlQWN0aW9uPFF1ZXJ5VHlwZT4+XSA9PiB7XG4gIGNvbnN0IFtxdWVyeSwgc2V0UXVlcnldID0gUmVhY3QudXNlU3RhdGUoVXNlclF1ZXJ5KGF0dHJpYnV0ZXMsIG9wdGlvbnMpKVxuICB1c2VMaXN0ZW5UbyhUeXBlZFVzZXJJbnN0YW5jZS5nZXRQcmVmZXJlbmNlcygpLCAnY2hhbmdlOnJlc3VsdENvdW50JywgKCkgPT4ge1xuICAgIHF1ZXJ5LnNldCgnY291bnQnLCBUeXBlZFVzZXJJbnN0YW5jZS5nZXRSZXN1bHRDb3VudCgpKVxuICB9KVxuICB1c2VMaXN0ZW5UbyhUeXBlZFVzZXJJbnN0YW5jZS5nZXRQcmVmZXJlbmNlcygpLCAnY2hhbmdlOnJlc3VsdEZpbHRlcicsICgpID0+IHtcbiAgICBxdWVyeS5zdGFydFNlYXJjaEZyb21GaXJzdFBhZ2UoKVxuICB9KVxuICB1c2VMaXN0ZW5UbyhUeXBlZFVzZXJJbnN0YW5jZS5nZXRQcmVmZXJlbmNlcygpLCAnY2hhbmdlOnJlc3VsdFNvcnQnLCAoKSA9PiB7XG4gICAgcXVlcnkuc3RhcnRTZWFyY2hGcm9tRmlyc3RQYWdlKClcbiAgfSlcbiAgcmV0dXJuIFtxdWVyeSwgc2V0UXVlcnldXG59XG4iXX0=