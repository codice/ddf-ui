import { __assign, __read } from "tslib";
/**
 * Copyright (c) Codice Foundation
 *
 * This is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser
 * General Public License as published by the Free Software Foundation, either version 3 of the
 * License, or any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
 * even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details. A copy of the GNU Lesser General Public License
 * is distributed along with this program and can be found at
 * <http://www.gnu.org/licenses/lgpl.html>.
 *
 **/
import React from 'react';
import { FilterBuilderClass } from '../../component/filter-builder/filter.structure';
import { useListenTo } from '../../component/selection-checkbox/useBackbone.hook';
import { TypedUserInstance } from '../../component/singletons/TypedUser';
import cql from '../cql';
import UntypedQuery from './Query';
export var DEFAULT_QUERY_OPTIONS = {
    transformDefaults: function (_a) {
        var originalDefaults = _a.originalDefaults;
        return originalDefaults;
    },
    transformFilterTree: function (_a) {
        var originalFilterTree = _a.originalFilterTree;
        return cql.write(originalFilterTree);
    },
    transformCount: function (_a) {
        var originalCount = _a.originalCount;
        return originalCount;
    },
    transformSorts: function (_a) {
        var originalSorts = _a.originalSorts;
        return originalSorts;
    },
    limitToHistoric: false,
    limitToDeleted: false,
    additionalOptions: undefined,
};
export var Query = function (attributes, options) {
    var mergedOptions = __assign(__assign({}, DEFAULT_QUERY_OPTIONS), options);
    return new UntypedQuery(attributes, mergedOptions);
};
function mixinEphemeralFilter(originalCQL) {
    var ephemeralFilter = TypedUserInstance.getEphemeralFilter();
    try {
        if (ephemeralFilter) {
            return new FilterBuilderClass({
                filters: [ephemeralFilter, originalCQL],
                type: 'AND',
            });
        }
        else {
            return originalCQL;
        }
    }
    catch (err) {
        console.error(err);
        return originalCQL;
    }
}
export var DEFAULT_USER_QUERY_OPTIONS = {
    transformDefaults: function (_a) {
        var originalDefaults = _a.originalDefaults;
        return __assign(__assign(__assign({}, originalDefaults), TypedUserInstance.getQuerySettingsJSON()), { count: TypedUserInstance.getResultCount() });
    },
    transformFilterTree: function (_a) {
        var originalFilterTree = _a.originalFilterTree;
        return cql.write(mixinEphemeralFilter(originalFilterTree));
    },
    transformSorts: function (_a) {
        var originalSorts = _a.originalSorts;
        return TypedUserInstance.getEphemeralSorts() || originalSorts;
    },
    transformCount: function (_a) {
        var originalCount = _a.originalCount;
        return TypedUserInstance.getResultCount() || originalCount;
    },
    limitToDeleted: false,
    limitToHistoric: false,
    additionalOptions: undefined,
};
/**
 * This should be used in place of useUserQuery _only_ if you do not intend to listen to changes to user prefs.
 */
export var UserQuery = function (attributes, options) {
    var mergedOptions = __assign(__assign({}, DEFAULT_USER_QUERY_OPTIONS), options);
    return Query(attributes, mergedOptions);
};
export var useQuery = function (_a) {
    var _b = _a === void 0 ? {} : _a, attributes = _b.attributes, options = _b.options;
    var _c = __read(React.useState(Query(attributes, options)), 2), query = _c[0], setQuery = _c[1];
    return [query, setQuery];
};
export var useUserQuery = function (_a) {
    var _b = _a === void 0 ? {} : _a, attributes = _b.attributes, options = _b.options;
    var _c = __read(React.useState(UserQuery(attributes, options)), 2), query = _c[0], setQuery = _c[1];
    useListenTo(TypedUserInstance.getPreferences(), 'change:resultCount', function () {
        query.set('count', TypedUserInstance.getResultCount());
    });
    useListenTo(TypedUserInstance.getPreferences(), 'change:resultFilter', function () {
        query.startSearchFromFirstPage();
    });
    useListenTo(TypedUserInstance.getPreferences(), 'change:resultSort', function () {
        query.startSearchFromFirstPage();
    });
    return [query, setQuery];
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVHlwZWRRdWVyeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9tYWluL3dlYmFwcC9qcy9tb2RlbC9UeXBlZFF1ZXJ5LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7Ozs7SUFhSTtBQUNKLE9BQU8sS0FBbUMsTUFBTSxPQUFPLENBQUE7QUFDdkQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0saURBQWlELENBQUE7QUFDcEYsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHFEQUFxRCxDQUFBO0FBQ2pGLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHNDQUFzQyxDQUFBO0FBQ3hFLE9BQU8sR0FBRyxNQUFNLFFBQVEsQ0FBQTtBQUV4QixPQUFPLFlBQTJCLE1BQU0sU0FBUyxDQUFBO0FBd0RqRCxNQUFNLENBQUMsSUFBTSxxQkFBcUIsR0FBcUM7SUFDckUsaUJBQWlCLEVBQUUsVUFBQyxFQUFvQjtZQUFsQixnQkFBZ0Isc0JBQUE7UUFDcEMsT0FBTyxnQkFBZ0IsQ0FBQTtJQUN6QixDQUFDO0lBQ0QsbUJBQW1CLEVBQUUsVUFBQyxFQUFzQjtZQUFwQixrQkFBa0Isd0JBQUE7UUFDeEMsT0FBTyxHQUFHLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLENBQUE7SUFDdEMsQ0FBQztJQUNELGNBQWMsRUFBRSxVQUFDLEVBQWlCO1lBQWYsYUFBYSxtQkFBQTtRQUM5QixPQUFPLGFBQWEsQ0FBQTtJQUN0QixDQUFDO0lBQ0QsY0FBYyxFQUFFLFVBQUMsRUFBaUI7WUFBZixhQUFhLG1CQUFBO1FBQzlCLE9BQU8sYUFBYSxDQUFBO0lBQ3RCLENBQUM7SUFDRCxlQUFlLEVBQUUsS0FBSztJQUN0QixjQUFjLEVBQUUsS0FBSztJQUNyQixpQkFBaUIsRUFBRSxTQUFTO0NBQzdCLENBQUE7QUFFRCxNQUFNLENBQUMsSUFBTSxLQUFLLEdBQUcsVUFDbkIsVUFBZ0MsRUFDaEMsT0FBc0I7SUFF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QUFFLGlCQUFpQixDQUFDLGNBQWMsRUFBRSxDQUFDLENBQUE7SUFDeEQsQ0FBQyxDQUFDLENBQUE7SUFDRixXQUFXLENBQUMsaUJBQWlCLENBQUMsY0FBYyxFQUFFLEVBQUUscUJBQXFCLEVBQUU7UUFDckUsS0FBSyxDQUFDLHdCQUF3QixFQUFFLENBQUE7SUFDbEMsQ0FBQyxDQUFDLENBQUE7SUFDRixXQUFXLENBQUMsaUJBQWlCLENBQUMsY0FBYyxFQUFFLEVBQUUsbUJBQW1CLEVBQUU7UUFDbkUsS0FBSyxDQUFDLHdCQUF3QixFQUFFLENBQUE7SUFDbEMsQ0FBQyxDQUFDLENBQUE7SUFDRixPQUFPLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFBO0FBQzFCLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSBDb2RpY2UgRm91bmRhdGlvblxuICpcbiAqIFRoaXMgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeSBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBMZXNzZXJcbiAqIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5IHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlXG4gKiBMaWNlbnNlLCBvciBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0XG4gKiBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gU2VlIHRoZSBHTlVcbiAqIExlc3NlciBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuIEEgY29weSBvZiB0aGUgR05VIExlc3NlciBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlXG4gKiBpcyBkaXN0cmlidXRlZCBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbSBhbmQgY2FuIGJlIGZvdW5kIGF0XG4gKiA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzL2xncGwuaHRtbD4uXG4gKlxuICoqL1xuaW1wb3J0IFJlYWN0LCB7IERpc3BhdGNoLCBTZXRTdGF0ZUFjdGlvbiB9IGZyb20gJ3JlYWN0J1xuaW1wb3J0IHsgRmlsdGVyQnVpbGRlckNsYXNzIH0gZnJvbSAnLi4vLi4vY29tcG9uZW50L2ZpbHRlci1idWlsZGVyL2ZpbHRlci5zdHJ1Y3R1cmUnXG5pbXBvcnQgeyB1c2VMaXN0ZW5UbyB9IGZyb20gJy4uLy4uL2NvbXBvbmVudC9zZWxlY3Rpb24tY2hlY2tib3gvdXNlQmFja2JvbmUuaG9vaydcbmltcG9ydCB7IFR5cGVkVXNlckluc3RhbmNlIH0gZnJvbSAnLi4vLi4vY29tcG9uZW50L3NpbmdsZXRvbnMvVHlwZWRVc2VyJ1xuaW1wb3J0IGNxbCBmcm9tICcuLi9jcWwnXG5pbXBvcnQgeyBRdWVyeUF0dHJpYnV0ZXNUeXBlLCBTb3J0VHlwZSB9IGZyb20gJy4vUXVlcnkuc2hhcmVkLXR5cGVzJ1xuaW1wb3J0IFVudHlwZWRRdWVyeSwgeyBRdWVyeVR5cGUgfSBmcm9tICcuL1F1ZXJ5J1xuXG4vKipcbiAqIE1haW5seSB1c2VkIGJ5IGxhenkgcXVlcnkgcmVzdWx0cywgc2luY2UgaXQgZ2V0cyBwYXNzZWQgYSBmdW5jdGlvbiB0aGF0IGFkZHMgaW4gdGhlIHF1ZXJ5IHJlZiBmb3IgaXRcbiAqL1xuZXhwb3J0IHR5cGUgVHJhbnNmb3JtU29ydHNDb21wb3NlZEZ1bmN0aW9uVHlwZSA9ICh7XG4gIG9yaWdpbmFsU29ydHMsXG59OiB7XG4gIG9yaWdpbmFsU29ydHM6IFNvcnRUeXBlW11cbn0pID0+IFNvcnRUeXBlW11cblxuZXhwb3J0IHR5cGUgVHJhbnNmb3JtU29ydHNGdW5jdGlvblR5cGUgPSAoe1xuICBvcmlnaW5hbFNvcnRzLFxuICBxdWVyeVJlZixcbn06IHtcbiAgb3JpZ2luYWxTb3J0czogU29ydFR5cGVbXVxuICBxdWVyeVJlZjogQmFja2JvbmUuTW9kZWw8YW55PlxufSkgPT4gU29ydFR5cGVbXVxuXG5leHBvcnQgdHlwZSBRdWVyeU9wdGlvbnMgPSB7XG4gIC8qKlxuICAgKiBQYXNzIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHRoZSBkZWZhdWx0cyB0byB1c2VcbiAgICovXG4gIHRyYW5zZm9ybURlZmF1bHRzPzogKHtcbiAgICBvcmlnaW5hbERlZmF1bHRzLFxuICAgIHF1ZXJ5UmVmLFxuICB9OiB7XG4gICAgb3JpZ2luYWxEZWZhdWx0czogUXVlcnlBdHRyaWJ1dGVzVHlwZVxuICAgIHF1ZXJ5UmVmOiBCYWNrYm9uZS5Nb2RlbDxhbnk+XG4gIH0pID0+IFF1ZXJ5QXR0cmlidXRlc1R5cGVcbiAgLyoqXG4gICAqICBQYXNzIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHRoZSBjcWwgZ2l2ZW4gYSBmaWx0ZXIgdHJlZSwgYWxsb3dpbmcgc3VjaCB0aGluZ3MgYXMgbWl4aW5nIGluIGVwaGVtZXJhbCBmaWx0ZXJzXG4gICAqL1xuICB0cmFuc2Zvcm1GaWx0ZXJUcmVlPzogKHtcbiAgICBvcmlnaW5hbEZpbHRlclRyZWUsXG4gICAgcXVlcnlSZWYsXG4gIH06IHtcbiAgICBvcmlnaW5hbEZpbHRlclRyZWU6IEZpbHRlckJ1aWxkZXJDbGFzc1xuICAgIHF1ZXJ5UmVmOiBCYWNrYm9uZS5Nb2RlbDxhbnk+XG4gIH0pID0+IHN0cmluZ1xuICAvKipcbiAgICogUGFzcyBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUgc29ydHMgdG8gdXNlLCBhbGxvd2luZyBzdWNoIHRoaW5ncyBhcyBzdWJzdGl0dXRpbmcgZXBoZW1lcmFsIHNvcnRzXG4gICAqL1xuICB0cmFuc2Zvcm1Tb3J0cz86IFRyYW5zZm9ybVNvcnRzRnVuY3Rpb25UeXBlXG4gIHRyYW5zZm9ybUNvdW50PzogKHtcbiAgICBvcmlnaW5hbENvdW50LFxuICAgIHF1ZXJ5UmVmLFxuICB9OiB7XG4gICAgb3JpZ2luYWxDb3VudDogbnVtYmVyXG4gICAgcXVlcnlSZWY6IEJhY2tib25lLk1vZGVsPGFueT5cbiAgfSkgPT4gbnVtYmVyXG4gIGxpbWl0VG9EZWxldGVkPzogYm9vbGVhblxuICBsaW1pdFRvSGlzdG9yaWM/OiBib29sZWFuXG4gIGFkZGl0aW9uYWxPcHRpb25zPzogYW55XG59XG5cbmV4cG9ydCBjb25zdCBERUZBVUxUX1FVRVJZX09QVElPTlM6IFJlYWRvbmx5PFJlcXVpcmVkPFF1ZXJ5T3B0aW9ucz4+ID0ge1xuICB0cmFuc2Zvcm1EZWZhdWx0czogKHsgb3JpZ2luYWxEZWZhdWx0cyB9KSA9PiB7XG4gICAgcmV0dXJuIG9yaWdpbmFsRGVmYXVsdHNcbiAgfSxcbiAgdHJhbnNmb3JtRmlsdGVyVHJlZTogKHsgb3JpZ2luYWxGaWx0ZXJUcmVlIH0pID0+IHtcbiAgICByZXR1cm4gY3FsLndyaXRlKG9yaWdpbmFsRmlsdGVyVHJlZSlcbiAgfSxcbiAgdHJhbnNmb3JtQ291bnQ6ICh7IG9yaWdpbmFsQ291bnQgfSkgPT4ge1xuICAgIHJldHVybiBvcmlnaW5hbENvdW50XG4gIH0sXG4gIHRyYW5zZm9ybVNvcnRzOiAoeyBvcmlnaW5hbFNvcnRzIH0pID0+IHtcbiAgICByZXR1cm4gb3JpZ2luYWxTb3J0c1xuICB9LFxuICBsaW1pdFRvSGlzdG9yaWM6IGZhbHNlLFxuICBsaW1pdFRvRGVsZXRlZDogZmFsc2UsXG4gIGFkZGl0aW9uYWxPcHRpb25zOiB1bmRlZmluZWQsXG59XG5cbmV4cG9ydCBjb25zdCBRdWVyeSA9IChcbiAgYXR0cmlidXRlcz86IFF1ZXJ5QXR0cmlidXRlc1R5cGUsXG4gIG9wdGlvbnM/OiBRdWVyeU9wdGlvbnNcbikgPT4ge1xuICBjb25zdCBtZXJnZWRPcHRpb25zOiBSZXF1aXJlZDxRdWVyeU9wdGlvbnM+ID0ge1xuICAgIC4uLkRFRkFVTFRfUVVFUllfT1BUSU9OUyxcbiAgICAuLi5vcHRpb25zLFxuICB9XG4gIHJldHVybiBuZXcgVW50eXBlZFF1ZXJ5KGF0dHJpYnV0ZXMsIG1lcmdlZE9wdGlvbnMpXG59XG5cbmZ1bmN0aW9uIG1peGluRXBoZW1lcmFsRmlsdGVyKFxuICBvcmlnaW5hbENRTDogRmlsdGVyQnVpbGRlckNsYXNzXG4pOiBGaWx0ZXJCdWlsZGVyQ2xhc3Mge1xuICBjb25zdCBlcGhlbWVyYWxGaWx0ZXIgPSBUeXBlZFVzZXJJbnN0YW5jZS5nZXRFcGhlbWVyYWxGaWx0ZXIoKVxuICB0cnkge1xuICAgIGlmIChlcGhlbWVyYWxGaWx0ZXIpIHtcbiAgICAgIHJldHVybiBuZXcgRmlsdGVyQnVpbGRlckNsYXNzKHtcbiAgICAgICAgZmlsdGVyczogW2VwaGVtZXJhbEZpbHRlciwgb3JpZ2luYWxDUUxdLFxuICAgICAgICB0eXBlOiAnQU5EJyxcbiAgICAgIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBvcmlnaW5hbENRTFxuICAgIH1cbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgY29uc29sZS5lcnJvcihlcnIpXG4gICAgcmV0dXJuIG9yaWdpbmFsQ1FMXG4gIH1cbn1cblxuZXhwb3J0IGNvbnN0IERFRkFVTFRfVVNFUl9RVUVSWV9PUFRJT05TOiBSZWFkb25seTxSZXF1aXJlZDxRdWVyeU9wdGlvbnM+PiA9IHtcbiAgdHJhbnNmb3JtRGVmYXVsdHM6ICh7IG9yaWdpbmFsRGVmYXVsdHMgfSkgPT4ge1xuICAgIHJldHVybiB7XG4gICAgICAuLi5vcmlnaW5hbERlZmF1bHRzLFxuICAgICAgLi4uVHlwZWRVc2VySW5zdGFuY2UuZ2V0UXVlcnlTZXR0aW5nc0pTT04oKSxcbiAgICAgIGNvdW50OiBUeXBlZFVzZXJJbnN0YW5jZS5nZXRSZXN1bHRDb3VudCgpLFxuICAgIH1cbiAgfSxcbiAgdHJhbnNmb3JtRmlsdGVyVHJlZTogKHsgb3JpZ2luYWxGaWx0ZXJUcmVlIH0pID0+IHtcbiAgICByZXR1cm4gY3FsLndyaXRlKG1peGluRXBoZW1lcmFsRmlsdGVyKG9yaWdpbmFsRmlsdGVyVHJlZSkpXG4gIH0sXG4gIHRyYW5zZm9ybVNvcnRzOiAoeyBvcmlnaW5hbFNvcnRzIH0pID0+IHtcbiAgICByZXR1cm4gVHlwZWRVc2VySW5zdGFuY2UuZ2V0RXBoZW1lcmFsU29ydHMoKSB8fCBvcmlnaW5hbFNvcnRzXG4gIH0sXG4gIHRyYW5zZm9ybUNvdW50OiAoeyBvcmlnaW5hbENvdW50IH0pID0+IHtcbiAgICByZXR1cm4gVHlwZWRVc2VySW5zdGFuY2UuZ2V0UmVzdWx0Q291bnQoKSB8fCBvcmlnaW5hbENvdW50XG4gIH0sXG4gIGxpbWl0VG9EZWxldGVkOiBmYWxzZSxcbiAgbGltaXRUb0hpc3RvcmljOiBmYWxzZSxcbiAgYWRkaXRpb25hbE9wdGlvbnM6IHVuZGVmaW5lZCxcbn1cblxuLyoqXG4gKiBUaGlzIHNob3VsZCBiZSB1c2VkIGluIHBsYWNlIG9mIHVzZVVzZXJRdWVyeSBfb25seV8gaWYgeW91IGRvIG5vdCBpbnRlbmQgdG8gbGlzdGVuIHRvIGNoYW5nZXMgdG8gdXNlciBwcmVmcy5cbiAqL1xuZXhwb3J0IGNvbnN0IFVzZXJRdWVyeSA9IChcbiAgYXR0cmlidXRlcz86IFF1ZXJ5QXR0cmlidXRlc1R5cGUsXG4gIG9wdGlvbnM/OiBRdWVyeU9wdGlvbnNcbikgPT4ge1xuICBjb25zdCBtZXJnZWRPcHRpb25zOiBSZXF1aXJlZDxRdWVyeU9wdGlvbnM+ID0ge1xuICAgIC4uLkRFRkFVTFRfVVNFUl9RVUVSWV9PUFRJT05TLFxuICAgIC4uLm9wdGlvbnMsXG4gIH1cbiAgcmV0dXJuIFF1ZXJ5KGF0dHJpYnV0ZXMsIG1lcmdlZE9wdGlvbnMpXG59XG5cbmV4cG9ydCBjb25zdCB1c2VRdWVyeSA9ICh7XG4gIGF0dHJpYnV0ZXMsXG4gIG9wdGlvbnMsXG59OiB7XG4gIGF0dHJpYnV0ZXM/OiBRdWVyeUF0dHJpYnV0ZXNUeXBlXG4gIG9wdGlvbnM/OiBRdWVyeU9wdGlvbnNcbn0gPSB7fSk6IFtRdWVyeVR5cGUsIERpc3BhdGNoPFNldFN0YXRlQWN0aW9uPFF1ZXJ5VHlwZT4+XSA9PiB7XG4gIGNvbnN0IFtxdWVyeSwgc2V0UXVlcnldID0gUmVhY3QudXNlU3RhdGUoUXVlcnkoYXR0cmlidXRlcywgb3B0aW9ucykpXG4gIHJldHVybiBbcXVlcnksIHNldFF1ZXJ5XVxufVxuXG5leHBvcnQgY29uc3QgdXNlVXNlclF1ZXJ5ID0gKHtcbiAgYXR0cmlidXRlcyxcbiAgb3B0aW9ucyxcbn06IHtcbiAgYXR0cmlidXRlcz86IFF1ZXJ5QXR0cmlidXRlc1R5cGVcbiAgb3B0aW9ucz86IFF1ZXJ5T3B0aW9uc1xufSA9IHt9KTogW1F1ZXJ5VHlwZSwgRGlzcGF0Y2g8U2V0U3RhdGVBY3Rpb248UXVlcnlUeXBlPj5dID0+IHtcbiAgY29uc3QgW3F1ZXJ5LCBzZXRRdWVyeV0gPSBSZWFjdC51c2VTdGF0ZShVc2VyUXVlcnkoYXR0cmlidXRlcywgb3B0aW9ucykpXG4gIHVzZUxpc3RlblRvKFR5cGVkVXNlckluc3RhbmNlLmdldFByZWZlcmVuY2VzKCksICdjaGFuZ2U6cmVzdWx0Q291bnQnLCAoKSA9PiB7XG4gICAgcXVlcnkuc2V0KCdjb3VudCcsIFR5cGVkVXNlckluc3RhbmNlLmdldFJlc3VsdENvdW50KCkpXG4gIH0pXG4gIHVzZUxpc3RlblRvKFR5cGVkVXNlckluc3RhbmNlLmdldFByZWZlcmVuY2VzKCksICdjaGFuZ2U6cmVzdWx0RmlsdGVyJywgKCkgPT4ge1xuICAgIHF1ZXJ5LnN0YXJ0U2VhcmNoRnJvbUZpcnN0UGFnZSgpXG4gIH0pXG4gIHVzZUxpc3RlblRvKFR5cGVkVXNlckluc3RhbmNlLmdldFByZWZlcmVuY2VzKCksICdjaGFuZ2U6cmVzdWx0U29ydCcsICgpID0+IHtcbiAgICBxdWVyeS5zdGFydFNlYXJjaEZyb21GaXJzdFBhZ2UoKVxuICB9KVxuICByZXR1cm4gW3F1ZXJ5LCBzZXRRdWVyeV1cbn1cbiJdfQ==