import { __read } from "tslib";
import { jsx as _jsx } from "react/jsx-runtime";
import * as React from 'react';
import { useParams } from 'react-router-dom';
import { useLazyResultsFromSelectionInterface } from '../selection-interface/hooks';
import { GoldenLayout } from '../golden-layout/golden-layout';
import { DEFAULT_QUERY_OPTIONS, useUserQuery } from '../../js/model/TypedQuery';
import { FilterBuilderClass, FilterClass, } from '../filter-builder/filter.structure';
import { getFilterTreeForId } from './metacard-nav';
import SelectionInterfaceModel from '../selection-interface/selection-interface.model';
import user from '../singletons/user-instance';
import _ from 'underscore';
export var getFilterTreeForUpload = function (_a) {
    var upload = _a.upload;
    return new FilterBuilderClass({
        type: 'OR',
        filters: _.flatten(upload
            .get('uploads')
            .filter(function (file) { return file.id || file.get('children') !== undefined; })
            .map(function (file) {
            if (file.get('children') !== undefined) {
                return file.get('children').map(function (child) {
                    return new FilterClass({
                        type: '=',
                        value: child,
                        property: 'id',
                    });
                });
            }
            else {
                return new FilterClass({
                    type: '=',
                    value: file.id,
                    property: 'id',
                });
            }
        })
            .concat(new FilterClass({
            type: '=',
            value: '-1',
            property: 'id',
        }))),
    });
};
var MetacardRoute = function () {
    var params = useParams();
    var _a = __read(React.useState(params.metacardId || params.id), 2), id = _a[0], setId = _a[1];
    React.useEffect(function () {
        setId(params.metacardId || params.id);
    }, [params.metacardId]);
    var _b = __read(useUserQuery({
        attributes: getFilterTreeForId({ id: id || '' }),
        options: {
            transformDefaults: DEFAULT_QUERY_OPTIONS.transformDefaults,
        },
    }), 1), query = _b[0];
    var _c = __read(React.useState(new SelectionInterfaceModel({
        currentQuery: query,
    })), 1), selectionInterface = _c[0];
    React.useEffect(function () {
        if (id === undefined && params.uploadId) {
            var upload = user
                .get('user')
                .get('preferences')
                .get('uploads')
                .get(params.uploadId);
            if (upload) {
                query.set('filterTree', getFilterTreeForUpload({ upload: upload }));
                query.cancelCurrentSearches();
                query.startSearchFromFirstPage();
            }
        }
    }, [id, params.uploadId]);
    React.useEffect(
    // @ts-expect-error ts-migrate(7030) FIXME: Not all code paths return a value.
    function () {
        if (id) {
            query.set('filterTree', getFilterTreeForId({ id: id }));
            query.cancelCurrentSearches();
            query.startSearchFromFirstPage();
            return function () {
                query.cancelCurrentSearches();
            };
        }
    }, [id]);
    var lazyResults = useLazyResultsFromSelectionInterface({
        selectionInterface: selectionInterface,
    });
    var filteredResults = Object.values(lazyResults.results);
    filteredResults.forEach(function (result) {
        result.setSelected(true);
    });
    return _jsx(GoldenLayout, { selectionInterface: selectionInterface });
};
export default MetacardRoute;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWV0YWNhcmQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvbWFpbi93ZWJhcHAvY29tcG9uZW50L3BhZ2VzL21ldGFjYXJkLnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLE9BQU8sS0FBSyxLQUFLLE1BQU0sT0FBTyxDQUFBO0FBRTlCLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQTtBQUM1QyxPQUFPLEVBQUUsb0NBQW9DLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQTtBQUNuRixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sZ0NBQWdDLENBQUE7QUFDN0QsT0FBTyxFQUFFLHFCQUFxQixFQUFFLFlBQVksRUFBRSxNQUFNLDJCQUEyQixDQUFBO0FBQy9FLE9BQU8sRUFDTCxrQkFBa0IsRUFDbEIsV0FBVyxHQUNaLE1BQU0sb0NBQW9DLENBQUE7QUFDM0MsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sZ0JBQWdCLENBQUE7QUFDbkQsT0FBTyx1QkFBdUIsTUFBTSxrREFBa0QsQ0FBQTtBQUN0RixPQUFPLElBQUksTUFBTSw2QkFBNkIsQ0FBQTtBQUM5QyxPQUFPLENBQUMsTUFBTSxZQUFZLENBQUE7QUFNMUIsTUFBTSxDQUFDLElBQU0sc0JBQXNCLEdBQUcsVUFBQyxFQUl0QztRQUhDLE1BQU0sWUFBQTtJQUlOLE9BQU8sSUFBSSxrQkFBa0IsQ0FBQztRQUM1QixJQUFJLEVBQUUsSUFBSTtRQUNWLE9BQU8sRUFBRSxDQUFDLENBQUMsT0FBTyxDQUNoQixNQUFNO2FBQ0gsR0FBRyxDQUFDLFNBQVMsQ0FBQzthQUNkLE1BQU0sQ0FBQyxVQUFDLElBQUksSUFBSyxPQUFBLElBQUksQ0FBQyxFQUFFLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsS0FBSyxTQUFTLEVBQTdDLENBQTZDLENBQUM7YUFDL0QsR0FBRyxDQUFDLFVBQUMsSUFBSTtZQUNSLElBQUksSUFBSSxD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Q25ELEtBQUssQ0FBQyxxQkFBcUIsRUFBRSxDQUFBO1lBQzdCLEtBQUssQ0FBQyx3QkFBd0IsRUFBRSxDQUFBO1lBQ2hDLE9BQU87Z0JBQ0wsS0FBSyxDQUFDLHFCQUFxQixFQUFFLENBQUE7WUFDL0IsQ0FBQyxDQUFBO1FBQ0gsQ0FBQztJQUNILENBQUMsRUFDRCxDQUFDLEVBQUUsQ0FBQyxDQUNMLENBQUE7SUFDRCxJQUFNLFdBQVcsR0FBRyxvQ0FBb0MsQ0FBQztRQUN2RCxrQkFBa0Isb0JBQUE7S0FDbkIsQ0FBQyxDQUFBO0lBQ0YsSUFBTSxlQUFlLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUE7SUFFMUQsZUFBZSxDQUFDLE9BQU8sQ0FBQyxVQUFDLE1BQU07UUFDN0IsTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUMxQixDQUFDLENBQUMsQ0FBQTtJQUVGLE9BQU8sS0FBQyxZQUFZLElBQUMsa0JBQWtCLEVBQUUsa0JBQWtCLEdBQUksQ0FBQTtBQUNqRSxDQUFDLENBQUE7QUFFRCxlQUFlLGFBQWEsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0J1xuXG5pbXBvcnQgeyB1c2VQYXJhbXMgfSBmcm9tICdyZWFjdC1yb3V0ZXItZG9tJ1xuaW1wb3J0IHsgdXNlTGF6eVJlc3VsdHNGcm9tU2VsZWN0aW9uSW50ZXJmYWNlIH0gZnJvbSAnLi4vc2VsZWN0aW9uLWludGVyZmFjZS9ob29rcydcbmltcG9ydCB7IEdvbGRlbkxheW91dCB9IGZyb20gJy4uL2dvbGRlbi1sYXlvdXQvZ29sZGVuLWxheW91dCdcbmltcG9ydCB7IERFRkFVTFRfUVVFUllfT1BUSU9OUywgdXNlVXNlclF1ZXJ5IH0gZnJvbSAnLi4vLi4vanMvbW9kZWwvVHlwZWRRdWVyeSdcbmltcG9ydCB7XG4gIEZpbHRlckJ1aWxkZXJDbGFzcyxcbiAgRmlsdGVyQ2xhc3MsXG59IGZyb20gJy4uL2ZpbHRlci1idWlsZGVyL2ZpbHRlci5zdHJ1Y3R1cmUnXG5pbXBvcnQgeyBnZXRGaWx0ZXJUcmVlRm9ySWQgfSBmcm9tICcuL21ldGFjYXJkLW5hdidcbmltcG9ydCBTZWxlY3Rpb25JbnRlcmZhY2VNb2RlbCBmcm9tICcuLi9zZWxlY3Rpb24taW50ZXJmYWNlL3NlbGVjdGlvbi1pbnRlcmZhY2UubW9kZWwnXG5pbXBvcnQgdXNlciBmcm9tICcuLi9zaW5nbGV0b25zL3VzZXItaW5zdGFuY2UnXG5pbXBvcnQgXyBmcm9tICd1bmRlcnNjb3JlJ1xuXG50eXBlIFVwbG9hZFR5cGUgPSBCYWNrYm9uZS5Nb2RlbDx7XG4gIHVwbG9hZHM6IEJhY2tib25lLk1vZGVsPHsgaWQ6IHN0cmluZzsgY2hpbGRyZW46IHN0cmluZ1tdIH0+W11cbn0+XG5cbmV4cG9ydCBjb25zdCBnZXRGaWx0ZXJUcmVlRm9yVXBsb2FkID0gKHtcbiAgdXBsb2FkLFxufToge1xuICB1cGxvYWQ6IFVwbG9hZFR5cGVcbn0pOiBGaWx0ZXJCdWlsZGVyQ2xhc3MgPT4ge1xuICByZXR1cm4gbmV3IEZpbHRlckJ1aWxkZXJDbGFzcyh7XG4gICAgdHlwZTogJ09SJyxcbiAgICBmaWx0ZXJzOiBfLmZsYXR0ZW4oXG4gICAgICB1cGxvYWRcbiAgICAgICAgLmdldCgndXBsb2FkcycpXG4gICAgICAgIC5maWx0ZXIoKGZpbGUpID0+IGZpbGUuaWQgfHwgZmlsZS5nZXQoJ2NoaWxkcmVuJykgIT09IHVuZGVmaW5lZClcbiAgICAgICAgLm1hcCgoZmlsZSkgPT4ge1xuICAgICAgICAgIGlmIChmaWxlLmdldCgnY2hpbGRyZW4nKSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICByZXR1cm4gZmlsZS5nZXQoJ2NoaWxkcmVuJykubWFwKFxuICAgICAgICAgICAgICAoY2hpbGQpID0+XG4gICAgICAgICAgICAgICAgbmV3IEZpbHRlckNsYXNzKHtcbiAgICAgICAgICAgICAgICAgIHR5cGU6ICc9JyxcbiAgICAgICAgICAgICAgICAgIHZhbHVlOiBjaGlsZCxcbiAgICAgICAgICAgICAgICAgIHByb3BlcnR5OiAnaWQnLFxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgRmlsdGVyQ2xhc3Moe1xuICAgICAgICAgICAgICB0eXBlOiAnPScsXG4gICAgICAgICAgICAgIHZhbHVlOiBmaWxlLmlkLFxuICAgICAgICAgICAgICBwcm9wZXJ0eTogJ2lkJyxcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgICAuY29uY2F0KFxuICAgICAgICAgIG5ldyBGaWx0ZXJDbGFzcyh7XG4gICAgICAgICAgICB0eXBlOiAnPScsXG4gICAgICAgICAgICB2YWx1ZTogJy0xJyxcbiAgICAgICAgICAgIHByb3BlcnR5OiAnaWQnLFxuICAgICAgICAgIH0pXG4gICAgICAgIClcbiAgICApLFxuICB9KVxufVxuXG5jb25zdCBNZXRhY2FyZFJvdXRlID0gKCkgPT4ge1xuICBjb25zdCBwYXJhbXMgPSB1c2VQYXJhbXM8e1xuICAgIGlkOiBzdHJpbmdcbiAgICBtZXRhY2FyZElkOiBzdHJpbmdcbiAgICB1cGxvYWRJZDogc3RyaW5nXG4gIH0+KClcblxuICBjb25zdCBbaWQsIHNldElkXSA9IFJlYWN0LnVzZVN0YXRlKHBhcmFtcy5tZXRhY2FyZElkIHx8IHBhcmFtcy5pZClcbiAgUmVhY3QudXNlRWZmZWN0KCgpID0+IHtcbiAgICBzZXRJZChwYXJhbXMubWV0YWNhcmRJZCB8fCBwYXJhbXMuaWQpXG4gIH0sIFtwYXJhbXMubWV0YWNhcmRJZF0pXG4gIGNvbnN0IFtxdWVyeV0gPSB1c2VVc2VyUXVlcnkoe1xuICAgIGF0dHJpYnV0ZXM6IGdldEZpbHRlclRyZWVGb3JJZCh7IGlkOiBpZCB8fCAnJyB9KSxcbiAgICBvcHRpb25zOiB7XG4gICAgICB0cmFuc2Zvcm1EZWZhdWx0czogREVGQVVMVF9RVUVSWV9PUFRJT05TLnRyYW5zZm9ybURlZmF1bHRzLFxuICAgIH0sXG4gIH0pXG4gIGNvbnN0IFtzZWxlY3Rpb25JbnRlcmZhY2VdID0gUmVhY3QudXNlU3RhdGUoXG4gICAgbmV3IFNlbGVjdGlvbkludGVyZmFjZU1vZGVsKHtcbiAgICAgIGN1cnJlbnRRdWVyeTogcXVlcnksXG4gICAgfSlcbiAgKVxuXG4gIFJlYWN0LnVzZUVmZmVjdCgoKSA9PiB7XG4gICAgaWYgKGlkID09PSB1bmRlZmluZWQgJiYgcGFyYW1zLnVwbG9hZElkKSB7XG4gICAgICBjb25zdCB1cGxvYWQgPSB1c2VyXG4gICAgICAgIC5nZXQoJ3VzZXInKVxuICAgICAgICAuZ2V0KCdwcmVmZXJlbmNlcycpXG4gICAgICAgIC5nZXQoJ3VwbG9hZHMnKVxuICAgICAgICAuZ2V0KHBhcmFtcy51cGxvYWRJZClcbiAgICAgIGlmICh1cGxvYWQpIHtcbiAgICAgICAgcXVlcnkuc2V0KCdmaWx0ZXJUcmVlJywgZ2V0RmlsdGVyVHJlZUZvclVwbG9hZCh7IHVwbG9hZCB9KSlcbiAgICAgICAgcXVlcnkuY2FuY2VsQ3VycmVudFNlYXJjaGVzKClcbiAgICAgICAgcXVlcnkuc3RhcnRTZWFyY2hGcm9tRmlyc3RQYWdlKClcbiAgICAgIH1cbiAgICB9XG4gIH0sIFtpZCwgcGFyYW1zLnVwbG9hZElkXSlcblxuICBSZWFjdC51c2VFZmZlY3QoXG4gICAgLy8gQHRzLWV4cGVjdC1lcnJvciB0cy1taWdyYXRlKDcwMzApIEZJWE1FOiBOb3QgYWxsIGNvZGUgcGF0aHMgcmV0dXJuIGEgdmFsdWUuXG4gICAgKCkgPT4ge1xuICAgICAgaWYgKGlkKSB7XG4gICAgICAgIHF1ZXJ5LnNldCgnZmlsdGVyVHJlZScsIGdldEZpbHRlclRyZWVGb3JJZCh7IGlkIH0pKVxuICAgICAgICBxdWVyeS5jYW5jZWxDdXJyZW50U2VhcmNoZXMoKVxuICAgICAgICBxdWVyeS5zdGFydFNlYXJjaEZyb21GaXJzdFBhZ2UoKVxuICAgICAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgICAgIHF1ZXJ5LmNhbmNlbEN1cnJlbnRTZWFyY2hlcygpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9LFxuICAgIFtpZF1cbiAgKVxuICBjb25zdCBsYXp5UmVzdWx0cyA9IHVzZUxhenlSZXN1bHRzRnJvbVNlbGVjdGlvbkludGVyZmFjZSh7XG4gICAgc2VsZWN0aW9uSW50ZXJmYWNlLFxuICB9KVxuICBjb25zdCBmaWx0ZXJlZFJlc3VsdHMgPSBPYmplY3QudmFsdWVzKGxhenlSZXN1bHRzLnJlc3VsdHMpXG5cbiAgZmlsdGVyZWRSZXN1bHRzLmZvckVhY2goKHJlc3VsdCkgPT4ge1xuICAgIHJlc3VsdC5zZXRTZWxlY3RlZCh0cnVlKVxuICB9KVxuXG4gIHJldHVybiA8R29sZGVuTGF5b3V0IHNlbGVjdGlvbkludGVyZmFjZT17c2VsZWN0aW9uSW50ZXJmYWNlfSAvPlxufVxuXG5leHBvcnQgZGVmYXVsdCBNZXRhY2FyZFJvdXRlXG4iXX0=