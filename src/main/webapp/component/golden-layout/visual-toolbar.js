import { __assign, __read } from "tslib";
import { jsx as _jsx, Fragment as _Fragment, jsxs as _jsxs } from "react/jsx-runtime";
import React from 'react';
import MinimizeIcon from '@mui/icons-material/Minimize';
import CloseIcon from '@mui/icons-material/Close';
import PopoutIcon from '@mui/icons-material/OpenInNew';
import Button from '@mui/material/Button';
import Paper from '@mui/material/Paper';
import { Elevations } from '../theme/theme';
import ExtensionPoints from '../../extension-points/extension-points';
import { CloseOnClickTooltip, MinimizedHeight, adjustStackInMinimizedPlaceIfNecessary, getBottomItem, getRootColumnContent, layoutAlreadyHasMinimizedStack, rootIsEmpty, rootIsNotAColumn, useIsMaximized, useRoot, useStackSize, } from './stack-toolbar';
import { Grid } from '@mui/material';
import _ from 'underscore';
function useStackRelatedToTab(tab) {
    var _a = __read(React.useState(tab.contentItem.parent), 2), stack = _a[0], setStack = _a[1];
    React.useEffect(function () {
        setStack(tab.contentItem.parent);
    }, [tab]);
    return stack;
}
// add the tab to the existing minimized stack
function addTabToExistingMinimizedStack(_a) {
    var tab = _a.tab, stack = _a.stack;
    var bottomItem = getBottomItem(stack);
    if (bottomItem) {
        stack.removeChild(tab.contentItem, true); // for some reason removeChild is overly restrictive on type of "thing" so we have to cast
        bottomItem.addChild(tab.contentItem, undefined);
    }
}
// we have to move each item individually because golden layout doesn't support moving an entire stack, and addChild does not work as documentation says (it doesn't remove the existing automatically)
function createNewStackFromExistingTab(_a) {
    var tab = _a.tab, stack = _a.stack;
    var existingItem = tab.contentItem;
    var newStackItem = stack.layoutManager._$normalizeContentItem({
        type: 'stack',
    });
    stack.removeChild(existingItem, true); // for some reason removeChild is overly restrictive on type of "thing" so we have to cast
    newStackItem.addChild(existingItem, undefined);
    return newStackItem;
}
function createAndAddNewMinimizedStackForTab(_a) {
    var _b;
    var tab = _a.tab, stack = _a.stack, goldenLayoutRoot = _a.goldenLayoutRoot;
    var newStackItem = createNewStackFromExistingTab({ stack: stack, tab: tab });
    if (rootIsNotAColumn(goldenLayoutRoot)) {
        var existingRootContent = getRootColumnContent(goldenLayoutRoot);
        goldenLayoutRoot.removeChild(existingRootContent, true); // for some reason removeChild is overly restrictive on type of "thing" so we have to cast
        // we need a column for minimize to work, so make a new column and add the existing root to it
        var newColumnItem = stack.layoutManager._$normalizeContentItem({
            type: 'column',
        });
        newColumnItem.addChild(existingRootContent);
        newColumnItem.addChild(newStackItem);
        goldenLayoutRoot.addChild(newColumnItem);
    }
    else if (rootIsEmpty(goldenLayoutRoot)) {
        var newColumnItem = stack.layoutManager._$normalizeContentItem({
            type: 'column',
        });
        newColumnItem.addChild(newStackItem);
        goldenLayoutRoot.addChild(newColumnItem);
    }
    else {
        (_b = getRootColumnContent(goldenLayoutRoot)) === null || _b === void 0 ? void 0 : _b.addChild(newStackItem);
    }
}
// keep track of pixel height on each stack, which allows us to detect when a stack is "minimized" later on
function usePixelHeightTrackingForTab(tab, stack, height) {
    React.useEffect(function () {
        if (stack) {
            ;
            stack.pixelHeight = height;
        }
    }, [height, stack]);
    var goldenLayoutRoot = useRoot(stack);
    var minimizeCallback = React.useCallback(function () {
        if (!goldenLayoutRoot) {
            return;
        }
        if (layoutAlreadyHasMinimizedStack({ stack: stack })) {
            // minimized area exists, add this to it
            addTabToExistingMinimizedStack({ tab: tab, stack: stack });
        }
        else {
            // rearrange layout if necessary and move the stack
            createAndAddNewMinimizedStackForTab({ tab: tab, stack: stack, goldenLayoutRoot: goldenLayoutRoot });
        }
        adjustStackInMinimizedPlaceIfNecessary({ goldenLayoutRoot: goldenLayoutRoot });
    }, [stack, goldenLayoutRoot]);
    return { minimizeCallback: minimizeCallback };
}
function useCanBeMinimizedTab(_a) {
    var stack = _a.stack, height = _a.height, width = _a.width;
    var _b = __read(React.useState(stack.contentItems.length), 2), itemCount = _b[0], setItemCount = _b[1];
    var _c = __read(React.useState(true), 2), canBeMinimized = _c[0], setCanBeMinimized = _c[1];
    React.useEffect(function () {
        var rootContent = getRootColumnContent(stack);
        if ((rootContent === null || rootContent === void 0 ? void 0 : rootContent.isStack) && (rootContent === null || rootContent === void 0 ? void 0 : rootContent.contentItems.length) === 1) {
            setCanBeMinimized(false);
        }
        else {
            setCanBeMinimized(true);
        }
    }, [stack, height, width, itemCount]);
    React.useEffect(function () {
        if (stack) {
            var callback_1 = function () {
                setItemCount(stack.contentItems.length);
            };
            stack.on('itemCreated', callback_1);
            stack.on('itemDestroyed', callback_1);
            return function () {
                stack.off('itemCreated', callback_1);
                stack.off('itemDestroyed', callback_1);
            };
        }
        return function () { };
    }, [stack]);
    return canBeMinimized;
}
export var GoldenLayoutComponentHeader = function (_a) {
    var viz = _a.viz, tab = _a.tab, options = _a.options, componentState = _a.componentState, container = _a.container, name = _a.name;
    var relatedStack = useStackRelatedToTab(tab);
    var _b = useStackSize(relatedStack), height = _b.height, width = _b.width;
    var minimizeCallback = usePixelHeightTrackingForTab(tab, relatedStack, height).minimizeCallback;
    var canBeMinimized = useCanBeMinimizedTab({
        stack: relatedStack,
        width: width,
        height: height,
    });
    var isMaximized = useIsMaximized({ stack: relatedStack });
    var isMinimized = height && height <= MinimizedHeight;
    return (_jsx(ExtensionPoints.providers, { children: _jsxs("div", { "data-id": "".concat(name, "-tab"), className: "flex flex-row items-center flex-nowrap", children: [_jsx(Grid, { item: true, className: "px-1 text-base", children: _jsx("div", { children: tab.titleElement.text() }) }), _jsx(Grid, { item: true, children: viz.header ? (_jsx(viz.header, __assign({}, _.extend({}, options, componentState, {
                        container: container,
                    })))) : null }), isMinimized || isMaximized || !canBeMinimized ? (_jsx(_Fragment, {})) : (_jsx(Grid, { item: true, children: _jsx(CloseOnClickTooltip, { title: _jsx(Paper, { elevation: Elevations.overlays, className: "p-1", children: "Minimize visual to bottom of layout" }), children: _jsx(Button, { onClick: minimizeCallback, children: _jsx(MinimizeIcon, { fontSize: "small" }) }) }) })), _jsx(Grid, { item: true, children: !tab.contentItem.layoutManager.isSubWindow &&
                        tab.closeElement[0].style.display !== 'none' ? (_jsx(CloseOnClickTooltip, { title: _jsx(Paper, { elevation: Elevations.overlays, className: "p-1", children: "Open visual in new window" }), children: _jsx(Button, { "data-id": "popout-tab-button", onClick: function () {
                                tab.contentItem.popout();
                            }, children: _jsx(PopoutIcon, { fontSize: "small" }) }) })) : null }), _jsx(Grid, { item: true, children: tab.closeElement[0].style.display !== 'none' ? (_jsx(CloseOnClickTooltip, { title: _jsx(Paper, { elevation: Elevations.overlays, className: "p-1", children: "Close visual" }), children: _jsx(Button, { "data-id": "close-tab-button", onClick: function (e) {
                                ;
                                tab._onCloseClickFn(e);
                            }, children: _jsx(CloseIcon, { fontSize: "small" }) }) })) : null })] }) }));
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlzdWFsLXRvb2xiYXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvbWFpbi93ZWJhcHAvY29tcG9uZW50L2dvbGRlbi1sYXlvdXQvdmlzdWFsLXRvb2xiYXIudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EsT0FBTyxLQUFLLE1BQU0sT0FBTyxDQUFBO0FBQ3pCLE9BQU8sWUFBWSxNQUFNLDhCQUE4QixDQUFBO0FBQ3ZELE9BQU8sU0FBUyxNQUFNLDJCQUEyQixDQUFBO0FBQ2pELE9BQU8sVUFBVSxNQUFNLCtCQUErQixDQUFBO0FBRXRELE9BQU8sTUFBTSxNQUFNLHNCQUFzQixDQUFBO0FBQ3pDLE9BQU8sS0FBSyxNQUFNLHFCQUFxQixDQUFBO0FBQ3ZDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQTtBQUMzQyxPQUFPLGVBQWUsTUFBTSx5Q0FBeUMsQ0FBQTtBQUNyRSxPQUFPLEVBQ0wsbUJBQW1CLEVBQ25CLGVBQWUsRUFDZixzQ0FBc0MsRUFDdEMsYUFBYSxFQUNiLG9CQUFvQixFQUNwQiw4QkFBOEIsRUFDOUIsV0FBVyxFQUNYLGdCQUFnQixFQUNoQixjQUFjLEVBQ2QsT0FBTyxFQUNQLFlBQVksR0FDYixNQUFNLGlCQUFpQixDQUFBO0FBQ3hCLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxlQUFlLENBQUE7QUFDcEMsT0FBTyxDQUFDLE1BQU0sWUFBWSxDQUFBO0FBRTFCLFNBQVMsb0JBQW9CLENBQUMsR0FBcUI7SUFDM0MsSUFBQSxLQUFBLE9BQW9CLEtBQUssQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsSUFBQSxFQUF6RCxLQUFLLFFBQUEsRUFBRSxRQUFRLFFBQTBDLENBQUE7SUFDaEUsS0FBSyxDQUFDLFNBQVMsQ0FBQztRQUNkLFFBQVEsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFBO0lBQ2xDLENB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QkFBa0IsRUFDMUIsT0FBTyxFQUFFLFVBQUMsQ0FBQztnQ0FDVCxDQUFDO2dDQUFDLEdBQVcsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUE7NEJBQ2xDLENBQUMsWUFFRCxLQUFDLFNBQVMsSUFBQyxRQUFRLEVBQUMsT0FBTyxHQUFHLEdBQ3ZCLEdBQ1csQ0FDdkIsQ0FBQyxDQUFDLENBQUMsSUFBSSxHQUNILElBQ0gsR0FDb0IsQ0FDN0IsQ0FBQTtBQUNILENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBHb2xkZW5MYXlvdXQgZnJvbSAnZ29sZGVuLWxheW91dCdcbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCdcbmltcG9ydCBNaW5pbWl6ZUljb24gZnJvbSAnQG11aS9pY29ucy1tYXRlcmlhbC9NaW5pbWl6ZSdcbmltcG9ydCBDbG9zZUljb24gZnJvbSAnQG11aS9pY29ucy1tYXRlcmlhbC9DbG9zZSdcbmltcG9ydCBQb3BvdXRJY29uIGZyb20gJ0BtdWkvaWNvbnMtbWF0ZXJpYWwvT3BlbkluTmV3J1xuXG5pbXBvcnQgQnV0dG9uIGZyb20gJ0BtdWkvbWF0ZXJpYWwvQnV0dG9uJ1xuaW1wb3J0IFBhcGVyIGZyb20gJ0BtdWkvbWF0ZXJpYWwvUGFwZXInXG5pbXBvcnQgeyBFbGV2YXRpb25zIH0gZnJvbSAnLi4vdGhlbWUvdGhlbWUnXG5pbXBvcnQgRXh0ZW5zaW9uUG9pbnRzIGZyb20gJy4uLy4uL2V4dGVuc2lvbi1wb2ludHMvZXh0ZW5zaW9uLXBvaW50cydcbmltcG9ydCB7XG4gIENsb3NlT25DbGlja1Rvb2x0aXAsXG4gIE1pbmltaXplZEhlaWdodCxcbiAgYWRqdXN0U3RhY2tJbk1pbmltaXplZFBsYWNlSWZOZWNlc3NhcnksXG4gIGdldEJvdHRvbUl0ZW0sXG4gIGdldFJvb3RDb2x1bW5Db250ZW50LFxuICBsYXlvdXRBbHJlYWR5SGFzTWluaW1pemVkU3RhY2ssXG4gIHJvb3RJc0VtcHR5LFxuICByb290SXNOb3RBQ29sdW1uLFxuICB1c2VJc01heGltaXplZCxcbiAgdXNlUm9vdCxcbiAgdXNlU3RhY2tTaXplLFxufSBmcm9tICcuL3N0YWNrLXRvb2xiYXInXG5pbXBvcnQgeyBHcmlkIH0gZnJvbSAnQG11aS9tYXRlcmlhbCdcbmltcG9ydCBfIGZyb20gJ3VuZGVyc2NvcmUnXG5cbmZ1bmN0aW9uIHVzZVN0YWNrUmVsYXRlZFRvVGFiKHRhYjogR29sZGVuTGF5b3V0LlRhYikge1xuICBjb25zdCBbc3RhY2ssIHNldFN0YWNrXSA9IFJlYWN0LnVzZVN0YXRlKHRhYi5jb250ZW50SXRlbS5wYXJlbnQpXG4gIFJlYWN0LnVzZUVmZmVjdCgoKSA9PiB7XG4gICAgc2V0U3RhY2sodGFiLmNvbnRlbnRJdGVtLnBhcmVudClcbiAgfSwgW3RhYl0pXG4gIHJldHVybiBzdGFjayBhcyBHb2xkZW5MYXlvdXQuVGFiICYgR29sZGVuTGF5b3V0LkNvbnRlbnRJdGVtXG59XG5cbi8vIGFkZCB0aGUgdGFiIHRvIHRoZSBleGlzdGluZyBtaW5pbWl6ZWQgc3RhY2tcbmZ1bmN0aW9uIGFkZFRhYlRvRXhpc3RpbmdNaW5pbWl6ZWRTdGFjayh7XG4gIHRhYixcbiAgc3RhY2ssXG59OiB7XG4gIHRhYjogR29sZGVuTGF5b3V0LlRhYiAmIEdvbGRlbkxheW91dC5Db250ZW50SXRlbVxuICBzdGFjazogR29sZGVuTGF5b3V0LlRhYiAmIEdvbGRlbkxheW91dC5Db250ZW50SXRlbVxufSkge1xuICBjb25zdCBib3R0b21JdGVtID0gZ2V0Qm90dG9tSXRlbShzdGFjaylcbiAgaWYgKGJvdHRvbUl0ZW0pIHtcbiAgICBzdGFjay5yZW1vdmVDaGlsZCh0YWIuY29udGVudEl0ZW0gYXMgYW55LCB0cnVlKSAvLyBmb3Igc29tZSByZWFzb24gcmVtb3ZlQ2hpbGQgaXMgb3Zlcmx5IHJlc3RyaWN0aXZlIG9uIHR5cGUgb2YgXCJ0aGluZ1wiIHNvIHdlIGhhdmUgdG8gY2FzdFxuICAgIGJvdHRvbUl0ZW0uYWRkQ2hpbGQodGFiLmNvbnRlbnRJdGVtLCB1bmRlZmluZWQpXG4gIH1cbn1cblxuLy8gd2UgaGF2ZSB0byBtb3ZlIGVhY2ggaXRlbSBpbmRpdmlkdWFsbHkgYmVjYXVzZSBnb2xkZW4gbGF5b3V0IGRvZXNuJ3Qgc3VwcG9ydCBtb3ZpbmcgYW4gZW50aXJlIHN0YWNrLCBhbmQgYWRkQ2hpbGQgZG9lcyBub3Qgd29yayBhcyBkb2N1bWVudGF0aW9uIHNheXMgKGl0IGRvZXNuJ3QgcmVtb3ZlIHRoZSBleGlzdGluZyBhdXRvbWF0aWNhbGx5KVxuZnVuY3Rpb24gY3JlYXRlTmV3U3RhY2tGcm9tRXhpc3RpbmdUYWIoe1xuICB0YWIsXG4gIHN0YWNrLFxufToge1xuICB0YWI6IEdvbGRlbkxheW91dC5UYWIgJiBHb2xkZW5MYXlvdXQuQ29udGVudEl0ZW1cbiAgc3RhY2s6IEdvbGRlbkxheW91dC5UYWIgJiBHb2xkZW5MYXlvdXQuQ29udGVudEl0ZW1cbn0pIHtcbiAgY29uc3QgZXhpc3RpbmdJdGVtID0gdGFiLmNvbnRlbnRJdGVtXG4gIGNvbnN0IG5ld1N0YWNrSXRlbSA9IHN0YWNrLmxheW91dE1hbmFnZXIuXyRub3JtYWxpemVDb250ZW50SXRlbSh7XG4gICAgdHlwZTogJ3N0YWNrJyxcbiAgfSlcbiAgc3RhY2sucmVtb3ZlQ2hpbGQoZXhpc3RpbmdJdGVtIGFzIGFueSwgdHJ1ZSkgLy8gZm9yIHNvbWUgcmVhc29uIHJlbW92ZUNoaWxkIGlzIG92ZXJseSByZXN0cmljdGl2ZSBvbiB0eXBlIG9mIFwidGhpbmdcIiBzbyB3ZSBoYXZlIHRvIGNhc3RcbiAgbmV3U3RhY2tJdGVtLmFkZENoaWxkKGV4aXN0aW5nSXRlbSwgdW5kZWZpbmVkKVxuICByZXR1cm4gbmV3U3RhY2tJdGVtXG59XG5cbmZ1bmN0aW9uIGNyZWF0ZUFuZEFkZE5ld01pbmltaXplZFN0YWNrRm9yVGFiKHtcbiAgdGFiLFxuICBzdGFjayxcbiAgZ29sZGVuTGF5b3V0Um9vdCxcbn06IHtcbiAgdGFiOiBHb2xkZW5MYXlvdXQuVGFiICYgR29sZGVuTGF5b3V0LkNvbnRlbnRJdGVtXG4gIHN0YWNrOiBHb2xkZW5MYXlvdXQuVGFiICYgR29sZGVuTGF5b3V0LkNvbnRlbnRJdGVtXG4gIGdvbGRlbkxheW91dFJvb3Q6IEdvbGRlbkxheW91dC5Db250ZW50SXRlbVxufSkge1xuICBjb25zdCBuZXdTdGFja0l0ZW0gPSBjcmVhdGVOZXdTdGFja0Zyb21FeGlzdGluZ1RhYih7IHN0YWNrLCB0YWIgfSlcbiAgaWYgKHJvb3RJc05vdEFDb2x1bW4oZ29sZGVuTGF5b3V0Um9vdCkpIHtcbiAgICBjb25zdCBleGlzdGluZ1Jvb3RDb250ZW50ID0gZ2V0Um9vdENvbHVtbkNvbnRlbnQoZ29sZGVuTGF5b3V0Um9vdClcbiAgICBnb2xkZW5MYXlvdXRSb290LnJlbW92ZUNoaWxkKGV4aXN0aW5nUm9vdENvbnRlbnQgYXMgYW55LCB0cnVlKSAvLyBmb3Igc29tZSByZWFzb24gcmVtb3ZlQ2hpbGQgaXMgb3Zlcmx5IHJlc3RyaWN0aXZlIG9uIHR5cGUgb2YgXCJ0aGluZ1wiIHNvIHdlIGhhdmUgdG8gY2FzdFxuXG4gICAgLy8gd2UgbmVlZCBhIGNvbHVtbiBmb3IgbWluaW1pemUgdG8gd29yaywgc28gbWFrZSBhIG5ldyBjb2x1bW4gYW5kIGFkZCB0aGUgZXhpc3Rpbmcgcm9vdCB0byBpdFxuICAgIGNvbnN0IG5ld0NvbHVtbkl0ZW0gPSBzdGFjay5sYXlvdXRNYW5hZ2VyLl8kbm9ybWFsaXplQ29udGVudEl0ZW0oe1xuICAgICAgdHlwZTogJ2NvbHVtbicsXG4gICAgfSlcbiAgICBuZXdDb2x1bW5JdGVtLmFkZENoaWxkKGV4aXN0aW5nUm9vdENvbnRlbnQpXG4gICAgbmV3Q29sdW1uSXRlbS5hZGRDaGlsZChuZXdTdGFja0l0ZW0pXG5cbiAgICBnb2xkZW5MYXlvdXRSb290LmFkZENoaWxkKG5ld0NvbHVtbkl0ZW0pXG4gIH0gZWxzZSBpZiAocm9vdElzRW1wdHkoZ29sZGVuTGF5b3V0Um9vdCkpIHtcbiAgICBjb25zdCBuZXdDb2x1bW5JdGVtID0gc3RhY2subGF5b3V0TWFuYWdlci5fJG5vcm1hbGl6ZUNvbnRlbnRJdGVtKHtcbiAgICAgIHR5cGU6ICdjb2x1bW4nLFxuICAgIH0pXG4gICAgbmV3Q29sdW1uSXRlbS5hZGRDaGlsZChuZXdTdGFja0l0ZW0pXG5cbiAgICBnb2xkZW5MYXlvdXRSb290LmFkZENoaWxkKG5ld0NvbHVtbkl0ZW0pXG4gIH0gZWxzZSB7XG4gICAgZ2V0Um9vdENvbHVtbkNvbnRlbnQoZ29sZGVuTGF5b3V0Um9vdCk/LmFkZENoaWxkKG5ld1N0YWNrSXRlbSlcbiAgfVxufVxuXG4vLyBrZWVwIHRyYWNrIG9mIHBpeGVsIGhlaWdodCBvbiBlYWNoIHN0YWNrLCB3aGljaCBhbGxvd3MgdXMgdG8gZGV0ZWN0IHdoZW4gYSBzdGFjayBpcyBcIm1pbmltaXplZFwiIGxhdGVyIG9uXG5mdW5jdGlvbiB1c2VQaXhlbEhlaWdodFRyYWNraW5nRm9yVGFiKFxuICB0YWI6IEdvbGRlbkxheW91dC5UYWIgJiBHb2xkZW5MYXlvdXQuQ29udGVudEl0ZW0sXG4gIHN0YWNrOiBHb2xkZW5MYXlvdXQuVGFiICYgR29sZGVuTGF5b3V0LkNvbnRlbnRJdGVtLFxuICBoZWlnaHQ6IG51bWJlciB8IHVuZGVmaW5lZFxuKSB7XG4gIFJlYWN0LnVzZUVmZmVjdCgoKSA9PiB7XG4gICAgaWYgKHN0YWNrKSB7XG4gICAgICA7KHN0YWNrIGFzIGFueSkucGl4ZWxIZWlnaHQgPSBoZWlnaHRcbiAgICB9XG4gIH0sIFtoZWlnaHQsIHN0YWNrXSlcbiAgY29uc3QgZ29sZGVuTGF5b3V0Um9vdCA9IHVzZVJvb3Qoc3RhY2spXG5cbiAgY29uc3QgbWluaW1pemVDYWxsYmFjayA9IFJlYWN0LnVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICBpZiAoIWdvbGRlbkxheW91dFJvb3QpIHtcbiAgICAgIHJldHVyblxuICAgIH1cbiAgICBpZiAobGF5b3V0QWxyZWFkeUhhc01pbmltaXplZFN0YWNrKHsgc3RhY2sgfSkpIHtcbiAgICAgIC8vIG1pbmltaXplZCBhcmVhIGV4aXN0cywgYWRkIHRoaXMgdG8gaXRcbiAgICAgIGFkZFRhYlRvRXhpc3RpbmdNaW5pbWl6ZWRTdGFjayh7IHRhYiwgc3RhY2sgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gcmVhcnJhbmdlIGxheW91dCBpZiBuZWNlc3NhcnkgYW5kIG1vdmUgdGhlIHN0YWNrXG4gICAgICBjcmVhdGVBbmRBZGROZXdNaW5pbWl6ZWRTdGFja0ZvclRhYih7IHRhYiwgc3RhY2ssIGdvbGRlbkxheW91dFJvb3QgfSlcbiAgICB9XG4gICAgYWRqdXN0U3RhY2tJbk1pbmltaXplZFBsYWNlSWZOZWNlc3NhcnkoeyBnb2xkZW5MYXlvdXRSb290IH0pXG4gIH0sIFtzdGFjaywgZ29sZGVuTGF5b3V0Um9vdF0pXG5cbiAgcmV0dXJuIHsgbWluaW1pemVDYWxsYmFjayB9XG59XG5cbmZ1bmN0aW9uIHVzZUNhbkJlTWluaW1pemVkVGFiKHtcbiAgc3RhY2ssXG4gIGhlaWdodCxcbiAgd2lkdGgsXG59OiB7XG4gIHN0YWNrOiBHb2xkZW5MYXlvdXQuVGFiICYgR29sZGVuTGF5b3V0LkNvbnRlbnRJdGVtXG4gIGhlaWdodD86IG51bWJlclxuICB3aWR0aD86IG51bWJlclxufSkge1xuICBjb25zdCBbaXRlbUNvdW50LCBzZXRJdGVtQ291bnRdID0gUmVhY3QudXNlU3RhdGUoc3RhY2suY29udGVudEl0ZW1zLmxlbmd0aClcbiAgY29uc3QgW2NhbkJlTWluaW1pemVkLCBzZXRDYW5CZU1pbmltaXplZF0gPSBSZWFjdC51c2VTdGF0ZSh0cnVlKVxuICBSZWFjdC51c2VFZmZlY3QoKCkgPT4ge1xuICAgIGNvbnN0IHJvb3RDb250ZW50ID0gZ2V0Um9vdENvbHVtbkNvbnRlbnQoc3RhY2spXG4gICAgaWYgKHJvb3RDb250ZW50Py5pc1N0YWNrICYmIHJvb3RDb250ZW50Py5jb250ZW50SXRlbXMubGVuZ3RoID09PSAxKSB7XG4gICAgICBzZXRDYW5CZU1pbmltaXplZChmYWxzZSlcbiAgICB9IGVsc2Uge1xuICAgICAgc2V0Q2FuQmVNaW5pbWl6ZWQodHJ1ZSlcbiAgICB9XG4gIH0sIFtzdGFjaywgaGVpZ2h0LCB3aWR0aCwgaXRlbUNvdW50XSlcbiAgUmVhY3QudXNlRWZmZWN0KCgpID0+IHtcbiAgICBpZiAoc3RhY2spIHtcbiAgICAgIGNvbnN0IGNhbGxiYWNrID0gKCkgPT4ge1xuICAgICAgICBzZXRJdGVtQ291bnQoc3RhY2suY29udGVudEl0ZW1zLmxlbmd0aClcbiAgICAgIH1cbiAgICAgIHN0YWNrLm9uKCdpdGVtQ3JlYXRlZCcsIGNhbGxiYWNrKVxuICAgICAgc3RhY2sub24oJ2l0ZW1EZXN0cm95ZWQnLCBjYWxsYmFjaylcbiAgICAgIHJldHVybiAoKSA9PiB7XG4gICAgICAgIHN0YWNrLm9mZignaXRlbUNyZWF0ZWQnLCBjYWxsYmFjaylcbiAgICAgICAgc3RhY2sub2ZmKCdpdGVtRGVzdHJveWVkJywgY2FsbGJhY2spXG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiAoKSA9PiB7fVxuICB9LCBbc3RhY2tdKVxuICByZXR1cm4gY2FuQmVNaW5pbWl6ZWRcbn1cblxuZXhwb3J0IGNvbnN0IEdvbGRlbkxheW91dENvbXBvbmVudEhlYWRlciA9ICh7XG4gIHZpeixcbiAgdGFiLFxuICBvcHRpb25zLFxuICBjb21wb25lbnRTdGF0ZSxcbiAgY29udGFpbmVyLFxuICBuYW1lLFxufToge1xuICB2aXo6IGFueVxuICB0YWI6IEdvbGRlbkxheW91dC5UYWIgJiBHb2xkZW5MYXlvdXQuQ29udGVudEl0ZW1cbiAgb3B0aW9uczogYW55XG4gIGNvbXBvbmVudFN0YXRlOiBhbnlcbiAgY29udGFpbmVyOiBhbnlcbiAgbmFtZTogYW55XG59KSA9PiB7XG4gIGNvbnN0IHJlbGF0ZWRTdGFjayA9IHVzZVN0YWNrUmVsYXRlZFRvVGFiKHRhYilcbiAgY29uc3QgeyBoZWlnaHQsIHdpZHRoIH0gPSB1c2VTdGFja1NpemUocmVsYXRlZFN0YWNrKVxuICBjb25zdCB7IG1pbmltaXplQ2FsbGJhY2sgfSA9IHVzZVBpeGVsSGVpZ2h0VHJhY2tpbmdGb3JUYWIoXG4gICAgdGFiIGFzIGFueSxcbiAgICByZWxhdGVkU3RhY2ssXG4gICAgaGVpZ2h0XG4gIClcbiAgY29uc3QgY2FuQmVNaW5pbWl6ZWQgPSB1c2VDYW5CZU1pbmltaXplZFRhYih7XG4gICAgc3RhY2s6IHJlbGF0ZWRTdGFjayxcbiAgICB3aWR0aCxcbiAgICBoZWlnaHQsXG4gIH0pXG4gIGNvbnN0IGlzTWF4aW1pemVkID0gdXNlSXNNYXhpbWl6ZWQoeyBzdGFjazogcmVsYXRlZFN0YWNrIH0pXG4gIGNvbnN0IGlzTWluaW1pemVkID0gaGVpZ2h0ICYmIGhlaWdodCA8PSBNaW5pbWl6ZWRIZWlnaHRcbiAgcmV0dXJuIChcbiAgICA8RXh0ZW5zaW9uUG9pbnRzLnByb3ZpZGVycz5cbiAgICAgIDxkaXZcbiAgICAgICAgZGF0YS1pZD17YCR7bmFtZX0tdGFiYH1cbiAgICAgICAgY2xhc3NOYW1lPXtgZmxleCBmbGV4LXJvdyBpdGVtcy1jZW50ZXIgZmxleC1ub3dyYXBgfVxuICAgICAgPlxuICAgICAgICA8R3JpZCBpdGVtIGNsYXNzTmFtZT1cInB4LTEgdGV4dC1iYXNlXCI+XG4gICAgICAgICAgPGRpdj57dGFiLnRpdGxlRWxlbWVudC50ZXh0KCl9PC9kaXY+XG4gICAgICAgIDwvR3JpZD5cbiAgICAgICAgPEdyaWQgaXRlbT5cbiAgICAgICAgICB7dml6LmhlYWRlciA/IChcbiAgICAgICAgICAgIDx2aXouaGVhZGVyXG4gICAgICAgICAgICAgIHsuLi5fLmV4dGVuZCh7fSwgb3B0aW9ucywgY29tcG9uZW50U3RhdGUsIHtcbiAgICAgICAgICAgICAgICBjb250YWluZXIsXG4gICAgICAgICAgICAgIH0pfVxuICAgICAgICAgICAgLz5cbiAgICAgICAgICApIDogbnVsbH1cbiAgICAgICAgPC9HcmlkPlxuICAgICAgICB7aXNNaW5pbWl6ZWQgfHwgaXNNYXhpbWl6ZWQgfHwgIWNhbkJlTWluaW1pemVkID8gKFxuICAgICAgICAgIDw+PC8+XG4gICAgICAgICkgOiAoXG4gICAgICAgICAgPEdyaWQgaXRlbT5cbiAgICAgICAgICAgIDxDbG9zZU9uQ2xpY2tUb29sdGlwXG4gICAgICAgICAgICAgIHRpdGxlPXtcbiAgICAgICAgICAgICAgICA8UGFwZXIgZWxldmF0aW9uPXtFbGV2YXRpb25zLm92ZXJsYXlzfSBjbGFzc05hbWU9XCJwLTFcIj5cbiAgICAgICAgICAgICAgICAgIE1pbmltaXplIHZpc3VhbCB0byBib3R0b20gb2YgbGF5b3V0XG4gICAgICAgICAgICAgICAgPC9QYXBlcj5cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgPlxuICAgICAgICAgICAgICA8QnV0dG9uIG9uQ2xpY2s9e21pbmltaXplQ2FsbGJhY2t9PlxuICAgICAgICAgICAgICAgIDxNaW5pbWl6ZUljb24gZm9udFNpemU9XCJzbWFsbFwiIC8+XG4gICAgICAgICAgICAgIDwvQnV0dG9uPlxuICAgICAgICAgICAgPC9DbG9zZU9uQ2xpY2tUb29sdGlwPlxuICAgICAgICAgIDwvR3JpZD5cbiAgICAgICAgKX1cblxuICAgICAgICA8R3JpZCBpdGVtPlxuICAgICAgICAgIHshdGFiLmNvbnRlbnRJdGVtLmxheW91dE1hbmFnZXIuaXNTdWJXaW5kb3cgJiZcbiAgICAgICAgICB0YWIuY2xvc2VFbGVtZW50WzBdLnN0eWxlLmRpc3BsYXkgIT09ICdub25lJyA/IChcbiAgICAgICAgICAgIDxDbG9zZU9uQ2xpY2tUb29sdGlwXG4gICAgICAgICAgICAgIHRpdGxlPXtcbiAgICAgICAgICAgICAgICA8UGFwZXIgZWxldmF0aW9uPXtFbGV2YXRpb25zLm92ZXJsYXlzfSBjbGFzc05hbWU9XCJwLTFcIj5cbiAgICAgICAgICAgICAgICAgIE9wZW4gdmlzdWFsIGluIG5ldyB3aW5kb3dcbiAgICAgICAgICAgICAgICA8L1BhcGVyPlxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgIDxCdXR0b25cbiAgICAgICAgICAgICAgICBkYXRhLWlkPVwicG9wb3V0LXRhYi1idXR0b25cIlxuICAgICAgICAgICAgICAgIG9uQ2xpY2s9eygpID0+IHtcbiAgICAgICAgICAgICAgICAgIHRhYi5jb250ZW50SXRlbS5wb3BvdXQoKVxuICAgICAgICAgICAgICAgIH19XG4gICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICA8UG9wb3V0SWNvbiBmb250U2l6ZT1cInNtYWxsXCIgLz5cbiAgICAgICAgICAgICAgPC9CdXR0b24+XG4gICAgICAgICAgICA8L0Nsb3NlT25DbGlja1Rvb2x0aXA+XG4gICAgICAgICAgKSA6IG51bGx9XG4gICAgICAgIDwvR3JpZD5cbiAgICAgICAgPEdyaWQgaXRlbT5cbiAgICAgICAgICB7dGFiLmNsb3NlRWxlbWVudFswXS5zdHlsZS5kaXNwbGF5ICE9PSAnbm9uZScgPyAoXG4gICAgICAgICAgICA8Q2xvc2VPbkNsaWNrVG9vbHRpcFxuICAgICAgICAgICAgICB0aXRsZT17XG4gICAgICAgICAgICAgICAgPFBhcGVyIGVsZXZhdGlvbj17RWxldmF0aW9ucy5vdmVybGF5c30gY2xhc3NOYW1lPVwicC0xXCI+XG4gICAgICAgICAgICAgICAgICBDbG9zZSB2aXN1YWxcbiAgICAgICAgICAgICAgICA8L1BhcGVyPlxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgIDxCdXR0b25cbiAgICAgICAgICAgICAgICBkYXRhLWlkPVwiY2xvc2UtdGFiLWJ1dHRvblwiXG4gICAgICAgICAgICAgICAgb25DbGljaz17KGUpID0+IHtcbiAgICAgICAgICAgICAgICAgIDsodGFiIGFzIGFueSkuX29uQ2xvc2VDbGlja0ZuKGUpXG4gICAgICAgICAgICAgICAgfX1cbiAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgIDxDbG9zZUljb24gZm9udFNpemU9XCJzbWFsbFwiIC8+XG4gICAgICAgICAgICAgIDwvQnV0dG9uPlxuICAgICAgICAgICAgPC9DbG9zZU9uQ2xpY2tUb29sdGlwPlxuICAgICAgICAgICkgOiBudWxsfVxuICAgICAgICA8L0dyaWQ+XG4gICAgICA8L2Rpdj5cbiAgICA8L0V4dGVuc2lvblBvaW50cy5wcm92aWRlcnM+XG4gIClcbn1cbiJdfQ==