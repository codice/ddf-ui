import { __read } from "tslib";
import { Fragment as _Fragment, jsx as _jsx } from "react/jsx-runtime";
/**
 * Copyright (c) Codice Foundation
 *
 * This is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser
 * General Public License as published by the Free Software Foundation, either version 3 of the
 * License, or any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
 * even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details. A copy of the GNU Lesser General Public License
 * is distributed along with this program and can be found at
 * <http://www.gnu.org/licenses/lgpl.html>.
 *
 **/
import React from 'react';
import DistanceUtils from '../../../../js/DistanceUtils';
// @ts-expect-error ts-migrate(7016) FIXME: Could not find a declaration file for module 'cesi... Remove this comment to see the full error message
import Cesium from 'cesium/Build/Cesium/Cesium';
import _ from 'underscore';
import * as Turf from '@turf/turf';
import { useListenTo } from '../../../selection-checkbox/useBackbone.hook';
import { useRender } from '../../../hooks/useRender';
import { removeOldDrawing, makeOldDrawingNonEditable, } from './drawing-and-display';
import { getIdFromModelForDisplay } from '../drawing-and-display';
import TurfCircle from '@turf/circle';
import DrawHelper from '../../../../lib/cesium-drawhelper/DrawHelper';
import { contrastingColor } from '../../../../react-component/location/location-color-selector';
var toDeg = Cesium.Math.toDegrees;
var CAMERA_MAGNITUDE_THRESHOLD = 8000000;
var getCurrentMagnitudeFromMap = function (_a) {
    var map = _a.map;
    return map.getMap().camera.getMagnitude();
};
var needsRedraw = function (_a) {
    var map = _a.map, drawnMagnitude = _a.drawnMagnitude;
    var currentMagnitude = getCurrentMagnitudeFromMap({ map: map });
    if (currentMagnitude < CAMERA_MAGNITUDE_THRESHOLD &&
        drawnMagnitude > CAMERA_MAGNITUDE_THRESHOLD) {
        return true;
    }
    if (currentMagnitude > CAMERA_MAGNITUDE_THRESHOLD &&
        drawnMagnitude < CAMERA_MAGNITUDE_THRESHOLD) {
        return true;
    }
    return false;
};
var defaultAttrs = ['lat', 'lon', 'radius'];
var isModelReset = function (_a) {
    var modelProp = _a.modelProp;
    if (_.every(defaultAttrs, function (val) { return _.isUndefined(modelProp[val]); }) ||
        _.isEmpty(modelProp)) {
        return true;
    }
    return false;
};
var cartesian3ToCircle = function (center, radius, ellipsoid) {
    var latLon = ellipsoid.cartesianToCartographic(center);
    var lon = toDeg(latLon.longitude);
    var lat = toDeg(latLon.latitude);
    var radiusUnits = 'meters';
    if (radius >= 1000) {
        radius /= 1000;
        radiusUnits = 'kilometers';
    }
    return {
        lon: DistanceUtils.coordinateRound(lon),
        lat: DistanceUtils.coordinateRound(lat),
        radius: radius,
        radiusUnits: radiusUnits,
    };
};
var drawGeometry = function (_a) {
    // if model has been reset
    var model = _a.model, map = _a.map, id = _a.id, onDraw = _a.onDraw, translation = _a.translation, isInteractive = _a.isInteractive;
    var modelProp = model.toJSON();
    if (isModelReset({ modelProp: modelProp })) {
        map.getMap().scene.requestRender();
        return;
    }
    modelProp.lat = parseFloat(modelProp.lat);
    modelProp.lon = parseFloat(modelProp.lon);
    if (Number.isNaN(modelProp.lat) || Number.isNaN(modelProp.lon)) {
        map.getMap().scene.requestRender();
        return;
    }
    if (translation) {
        modelProp.lon += translation.longitude;
        modelProp.lat += translation.latitude;
    }
    var primitive;
    if (onDraw) {
        primitive = new DrawHelper.CirclePrimitive({
            center: Cesium.Cartesian3.fromDegrees(modelProp.lon, modelProp.lat),
            radius: DistanceUtils.getDistanceInMeters(modelProp.radius, modelProp.radiusUnits),
            height: 0,
            id: id,
            material: Cesium.Material.fromType('Color', {
                color: Cesium.Color.fromAlpha(contrastingColor, 0.2),
            }),
        });
        primitive.setEditable();
        primitive.addListener('onEdited', function (event) {
            var circle = cartesian3ToCircle(event.center, event.radius, map.getMap().scene.globe.ellipsoid);
            onDraw(circle);
        });
    }
    else {
        var color = model.get('color');
        var centerPt = Turf.point([modelProp.lon, modelProp.lat]);
        var circleToCheck = TurfCircle(centerPt, DistanceUtils.getDistanceInMeters(modelProp.radius, modelProp.radiusUnits), { units: 'meters', steps: 64 });
        primitive = new Cesium.PolylineCollection();
        primitive.add({
            width: isInteractive ? 12 : 8,
            material: Cesium.Material.fromType('PolylineOutline', {
                color: isInteractive
                    ? Cesium.Color.fromCssColorString(contrastingColor)
                    : color
                        ? Cesium.Color.fromCssColorString(color)
                        : Cesium.Color.KHAKI,
                outlineColor: Cesium.Color.WHITE,
                outlineWidth: isInteractive ? 6 : 4,
            }),
            id: 'userDrawing',
            positions: Cesium.Cartesian3.fromDegreesArray(_.flatten(circleToCheck.geometry.coordinates)),
        });
    }
    primitive.id = id;
    primitive.locationId = modelProp.locationId;
    map.getMap().scene.primitives.add(primitive);
    map.getMap().scene.requestRender();
};
var useCameraMagnitude = function (_a) {
    var map = _a.map;
    var _b = __read(React.useState(0), 2), cameraMagnitude = _b[0], setCameraMagnitude = _b[1];
    var _c = __read(React.useState(false), 2), isMoving = _c[0], setIsMoving = _c[1];
    var render = useRender();
    React.useEffect(function () {
        var startListener = function () { return setIsMoving(true); };
        var endListener = function () { return setIsMoving(false); };
        map === null || map === void 0 ? void 0 : map.getMap().scene.camera.moveStart.addEventListener(startListener);
        map === null || map === void 0 ? void 0 : map.getMap().scene.camera.moveEnd.addEventListener(endListener);
        return function () {
            map === null || map === void 0 ? void 0 : map.getMap().scene.camera.moveStart.removeEventListener(startListener);
            map === null || map === void 0 ? void 0 : map.getMap().scene.camera.moveEnd.removeEventListener(endListener);
        };
    }, [map]);
    React.useEffect(function () {
        if (isMoving) {
            var animationId_1 = window.requestAnimationFrame(function () {
                setCameraMagnitude(getCurrentMagnitudeFromMap({ map: map }));
            });
            return function () {
                window.cancelAnimationFrame(animationId_1);
            };
        }
        return function () { };
    }, [isMoving, render]);
    return [cameraMagnitude, setCameraMagnitude];
};
var useListenToModel = function (_a) {
    var model = _a.model, map = _a.map, newCircle = _a.newCircle, onDraw = _a.onDraw, translation = _a.translation, isInteractive = _a.isInteractive;
    var _b = __read(useCameraMagnitude({ map: map }), 1), cameraMagnitude = _b[0];
    var _c = __read(React.useState(0), 2), drawnMagnitude = _c[0], setDrawnMagnitude = _c[1];
    var callback = React.useMemo(function () {
        return function () {
            if (map) {
                if (newCircle) {
                    // Clone the model to display the new circle drawn because we don't
                    // want to update the existing model unless the user clicks Apply.
                    var newModel = model.clone();
                    newModel.set(newCircle);
                    makeOldDrawingNonEditable({
                        map: map,
                        id: getIdFromModelForDisplay({ model: model }),
                    });
                    drawGeometry({
                        map: map,
                        model: newModel,
                        id: getIdFromModelForDisplay({ model: model }),
                        setDrawnMagnitude: setDrawnMagnitude,
                        onDraw: onDraw,
                    });
                }
                else if (model) {
                    removeOldDrawing({ map: map, id: getIdFromModelForDisplay({ model: model }) });
                    drawGeometry({
                        map: map,
                        model: model,
                        id: getIdFromModelForDisplay({ model: model }),
                        setDrawnMagnitude: setDrawnMagnitude,
                        onDraw: onDraw,
                        translation: translation,
                        isInteractive: isInteractive,
                    });
                }
            }
        };
    }, [model, map, newCircle, translation, isInteractive]);
    useListenTo(model, 'change:lat change:lon change:radius change:color', callback);
    React.useEffect(function () {
        if (map && needsRedraw({ map: map, drawnMagnitude: drawnMagnitude })) {
            callback();
        }
    }, [cameraMagnitude, drawnMagnitude, callback, map]);
    React.useEffect(function () {
        callback();
    }, [callback]);
};
var useStartMapDrawing = function (_a) {
    var map = _a.map, model = _a.model, setNewCircle = _a.setNewCircle, onDraw = _a.onDraw;
    React.useEffect(function () {
        if (map && model) {
            map.getMap().drawHelper["startDrawingCircle"]({
                callback: function (center, radius) {
                    var circle = cartesian3ToCircle(center, radius, map.getMap().scene.globe.ellipsoid);
                    setNewCircle(circle);
                    onDraw(circle);
                },
                material: Cesium.Material.fromType('Color', {
                    color: Cesium.Color.fromAlpha(contrastingColor, 0.2),
                }),
            });
        }
    }, [map, model]);
};
export var CesiumCircleDisplay = function (_a) {
    var map = _a.map, model = _a.model, onDraw = _a.onDraw, translation = _a.translation, isInteractive = _a.isInteractive;
    // Use state to store the circle drawn by the user before they click Apply or Cancel.
    // When the user clicks Draw, they are allowed to edit the existing circle (if it
    // exists), or draw a new circle. If they draw a new circle, save it to state then show
    // it instead of the draw model because we don't want to update the draw model
    // unless the user clicks Apply.
    var _b = __read(React.useState(null), 2), newCircle = _b[0], setNewCircle = _b[1];
    if (onDraw) {
        useStartMapDrawing({ map: map, model: model, setNewCircle: setNewCircle, onDraw: onDraw });
    }
    useListenToModel({
        map: map,
        model: model,
        newCircle: newCircle,
        onDraw: onDraw,
        translation: translation,
        isInteractive: isInteractive,
    });
    React.useEffect(function () {
        return function () {
            if (model && map) {
                removeOldDrawing({ map: map, id: getIdFromModelForDisplay({ model: model }) });
                map.getMap().drawHelper.stopDrawing();
            }
        };
    }, [map, model]);
    return _jsx(_Fragment, {});
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2lyY2xlLWRpc3BsYXkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9zcmMvbWFpbi93ZWJhcHAvY29tcG9uZW50L3Zpc3VhbGl6YXRpb24vbWFwcy9jZXNpdW0vY2lyY2xlLWRpc3BsYXkudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUE7Ozs7Ozs7Ozs7Ozs7SUFhSTtBQUNKLE9BQU8sS0FBSyxNQUFNLE9BQU8sQ0FBQTtBQUN6QixPQUFPLGFBQWEsTUFBTSw4QkFBOEIsQ0FBQTtBQUN4RCxtSkFBbUo7QUFDbkosT0FBTyxNQUFNLE1BQU0sNEJBQTRCLENBQUE7QUFDL0MsT0FBTyxDQUFDLE1BQU0sWUFBWSxDQUFBO0FBQzFCLE9BQU8sS0FBSyxJQUFJLE1BQU0sWUFBWSxDQUFBO0FBQ2xDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSw4Q0FBOEMsQ0FBQTtBQUMxRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sMEJBQTBCLENBQUE7QUFDcEQsT0FBTyxFQUNMLGdCQUFnQixFQUNoQix5QkFBeUIsR0FDMUIsTUFBTSx1QkFBdUIsQ0FBQTtBQUM5QixPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQTtBQUNqRSxPQUFPLFVBQVUsTUFBTSxjQUFjLENBQUE7QUFDckMsT0FBTyxVQUFVLE1BQU0sOENBQThDLENBQUE7QUFDckUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sOERBQThELENBQUE7QUFFL0YsSUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUE7QUFFbkMsSUFBTSwwQkFBMEIsR0FBRyxPQUFPLENBQUE7QUFTMUMsSUFBTSwwQkFBMEIsR0FBRyxVQUFDLEVBQXFCO1FBQW5CLEdBQUcsU0FBQTtJQUN2QyxPQUFPLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxNQUFNLENBQUMsWUFBWSxFQUFFLENBQUE7QUFDM0MsQ0FBQyxDQUFBO0FBRUQsSUFBTSxXQUFXLEdBQUcsVUFBQyxFQU1wQjtRQUxDLEdBQUcsU0FBQSxFQUNILGNBQWMsb0JBQUE7SUFLZCxJQUFNLGdCQUFnQixHQUFHLDBCQUEwQixDQUFDLEVBQUUsR0FBRyxLQUFBLEVBQUUsQ0FBQyxDQUFBO0lBRTVELElBQ0UsZ0JBQWdCLEdBQUcsMEJBQTBCO1FBQzdDLGNBQWMsR0FBRywwQkFBMEIsRUFDM0MsQ0FBQztRQUNELE9BQU8sSUFBSSxDQUFBO0lBQ2IsQ0FBQztJQUNELElBQ0UsZ0JBQWdCLEdBQUcsMEJBQTBCO1FBQzdDLGNBQWMsR0FBRywwQkFBMEIsRUFDM0MsQ0FBQztRQUNELE9BQU8sSUFBSSxDQUFBO0lBQ2IsQ0FBQztJQUVELE9BQU8sS0FBSyxDQUFBO0FBQ2QsQ0FBQyxDQUFBO0FBRUQsSUFBTSxZQUFZLEdBQUcsQ0FBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFBO0FBRTdDLElBQU0sWUFBWSxHQUFHLFVBQUMsRUFBaUM7UUFBL0IsU0FBUyxlQUFBO0lBQy9CLElBQ0UsQ0FBQyxDQUFDLEtBQUssQ0FBQyxZQUFZLEVBQUUsVUFBQyxHQUFRLElBQUssT0FBQSxDQUFDLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUE3QixDQUE2QixDQUFDO1FBQ2xFLENBQUMsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEVBQ3BCLENBQUM7UUFDRCxPQUFPLElBQUksQ0FBQTtJQUNiLENBQUM7SUFDRCxPQUFPLEtBQUssQ0FBQTtBQUNkLENBQUMsQ0FBQTtBQUVELElBQU0sa0JBQWtCLEdBQUcsVUFDekIsTUFBeUIsRUFDekIsTUFBYyxFQUNkLFNBQTJCO0lBRTNCLElBQU0sTUFBTSxHQUFHLFNBQVMsQ0FBQyx1QkFBdUIsQ0FBQyxNQUFNLENBQUMsQ0FBQTtJQUN4RCxJQUFNLEdBQUcsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFBO0lBQ25DLElBQU0sR0FBRyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUE7SUFDbEMsSUFBSSxXQUFXLEdBQUcsUUFBUSxDQUFBO0lBQzFCLElBQUksTUFBTSxJQUFJLElBQUksRUFBRSxDQUFDO1FBQ25CLE1BQU0sSUFBSSxJQUFJLENBQUE7UUFDZCxXQUFXLEdBQUcsWUFBWSxDQUFBO0lBQzVCLENBQUM7SUFDRCxPQUFPO1FBQ0wsR0FBRyxFQUFFLGFBQWEsQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDO1FBQ3ZDLEdBQUcsRUFBRSxhQUFhLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQztRQUN2QyxNQUFNLFFBQUE7UUFDTixXQUFXLGFBQUE7S0FDWixDQUFBO0FBQ0gsQ0FBQyxDQUFBO0FBRUQsSUFBTSxZQUFZLEdBQUcsVUFBQyxFQWVyQjtJQUNDLDBCQUEwQjtRQWYxQixLQUFLLFdBQUEsRUFDTCxHQUFHLFNBQUEsRUFDSCxFQUFFLFFBQUEsRUFDRixNQUFNLFlBQUEsRUFDTixXQUFXLGlCQUFBLEVBQ1gsYUFBYSxtQkFBQTtJQVliLElBQU0sU0FBUyxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQTtJQUNoQyxJQUFJLFlBQVksQ0FBQyxFQUFFLFNBQVMsV0FBQSxFQUFFLENBQUMsRUFBRSxDQUFDO1FBQ2hDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxLQUFLLENBQUMsYUFBYSxFQUFFLENBQUE7UUFDbEMsT0FBTTtJQUNSLENBQUM7SUFDRCxTQUFTLENBQUMsR0FBRyxHQUFHLFVBQVUsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUE7SUFDekMsU0FBUyxDQUFDLEdBQUcsR0FBRyxVQUFVLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFBO0lBQ3pDLElBQUksTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLElBQUksTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztRQUMvRCxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRSxDQUFBO1FBQ2xDLE9BQU07SUFDUixDQUFDO0lBRUQsSUFBSSxXQUFXLEVBQUUsQ0FBQztRQUNoQixTQUFTLENBQUMsR0FBRyxJQUFJLFdBQVcsQ0FBQyxTQUFTLENBQUE7UUFDdEMsU0FBUyxDQUFDLEdBQUcsSUFBSSxXQUFXLENBQUMsUUFBUSxDQUFBO0lBQ3ZDLENBQUM7SUFFRCxJQUFJLFNBQVMsQ0FBQTtJQUViLElBQUksTUFBTSxFQUFFLENBQUM7UUFDWCxTQUFTLEdBQUcsSUFBSyxVQUFVLENBQUMsZUFBdUIsQ0FBQztZQUNsRCxNQUFNLEVBQUUsTUFBTSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRSxTQUFTLENBQUMsR0FBRyxDQUFDO1lBQ25FLE1BQU0sRUFBRSxhQUFhLENBQUMsbUJBQW1CLENBQ3ZDLFNBQVMsQ0FBQyxNQUFNLEVBQ2hCLFNBQVMsQ0FBQyxXQUFXLENBQ3RCO1lBQ0QsTUFBTSxFQUFFLENBQUM7WUFDVCxFQUFFLElBQUE7WUFDRixRQUFRLEVBQUUsTUFBTSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFO2dCQUMxQyxLQUFLLEVBQUUsTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxDQUFDO2FBQ3JELENBQUM7U0FDSCxDQUFDLENBQUE7UUFDRixTQUFTLENBQUMsV0FBVyxFQUFFLENBQUE7UUFDdkIsU0FBUyxDQUFDLFdBQVcsQ0FBQyxVQUFVLEVBQUUsVUFBVSxLQUFVO1lBQ3BELElBQU0sTUFBTSxHQUFHLGtCQUFrQixDQUMvQixLQUFLLENBQUMsTUFBTSxFQUNaLEtBQUssQ0FBQyxNQUFNLEVBQ1osR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUNuQyxDQUFBO1lBQ0QsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQ2hCLENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQztTQUFNLENBQUM7UUFDTixJQUFNLEtBQUssR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBRWhDLElBQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO1FBQzNELElBQU0sYUFBYSxHQUFHLFVBQVUsQ0FDOUIsUUFBUSxFQUNSLGFBQWEsQ0FBQyxtQkFBbUIsQ0FDL0IsU0FBUyxDQUFDLE1BQU0sRUFDaEIsU0FBUyxDQUFDLFdBQVcsQ0FDdEIsRUFDRCxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxDQUMvQixDQUFBO1FBRUQsU0FBUyxHQUFHLElBQUksTUFBTSxDQUFDLGtCQUFrQixFQUFFLENBQUE7UUFDM0MsU0FBUyxDQUFDLEdBQUcsQ0FBQztZQUNaLEtBQUssRUFBRSxhQUFhLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUM3QixRQUFRLEVBQUUsTUFBTSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsaUJBQWlCLEVBQUU7Z0JBQ3BELEtBQUssRUFBRSxhQUFhO29CQUNsQixDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxnQkFBZ0IsQ0FBQztvQkFDbkQsQ0FBQyxDQUFDLEtBQUs7d0JBQ1AsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDO3dCQUN4QyxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLO2dCQUN0QixZQUFZLEVBQUUsTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLO2dCQUNoQyxZQUFZLEVBQUUsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDcEMsQ0FBQztZQUNGLEVBQUUsRUFBRSxhQUFhO1lBQ2pCLFNBQVMsRUFBRSxNQUFNLENBQUMsVUFBVSxDQUFDLGdCQUFnQixDQUMzQyxDQUFDLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQzlDO1NBQ0YsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUVELFNBQVMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFBO0lBQ2pCLFNBQVMsQ0FBQyxVQUFVLEdBQUcsU0FBUyxDQUFDLFVBQVUsQ0FBQTtJQUMzQyxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUE7SUFDNUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDLEtBQUssQ0FBQyxhQUFhLEVBQUUsQ0FBQTtBQUNwQyxDQUFDLENBQUE7QUFFRCxJQUFNLGtCQUFrQixHQUFHLFVBQUMsRUFJM0I7UUFIQyxHQUFHLFNBQUE7SUFJRyxJQUFBLEtBQUEsT0FBd0MsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBQSxFQUF4RCxlQUFlLFFBQUEsRUFBRSxrQkFBa0IsUUFBcUIsQ0FBQTtJQUN6RCxJQUFBLEtBQUEsT0FBMEIsS0FBSyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsSUFBQSxFQUE5QyxRQUFRLFFBQUEsRUFBRSxXQUFXLFFBQXlCLENBQUE7SUFDckQsSUFBTSxNQUFNLEdBQUcsU0FBUyxFQUFFLENBQUE7SUFDMUIsS0FBSyxDQUFDLFNBQVMsQ0FBQztRQUNkLElBQU0sYUFBYSxHQUFHLGNBQU0sT0FBQSxXQUFXLENBQUMsSUFBSSxDQUFDLEVBQWpCLENBQWlCLENBQUE7UUFDN0MsSUFBTSxXQUFXLEdBQUcsY0FBTSxPQUFBLFdBQVcsQ0FBQyxLQUFLLENBQUMsRUFBbEIsQ0FBa0IsQ0FBQTtRQUM1QyxHQUFHLGFBQUgsR0FBRyx1QkFBSCxHQUFHLENBQUUsTUFBTSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLGdCQUFnQixDQUFDLGFBQWEsQ0FBQyxDQUFBO1FBQ3BFLEdBQUcsYUFBSCxHQUFHLHVCQUFILEdBQUcsQ0FBRSxNQUFNLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLENBQUE7UUFDaEUsT0FBTztZQUNMLEdBQUcsYUFBSCxHQUFHLHVCQUFILEdBQUcsQ0FBRSxNQUFNLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsbUJBQW1CLENBQUMsYUFBYSxDQUFDLENBQUE7WUFDdkUsR0FBRyxhQUFILEdBQUcsdUJBQUgsR0FBRyxDQUFFLE1BQU0sR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxXQUFXLENBQUMsQ0FBQTtRQUNyRSxDQUFDLENBQUE7SUFDSCxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO0lBQ1QsS0FBSyxDQUFDLFNBQVMsQ0FBQztRQUNkLElBQUksUUFBUSxFQUFFLENBQUM7WUFDYixJQUFNLGFBQVcsR0FBRyxNQUFNLENBQUMscUJBQXFCLENBQUM7Z0JBQy9DLGtCQUFrQixDQUFDLDBCQUEwQixDQUFDLEVBQUUsR0FBRyxLQUFBLEVBQUUsQ0FBQyxDQUFDLENBQUE7WUFDekQsQ0FBQyxDQUFDLENBQUE7WUFDRixPQUFPO2dCQUNMLE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxhQUFXLENBQUMsQ0FBQTtZQUMxQyxDQUFDLENBQUE7UUFDSCxDQUFDO1FBQ0QsT0FBTyxjQUFPLENBQUMsQ0FBQTtJQUNqQixDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQTtJQUN0QixPQUFPLENBQUMsZUFBZSxFQUFFLGtCQUFrQixDQUFDLENBQUE7QUFDOUMsQ0FBQyxDQUFBO0FBRUQsSUFBTSxnQkFBZ0IsR0FBRyxVQUFDLEVBY3pCO1FBYkMsS0FBSyxXQUFBLEVBQ0wsR0FBRyxTQUFBLEVBQ0gsU0FBUyxlQUFBLEVBQ1QsTUFBTSxZQUFBLEVBQ04sV0FBVyxpQkFBQSxFQUNYLGFBQWEsbUJBQUE7SUFTUCxJQUFBLEtBQUEsT0FBb0Isa0JBQWtCLENBQUMsRUFBRSxHQUFHLEtBQUEsRUFBRSxDQUFDLElBQUEsRUFBOUMsZUFBZSxRQUErQixDQUFBO0lBQy9DLElBQUEsS0FBQSxPQUFzQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFBLEVBQXRELGNBQWMsUUFBQSxFQUFFLGlCQUFpQixRQUFxQixDQUFBO0lBQzdELElBQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUM7UUFDN0IsT0FBTztZQUNMLElBQUksR0FBRyxFQUFFLENBQUM7Z0JBQ1IsSUFBSSxTQUFTLEVBQUUsQ0FBQztvQkFDZCxtRUFBbUU7b0JBQ25FLGtFQUFrRTtvQkFDbEUsSUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFBO29CQUM5QixRQUFRLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFBO29CQUN2Qix5QkFBeUIsQ0FBQzt3QkFDeEIsR0FBRyxLQUFBO3dCQUNILEVBQUUsRUFBRSx3QkFBd0IsQ0FBQyxFQUFFLEtBQUssT0FBQSxFQUFFLENBQUM7cUJBQ3hDLENBQUMsQ0FBQTtvQkFDRixZQUFZLENBQUM7d0JBQ1gsR0FBRyxLQUFBO3dCQUNILEtBQUssRUFBRSxRQUFRO3dCQUNmLEVBQUUsRUFBRSx3QkFBd0IsQ0FBQyxFQUFFLEtBQUssT0FBQSxFQUFFLENBQUM7d0JBQ3ZDLGlCQUFpQixtQkFBQTt3QkFDakIsTUFBTSxRQUFBO3FCQUNQLENBQUMsQ0FBQTtnQkFDSixDQUFDO3FCQUFNLElBQUksS0FBSyxFQUFFLENBQUM7b0JBQ2pCLGdCQUFnQixDQUFDLEVBQUUsR0FBRyxLQUFBLEVBQUUsRUFBRSxFQUFFLHdCQUF3QixDQUFDLEVBQUUsS0FBSyxPQUFBLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQTtvQkFDbEUsWUFBWSxDQUFDO3dCQUNYLEdBQUcsS0FBQTt3QkFDSCxLQUFLLE9BQUE7d0JBQ0wsRUFBRSxFQUFFLHdCQUF3QixDQUFDLEVBQUUsS0FBSyxPQUFBLEVBQUUsQ0FBQzt3QkFDdkMsaUJBQWlCLG1CQUFBO3dCQUNqQixNQUFNLFFBQUE7d0JBQ04sV0FBVyxhQUFBO3dCQUNYLGFBQWEsZUFBQTtxQkFDZCxDQUFDLENBQUE7Z0JBQ0osQ0FBQztZQUNILENBQUM7UUFDSCxDQUFDLENBQUE7SUFDSCxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxXQUFXLEVBQUUsYUFBYSxDQUFDLENBQUMsQ0FBQTtJQUN2RCxXQUFXLENBQ1QsS0FBSyxFQUNMLGtEQUFrRCxFQUNsRCxRQUFRLENBQ1QsQ0FBQTtJQUNELEtBQUssQ0FBQyxTQUFTLENBQUM7UUFDZCxJQUFJLEdBQUcsSUFBSSxXQUFXLENBQUMsRUFBRSxHQUFHLEtBQUEsRUFBRSxjQUFjLGdCQUFBLEVBQUUsQ0FBQyxFQUFFLENBQUM7WUFDaEQsUUFBUSxFQUFFLENBQUE7UUFDWixDQUFDO0lBQ0gsQ0FBQyxFQUFFLENBQUMsZUFBZSxFQUFFLGNBQWMsRUFBRSxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQTtJQUNwRCxLQUFLLENBQUMsU0FBUyxDQUFDO1FBQ2QsUUFBUSxFQUFFLENBQUE7SUFDWixDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFBO0FBQ2hCLENBQUMsQ0FBQTtBQUVELElBQU0sa0JBQWtCLEdBQUcsVUFBQyxFQVUzQjtRQVRDLEdBQUcsU0FBQSxFQUNILEtBQUssV0FBQSxFQUNMLFlBQVksa0JBQUEsRUFDWixNQUFNLFlBQUE7SUFPTixLQUFLLENBQUMsU0FBUyxDQUFDO1FBQ2QsSUFBSSxHQUFHLElBQUksS0FBSyxFQUFFLENBQUM7WUFDakIsR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDLFVBQVUsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO2dCQUM1QyxRQUFRLEVBQUUsVUFBQyxNQUF5QixFQUFFLE1BQWM7b0JBQ2xELElBQU0sTUFBTSxHQUFHLGtCQUFrQixDQUMvQixNQUFNLEVBQ04sTUFBTSxFQUNOLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FDbkMsQ0FBQTtvQkFDRCxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUE7b0JBQ3BCLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQTtnQkFDaEIsQ0FBQztnQkFDRCxRQUFRLEVBQUUsTUFBTSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFO29CQUMxQyxLQUFLLEVBQUUsTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxDQUFDO2lCQUNyRCxDQUFDO2FBQ0gsQ0FBQyxDQUFBO1FBQ0osQ0FBQztJQUNILENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFBO0FBQ2xCLENBQUMsQ0FBQTtBQUVELE1BQU0sQ0FBQyxJQUFNLG1CQUFtQixHQUFHLFVBQUMsRUFZbkM7UUFYQyxHQUFHLFNBQUEsRUFDSCxLQUFLLFdBQUEsRUFDTCxNQUFNLFlBQUEsRUFDTixXQUFXLGlCQUFBLEVBQ1gsYUFBYSxtQkFBQTtJQVFiLHFGQUFxRjtJQUNyRixpRkFBaUY7SUFDakYsdUZBQXVGO0lBQ3ZGLDhFQUE4RTtJQUM5RSxnQ0FBZ0M7SUFDMUIsSUFBQSxLQUFBLE9BQTRCLEtBQUssQ0FBQyxRQUFRLENBQWdCLElBQUksQ0FBQyxJQUFBLEVBQTlELFNBQVMsUUFBQSxFQUFFLFlBQVksUUFBdUMsQ0FBQTtJQUNyRSxJQUFJLE1BQU0sRUFBRSxDQUFDO1FBQ1gsa0JBQWtCLENBQUMsRUFBRSxHQUFHLEtBQUEsRUFBRSxLQUFLLE9BQUEsRUFBRSxZQUFZLGNBQUEsRUFBRSxNQUFNLFFBQUEsRUFBRSxDQUFDLENBQUE7SUFDMUQsQ0FBQztJQUNELGdCQUFnQixDQUFDO1FBQ2YsR0FBRyxLQUFBO1FBQ0gsS0FBSyxPQUFBO1FBQ0wsU0FBUyxXQUFBO1FBQ1QsTUFBTSxRQUFBO1FBQ04sV0FBVyxhQUFBO1FBQ1gsYUFBYSxlQUFBO0tBQ2QsQ0FBQyxDQUFBO0lBQ0YsS0FBSyxDQUFDLFNBQVMsQ0FBQztRQUNkLE9BQU87WUFDTCxJQUFJLEtBQUssSUFBSSxHQUFHLEVBQUUsQ0FBQztnQkFDakIsZ0JBQWdCLENBQUMsRUFBRSxHQUFHLEtBQUEsRUFBRSxFQUFFLEVBQUUsd0JBQXdCLENBQUMsRUFBRSxLQUFLLE9BQUEsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFBO2dCQUNsRSxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUMsVUFBVSxDQUFDLFdBQVcsRUFBRSxDQUFBO1lBQ3ZDLENBQUM7UUFDSCxDQUFDLENBQUE7SUFDSCxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQTtJQUNoQixPQUFPLG1CQUFLLENBQUE7QUFDZCxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAoYykgQ29kaWNlIEZvdW5kYXRpb25cbiAqXG4gKiBUaGlzIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgTGVzc2VyXG4gKiBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieSB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZVxuICogTGljZW5zZSwgb3IgYW55IGxhdGVyIHZlcnNpb24uXG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dFxuICogZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuIFNlZSB0aGUgR05VXG4gKiBMZXNzZXIgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLiBBIGNvcHkgb2YgdGhlIEdOVSBMZXNzZXIgR2VuZXJhbCBQdWJsaWMgTGljZW5zZVxuICogaXMgZGlzdHJpYnV0ZWQgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0gYW5kIGNhbiBiZSBmb3VuZCBhdFxuICogPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy9sZ3BsLmh0bWw+LlxuICpcbiAqKi9cbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCdcbmltcG9ydCBEaXN0YW5jZVV0aWxzIGZyb20gJy4uLy4uLy4uLy4uL2pzL0Rpc3RhbmNlVXRpbHMnXG4vLyBAdHMtZXhwZWN0LWVycm9yIHRzLW1pZ3JhdGUoNzAxNikgRklYTUU6IENvdWxkIG5vdCBmaW5kIGEgZGVjbGFyYXRpb24gZmlsZSBmb3IgbW9kdWxlICdjZXNpLi4uIFJlbW92ZSB0aGlzIGNvbW1lbnQgdG8gc2VlIHRoZSBmdWxsIGVycm9yIG1lc3NhZ2VcbmltcG9ydCBDZXNpdW0gZnJvbSAnY2VzaXVtL0J1aWxkL0Nlc2l1bS9DZXNpdW0nXG5pbXBvcnQgXyBmcm9tICd1bmRlcnNjb3JlJ1xuaW1wb3J0ICogYXMgVHVyZiBmcm9tICdAdHVyZi90dXJmJ1xuaW1wb3J0IHsgdXNlTGlzdGVuVG8gfSBmcm9tICcuLi8uLi8uLi9zZWxlY3Rpb24tY2hlY2tib3gvdXNlQmFja2JvbmUuaG9vaydcbmltcG9ydCB7IHVzZVJlbmRlciB9IGZyb20gJy4uLy4uLy4uL2hvb2tzL3VzZVJlbmRlcidcbmltcG9ydCB7XG4gIHJlbW92ZU9sZERyYXdpbmcsXG4gIG1ha2VPbGREcmF3aW5nTm9uRWRpdGFibGUsXG59IGZyb20gJy4vZHJhd2luZy1hbmQtZGlzcGxheSdcbmltcG9ydCB7IGdldElkRnJvbU1vZGVsRm9yRGlzcGxheSB9IGZyb20gJy4uL2RyYXdpbmctYW5kLWRpc3BsYXknXG5pbXBvcnQgVHVyZkNpcmNsZSBmcm9tICdAdHVyZi9jaXJjbGUnXG5pbXBvcnQgRHJhd0hlbHBlciBmcm9tICcuLi8uLi8uLi8uLi9saWIvY2VzaXVtLWRyYXdoZWxwZXIvRHJhd0hlbHBlcidcbmltcG9ydCB7IGNvbnRyYXN0aW5nQ29sb3IgfSBmcm9tICcuLi8uLi8uLi8uLi9yZWFjdC1jb21wb25lbnQvbG9jYXRpb24vbG9jYXRpb24tY29sb3Itc2VsZWN0b3InXG5pbXBvcnQgeyBUcmFuc2xhdGlvbiB9IGZyb20gJy4uL2ludGVyYWN0aW9ucy5wcm92aWRlcidcbmNvbnN0IHRvRGVnID0gQ2VzaXVtLk1hdGgudG9EZWdyZWVzXG5cbmNvbnN0IENBTUVSQV9NQUdOSVRVREVfVEhSRVNIT0xEID0gODAwMDAwMFxuXG50eXBlIENpcmNsZSA9IHtcbiAgbG9uOiBudW1iZXJcbiAgbGF0OiBudW1iZXJcbiAgcmFkaXVzOiBudW1iZXJcbiAgcmFkaXVzVW5pdHM6IHN0cmluZ1xufVxuXG5jb25zdCBnZXRDdXJyZW50TWFnbml0dWRlRnJvbU1hcCA9ICh7IG1hcCB9OiB7IG1hcDogYW55IH0pID0+IHtcbiAgcmV0dXJuIG1hcC5nZXRNYXAoKS5jYW1lcmEuZ2V0TWFnbml0dWRlKClcbn1cblxuY29uc3QgbmVlZHNSZWRyYXcgPSAoe1xuICBtYXAsXG4gIGRyYXduTWFnbml0dWRlLFxufToge1xuICBtYXA6IGFueVxuICBkcmF3bk1hZ25pdHVkZTogYW55XG59KSA9PiB7XG4gIGNvbnN0IGN1cnJlbnRNYWduaXR1ZGUgPSBnZXRDdXJyZW50TWFnbml0dWRlRnJvbU1hcCh7IG1hcCB9KVxuXG4gIGlmIChcbiAgICBjdXJyZW50TWFnbml0dWRlIDwgQ0FNRVJBX01BR05JVFVERV9USFJFU0hPTEQgJiZcbiAgICBkcmF3bk1hZ25pdHVkZSA+IENBTUVSQV9NQUdOSVRVREVfVEhSRVNIT0xEXG4gICkge1xuICAgIHJldHVybiB0cnVlXG4gIH1cbiAgaWYgKFxuICAgIGN1cnJlbnRNYWduaXR1ZGUgPiBDQU1FUkFfTUFHTklUVURFX1RIUkVTSE9MRCAmJlxuICAgIGRyYXduTWFnbml0dWRlIDwgQ0FNRVJBX01BR05JVFVERV9USFJFU0hPTERcbiAgKSB7XG4gICAgcmV0dXJuIHRydWVcbiAgfVxuXG4gIHJldHVybiBmYWxzZVxufVxuXG5jb25zdCBkZWZhdWx0QXR0cnMgPSBbJ2xhdCcsICdsb24nLCAncmFkaXVzJ11cblxuY29uc3QgaXNNb2RlbFJlc2V0ID0gKHsgbW9kZWxQcm9wIH06IHsgbW9kZWxQcm9wOiBhbnkgfSkgPT4ge1xuICBpZiAoXG4gICAgXy5ldmVyeShkZWZhdWx0QXR0cnMsICh2YWw6IGFueSkgPT4gXy5pc1VuZGVmaW5lZChtb2RlbFByb3BbdmFsXSkpIHx8XG4gICAgXy5pc0VtcHR5KG1vZGVsUHJvcClcbiAgKSB7XG4gICAgcmV0dXJuIHRydWVcbiAgfVxuICByZXR1cm4gZmFsc2Vcbn1cblxuY29uc3QgY2FydGVzaWFuM1RvQ2lyY2xlID0gKFxuICBjZW50ZXI6IENlc2l1bS5DYXJ0ZXNpYW4zLFxuICByYWRpdXM6IG51bWJlcixcbiAgZWxsaXBzb2lkOiBDZXNpdW0uRWxsaXBzb2lkXG4pOiBDaXJjbGUgPT4ge1xuICBjb25zdCBsYXRMb24gPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoY2VudGVyKVxuICBjb25zdCBsb24gPSB0b0RlZyhsYXRMb24ubG9uZ2l0dWRlKVxuICBjb25zdCBsYXQgPSB0b0RlZyhsYXRMb24ubGF0aXR1ZGUpXG4gIGxldCByYWRpdXNVbml0cyA9ICdtZXRlcnMnXG4gIGlmIChyYWRpdXMgPj0gMTAwMCkge1xuICAgIHJhZGl1cyAvPSAxMDAwXG4gICAgcmFkaXVzVW5pdHMgPSAna2lsb21ldGVycydcbiAgfVxuICByZXR1cm4ge1xuICAgIGxvbjogRGlzdGFuY2VVdGlscy5jb29yZGluYXRlUm91bmQobG9uKSxcbiAgICBsYXQ6IERpc3RhbmNlVXRpbHMuY29vcmRpbmF0ZVJvdW5kKGxhdCksXG4gICAgcmFkaXVzLFxuICAgIHJhZGl1c1VuaXRzLFxuICB9XG59XG5cbmNvbnN0IGRyYXdHZW9tZXRyeSA9ICh7XG4gIG1vZGVsLFxuICBtYXAsXG4gIGlkLFxuICBvbkRyYXcsXG4gIHRyYW5zbGF0aW9uLFxuICBpc0ludGVyYWN0aXZlLFxufToge1xuICBtb2RlbDogYW55XG4gIG1hcDogYW55XG4gIGlkOiBhbnlcbiAgc2V0RHJhd25NYWduaXR1ZGU6IChudW1iZXI6IGFueSkgPT4gdm9pZFxuICBvbkRyYXc/OiAoZHJhd2luZ0xvY2F0aW9uOiBDaXJjbGUpID0+IHZvaWRcbiAgdHJhbnNsYXRpb24/OiBUcmFuc2xhdGlvblxuICBpc0ludGVyYWN0aXZlPzogYm9vbGVhbiAvLyBub3RlOiAnaW50ZXJhY3RpdmUnIGlzIGRpZmZlcmVudCBmcm9tIGRyYXdpbmdcbn0pID0+IHtcbiAgLy8gaWYgbW9kZWwgaGFzIGJlZW4gcmVzZXRcblxuICBjb25zdCBtb2RlbFByb3AgPSBtb2RlbC50b0pTT04oKVxuICBpZiAoaXNNb2RlbFJlc2V0KHsgbW9kZWxQcm9wIH0pKSB7XG4gICAgbWFwLmdldE1hcCgpLnNjZW5lLnJlcXVlc3RSZW5kZXIoKVxuICAgIHJldHVyblxuICB9XG4gIG1vZGVsUHJvcC5sYXQgPSBwYXJzZUZsb2F0KG1vZGVsUHJvcC5sYXQpXG4gIG1vZGVsUHJvcC5sb24gPSBwYXJzZUZsb2F0KG1vZGVsUHJvcC5sb24pXG4gIGlmIChOdW1iZXIuaXNOYU4obW9kZWxQcm9wLmxhdCkgfHwgTnVtYmVyLmlzTmFOKG1vZGVsUHJvcC5sb24pKSB7XG4gICAgbWFwLmdldE1hcCgpLnNjZW5lLnJlcXVlc3RSZW5kZXIoKVxuICAgIHJldHVyblxuICB9XG5cbiAgaWYgKHRyYW5zbGF0aW9uKSB7XG4gICAgbW9kZWxQcm9wLmxvbiArPSB0cmFuc2xhdGlvbi5sb25naXR1ZGVcbiAgICBtb2RlbFByb3AubGF0ICs9IHRyYW5zbGF0aW9uLmxhdGl0dWRlXG4gIH1cblxuICBsZXQgcHJpbWl0aXZlXG5cbiAgaWYgKG9uRHJhdykge1xuICAgIHByaW1pdGl2ZSA9IG5ldyAoRHJhd0hlbHBlci5DaXJjbGVQcmltaXRpdmUgYXMgYW55KSh7XG4gICAgICBjZW50ZXI6IENlc2l1bS5DYXJ0ZXNpYW4zLmZyb21EZWdyZWVzKG1vZGVsUHJvcC5sb24sIG1vZGVsUHJvcC5sYXQpLFxuICAgICAgcmFkaXVzOiBEaXN0YW5jZVV0aWxzLmdldERpc3RhbmNlSW5NZXRlcnMoXG4gICAgICAgIG1vZGVsUHJvcC5yYWRpdXMsXG4gICAgICAgIG1vZGVsUHJvcC5yYWRpdXNVbml0c1xuICAgICAgKSxcbiAgICAgIGhlaWdodDogMCxcbiAgICAgIGlkLFxuICAgICAgbWF0ZXJpYWw6IENlc2l1bS5NYXRlcmlhbC5mcm9tVHlwZSgnQ29sb3InLCB7XG4gICAgICAgIGNvbG9yOiBDZXNpdW0uQ29sb3IuZnJvbUFscGhhKGNvbnRyYXN0aW5nQ29sb3IsIDAuMiksXG4gICAgICB9KSxcbiAgICB9KVxuICAgIHByaW1pdGl2ZS5zZXRFZGl0YWJsZSgpXG4gICAgcHJpbWl0aXZlLmFkZExpc3RlbmVyKCdvbkVkaXRlZCcsIGZ1bmN0aW9uIChldmVudDogYW55KSB7XG4gICAgICBjb25zdCBjaXJjbGUgPSBjYXJ0ZXNpYW4zVG9DaXJjbGUoXG4gICAgICAgIGV2ZW50LmNlbnRlcixcbiAgICAgICAgZXZlbnQucmFkaXVzLFxuICAgICAgICBtYXAuZ2V0TWFwKCkuc2NlbmUuZ2xvYmUuZWxsaXBzb2lkXG4gICAgICApXG4gICAgICBvbkRyYXcoY2lyY2xlKVxuICAgIH0pXG4gIH0gZWxzZSB7XG4gICAgY29uc3QgY29sb3IgPSBtb2RlbC5nZXQoJ2NvbG9yJylcblxuICAgIGNvbnN0IGNlbnRlclB0ID0gVHVyZi5wb2ludChbbW9kZWxQcm9wLmxvbiwgbW9kZWxQcm9wLmxhdF0pXG4gICAgY29uc3QgY2lyY2xlVG9DaGVjayA9IFR1cmZDaXJjbGUoXG4gICAgICBjZW50ZXJQdCxcbiAgICAgIERpc3RhbmNlVXRpbHMuZ2V0RGlzdGFuY2VJbk1ldGVycyhcbiAgICAgICAgbW9kZWxQcm9wLnJhZGl1cyxcbiAgICAgICAgbW9kZWxQcm9wLnJhZGl1c1VuaXRzXG4gICAgICApLFxuICAgICAgeyB1bml0czogJ21ldGVycycsIHN0ZXBzOiA2NCB9XG4gICAgKVxuXG4gICAgcHJpbWl0aXZlID0gbmV3IENlc2l1bS5Qb2x5bGluZUNvbGxlY3Rpb24oKVxuICAgIHByaW1pdGl2ZS5hZGQoe1xuICAgICAgd2lkdGg6IGlzSW50ZXJhY3RpdmUgPyAxMiA6IDgsXG4gICAgICBtYXRlcmlhbDogQ2VzaXVtLk1hdGVyaWFsLmZyb21UeXBlKCdQb2x5bGluZU91dGxpbmUnLCB7XG4gICAgICAgIGNvbG9yOiBpc0ludGVyYWN0aXZlXG4gICAgICAgICAgPyBDZXNpdW0uQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKGNvbnRyYXN0aW5nQ29sb3IpXG4gICAgICAgICAgOiBjb2xvclxuICAgICAgICAgID8gQ2VzaXVtLkNvbG9yLmZyb21Dc3NDb2xvclN0cmluZyhjb2xvcilcbiAgICAgICAgICA6IENlc2l1bS5Db2xvci5LSEFLSSxcbiAgICAgICAgb3V0bGluZUNvbG9yOiBDZXNpdW0uQ29sb3IuV0hJVEUsXG4gICAgICAgIG91dGxpbmVXaWR0aDogaXNJbnRlcmFjdGl2ZSA/IDYgOiA0LFxuICAgICAgfSksXG4gICAgICBpZDogJ3VzZXJEcmF3aW5nJyxcbiAgICAgIHBvc2l0aW9uczogQ2VzaXVtLkNhcnRlc2lhbjMuZnJvbURlZ3JlZXNBcnJheShcbiAgICAgICAgXy5mbGF0dGVuKGNpcmNsZVRvQ2hlY2suZ2VvbWV0cnkuY29vcmRpbmF0ZXMpXG4gICAgICApLFxuICAgIH0pXG4gIH1cblxuICBwcmltaXRpdmUuaWQgPSBpZFxuICBwcmltaXRpdmUubG9jYXRpb25JZCA9IG1vZGVsUHJvcC5sb2NhdGlvbklkXG4gIG1hcC5nZXRNYXAoKS5zY2VuZS5wcmltaXRpdmVzLmFkZChwcmltaXRpdmUpXG4gIG1hcC5nZXRNYXAoKS5zY2VuZS5yZXF1ZXN0UmVuZGVyKClcbn1cblxuY29uc3QgdXNlQ2FtZXJhTWFnbml0dWRlID0gKHtcbiAgbWFwLFxufToge1xuICBtYXA6IGFueVxufSk6IFtudW1iZXIsIFJlYWN0LkRpc3BhdGNoPFJlYWN0LlNldFN0YXRlQWN0aW9uPG51bWJlcj4+XSA9PiB7XG4gIGNvbnN0IFtjYW1lcmFNYWduaXR1ZGUsIHNldENhbWVyYU1hZ25pdHVkZV0gPSBSZWFjdC51c2VTdGF0ZSgwKVxuICBjb25zdCBbaXNNb3ZpbmcsIHNldElzTW92aW5nXSA9IFJlYWN0LnVzZVN0YXRlKGZhbHNlKVxuICBjb25zdCByZW5kZXIgPSB1c2VSZW5kZXIoKVxuICBSZWFjdC51c2VFZmZlY3QoKCkgPT4ge1xuICAgIGNvbnN0IHN0YXJ0TGlzdGVuZXIgPSAoKSA9PiBzZXRJc01vdmluZyh0cnVlKVxuICAgIGNvbnN0IGVuZExpc3RlbmVyID0gKCkgPT4gc2V0SXNNb3ZpbmcoZmFsc2UpXG4gICAgbWFwPy5nZXRNYXAoKS5zY2VuZS5jYW1lcmEubW92ZVN0YXJ0LmFkZEV2ZW50TGlzdGVuZXIoc3RhcnRMaXN0ZW5lcilcbiAgICBtYXA/LmdldE1hcCgpLnNjZW5lLmNhbWVyYS5tb3ZlRW5kLmFkZEV2ZW50TGlzdGVuZXIoZW5kTGlzdGVuZXIpXG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIG1hcD8uZ2V0TWFwKCkuc2NlbmUuY2FtZXJhLm1vdmVTdGFydC5yZW1vdmVFdmVudExpc3RlbmVyKHN0YXJ0TGlzdGVuZXIpXG4gICAgICBtYXA/LmdldE1hcCgpLnNjZW5lLmNhbWVyYS5tb3ZlRW5kLnJlbW92ZUV2ZW50TGlzdGVuZXIoZW5kTGlzdGVuZXIpXG4gICAgfVxuICB9LCBbbWFwXSlcbiAgUmVhY3QudXNlRWZmZWN0KCgpID0+IHtcbiAgICBpZiAoaXNNb3ZpbmcpIHtcbiAgICAgIGNvbnN0IGFuaW1hdGlvbklkID0gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XG4gICAgICAgIHNldENhbWVyYU1hZ25pdHVkZShnZXRDdXJyZW50TWFnbml0dWRlRnJvbU1hcCh7IG1hcCB9KSlcbiAgICAgIH0pXG4gICAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgICB3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUoYW5pbWF0aW9uSWQpXG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiAoKSA9PiB7fVxuICB9LCBbaXNNb3ZpbmcsIHJlbmRlcl0pXG4gIHJldHVybiBbY2FtZXJhTWFnbml0dWRlLCBzZXRDYW1lcmFNYWduaXR1ZGVdXG59XG5cbmNvbnN0IHVzZUxpc3RlblRvTW9kZWwgPSAoe1xuICBtb2RlbCxcbiAgbWFwLFxuICBuZXdDaXJjbGUsXG4gIG9uRHJhdyxcbiAgdHJhbnNsYXRpb24sXG4gIGlzSW50ZXJhY3RpdmUsXG59OiB7XG4gIG1vZGVsOiBhbnlcbiAgbWFwOiBhbnlcbiAgbmV3Q2lyY2xlOiBDaXJjbGUgfCBudWxsXG4gIG9uRHJhdz86IChkcmF3aW5nTG9jYXRpb246IENpcmNsZSkgPT4gdm9pZFxuICB0cmFuc2xhdGlvbj86IFRyYW5zbGF0aW9uXG4gIGlzSW50ZXJhY3RpdmU/OiBib29sZWFuIC8vIG5vdGU6ICdpbnRlcmFjdGl2ZScgaXMgZGlmZmVyZW50IGZyb20gZHJhd2luZ1xufSkgPT4ge1xuICBjb25zdCBbY2FtZXJhTWFnbml0dWRlXSA9IHVzZUNhbWVyYU1hZ25pdHVkZSh7IG1hcCB9KVxuICBjb25zdCBbZHJhd25NYWduaXR1ZGUsIHNldERyYXduTWFnbml0dWRlXSA9IFJlYWN0LnVzZVN0YXRlKDApXG4gIGNvbnN0IGNhbGxiYWNrID0gUmVhY3QudXNlTWVtbygoKSA9PiB7XG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIGlmIChtYXApIHtcbiAgICAgICAgaWYgKG5ld0NpcmNsZSkge1xuICAgICAgICAgIC8vIENsb25lIHRoZSBtb2RlbCB0byBkaXNwbGF5IHRoZSBuZXcgY2lyY2xlIGRyYXduIGJlY2F1c2Ugd2UgZG9uJ3RcbiAgICAgICAgICAvLyB3YW50IHRvIHVwZGF0ZSB0aGUgZXhpc3RpbmcgbW9kZWwgdW5sZXNzIHRoZSB1c2VyIGNsaWNrcyBBcHBseS5cbiAgICAgICAgICBjb25zdCBuZXdNb2RlbCA9IG1vZGVsLmNsb25lKClcbiAgICAgICAgICBuZXdNb2RlbC5zZXQobmV3Q2lyY2xlKVxuICAgICAgICAgIG1ha2VPbGREcmF3aW5nTm9uRWRpdGFibGUoe1xuICAgICAgICAgICAgbWFwLFxuICAgICAgICAgICAgaWQ6IGdldElkRnJvbU1vZGVsRm9yRGlzcGxheSh7IG1vZGVsIH0pLFxuICAgICAgICAgIH0pXG4gICAgICAgICAgZHJhd0dlb21ldHJ5KHtcbiAgICAgICAgICAgIG1hcCxcbiAgICAgICAgICAgIG1vZGVsOiBuZXdNb2RlbCxcbiAgICAgICAgICAgIGlkOiBnZXRJZEZyb21Nb2RlbEZvckRpc3BsYXkoeyBtb2RlbCB9KSxcbiAgICAgICAgICAgIHNldERyYXduTWFnbml0dWRlLFxuICAgICAgICAgICAgb25EcmF3LFxuICAgICAgICAgIH0pXG4gICAgICAgIH0gZWxzZSBpZiAobW9kZWwpIHtcbiAgICAgICAgICByZW1vdmVPbGREcmF3aW5nKHsgbWFwLCBpZDogZ2V0SWRGcm9tTW9kZWxGb3JEaXNwbGF5KHsgbW9kZWwgfSkgfSlcbiAgICAgICAgICBkcmF3R2VvbWV0cnkoe1xuICAgICAgICAgICAgbWFwLFxuICAgICAgICAgICAgbW9kZWwsXG4gICAgICAgICAgICBpZDogZ2V0SWRGcm9tTW9kZWxGb3JEaXNwbGF5KHsgbW9kZWwgfSksXG4gICAgICAgICAgICBzZXREcmF3bk1hZ25pdHVkZSxcbiAgICAgICAgICAgIG9uRHJhdyxcbiAgICAgICAgICAgIHRyYW5zbGF0aW9uLFxuICAgICAgICAgICAgaXNJbnRlcmFjdGl2ZSxcbiAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9LCBbbW9kZWwsIG1hcCwgbmV3Q2lyY2xlLCB0cmFuc2xhdGlvbiwgaXNJbnRlcmFjdGl2ZV0pXG4gIHVzZUxpc3RlblRvKFxuICAgIG1vZGVsLFxuICAgICdjaGFuZ2U6bGF0IGNoYW5nZTpsb24gY2hhbmdlOnJhZGl1cyBjaGFuZ2U6Y29sb3InLFxuICAgIGNhbGxiYWNrXG4gIClcbiAgUmVhY3QudXNlRWZmZWN0KCgpID0+IHtcbiAgICBpZiAobWFwICYmIG5lZWRzUmVkcmF3KHsgbWFwLCBkcmF3bk1hZ25pdHVkZSB9KSkge1xuICAgICAgY2FsbGJhY2soKVxuICAgIH1cbiAgfSwgW2NhbWVyYU1hZ25pdHVkZSwgZHJhd25NYWduaXR1ZGUsIGNhbGxiYWNrLCBtYXBdKVxuICBSZWFjdC51c2VFZmZlY3QoKCkgPT4ge1xuICAgIGNhbGxiYWNrKClcbiAgfSwgW2NhbGxiYWNrXSlcbn1cblxuY29uc3QgdXNlU3RhcnRNYXBEcmF3aW5nID0gKHtcbiAgbWFwLFxuICBtb2RlbCxcbiAgc2V0TmV3Q2lyY2xlLFxuICBvbkRyYXcsXG59OiB7XG4gIG1hcDogYW55XG4gIG1vZGVsOiBhbnlcbiAgc2V0TmV3Q2lyY2xlOiAobmV3Q2lyY2xlOiBDaXJjbGUpID0+IHZvaWRcbiAgb25EcmF3OiAobmV3Q2lyY2xlOiBDaXJjbGUpID0+IHZvaWRcbn0pID0+IHtcbiAgUmVhY3QudXNlRWZmZWN0KCgpID0+IHtcbiAgICBpZiAobWFwICYmIG1vZGVsKSB7XG4gICAgICBtYXAuZ2V0TWFwKCkuZHJhd0hlbHBlcltgc3RhcnREcmF3aW5nQ2lyY2xlYF0oe1xuICAgICAgICBjYWxsYmFjazogKGNlbnRlcjogQ2VzaXVtLkNhcnRlc2lhbjMsIHJhZGl1czogbnVtYmVyKSA9PiB7XG4gICAgICAgICAgY29uc3QgY2lyY2xlID0gY2FydGVzaWFuM1RvQ2lyY2xlKFxuICAgICAgICAgICAgY2VudGVyLFxuICAgICAgICAgICAgcmFkaXVzLFxuICAgICAgICAgICAgbWFwLmdldE1hcCgpLnNjZW5lLmdsb2JlLmVsbGlwc29pZFxuICAgICAgICAgIClcbiAgICAgICAgICBzZXROZXdDaXJjbGUoY2lyY2xlKVxuICAgICAgICAgIG9uRHJhdyhjaXJjbGUpXG4gICAgICAgIH0sXG4gICAgICAgIG1hdGVyaWFsOiBDZXNpdW0uTWF0ZXJpYWwuZnJvbVR5cGUoJ0NvbG9yJywge1xuICAgICAgICAgIGNvbG9yOiBDZXNpdW0uQ29sb3IuZnJvbUFscGhhKGNvbnRyYXN0aW5nQ29sb3IsIDAuMiksXG4gICAgICAgIH0pLFxuICAgICAgfSlcbiAgICB9XG4gIH0sIFttYXAsIG1vZGVsXSlcbn1cblxuZXhwb3J0IGNvbnN0IENlc2l1bUNpcmNsZURpc3BsYXkgPSAoe1xuICBtYXAsXG4gIG1vZGVsLFxuICBvbkRyYXcsXG4gIHRyYW5zbGF0aW9uLFxuICBpc0ludGVyYWN0aXZlLFxufToge1xuICBtYXA6IGFueVxuICBtb2RlbDogYW55XG4gIG9uRHJhdz86IChuZXdDaXJjbGU6IENpcmNsZSkgPT4gdm9pZFxuICB0cmFuc2xhdGlvbj86IFRyYW5zbGF0aW9uXG4gIGlzSW50ZXJhY3RpdmU/OiBib29sZWFuIC8vIG5vdGU6ICdpbnRlcmFjdGl2ZScgaXMgZGlmZmVyZW50IGZyb20gZHJhd2luZ1xufSkgPT4ge1xuICAvLyBVc2Ugc3RhdGUgdG8gc3RvcmUgdGhlIGNpcmNsZSBkcmF3biBieSB0aGUgdXNlciBiZWZvcmUgdGhleSBjbGljayBBcHBseSBvciBDYW5jZWwuXG4gIC8vIFdoZW4gdGhlIHVzZXIgY2xpY2tzIERyYXcsIHRoZXkgYXJlIGFsbG93ZWQgdG8gZWRpdCB0aGUgZXhpc3RpbmcgY2lyY2xlIChpZiBpdFxuICAvLyBleGlzdHMpLCBvciBkcmF3IGEgbmV3IGNpcmNsZS4gSWYgdGhleSBkcmF3IGEgbmV3IGNpcmNsZSwgc2F2ZSBpdCB0byBzdGF0ZSB0aGVuIHNob3dcbiAgLy8gaXQgaW5zdGVhZCBvZiB0aGUgZHJhdyBtb2RlbCBiZWNhdXNlIHdlIGRvbid0IHdhbnQgdG8gdXBkYXRlIHRoZSBkcmF3IG1vZGVsXG4gIC8vIHVubGVzcyB0aGUgdXNlciBjbGlja3MgQXBwbHkuXG4gIGNvbnN0IFtuZXdDaXJjbGUsIHNldE5ld0NpcmNsZV0gPSBSZWFjdC51c2VTdGF0ZTxDaXJjbGUgfCBudWxsPihudWxsKVxuICBpZiAob25EcmF3KSB7XG4gICAgdXNlU3RhcnRNYXBEcmF3aW5nKHsgbWFwLCBtb2RlbCwgc2V0TmV3Q2lyY2xlLCBvbkRyYXcgfSlcbiAgfVxuICB1c2VMaXN0ZW5Ub01vZGVsKHtcbiAgICBtYXAsXG4gICAgbW9kZWwsXG4gICAgbmV3Q2lyY2xlLFxuICAgIG9uRHJhdyxcbiAgICB0cmFuc2xhdGlvbixcbiAgICBpc0ludGVyYWN0aXZlLFxuICB9KVxuICBSZWFjdC51c2VFZmZlY3QoKCkgPT4ge1xuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICBpZiAobW9kZWwgJiYgbWFwKSB7XG4gICAgICAgIHJlbW92ZU9sZERyYXdpbmcoeyBtYXAsIGlkOiBnZXRJZEZyb21Nb2RlbEZvckRpc3BsYXkoeyBtb2RlbCB9KSB9KVxuICAgICAgICBtYXAuZ2V0TWFwKCkuZHJhd0hlbHBlci5zdG9wRHJhd2luZygpXG4gICAgICB9XG4gICAgfVxuICB9LCBbbWFwLCBtb2RlbF0pXG4gIHJldHVybiA8PjwvPlxufVxuIl19