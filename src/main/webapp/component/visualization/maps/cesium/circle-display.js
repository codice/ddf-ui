import { __read } from "tslib";
import { Fragment as _Fragment, jsx as _jsx } from "react/jsx-runtime";
/**
 * Copyright (c) Codice Foundation
 *
 * This is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser
 * General Public License as published by the Free Software Foundation, either version 3 of the
 * License, or any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
 * even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details. A copy of the GNU Lesser General Public License
 * is distributed along with this program and can be found at
 * <http://www.gnu.org/licenses/lgpl.html>.
 *
 **/
import React from 'react';
import DistanceUtils from '../../../../js/DistanceUtils';
// @ts-expect-error ts-migrate(7016) FIXME: Could not find a declaration file for module 'cesi... Remove this comment to see the full error message
import Cesium from 'cesium/Build/Cesium/Cesium';
import _ from 'underscore';
import * as Turf from '@turf/turf';
import { useListenTo } from '../../../selection-checkbox/useBackbone.hook';
import { useRender } from '../../../hooks/useRender';
import { removeOldDrawing, removeOrLockOldDrawing } from './drawing-and-display';
import { getIdFromModelForDisplay } from '../drawing-and-display';
import TurfCircle from '@turf/circle';
import DrawHelper from '../../../../lib/cesium-drawhelper/DrawHelper';
import { contrastingColor } from '../../../../react-component/location/location-color-selector';
var toDeg = Cesium.Math.toDegrees;
var CAMERA_MAGNITUDE_THRESHOLD = 8000000;
var getCurrentMagnitudeFromMap = function (_a) {
    var map = _a.map;
    return map.getMap().camera.getMagnitude();
};
var needsRedraw = function (_a) {
    var map = _a.map, drawnMagnitude = _a.drawnMagnitude;
    var currentMagnitude = getCurrentMagnitudeFromMap({ map: map });
    if (currentMagnitude < CAMERA_MAGNITUDE_THRESHOLD &&
        drawnMagnitude > CAMERA_MAGNITUDE_THRESHOLD) {
        return true;
    }
    if (currentMagnitude > CAMERA_MAGNITUDE_THRESHOLD &&
        drawnMagnitude < CAMERA_MAGNITUDE_THRESHOLD) {
        return true;
    }
    return false;
};
var defaultAttrs = ['lat', 'lon', 'radius'];
var isModelReset = function (_a) {
    var modelProp = _a.modelProp;
    if (_.every(defaultAttrs, function (val) { return _.isUndefined(modelProp[val]); }) ||
        _.isEmpty(modelProp)) {
        return true;
    }
    return false;
};
var cartesian3ToCircle = function (center, radius, ellipsoid) {
    var latLon = ellipsoid.cartesianToCartographic(center);
    var lon = toDeg(latLon.longitude);
    var lat = toDeg(latLon.latitude);
    var radiusUnits = 'meters';
    if (radius >= 1000) {
        radius /= 1000;
        radiusUnits = 'kilometers';
    }
    return {
        lon: DistanceUtils.coordinateRound(lon),
        lat: DistanceUtils.coordinateRound(lat),
        radius: radius,
        radiusUnits: radiusUnits,
    };
};
var drawGeometry = function (_a) {
    // if model has been reset
    var model = _a.model, map = _a.map, id = _a.id, onDraw = _a.onDraw, translation = _a.translation, isInteractive = _a.isInteractive;
    var modelProp = model.toJSON();
    if (isModelReset({ modelProp: modelProp })) {
        map.getMap().scene.requestRender();
        return;
    }
    modelProp.lat = parseFloat(modelProp.lat);
    modelProp.lon = parseFloat(modelProp.lon);
    if (Number.isNaN(modelProp.lat) || Number.isNaN(modelProp.lon)) {
        map.getMap().scene.requestRender();
        return;
    }
    if (translation) {
        modelProp.lon += translation.longitude;
        modelProp.lat += translation.latitude;
    }
    removeOrLockOldDrawing(Boolean(isInteractive), id, map, model);
    var primitive;
    if (onDraw) {
        primitive = new DrawHelper.CirclePrimitive({
            center: Cesium.Cartesian3.fromDegrees(modelProp.lon, modelProp.lat),
            radius: DistanceUtils.getDistanceInMeters(modelProp.radius, modelProp.radiusUnits),
            height: 0,
            id: id,
            material: Cesium.Material.fromType('Color', {
                color: Cesium.Color.fromAlpha(contrastingColor, 0.2),
            }),
        });
        primitive.setEditable();
        primitive.addListener('onEdited', function (event) {
            var circle = cartesian3ToCircle(event.center, event.radius, map.getMap().scene.globe.ellipsoid);
            onDraw(circle);
        });
    }
    else {
        var color = model.get('color');
        var centerPt = Turf.point([modelProp.lon, modelProp.lat]);
        var circleToCheck = TurfCircle(centerPt, DistanceUtils.getDistanceInMeters(modelProp.radius, modelProp.radiusUnits), { units: 'meters', steps: 64 });
        primitive = new Cesium.PolylineCollection();
        primitive.add({
            width: isInteractive ? 12 : 8,
            material: Cesium.Material.fromType('PolylineOutline', {
                color: isInteractive
                    ? Cesium.Color.fromCssColorString(contrastingColor)
                    : color
                        ? Cesium.Color.fromCssColorString(color)
                        : Cesium.Color.KHAKI,
                outlineColor: Cesium.Color.WHITE,
                outlineWidth: isInteractive ? 6 : 4,
            }),
            id: 'userDrawing',
            positions: Cesium.Cartesian3.fromDegreesArray(_.flatten(circleToCheck.geometry.coordinates)),
        });
    }
    primitive.id = id;
    primitive.locationId = modelProp.locationId;
    map.getMap().scene.primitives.add(primitive);
    map.getMap().scene.requestRender();
};
var useCameraMagnitude = function (_a) {
    var map = _a.map;
    var _b = __read(React.useState(0), 2), cameraMagnitude = _b[0], setCameraMagnitude = _b[1];
    var _c = __read(React.useState(false), 2), isMoving = _c[0], setIsMoving = _c[1];
    var render = useRender();
    React.useEffect(function () {
        var startListener = function () { return setIsMoving(true); };
        var endListener = function () { return setIsMoving(false); };
        map === null || map === void 0 ? void 0 : map.getMap().scene.camera.moveStart.addEventListener(startListener);
        map === null || map === void 0 ? void 0 : map.getMap().scene.camera.moveEnd.addEventListener(endListener);
        return function () {
            map === null || map === void 0 ? void 0 : map.getMap().scene.camera.moveStart.removeEventListener(startListener);
            map === null || map === void 0 ? void 0 : map.getMap().scene.camera.moveEnd.removeEventListener(endListener);
        };
    }, [map]);
    React.useEffect(function () {
        if (isMoving) {
            var animationId_1 = window.requestAnimationFrame(function () {
                setCameraMagnitude(getCurrentMagnitudeFromMap({ map: map }));
            });
            return function () {
                window.cancelAnimationFrame(animationId_1);
            };
        }
        return function () { };
    }, [isMoving, render]);
    return [cameraMagnitude, setCameraMagnitude];
};
var useListenToModel = function (_a) {
    var model = _a.model, map = _a.map, newCircle = _a.newCircle, onDraw = _a.onDraw, translation = _a.translation, isInteractive = _a.isInteractive;
    var _b = __read(useCameraMagnitude({ map: map }), 1), cameraMagnitude = _b[0];
    var _c = __read(React.useState(0), 2), drawnMagnitude = _c[0], setDrawnMagnitude = _c[1];
    var callback = React.useMemo(function () {
        return function () {
            if (map) {
                if (newCircle) {
                    // Clone the model to display the new circle drawn because we don't
                    // want to update the existing model unless the user clicks Apply.
                    var newModel = model.clone();
                    newModel.set(newCircle);
                    drawGeometry({
                        map: map,
                        model: newModel,
                        id: getIdFromModelForDisplay({ model: model }),
                        setDrawnMagnitude: setDrawnMagnitude,
                        onDraw: onDraw,
                    });
                }
                else if (model) {
                    drawGeometry({
                        map: map,
                        model: model,
                        id: getIdFromModelForDisplay({ model: model }),
                        setDrawnMagnitude: setDrawnMagnitude,
                        onDraw: onDraw,
                        translation: translation,
                        isInteractive: isInteractive,
                    });
                }
            }
        };
    }, [model, map, newCircle, translation, isInteractive]);
    useListenTo(model, 'change:lat change:lon change:radius', callback);
    React.useEffect(function () {
        if (map && needsRedraw({ map: map, drawnMagnitude: drawnMagnitude })) {
            callback();
        }
    }, [cameraMagnitude, drawnMagnitude, callback, map]);
    React.useEffect(function () {
        callback();
    }, [callback]);
};
var useStartMapDrawing = function (_a) {
    var map = _a.map, model = _a.model, setNewCircle = _a.setNewCircle, onDraw = _a.onDraw;
    React.useEffect(function () {
        if (map && model) {
            map.getMap().drawHelper["startDrawingCircle"]({
                callback: function (center, radius) {
                    var circle = cartesian3ToCircle(center, radius, map.getMap().scene.globe.ellipsoid);
                    setNewCircle(circle);
                    onDraw(circle);
                },
                material: Cesium.Material.fromType('Color', {
                    color: Cesium.Color.fromAlpha(contrastingColor, 0.2),
                }),
            });
        }
    }, [map, model]);
};
export var CesiumCircleDisplay = function (_a) {
    var map = _a.map, model = _a.model, onDraw = _a.onDraw, translation = _a.translation, isInteractive = _a.isInteractive;
    // Use state to store the circle drawn by the user before they click Apply or Cancel.
    // When the user clicks Draw, they are allowed to edit the existing circle (if it
    // exists), or draw a new circle. If they draw a new circle, save it to state then show
    // it instead of the draw model because we don't want to update the draw model
    // unless the user clicks Apply.
    var _b = __read(React.useState(null), 2), newCircle = _b[0], setNewCircle = _b[1];
    if (onDraw) {
        useStartMapDrawing({ map: map, model: model, setNewCircle: setNewCircle, onDraw: onDraw });
    }
    useListenToModel({
        map: map,
        model: model,
        newCircle: newCircle,
        onDraw: onDraw,
        translation: translation,
        isInteractive: isInteractive,
    });
    React.useEffect(function () {
        return function () {
            if (model && map) {
                removeOldDrawing({ map: map, id: getIdFromModelForDisplay({ model: model }) });
                map.getMap().drawHelper.stopDrawing();
            }
        };
    }, [map, model]);
    return _jsx(_Fragment, {});
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2lyY2xlLWRpc3BsYXkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9zcmMvbWFpbi93ZWJhcHAvY29tcG9uZW50L3Zpc3VhbGl6YXRpb24vbWFwcy9jZXNpdW0vY2lyY2xlLWRpc3BsYXkudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUE7Ozs7Ozs7Ozs7Ozs7SUFhSTtBQUNKLE9BQU8sS0FBSyxNQUFNLE9BQU8sQ0FBQTtBQUN6QixPQUFPLGFBQWEsTUFBTSw4QkFBOEIsQ0FBQTtBQUN4RCxtSkFBbUo7QUFDbkosT0FBTyxNQUFNLE1BQU0sNEJBQTRCLENBQUE7QUFDL0MsT0FBTyxDQUFDLE1BQU0sWUFBWSxDQUFBO0FBQzFCLE9BQU8sS0FBSyxJQUFJLE1BQU0sWUFBWSxDQUFBO0FBQ2xDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSw4Q0FBOEMsQ0FBQTtBQUMxRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sMEJBQTBCLENBQUE7QUFDcEQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLHNCQUFzQixFQUFFLE1BQU0sdUJBQXVCLENBQUE7QUFDaEYsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0sd0JBQXdCLENBQUE7QUFDakUsT0FBTyxVQUFVLE1BQU0sY0FBYyxDQUFBO0FBQ3JDLE9BQU8sVUFBVSxNQUFNLDhDQUE4QyxDQUFBO0FBQ3JFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDhEQUE4RCxDQUFBO0FBRS9GLElBQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFBO0FBRW5DLElBQU0sMEJBQTBCLEdBQUcsT0FBTyxDQUFBO0FBUzFDLElBQU0sMEJBQTBCLEdBQUcsVUFBQyxFQUFxQjtRQUFuQixHQUFHLFNBQUE7SUFDdkMsT0FBTyxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUMsTUFBTSxDQUFDLFlBQVksRUFBRSxDQUFBO0FBQzNDLENBQUMsQ0FBQTtBQUVE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QTtJQUNILENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFBO0lBQ2hCLE9BQU8sbUJBQUssQ0FBQTtBQUNkLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSBDb2RpY2UgRm91bmRhdGlvblxuICpcbiAqIFRoaXMgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeSBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBMZXNzZXJcbiAqIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5IHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlXG4gKiBMaWNlbnNlLCBvciBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0XG4gKiBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gU2VlIHRoZSBHTlVcbiAqIExlc3NlciBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuIEEgY29weSBvZiB0aGUgR05VIExlc3NlciBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlXG4gKiBpcyBkaXN0cmlidXRlZCBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbSBhbmQgY2FuIGJlIGZvdW5kIGF0XG4gKiA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzL2xncGwuaHRtbD4uXG4gKlxuICoqL1xuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0J1xuaW1wb3J0IERpc3RhbmNlVXRpbHMgZnJvbSAnLi4vLi4vLi4vLi4vanMvRGlzdGFuY2VVdGlscydcbi8vIEB0cy1leHBlY3QtZXJyb3IgdHMtbWlncmF0ZSg3MDE2KSBGSVhNRTogQ291bGQgbm90IGZpbmQgYSBkZWNsYXJhdGlvbiBmaWxlIGZvciBtb2R1bGUgJ2Nlc2kuLi4gUmVtb3ZlIHRoaXMgY29tbWVudCB0byBzZWUgdGhlIGZ1bGwgZXJyb3IgbWVzc2FnZVxuaW1wb3J0IENlc2l1bSBmcm9tICdjZXNpdW0vQnVpbGQvQ2VzaXVtL0Nlc2l1bSdcbmltcG9ydCBfIGZyb20gJ3VuZGVyc2NvcmUnXG5pbXBvcnQgKiBhcyBUdXJmIGZyb20gJ0B0dXJmL3R1cmYnXG5pbXBvcnQgeyB1c2VMaXN0ZW5UbyB9IGZyb20gJy4uLy4uLy4uL3NlbGVjdGlvbi1jaGVja2JveC91c2VCYWNrYm9uZS5ob29rJ1xuaW1wb3J0IHsgdXNlUmVuZGVyIH0gZnJvbSAnLi4vLi4vLi4vaG9va3MvdXNlUmVuZGVyJ1xuaW1wb3J0IHsgcmVtb3ZlT2xkRHJhd2luZywgcmVtb3ZlT3JMb2NrT2xkRHJhd2luZyB9IGZyb20gJy4vZHJhd2luZy1hbmQtZGlzcGxheSdcbmltcG9ydCB7IGdldElkRnJvbU1vZGVsRm9yRGlzcGxheSB9IGZyb20gJy4uL2RyYXdpbmctYW5kLWRpc3BsYXknXG5pbXBvcnQgVHVyZkNpcmNsZSBmcm9tICdAdHVyZi9jaXJjbGUnXG5pbXBvcnQgRHJhd0hlbHBlciBmcm9tICcuLi8uLi8uLi8uLi9saWIvY2VzaXVtLWRyYXdoZWxwZXIvRHJhd0hlbHBlcidcbmltcG9ydCB7IGNvbnRyYXN0aW5nQ29sb3IgfSBmcm9tICcuLi8uLi8uLi8uLi9yZWFjdC1jb21wb25lbnQvbG9jYXRpb24vbG9jYXRpb24tY29sb3Itc2VsZWN0b3InXG5pbXBvcnQgeyBUcmFuc2xhdGlvbiB9IGZyb20gJy4uL2ludGVyYWN0aW9ucy5wcm92aWRlcidcbmNvbnN0IHRvRGVnID0gQ2VzaXVtLk1hdGgudG9EZWdyZWVzXG5cbmNvbnN0IENBTUVSQV9NQUdOSVRVREVfVEhSRVNIT0xEID0gODAwMDAwMFxuXG50eXBlIENpcmNsZSA9IHtcbiAgbG9uOiBudW1iZXJcbiAgbGF0OiBudW1iZXJcbiAgcmFkaXVzOiBudW1iZXJcbiAgcmFkaXVzVW5pdHM6IHN0cmluZ1xufVxuXG5jb25zdCBnZXRDdXJyZW50TWFnbml0dWRlRnJvbU1hcCA9ICh7IG1hcCB9OiB7IG1hcDogYW55IH0pID0+IHtcbiAgcmV0dXJuIG1hcC5nZXRNYXAoKS5jYW1lcmEuZ2V0TWFnbml0dWRlKClcbn1cblxuY29uc3QgbmVlZHNSZWRyYXcgPSAoe1xuICBtYXAsXG4gIGRyYXduTWFnbml0dWRlLFxufToge1xuICBtYXA6IGFueVxuICBkcmF3bk1hZ25pdHVkZTogYW55XG59KSA9PiB7XG4gIGNvbnN0IGN1cnJlbnRNYWduaXR1ZGUgPSBnZXRDdXJyZW50TWFnbml0dWRlRnJvbU1hcCh7IG1hcCB9KVxuXG4gIGlmIChcbiAgICBjdXJyZW50TWFnbml0dWRlIDwgQ0FNRVJBX01BR05JVFVERV9USFJFU0hPTEQgJiZcbiAgICBkcmF3bk1hZ25pdHVkZSA+IENBTUVSQV9NQUdOSVRVREVfVEhSRVNIT0xEXG4gICkge1xuICAgIHJldHVybiB0cnVlXG4gIH1cbiAgaWYgKFxuICAgIGN1cnJlbnRNYWduaXR1ZGUgPiBDQU1FUkFfTUFHTklUVURFX1RIUkVTSE9MRCAmJlxuICAgIGRyYXduTWFnbml0dWRlIDwgQ0FNRVJBX01BR05JVFVERV9USFJFU0hPTERcbiAgKSB7XG4gICAgcmV0dXJuIHRydWVcbiAgfVxuXG4gIHJldHVybiBmYWxzZVxufVxuXG5jb25zdCBkZWZhdWx0QXR0cnMgPSBbJ2xhdCcsICdsb24nLCAncmFkaXVzJ11cblxuY29uc3QgaXNNb2RlbFJlc2V0ID0gKHsgbW9kZWxQcm9wIH06IHsgbW9kZWxQcm9wOiBhbnkgfSkgPT4ge1xuICBpZiAoXG4gICAgXy5ldmVyeShkZWZhdWx0QXR0cnMsICh2YWw6IGFueSkgPT4gXy5pc1VuZGVmaW5lZChtb2RlbFByb3BbdmFsXSkpIHx8XG4gICAgXy5pc0VtcHR5KG1vZGVsUHJvcClcbiAgKSB7XG4gICAgcmV0dXJuIHRydWVcbiAgfVxuICByZXR1cm4gZmFsc2Vcbn1cblxuY29uc3QgY2FydGVzaWFuM1RvQ2lyY2xlID0gKFxuICBjZW50ZXI6IENlc2l1bS5DYXJ0ZXNpYW4zLFxuICByYWRpdXM6IG51bWJlcixcbiAgZWxsaXBzb2lkOiBDZXNpdW0uRWxsaXBzb2lkXG4pOiBDaXJjbGUgPT4ge1xuICBjb25zdCBsYXRMb24gPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoY2VudGVyKVxuICBjb25zdCBsb24gPSB0b0RlZyhsYXRMb24ubG9uZ2l0dWRlKVxuICBjb25zdCBsYXQgPSB0b0RlZyhsYXRMb24ubGF0aXR1ZGUpXG4gIGxldCByYWRpdXNVbml0cyA9ICdtZXRlcnMnXG4gIGlmIChyYWRpdXMgPj0gMTAwMCkge1xuICAgIHJhZGl1cyAvPSAxMDAwXG4gICAgcmFkaXVzVW5pdHMgPSAna2lsb21ldGVycydcbiAgfVxuICByZXR1cm4ge1xuICAgIGxvbjogRGlzdGFuY2VVdGlscy5jb29yZGluYXRlUm91bmQobG9uKSxcbiAgICBsYXQ6IERpc3RhbmNlVXRpbHMuY29vcmRpbmF0ZVJvdW5kKGxhdCksXG4gICAgcmFkaXVzLFxuICAgIHJhZGl1c1VuaXRzLFxuICB9XG59XG5cbmNvbnN0IGRyYXdHZW9tZXRyeSA9ICh7XG4gIG1vZGVsLFxuICBtYXAsXG4gIGlkLFxuICBvbkRyYXcsXG4gIHRyYW5zbGF0aW9uLFxuICBpc0ludGVyYWN0aXZlLFxufToge1xuICBtb2RlbDogYW55XG4gIG1hcDogYW55XG4gIGlkOiBhbnlcbiAgc2V0RHJhd25NYWduaXR1ZGU6IChudW1iZXI6IGFueSkgPT4gdm9pZFxuICBvbkRyYXc/OiAoZHJhd2luZ0xvY2F0aW9uOiBDaXJjbGUpID0+IHZvaWRcbiAgdHJhbnNsYXRpb24/OiBUcmFuc2xhdGlvblxuICBpc0ludGVyYWN0aXZlPzogYm9vbGVhbiAvLyBub3RlOiAnaW50ZXJhY3RpdmUnIGlzIGRpZmZlcmVudCBmcm9tIGRyYXdpbmdcbn0pID0+IHtcbiAgLy8gaWYgbW9kZWwgaGFzIGJlZW4gcmVzZXRcblxuICBjb25zdCBtb2RlbFByb3AgPSBtb2RlbC50b0pTT04oKVxuICBpZiAoaXNNb2RlbFJlc2V0KHsgbW9kZWxQcm9wIH0pKSB7XG4gICAgbWFwLmdldE1hcCgpLnNjZW5lLnJlcXVlc3RSZW5kZXIoKVxuICAgIHJldHVyblxuICB9XG4gIG1vZGVsUHJvcC5sYXQgPSBwYXJzZUZsb2F0KG1vZGVsUHJvcC5sYXQpXG4gIG1vZGVsUHJvcC5sb24gPSBwYXJzZUZsb2F0KG1vZGVsUHJvcC5sb24pXG4gIGlmIChOdW1iZXIuaXNOYU4obW9kZWxQcm9wLmxhdCkgfHwgTnVtYmVyLmlzTmFOKG1vZGVsUHJvcC5sb24pKSB7XG4gICAgbWFwLmdldE1hcCgpLnNjZW5lLnJlcXVlc3RSZW5kZXIoKVxuICAgIHJldHVyblxuICB9XG5cbiAgaWYgKHRyYW5zbGF0aW9uKSB7XG4gICAgbW9kZWxQcm9wLmxvbiArPSB0cmFuc2xhdGlvbi5sb25naXR1ZGVcbiAgICBtb2RlbFByb3AubGF0ICs9IHRyYW5zbGF0aW9uLmxhdGl0dWRlXG4gIH1cblxuICByZW1vdmVPckxvY2tPbGREcmF3aW5nKEJvb2xlYW4oaXNJbnRlcmFjdGl2ZSksIGlkLCBtYXAsIG1vZGVsKVxuXG4gIGxldCBwcmltaXRpdmVcblxuICBpZiAob25EcmF3KSB7XG4gICAgcHJpbWl0aXZlID0gbmV3IChEcmF3SGVscGVyLkNpcmNsZVByaW1pdGl2ZSBhcyBhbnkpKHtcbiAgICAgIGNlbnRlcjogQ2VzaXVtLkNhcnRlc2lhbjMuZnJvbURlZ3JlZXMobW9kZWxQcm9wLmxvbiwgbW9kZWxQcm9wLmxhdCksXG4gICAgICByYWRpdXM6IERpc3RhbmNlVXRpbHMuZ2V0RGlzdGFuY2VJbk1ldGVycyhcbiAgICAgICAgbW9kZWxQcm9wLnJhZGl1cyxcbiAgICAgICAgbW9kZWxQcm9wLnJhZGl1c1VuaXRzXG4gICAgICApLFxuICAgICAgaGVpZ2h0OiAwLFxuICAgICAgaWQsXG4gICAgICBtYXRlcmlhbDogQ2VzaXVtLk1hdGVyaWFsLmZyb21UeXBlKCdDb2xvcicsIHtcbiAgICAgICAgY29sb3I6IENlc2l1bS5Db2xvci5mcm9tQWxwaGEoY29udHJhc3RpbmdDb2xvciwgMC4yKSxcbiAgICAgIH0pLFxuICAgIH0pXG4gICAgcHJpbWl0aXZlLnNldEVkaXRhYmxlKClcbiAgICBwcmltaXRpdmUuYWRkTGlzdGVuZXIoJ29uRWRpdGVkJywgZnVuY3Rpb24gKGV2ZW50OiBhbnkpIHtcbiAgICAgIGNvbnN0IGNpcmNsZSA9IGNhcnRlc2lhbjNUb0NpcmNsZShcbiAgICAgICAgZXZlbnQuY2VudGVyLFxuICAgICAgICBldmVudC5yYWRpdXMsXG4gICAgICAgIG1hcC5nZXRNYXAoKS5zY2VuZS5nbG9iZS5lbGxpcHNvaWRcbiAgICAgIClcbiAgICAgIG9uRHJhdyhjaXJjbGUpXG4gICAgfSlcbiAgfSBlbHNlIHtcbiAgICBjb25zdCBjb2xvciA9IG1vZGVsLmdldCgnY29sb3InKVxuXG4gICAgY29uc3QgY2VudGVyUHQgPSBUdXJmLnBvaW50KFttb2RlbFByb3AubG9uLCBtb2RlbFByb3AubGF0XSlcbiAgICBjb25zdCBjaXJjbGVUb0NoZWNrID0gVHVyZkNpcmNsZShcbiAgICAgIGNlbnRlclB0LFxuICAgICAgRGlzdGFuY2VVdGlscy5nZXREaXN0YW5jZUluTWV0ZXJzKFxuICAgICAgICBtb2RlbFByb3AucmFkaXVzLFxuICAgICAgICBtb2RlbFByb3AucmFkaXVzVW5pdHNcbiAgICAgICksXG4gICAgICB7IHVuaXRzOiAnbWV0ZXJzJywgc3RlcHM6IDY0IH1cbiAgICApXG5cbiAgICBwcmltaXRpdmUgPSBuZXcgQ2VzaXVtLlBvbHlsaW5lQ29sbGVjdGlvbigpXG4gICAgcHJpbWl0aXZlLmFkZCh7XG4gICAgICB3aWR0aDogaXNJbnRlcmFjdGl2ZSA/IDEyIDogOCxcbiAgICAgIG1hdGVyaWFsOiBDZXNpdW0uTWF0ZXJpYWwuZnJvbVR5cGUoJ1BvbHlsaW5lT3V0bGluZScsIHtcbiAgICAgICAgY29sb3I6IGlzSW50ZXJhY3RpdmVcbiAgICAgICAgICA/IENlc2l1bS5Db2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoY29udHJhc3RpbmdDb2xvcilcbiAgICAgICAgICA6IGNvbG9yXG4gICAgICAgICAgPyBDZXNpdW0uQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKGNvbG9yKVxuICAgICAgICAgIDogQ2VzaXVtLkNvbG9yLktIQUtJLFxuICAgICAgICBvdXRsaW5lQ29sb3I6IENlc2l1bS5Db2xvci5XSElURSxcbiAgICAgICAgb3V0bGluZVdpZHRoOiBpc0ludGVyYWN0aXZlID8gNiA6IDQsXG4gICAgICB9KSxcbiAgICAgIGlkOiAndXNlckRyYXdpbmcnLFxuICAgICAgcG9zaXRpb25zOiBDZXNpdW0uQ2FydGVzaWFuMy5mcm9tRGVncmVlc0FycmF5KFxuICAgICAgICBfLmZsYXR0ZW4oY2lyY2xlVG9DaGVjay5nZW9tZXRyeS5jb29yZGluYXRlcylcbiAgICAgICksXG4gICAgfSlcbiAgfVxuXG4gIHByaW1pdGl2ZS5pZCA9IGlkXG4gIHByaW1pdGl2ZS5sb2NhdGlvbklkID0gbW9kZWxQcm9wLmxvY2F0aW9uSWRcbiAgbWFwLmdldE1hcCgpLnNjZW5lLnByaW1pdGl2ZXMuYWRkKHByaW1pdGl2ZSlcbiAgbWFwLmdldE1hcCgpLnNjZW5lLnJlcXVlc3RSZW5kZXIoKVxufVxuXG5jb25zdCB1c2VDYW1lcmFNYWduaXR1ZGUgPSAoe1xuICBtYXAsXG59OiB7XG4gIG1hcDogYW55XG59KTogW251bWJlciwgUmVhY3QuRGlzcGF0Y2g8UmVhY3QuU2V0U3RhdGVBY3Rpb248bnVtYmVyPj5dID0+IHtcbiAgY29uc3QgW2NhbWVyYU1hZ25pdHVkZSwgc2V0Q2FtZXJhTWFnbml0dWRlXSA9IFJlYWN0LnVzZVN0YXRlKDApXG4gIGNvbnN0IFtpc01vdmluZywgc2V0SXNNb3ZpbmddID0gUmVhY3QudXNlU3RhdGUoZmFsc2UpXG4gIGNvbnN0IHJlbmRlciA9IHVzZVJlbmRlcigpXG4gIFJlYWN0LnVzZUVmZmVjdCgoKSA9PiB7XG4gICAgY29uc3Qgc3RhcnRMaXN0ZW5lciA9ICgpID0+IHNldElzTW92aW5nKHRydWUpXG4gICAgY29uc3QgZW5kTGlzdGVuZXIgPSAoKSA9PiBzZXRJc01vdmluZyhmYWxzZSlcbiAgICBtYXA/LmdldE1hcCgpLnNjZW5lLmNhbWVyYS5tb3ZlU3RhcnQuYWRkRXZlbnRMaXN0ZW5lcihzdGFydExpc3RlbmVyKVxuICAgIG1hcD8uZ2V0TWFwKCkuc2NlbmUuY2FtZXJhLm1vdmVFbmQuYWRkRXZlbnRMaXN0ZW5lcihlbmRMaXN0ZW5lcilcbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgbWFwPy5nZXRNYXAoKS5zY2VuZS5jYW1lcmEubW92ZVN0YXJ0LnJlbW92ZUV2ZW50TGlzdGVuZXIoc3RhcnRMaXN0ZW5lcilcbiAgICAgIG1hcD8uZ2V0TWFwKCkuc2NlbmUuY2FtZXJhLm1vdmVFbmQucmVtb3ZlRXZlbnRMaXN0ZW5lcihlbmRMaXN0ZW5lcilcbiAgICB9XG4gIH0sIFttYXBdKVxuICBSZWFjdC51c2VFZmZlY3QoKCkgPT4ge1xuICAgIGlmIChpc01vdmluZykge1xuICAgICAgY29uc3QgYW5pbWF0aW9uSWQgPSB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgICAgc2V0Q2FtZXJhTWFnbml0dWRlKGdldEN1cnJlbnRNYWduaXR1ZGVGcm9tTWFwKHsgbWFwIH0pKVxuICAgICAgfSlcbiAgICAgIHJldHVybiAoKSA9PiB7XG4gICAgICAgIHdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZShhbmltYXRpb25JZClcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuICgpID0+IHt9XG4gIH0sIFtpc01vdmluZywgcmVuZGVyXSlcbiAgcmV0dXJuIFtjYW1lcmFNYWduaXR1ZGUsIHNldENhbWVyYU1hZ25pdHVkZV1cbn1cblxuY29uc3QgdXNlTGlzdGVuVG9Nb2RlbCA9ICh7XG4gIG1vZGVsLFxuICBtYXAsXG4gIG5ld0NpcmNsZSxcbiAgb25EcmF3LFxuICB0cmFuc2xhdGlvbixcbiAgaXNJbnRlcmFjdGl2ZSxcbn06IHtcbiAgbW9kZWw6IGFueVxuICBtYXA6IGFueVxuICBuZXdDaXJjbGU6IENpcmNsZSB8IG51bGxcbiAgb25EcmF3PzogKGRyYXdpbmdMb2NhdGlvbjogQ2lyY2xlKSA9PiB2b2lkXG4gIHRyYW5zbGF0aW9uPzogVHJhbnNsYXRpb25cbiAgaXNJbnRlcmFjdGl2ZT86IGJvb2xlYW4gLy8gbm90ZTogJ2ludGVyYWN0aXZlJyBpcyBkaWZmZXJlbnQgZnJvbSBkcmF3aW5nXG59KSA9PiB7XG4gIGNvbnN0IFtjYW1lcmFNYWduaXR1ZGVdID0gdXNlQ2FtZXJhTWFnbml0dWRlKHsgbWFwIH0pXG4gIGNvbnN0IFtkcmF3bk1hZ25pdHVkZSwgc2V0RHJhd25NYWduaXR1ZGVdID0gUmVhY3QudXNlU3RhdGUoMClcbiAgY29uc3QgY2FsbGJhY2sgPSBSZWFjdC51c2VNZW1vKCgpID0+IHtcbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgaWYgKG1hcCkge1xuICAgICAgICBpZiAobmV3Q2lyY2xlKSB7XG4gICAgICAgICAgLy8gQ2xvbmUgdGhlIG1vZGVsIHRvIGRpc3BsYXkgdGhlIG5ldyBjaXJjbGUgZHJhd24gYmVjYXVzZSB3ZSBkb24ndFxuICAgICAgICAgIC8vIHdhbnQgdG8gdXBkYXRlIHRoZSBleGlzdGluZyBtb2RlbCB1bmxlc3MgdGhlIHVzZXIgY2xpY2tzIEFwcGx5LlxuICAgICAgICAgIGNvbnN0IG5ld01vZGVsID0gbW9kZWwuY2xvbmUoKVxuICAgICAgICAgIG5ld01vZGVsLnNldChuZXdDaXJjbGUpXG4gICAgICAgICAgZHJhd0dlb21ldHJ5KHtcbiAgICAgICAgICAgIG1hcCxcbiAgICAgICAgICAgIG1vZGVsOiBuZXdNb2RlbCxcbiAgICAgICAgICAgIGlkOiBnZXRJZEZyb21Nb2RlbEZvckRpc3BsYXkoeyBtb2RlbCB9KSxcbiAgICAgICAgICAgIHNldERyYXduTWFnbml0dWRlLFxuICAgICAgICAgICAgb25EcmF3LFxuICAgICAgICAgIH0pXG4gICAgICAgIH0gZWxzZSBpZiAobW9kZWwpIHtcbiAgICAgICAgICBkcmF3R2VvbWV0cnkoe1xuICAgICAgICAgICAgbWFwLFxuICAgICAgICAgICAgbW9kZWwsXG4gICAgICAgICAgICBpZDogZ2V0SWRGcm9tTW9kZWxGb3JEaXNwbGF5KHsgbW9kZWwgfSksXG4gICAgICAgICAgICBzZXREcmF3bk1hZ25pdHVkZSxcbiAgICAgICAgICAgIG9uRHJhdyxcbiAgICAgICAgICAgIHRyYW5zbGF0aW9uLFxuICAgICAgICAgICAgaXNJbnRlcmFjdGl2ZSxcbiAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9LCBbbW9kZWwsIG1hcCwgbmV3Q2lyY2xlLCB0cmFuc2xhdGlvbiwgaXNJbnRlcmFjdGl2ZV0pXG4gIHVzZUxpc3RlblRvKG1vZGVsLCAnY2hhbmdlOmxhdCBjaGFuZ2U6bG9uIGNoYW5nZTpyYWRpdXMnLCBjYWxsYmFjaylcbiAgUmVhY3QudXNlRWZmZWN0KCgpID0+IHtcbiAgICBpZiAobWFwICYmIG5lZWRzUmVkcmF3KHsgbWFwLCBkcmF3bk1hZ25pdHVkZSB9KSkge1xuICAgICAgY2FsbGJhY2soKVxuICAgIH1cbiAgfSwgW2NhbWVyYU1hZ25pdHVkZSwgZHJhd25NYWduaXR1ZGUsIGNhbGxiYWNrLCBtYXBdKVxuICBSZWFjdC51c2VFZmZlY3QoKCkgPT4ge1xuICAgIGNhbGxiYWNrKClcbiAgfSwgW2NhbGxiYWNrXSlcbn1cblxuY29uc3QgdXNlU3RhcnRNYXBEcmF3aW5nID0gKHtcbiAgbWFwLFxuICBtb2RlbCxcbiAgc2V0TmV3Q2lyY2xlLFxuICBvbkRyYXcsXG59OiB7XG4gIG1hcDogYW55XG4gIG1vZGVsOiBhbnlcbiAgc2V0TmV3Q2lyY2xlOiAobmV3Q2lyY2xlOiBDaXJjbGUpID0+IHZvaWRcbiAgb25EcmF3OiAobmV3Q2lyY2xlOiBDaXJjbGUpID0+IHZvaWRcbn0pID0+IHtcbiAgUmVhY3QudXNlRWZmZWN0KCgpID0+IHtcbiAgICBpZiAobWFwICYmIG1vZGVsKSB7XG4gICAgICBtYXAuZ2V0TWFwKCkuZHJhd0hlbHBlcltgc3RhcnREcmF3aW5nQ2lyY2xlYF0oe1xuICAgICAgICBjYWxsYmFjazogKGNlbnRlcjogQ2VzaXVtLkNhcnRlc2lhbjMsIHJhZGl1czogbnVtYmVyKSA9PiB7XG4gICAgICAgICAgY29uc3QgY2lyY2xlID0gY2FydGVzaWFuM1RvQ2lyY2xlKFxuICAgICAgICAgICAgY2VudGVyLFxuICAgICAgICAgICAgcmFkaXVzLFxuICAgICAgICAgICAgbWFwLmdldE1hcCgpLnNjZW5lLmdsb2JlLmVsbGlwc29pZFxuICAgICAgICAgIClcbiAgICAgICAgICBzZXROZXdDaXJjbGUoY2lyY2xlKVxuICAgICAgICAgIG9uRHJhdyhjaXJjbGUpXG4gICAgICAgIH0sXG4gICAgICAgIG1hdGVyaWFsOiBDZXNpdW0uTWF0ZXJpYWwuZnJvbVR5cGUoJ0NvbG9yJywge1xuICAgICAgICAgIGNvbG9yOiBDZXNpdW0uQ29sb3IuZnJvbUFscGhhKGNvbnRyYXN0aW5nQ29sb3IsIDAuMiksXG4gICAgICAgIH0pLFxuICAgICAgfSlcbiAgICB9XG4gIH0sIFttYXAsIG1vZGVsXSlcbn1cblxuZXhwb3J0IGNvbnN0IENlc2l1bUNpcmNsZURpc3BsYXkgPSAoe1xuICBtYXAsXG4gIG1vZGVsLFxuICBvbkRyYXcsXG4gIHRyYW5zbGF0aW9uLFxuICBpc0ludGVyYWN0aXZlLFxufToge1xuICBtYXA6IGFueVxuICBtb2RlbDogYW55XG4gIG9uRHJhdz86IChuZXdDaXJjbGU6IENpcmNsZSkgPT4gdm9pZFxuICB0cmFuc2xhdGlvbj86IFRyYW5zbGF0aW9uXG4gIGlzSW50ZXJhY3RpdmU/OiBib29sZWFuIC8vIG5vdGU6ICdpbnRlcmFjdGl2ZScgaXMgZGlmZmVyZW50IGZyb20gZHJhd2luZ1xufSkgPT4ge1xuICAvLyBVc2Ugc3RhdGUgdG8gc3RvcmUgdGhlIGNpcmNsZSBkcmF3biBieSB0aGUgdXNlciBiZWZvcmUgdGhleSBjbGljayBBcHBseSBvciBDYW5jZWwuXG4gIC8vIFdoZW4gdGhlIHVzZXIgY2xpY2tzIERyYXcsIHRoZXkgYXJlIGFsbG93ZWQgdG8gZWRpdCB0aGUgZXhpc3RpbmcgY2lyY2xlIChpZiBpdFxuICAvLyBleGlzdHMpLCBvciBkcmF3IGEgbmV3IGNpcmNsZS4gSWYgdGhleSBkcmF3IGEgbmV3IGNpcmNsZSwgc2F2ZSBpdCB0byBzdGF0ZSB0aGVuIHNob3dcbiAgLy8gaXQgaW5zdGVhZCBvZiB0aGUgZHJhdyBtb2RlbCBiZWNhdXNlIHdlIGRvbid0IHdhbnQgdG8gdXBkYXRlIHRoZSBkcmF3IG1vZGVsXG4gIC8vIHVubGVzcyB0aGUgdXNlciBjbGlja3MgQXBwbHkuXG4gIGNvbnN0IFtuZXdDaXJjbGUsIHNldE5ld0NpcmNsZV0gPSBSZWFjdC51c2VTdGF0ZTxDaXJjbGUgfCBudWxsPihudWxsKVxuICBpZiAob25EcmF3KSB7XG4gICAgdXNlU3RhcnRNYXBEcmF3aW5nKHsgbWFwLCBtb2RlbCwgc2V0TmV3Q2lyY2xlLCBvbkRyYXcgfSlcbiAgfVxuICB1c2VMaXN0ZW5Ub01vZGVsKHtcbiAgICBtYXAsXG4gICAgbW9kZWwsXG4gICAgbmV3Q2lyY2xlLFxuICAgIG9uRHJhdyxcbiAgICB0cmFuc2xhdGlvbixcbiAgICBpc0ludGVyYWN0aXZlLFxuICB9KVxuICBSZWFjdC51c2VFZmZlY3QoKCkgPT4ge1xuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICBpZiAobW9kZWwgJiYgbWFwKSB7XG4gICAgICAgIHJlbW92ZU9sZERyYXdpbmcoeyBtYXAsIGlkOiBnZXRJZEZyb21Nb2RlbEZvckRpc3BsYXkoeyBtb2RlbCB9KSB9KVxuICAgICAgICBtYXAuZ2V0TWFwKCkuZHJhd0hlbHBlci5zdG9wRHJhd2luZygpXG4gICAgICB9XG4gICAgfVxuICB9LCBbbWFwLCBtb2RlbF0pXG4gIHJldHVybiA8PjwvPlxufVxuIl19