import { __read } from "tslib";
/**
 * Copyright (c) Codice Foundation
 *
 * This is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser
 * General Public License as published by the Free Software Foundation, either version 3 of the
 * License, or any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
 * even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details. A copy of the GNU Lesser General Public License
 * is distributed along with this program and can be found at
 * <http://www.gnu.org/licenses/lgpl.html>.
 *
 **/
import React from 'react';
import DistanceUtils from '../../../../js/DistanceUtils';
// @ts-expect-error ts-migrate(7016) FIXME: Could not find a declaration file for module 'cesi... Remove this comment to see the full error message
import Cesium from 'cesium/Build/Cesium/Cesium';
import _ from 'underscore';
import * as Turf from '@turf/turf';
import { useListenTo } from '../../../selection-checkbox/useBackbone.hook';
import { useRender } from '../../../hooks/useRender';
import { removeOldDrawing, removeOrLockOldDrawing } from './drawing-and-display';
import { getIdFromModelForDisplay } from '../drawing-and-display';
import TurfCircle from '@turf/circle';
import DrawHelper from '../../../../lib/cesium-drawhelper/DrawHelper';
import { contrastingColor } from '../../../../react-component/location/location-color-selector';
var toDeg = Cesium.Math.toDegrees;
var CAMERA_MAGNITUDE_THRESHOLD = 8000000;
var getCurrentMagnitudeFromMap = function (_a) {
    var map = _a.map;
    return map.getMap().camera.getMagnitude();
};
var needsRedraw = function (_a) {
    var map = _a.map, drawnMagnitude = _a.drawnMagnitude;
    var currentMagnitude = getCurrentMagnitudeFromMap({ map: map });
    if (currentMagnitude < CAMERA_MAGNITUDE_THRESHOLD &&
        drawnMagnitude > CAMERA_MAGNITUDE_THRESHOLD) {
        return true;
    }
    if (currentMagnitude > CAMERA_MAGNITUDE_THRESHOLD &&
        drawnMagnitude < CAMERA_MAGNITUDE_THRESHOLD) {
        return true;
    }
    return false;
};
var defaultAttrs = ['lat', 'lon', 'radius'];
var isModelReset = function (_a) {
    var modelProp = _a.modelProp;
    if (_.every(defaultAttrs, function (val) { return _.isUndefined(modelProp[val]); }) ||
        _.isEmpty(modelProp)) {
        return true;
    }
    return false;
};
var cartesian3ToCircle = function (center, radius, ellipsoid) {
    var latLon = ellipsoid.cartesianToCartographic(center);
    var lon = toDeg(latLon.longitude);
    var lat = toDeg(latLon.latitude);
    var radiusUnits = 'meters';
    if (radius >= 1000) {
        radius /= 1000;
        radiusUnits = 'kilometers';
    }
    return {
        lon: DistanceUtils.coordinateRound(lon),
        lat: DistanceUtils.coordinateRound(lat),
        radius: radius,
        radiusUnits: radiusUnits,
    };
};
var drawGeometry = function (_a) {
    // if model has been reset
    var model = _a.model, map = _a.map, id = _a.id, onDraw = _a.onDraw, translation = _a.translation, isInteractive = _a.isInteractive;
    var modelProp = model.toJSON();
    if (isModelReset({ modelProp: modelProp })) {
        map.getMap().scene.requestRender();
        return;
    }
    modelProp.lat = parseFloat(modelProp.lat);
    modelProp.lon = parseFloat(modelProp.lon);
    if (Number.isNaN(modelProp.lat) || Number.isNaN(modelProp.lon)) {
        map.getMap().scene.requestRender();
        return;
    }
    if (translation) {
        modelProp.lon += translation.longitude;
        modelProp.lat += translation.latitude;
    }
    removeOrLockOldDrawing(Boolean(isInteractive), id, map, model);
    var primitive;
    if (onDraw) {
        primitive = new DrawHelper.CirclePrimitive({
            center: Cesium.Cartesian3.fromDegrees(modelProp.lon, modelProp.lat),
            radius: DistanceUtils.getDistanceInMeters(modelProp.radius, modelProp.radiusUnits),
            height: 0,
            id: id,
            material: Cesium.Material.fromType('Color', {
                color: Cesium.Color.fromAlpha(contrastingColor, 0.2),
            }),
        });
        primitive.setEditable();
        primitive.addListener('onEdited', function (event) {
            var circle = cartesian3ToCircle(event.center, event.radius, map.getMap().scene.globe.ellipsoid);
            onDraw(circle);
        });
    }
    else {
        var color = model.get('color');
        var centerPt = Turf.point([modelProp.lon, modelProp.lat]);
        var circleToCheck = TurfCircle(centerPt, DistanceUtils.getDistanceInMeters(modelProp.radius, modelProp.radiusUnits), { units: 'meters', steps: 64 });
        primitive = new Cesium.PolylineCollection();
        primitive.add({
            width: isInteractive ? 12 : 8,
            material: Cesium.Material.fromType('PolylineOutline', {
                color: isInteractive
                    ? Cesium.Color.fromCssColorString(contrastingColor)
                    : color
                        ? Cesium.Color.fromCssColorString(color)
                        : Cesium.Color.KHAKI,
                outlineColor: Cesium.Color.WHITE,
                outlineWidth: isInteractive ? 6 : 4,
            }),
            id: 'userDrawing',
            positions: Cesium.Cartesian3.fromDegreesArray(_.flatten(circleToCheck.geometry.coordinates)),
        });
    }
    primitive.id = id;
    primitive.locationId = modelProp.locationId;
    map.getMap().scene.primitives.add(primitive);
    map.getMap().scene.requestRender();
};
var useCameraMagnitude = function (_a) {
    var map = _a.map;
    var _b = __read(React.useState(0), 2), cameraMagnitude = _b[0], setCameraMagnitude = _b[1];
    var _c = __read(React.useState(false), 2), isMoving = _c[0], setIsMoving = _c[1];
    var render = useRender();
    React.useEffect(function () {
        var startListener = function () { return setIsMoving(true); };
        var endListener = function () { return setIsMoving(false); };
        map === null || map === void 0 ? void 0 : map.getMap().scene.camera.moveStart.addEventListener(startListener);
        map === null || map === void 0 ? void 0 : map.getMap().scene.camera.moveEnd.addEventListener(endListener);
        return function () {
            map === null || map === void 0 ? void 0 : map.getMap().scene.camera.moveStart.removeEventListener(startListener);
            map === null || map === void 0 ? void 0 : map.getMap().scene.camera.moveEnd.removeEventListener(endListener);
        };
    }, [map]);
    React.useEffect(function () {
        if (isMoving) {
            var animationId_1 = window.requestAnimationFrame(function () {
                setCameraMagnitude(getCurrentMagnitudeFromMap({ map: map }));
            });
            return function () {
                window.cancelAnimationFrame(animationId_1);
            };
        }
        return function () { };
    }, [isMoving, render]);
    return [cameraMagnitude, setCameraMagnitude];
};
var useListenToModel = function (_a) {
    var model = _a.model, map = _a.map, newCircle = _a.newCircle, onDraw = _a.onDraw, translation = _a.translation, isInteractive = _a.isInteractive;
    var _b = __read(useCameraMagnitude({ map: map }), 1), cameraMagnitude = _b[0];
    var _c = __read(React.useState(0), 2), drawnMagnitude = _c[0], setDrawnMagnitude = _c[1];
    var callback = React.useMemo(function () {
        return function () {
            if (map) {
                if (newCircle) {
                    // Clone the model to display the new circle drawn because we don't
                    // want to update the existing model unless the user clicks Apply.
                    var newModel = model.clone();
                    newModel.set(newCircle);
                    drawGeometry({
                        map: map,
                        model: newModel,
                        id: getIdFromModelForDisplay({ model: model }),
                        setDrawnMagnitude: setDrawnMagnitude,
                        onDraw: onDraw,
                    });
                }
                else if (model) {
                    drawGeometry({
                        map: map,
                        model: model,
                        id: getIdFromModelForDisplay({ model: model }),
                        setDrawnMagnitude: setDrawnMagnitude,
                        onDraw: onDraw,
                        translation: translation,
                        isInteractive: isInteractive,
                    });
                }
            }
        };
    }, [model, map, newCircle, translation, isInteractive]);
    useListenTo(model, 'change:lat change:lon change:radius', callback);
    React.useEffect(function () {
        if (map && needsRedraw({ map: map, drawnMagnitude: drawnMagnitude })) {
            callback();
        }
    }, [cameraMagnitude, drawnMagnitude, callback, map]);
    React.useEffect(function () {
        callback();
    }, [callback]);
};
var useStartMapDrawing = function (_a) {
    var map = _a.map, model = _a.model, setNewCircle = _a.setNewCircle, onDraw = _a.onDraw;
    React.useEffect(function () {
        if (map && model) {
            map.getMap().drawHelper["startDrawingCircle"]({
                callback: function (center, radius) {
                    var circle = cartesian3ToCircle(center, radius, map.getMap().scene.globe.ellipsoid);
                    setNewCircle(circle);
                    onDraw(circle);
                },
                material: Cesium.Material.fromType('Color', {
                    color: Cesium.Color.fromAlpha(contrastingColor, 0.2),
                }),
            });
        }
    }, [map, model]);
};
export var CesiumCircleDisplay = function (_a) {
    var map = _a.map, model = _a.model, onDraw = _a.onDraw, translation = _a.translation, isInteractive = _a.isInteractive;
    // Use state to store the circle drawn by the user before they click Apply or Cancel.
    // When the user clicks Draw, they are allowed to edit the existing circle (if it
    // exists), or draw a new circle. If they draw a new circle, save it to state then show
    // it instead of the draw model because we don't want to update the draw model
    // unless the user clicks Apply.
    var _b = __read(React.useState(null), 2), newCircle = _b[0], setNewCircle = _b[1];
    if (onDraw) {
        useStartMapDrawing({ map: map, model: model, setNewCircle: setNewCircle, onDraw: onDraw });
    }
    useListenToModel({
        map: map,
        model: model,
        newCircle: newCircle,
        onDraw: onDraw,
        translation: translation,
        isInteractive: isInteractive,
    });
    React.useEffect(function () {
        return function () {
            if (model && map) {
                removeOldDrawing({ map: map, id: getIdFromModelForDisplay({ model: model }) });
                map.getMap().drawHelper.stopDrawing();
            }
        };
    }, [map, model]);
    return React.createElement(React.Fragment, null);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2lyY2xlLWRpc3BsYXkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9zcmMvbWFpbi93ZWJhcHAvY29tcG9uZW50L3Zpc3VhbGl6YXRpb24vbWFwcy9jZXNpdW0vY2lyY2xlLWRpc3BsYXkudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7Ozs7OztJQWFJO0FBQ0osT0FBTyxLQUFLLE1BQU0sT0FBTyxDQUFBO0FBQ3pCLE9BQU8sYUFBYSxNQUFNLDhCQUE4QixDQUFBO0FBQ3hELG1KQUFtSjtBQUNuSixPQUFPLE1BQU0sTUFBTSw0QkFBNEIsQ0FBQTtBQUMvQyxPQUFPLENBQUMsTUFBTSxZQUFZLENBQUE7QUFDMUIsT0FBTyxLQUFLLElBQUksTUFBTSxZQUFZLENBQUE7QUFDbEMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLDhDQUE4QyxDQUFBO0FBQzFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQTtBQUNwRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQTtBQUNoRixPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQTtBQUNqRSxPQUFPLFVBQVUsTUFBTSxjQUFjLENBQUE7QUFDckMsT0FBTyxVQUFVLE1BQU0sOENBQThDLENBQUE7QUFDckUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sOERBQThELENBQUE7QUFFL0YsSUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUE7QUFFbkMsSUFBTSwwQkFBMEIsR0FBRyxPQUFPLENBQUE7QUFTMUMsSUFBTSwwQkFBMEIsR0FBRyxVQUFDLEVBQXFCO1FBQW5CLEdBQUcsU0FBQTtJQUN2QyxPQUFPLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxNQUFNLENBQUMsWUFBWSxFQUFFLENBQUE7QUFDM0MsQ0FBQyxDQUFBO0FBRUQs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QUMsRUFZbkM7UUFYQyxHQUFHLFNBQUEsRUFDSCxLQUFLLFdBQUEsRUFDTCxNQUFNLFlBQUEsRUFDTixXQUFXLGlCQUFBLEVBQ1gsYUFBYSxtQkFBQTtJQVFiLHFGQUFxRjtJQUNyRixpRkFBaUY7SUFDakYsdUZBQXVGO0lBQ3ZGLDhFQUE4RTtJQUM5RSxnQ0FBZ0M7SUFDMUIsSUFBQSxLQUFBLE9BQTRCLEtBQUssQ0FBQyxRQUFRLENBQWdCLElBQUksQ0FBQyxJQUFBLEVBQTlELFNBQVMsUUFBQSxFQUFFLFlBQVksUUFBdUMsQ0FBQTtJQUNyRSxJQUFJLE1BQU0sRUFBRTtRQUNWLGtCQUFrQixDQUFDLEVBQUUsR0FBRyxLQUFBLEVBQUUsS0FBSyxPQUFBLEVBQUUsWUFBWSxjQUFBLEVBQUUsTUFBTSxRQUFBLEVBQUUsQ0FBQyxDQUFBO0tBQ3pEO0lBQ0QsZ0JBQWdCLENBQUM7UUFDZixHQUFHLEtBQUE7UUFDSCxLQUFLLE9BQUE7UUFDTCxTQUFTLFdBQUE7UUFDVCxNQUFNLFFBQUE7UUFDTixXQUFXLGFBQUE7UUFDWCxhQUFhLGVBQUE7S0FDZCxDQUFDLENBQUE7SUFDRixLQUFLLENBQUMsU0FBUyxDQUFDO1FBQ2QsT0FBTztZQUNMLElBQUksS0FBSyxJQUFJLEdBQUcsRUFBRTtnQkFDaEIsZ0JBQWdCLENBQUMsRUFBRSxHQUFHLEtBQUEsRUFBRSxFQUFFLEVBQUUsd0JBQXdCLENBQUMsRUFBRSxLQUFLLE9BQUEsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFBO2dCQUNsRSxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUMsVUFBVSxDQUFDLFdBQVcsRUFBRSxDQUFBO2FBQ3RDO1FBQ0gsQ0FBQyxDQUFBO0lBQ0gsQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUE7SUFDaEIsT0FBTyx5Q0FBSyxDQUFBO0FBQ2QsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgKGMpIENvZGljZSBGb3VuZGF0aW9uXG4gKlxuICogVGhpcyBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5IGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIExlc3NlclxuICogR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGVcbiAqIExpY2Vuc2UsIG9yIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLCBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXRcbiAqIGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YgTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiBTZWUgdGhlIEdOVVxuICogTGVzc2VyIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4gQSBjb3B5IG9mIHRoZSBHTlUgTGVzc2VyIEdlbmVyYWwgUHVibGljIExpY2Vuc2VcbiAqIGlzIGRpc3RyaWJ1dGVkIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtIGFuZCBjYW4gYmUgZm91bmQgYXRcbiAqIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvbGdwbC5odG1sPi5cbiAqXG4gKiovXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnXG5pbXBvcnQgRGlzdGFuY2VVdGlscyBmcm9tICcuLi8uLi8uLi8uLi9qcy9EaXN0YW5jZVV0aWxzJ1xuLy8gQHRzLWV4cGVjdC1lcnJvciB0cy1taWdyYXRlKDcwMTYpIEZJWE1FOiBDb3VsZCBub3QgZmluZCBhIGRlY2xhcmF0aW9uIGZpbGUgZm9yIG1vZHVsZSAnY2VzaS4uLiBSZW1vdmUgdGhpcyBjb21tZW50IHRvIHNlZSB0aGUgZnVsbCBlcnJvciBtZXNzYWdlXG5pbXBvcnQgQ2VzaXVtIGZyb20gJ2Nlc2l1bS9CdWlsZC9DZXNpdW0vQ2VzaXVtJ1xuaW1wb3J0IF8gZnJvbSAndW5kZXJzY29yZSdcbmltcG9ydCAqIGFzIFR1cmYgZnJvbSAnQHR1cmYvdHVyZidcbmltcG9ydCB7IHVzZUxpc3RlblRvIH0gZnJvbSAnLi4vLi4vLi4vc2VsZWN0aW9uLWNoZWNrYm94L3VzZUJhY2tib25lLmhvb2snXG5pbXBvcnQgeyB1c2VSZW5kZXIgfSBmcm9tICcuLi8uLi8uLi9ob29rcy91c2VSZW5kZXInXG5pbXBvcnQgeyByZW1vdmVPbGREcmF3aW5nLCByZW1vdmVPckxvY2tPbGREcmF3aW5nIH0gZnJvbSAnLi9kcmF3aW5nLWFuZC1kaXNwbGF5J1xuaW1wb3J0IHsgZ2V0SWRGcm9tTW9kZWxGb3JEaXNwbGF5IH0gZnJvbSAnLi4vZHJhd2luZy1hbmQtZGlzcGxheSdcbmltcG9ydCBUdXJmQ2lyY2xlIGZyb20gJ0B0dXJmL2NpcmNsZSdcbmltcG9ydCBEcmF3SGVscGVyIGZyb20gJy4uLy4uLy4uLy4uL2xpYi9jZXNpdW0tZHJhd2hlbHBlci9EcmF3SGVscGVyJ1xuaW1wb3J0IHsgY29udHJhc3RpbmdDb2xvciB9IGZyb20gJy4uLy4uLy4uLy4uL3JlYWN0LWNvbXBvbmVudC9sb2NhdGlvbi9sb2NhdGlvbi1jb2xvci1zZWxlY3RvcidcbmltcG9ydCB7IFRyYW5zbGF0aW9uIH0gZnJvbSAnLi4vaW50ZXJhY3Rpb25zLnByb3ZpZGVyJ1xuY29uc3QgdG9EZWcgPSBDZXNpdW0uTWF0aC50b0RlZ3JlZXNcblxuY29uc3QgQ0FNRVJBX01BR05JVFVERV9USFJFU0hPTEQgPSA4MDAwMDAwXG5cbnR5cGUgQ2lyY2xlID0ge1xuICBsb246IG51bWJlclxuICBsYXQ6IG51bWJlclxuICByYWRpdXM6IG51bWJlclxuICByYWRpdXNVbml0czogc3RyaW5nXG59XG5cbmNvbnN0IGdldEN1cnJlbnRNYWduaXR1ZGVGcm9tTWFwID0gKHsgbWFwIH06IHsgbWFwOiBhbnkgfSkgPT4ge1xuICByZXR1cm4gbWFwLmdldE1hcCgpLmNhbWVyYS5nZXRNYWduaXR1ZGUoKVxufVxuXG5jb25zdCBuZWVkc1JlZHJhdyA9ICh7XG4gIG1hcCxcbiAgZHJhd25NYWduaXR1ZGUsXG59OiB7XG4gIG1hcDogYW55XG4gIGRyYXduTWFnbml0dWRlOiBhbnlcbn0pID0+IHtcbiAgY29uc3QgY3VycmVudE1hZ25pdHVkZSA9IGdldEN1cnJlbnRNYWduaXR1ZGVGcm9tTWFwKHsgbWFwIH0pXG5cbiAgaWYgKFxuICAgIGN1cnJlbnRNYWduaXR1ZGUgPCBDQU1FUkFfTUFHTklUVURFX1RIUkVTSE9MRCAmJlxuICAgIGRyYXduTWFnbml0dWRlID4gQ0FNRVJBX01BR05JVFVERV9USFJFU0hPTERcbiAgKSB7XG4gICAgcmV0dXJuIHRydWVcbiAgfVxuICBpZiAoXG4gICAgY3VycmVudE1hZ25pdHVkZSA+IENBTUVSQV9NQUdOSVRVREVfVEhSRVNIT0xEICYmXG4gICAgZHJhd25NYWduaXR1ZGUgPCBDQU1FUkFfTUFHTklUVURFX1RIUkVTSE9MRFxuICApIHtcbiAgICByZXR1cm4gdHJ1ZVxuICB9XG5cbiAgcmV0dXJuIGZhbHNlXG59XG5cbmNvbnN0IGRlZmF1bHRBdHRycyA9IFsnbGF0JywgJ2xvbicsICdyYWRpdXMnXVxuXG5jb25zdCBpc01vZGVsUmVzZXQgPSAoeyBtb2RlbFByb3AgfTogeyBtb2RlbFByb3A6IGFueSB9KSA9PiB7XG4gIGlmIChcbiAgICBfLmV2ZXJ5KGRlZmF1bHRBdHRycywgKHZhbDogYW55KSA9PiBfLmlzVW5kZWZpbmVkKG1vZGVsUHJvcFt2YWxdKSkgfHxcbiAgICBfLmlzRW1wdHkobW9kZWxQcm9wKVxuICApIHtcbiAgICByZXR1cm4gdHJ1ZVxuICB9XG4gIHJldHVybiBmYWxzZVxufVxuXG5jb25zdCBjYXJ0ZXNpYW4zVG9DaXJjbGUgPSAoXG4gIGNlbnRlcjogQ2VzaXVtLkNhcnRlc2lhbjMsXG4gIHJhZGl1czogbnVtYmVyLFxuICBlbGxpcHNvaWQ6IENlc2l1bS5FbGxpcHNvaWRcbik6IENpcmNsZSA9PiB7XG4gIGNvbnN0IGxhdExvbiA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhjZW50ZXIpXG4gIGNvbnN0IGxvbiA9IHRvRGVnKGxhdExvbi5sb25naXR1ZGUpXG4gIGNvbnN0IGxhdCA9IHRvRGVnKGxhdExvbi5sYXRpdHVkZSlcbiAgbGV0IHJhZGl1c1VuaXRzID0gJ21ldGVycydcbiAgaWYgKHJhZGl1cyA+PSAxMDAwKSB7XG4gICAgcmFkaXVzIC89IDEwMDBcbiAgICByYWRpdXNVbml0cyA9ICdraWxvbWV0ZXJzJ1xuICB9XG4gIHJldHVybiB7XG4gICAgbG9uOiBEaXN0YW5jZVV0aWxzLmNvb3JkaW5hdGVSb3VuZChsb24pLFxuICAgIGxhdDogRGlzdGFuY2VVdGlscy5jb29yZGluYXRlUm91bmQobGF0KSxcbiAgICByYWRpdXMsXG4gICAgcmFkaXVzVW5pdHMsXG4gIH1cbn1cblxuY29uc3QgZHJhd0dlb21ldHJ5ID0gKHtcbiAgbW9kZWwsXG4gIG1hcCxcbiAgaWQsXG4gIG9uRHJhdyxcbiAgdHJhbnNsYXRpb24sXG4gIGlzSW50ZXJhY3RpdmUsXG59OiB7XG4gIG1vZGVsOiBhbnlcbiAgbWFwOiBhbnlcbiAgaWQ6IGFueVxuICBzZXREcmF3bk1hZ25pdHVkZTogKG51bWJlcjogYW55KSA9PiB2b2lkXG4gIG9uRHJhdz86IChkcmF3aW5nTG9jYXRpb246IENpcmNsZSkgPT4gdm9pZFxuICB0cmFuc2xhdGlvbj86IFRyYW5zbGF0aW9uXG4gIGlzSW50ZXJhY3RpdmU/OiBib29sZWFuIC8vIG5vdGU6ICdpbnRlcmFjdGl2ZScgaXMgZGlmZmVyZW50IGZyb20gZHJhd2luZ1xufSkgPT4ge1xuICAvLyBpZiBtb2RlbCBoYXMgYmVlbiByZXNldFxuXG4gIGNvbnN0IG1vZGVsUHJvcCA9IG1vZGVsLnRvSlNPTigpXG4gIGlmIChpc01vZGVsUmVzZXQoeyBtb2RlbFByb3AgfSkpIHtcbiAgICBtYXAuZ2V0TWFwKCkuc2NlbmUucmVxdWVzdFJlbmRlcigpXG4gICAgcmV0dXJuXG4gIH1cbiAgbW9kZWxQcm9wLmxhdCA9IHBhcnNlRmxvYXQobW9kZWxQcm9wLmxhdClcbiAgbW9kZWxQcm9wLmxvbiA9IHBhcnNlRmxvYXQobW9kZWxQcm9wLmxvbilcbiAgaWYgKE51bWJlci5pc05hTihtb2RlbFByb3AubGF0KSB8fCBOdW1iZXIuaXNOYU4obW9kZWxQcm9wLmxvbikpIHtcbiAgICBtYXAuZ2V0TWFwKCkuc2NlbmUucmVxdWVzdFJlbmRlcigpXG4gICAgcmV0dXJuXG4gIH1cblxuICBpZiAodHJhbnNsYXRpb24pIHtcbiAgICBtb2RlbFByb3AubG9uICs9IHRyYW5zbGF0aW9uLmxvbmdpdHVkZVxuICAgIG1vZGVsUHJvcC5sYXQgKz0gdHJhbnNsYXRpb24ubGF0aXR1ZGVcbiAgfVxuXG4gIHJlbW92ZU9yTG9ja09sZERyYXdpbmcoQm9vbGVhbihpc0ludGVyYWN0aXZlKSwgaWQsIG1hcCwgbW9kZWwpXG5cbiAgbGV0IHByaW1pdGl2ZVxuXG4gIGlmIChvbkRyYXcpIHtcbiAgICBwcmltaXRpdmUgPSBuZXcgKERyYXdIZWxwZXIuQ2lyY2xlUHJpbWl0aXZlIGFzIGFueSkoe1xuICAgICAgY2VudGVyOiBDZXNpdW0uQ2FydGVzaWFuMy5mcm9tRGVncmVlcyhtb2RlbFByb3AubG9uLCBtb2RlbFByb3AubGF0KSxcbiAgICAgIHJhZGl1czogRGlzdGFuY2VVdGlscy5nZXREaXN0YW5jZUluTWV0ZXJzKFxuICAgICAgICBtb2RlbFByb3AucmFkaXVzLFxuICAgICAgICBtb2RlbFByb3AucmFkaXVzVW5pdHNcbiAgICAgICksXG4gICAgICBoZWlnaHQ6IDAsXG4gICAgICBpZCxcbiAgICAgIG1hdGVyaWFsOiBDZXNpdW0uTWF0ZXJpYWwuZnJvbVR5cGUoJ0NvbG9yJywge1xuICAgICAgICBjb2xvcjogQ2VzaXVtLkNvbG9yLmZyb21BbHBoYShjb250cmFzdGluZ0NvbG9yLCAwLjIpLFxuICAgICAgfSksXG4gICAgfSlcbiAgICBwcmltaXRpdmUuc2V0RWRpdGFibGUoKVxuICAgIHByaW1pdGl2ZS5hZGRMaXN0ZW5lcignb25FZGl0ZWQnLCBmdW5jdGlvbiAoZXZlbnQ6IGFueSkge1xuICAgICAgY29uc3QgY2lyY2xlID0gY2FydGVzaWFuM1RvQ2lyY2xlKFxuICAgICAgICBldmVudC5jZW50ZXIsXG4gICAgICAgIGV2ZW50LnJhZGl1cyxcbiAgICAgICAgbWFwLmdldE1hcCgpLnNjZW5lLmdsb2JlLmVsbGlwc29pZFxuICAgICAgKVxuICAgICAgb25EcmF3KGNpcmNsZSlcbiAgICB9KVxuICB9IGVsc2Uge1xuICAgIGNvbnN0IGNvbG9yID0gbW9kZWwuZ2V0KCdjb2xvcicpXG5cbiAgICBjb25zdCBjZW50ZXJQdCA9IFR1cmYucG9pbnQoW21vZGVsUHJvcC5sb24sIG1vZGVsUHJvcC5sYXRdKVxuICAgIGNvbnN0IGNpcmNsZVRvQ2hlY2sgPSBUdXJmQ2lyY2xlKFxuICAgICAgY2VudGVyUHQsXG4gICAgICBEaXN0YW5jZVV0aWxzLmdldERpc3RhbmNlSW5NZXRlcnMoXG4gICAgICAgIG1vZGVsUHJvcC5yYWRpdXMsXG4gICAgICAgIG1vZGVsUHJvcC5yYWRpdXNVbml0c1xuICAgICAgKSxcbiAgICAgIHsgdW5pdHM6ICdtZXRlcnMnLCBzdGVwczogNjQgfVxuICAgIClcblxuICAgIHByaW1pdGl2ZSA9IG5ldyBDZXNpdW0uUG9seWxpbmVDb2xsZWN0aW9uKClcbiAgICBwcmltaXRpdmUuYWRkKHtcbiAgICAgIHdpZHRoOiBpc0ludGVyYWN0aXZlID8gMTIgOiA4LFxuICAgICAgbWF0ZXJpYWw6IENlc2l1bS5NYXRlcmlhbC5mcm9tVHlwZSgnUG9seWxpbmVPdXRsaW5lJywge1xuICAgICAgICBjb2xvcjogaXNJbnRlcmFjdGl2ZVxuICAgICAgICAgID8gQ2VzaXVtLkNvbG9yLmZyb21Dc3NDb2xvclN0cmluZyhjb250cmFzdGluZ0NvbG9yKVxuICAgICAgICAgIDogY29sb3JcbiAgICAgICAgICA/IENlc2l1bS5Db2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoY29sb3IpXG4gICAgICAgICAgOiBDZXNpdW0uQ29sb3IuS0hBS0ksXG4gICAgICAgIG91dGxpbmVDb2xvcjogQ2VzaXVtLkNvbG9yLldISVRFLFxuICAgICAgICBvdXRsaW5lV2lkdGg6IGlzSW50ZXJhY3RpdmUgPyA2IDogNCxcbiAgICAgIH0pLFxuICAgICAgaWQ6ICd1c2VyRHJhd2luZycsXG4gICAgICBwb3NpdGlvbnM6IENlc2l1bS5DYXJ0ZXNpYW4zLmZyb21EZWdyZWVzQXJyYXkoXG4gICAgICAgIF8uZmxhdHRlbihjaXJjbGVUb0NoZWNrLmdlb21ldHJ5LmNvb3JkaW5hdGVzKVxuICAgICAgKSxcbiAgICB9KVxuICB9XG5cbiAgcHJpbWl0aXZlLmlkID0gaWRcbiAgcHJpbWl0aXZlLmxvY2F0aW9uSWQgPSBtb2RlbFByb3AubG9jYXRpb25JZFxuICBtYXAuZ2V0TWFwKCkuc2NlbmUucHJpbWl0aXZlcy5hZGQocHJpbWl0aXZlKVxuICBtYXAuZ2V0TWFwKCkuc2NlbmUucmVxdWVzdFJlbmRlcigpXG59XG5cbmNvbnN0IHVzZUNhbWVyYU1hZ25pdHVkZSA9ICh7XG4gIG1hcCxcbn06IHtcbiAgbWFwOiBhbnlcbn0pOiBbbnVtYmVyLCBSZWFjdC5EaXNwYXRjaDxSZWFjdC5TZXRTdGF0ZUFjdGlvbjxudW1iZXI+Pl0gPT4ge1xuICBjb25zdCBbY2FtZXJhTWFnbml0dWRlLCBzZXRDYW1lcmFNYWduaXR1ZGVdID0gUmVhY3QudXNlU3RhdGUoMClcbiAgY29uc3QgW2lzTW92aW5nLCBzZXRJc01vdmluZ10gPSBSZWFjdC51c2VTdGF0ZShmYWxzZSlcbiAgY29uc3QgcmVuZGVyID0gdXNlUmVuZGVyKClcbiAgUmVhY3QudXNlRWZmZWN0KCgpID0+IHtcbiAgICBjb25zdCBzdGFydExpc3RlbmVyID0gKCkgPT4gc2V0SXNNb3ZpbmcodHJ1ZSlcbiAgICBjb25zdCBlbmRMaXN0ZW5lciA9ICgpID0+IHNldElzTW92aW5nKGZhbHNlKVxuICAgIG1hcD8uZ2V0TWFwKCkuc2NlbmUuY2FtZXJhLm1vdmVTdGFydC5hZGRFdmVudExpc3RlbmVyKHN0YXJ0TGlzdGVuZXIpXG4gICAgbWFwPy5nZXRNYXAoKS5zY2VuZS5jYW1lcmEubW92ZUVuZC5hZGRFdmVudExpc3RlbmVyKGVuZExpc3RlbmVyKVxuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICBtYXA/LmdldE1hcCgpLnNjZW5lLmNhbWVyYS5tb3ZlU3RhcnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihzdGFydExpc3RlbmVyKVxuICAgICAgbWFwPy5nZXRNYXAoKS5zY2VuZS5jYW1lcmEubW92ZUVuZC5yZW1vdmVFdmVudExpc3RlbmVyKGVuZExpc3RlbmVyKVxuICAgIH1cbiAgfSwgW21hcF0pXG4gIFJlYWN0LnVzZUVmZmVjdCgoKSA9PiB7XG4gICAgaWYgKGlzTW92aW5nKSB7XG4gICAgICBjb25zdCBhbmltYXRpb25JZCA9IHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xuICAgICAgICBzZXRDYW1lcmFNYWduaXR1ZGUoZ2V0Q3VycmVudE1hZ25pdHVkZUZyb21NYXAoeyBtYXAgfSkpXG4gICAgICB9KVxuICAgICAgcmV0dXJuICgpID0+IHtcbiAgICAgICAgd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lKGFuaW1hdGlvbklkKVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gKCkgPT4ge31cbiAgfSwgW2lzTW92aW5nLCByZW5kZXJdKVxuICByZXR1cm4gW2NhbWVyYU1hZ25pdHVkZSwgc2V0Q2FtZXJhTWFnbml0dWRlXVxufVxuXG5jb25zdCB1c2VMaXN0ZW5Ub01vZGVsID0gKHtcbiAgbW9kZWwsXG4gIG1hcCxcbiAgbmV3Q2lyY2xlLFxuICBvbkRyYXcsXG4gIHRyYW5zbGF0aW9uLFxuICBpc0ludGVyYWN0aXZlLFxufToge1xuICBtb2RlbDogYW55XG4gIG1hcDogYW55XG4gIG5ld0NpcmNsZTogQ2lyY2xlIHwgbnVsbFxuICBvbkRyYXc/OiAoZHJhd2luZ0xvY2F0aW9uOiBDaXJjbGUpID0+IHZvaWRcbiAgdHJhbnNsYXRpb24/OiBUcmFuc2xhdGlvblxuICBpc0ludGVyYWN0aXZlPzogYm9vbGVhbiAvLyBub3RlOiAnaW50ZXJhY3RpdmUnIGlzIGRpZmZlcmVudCBmcm9tIGRyYXdpbmdcbn0pID0+IHtcbiAgY29uc3QgW2NhbWVyYU1hZ25pdHVkZV0gPSB1c2VDYW1lcmFNYWduaXR1ZGUoeyBtYXAgfSlcbiAgY29uc3QgW2RyYXduTWFnbml0dWRlLCBzZXREcmF3bk1hZ25pdHVkZV0gPSBSZWFjdC51c2VTdGF0ZSgwKVxuICBjb25zdCBjYWxsYmFjayA9IFJlYWN0LnVzZU1lbW8oKCkgPT4ge1xuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICBpZiAobWFwKSB7XG4gICAgICAgIGlmIChuZXdDaXJjbGUpIHtcbiAgICAgICAgICAvLyBDbG9uZSB0aGUgbW9kZWwgdG8gZGlzcGxheSB0aGUgbmV3IGNpcmNsZSBkcmF3biBiZWNhdXNlIHdlIGRvbid0XG4gICAgICAgICAgLy8gd2FudCB0byB1cGRhdGUgdGhlIGV4aXN0aW5nIG1vZGVsIHVubGVzcyB0aGUgdXNlciBjbGlja3MgQXBwbHkuXG4gICAgICAgICAgY29uc3QgbmV3TW9kZWwgPSBtb2RlbC5jbG9uZSgpXG4gICAgICAgICAgbmV3TW9kZWwuc2V0KG5ld0NpcmNsZSlcbiAgICAgICAgICBkcmF3R2VvbWV0cnkoe1xuICAgICAgICAgICAgbWFwLFxuICAgICAgICAgICAgbW9kZWw6IG5ld01vZGVsLFxuICAgICAgICAgICAgaWQ6IGdldElkRnJvbU1vZGVsRm9yRGlzcGxheSh7IG1vZGVsIH0pLFxuICAgICAgICAgICAgc2V0RHJhd25NYWduaXR1ZGUsXG4gICAgICAgICAgICBvbkRyYXcsXG4gICAgICAgICAgfSlcbiAgICAgICAgfSBlbHNlIGlmIChtb2RlbCkge1xuICAgICAgICAgIGRyYXdHZW9tZXRyeSh7XG4gICAgICAgICAgICBtYXAsXG4gICAgICAgICAgICBtb2RlbCxcbiAgICAgICAgICAgIGlkOiBnZXRJZEZyb21Nb2RlbEZvckRpc3BsYXkoeyBtb2RlbCB9KSxcbiAgICAgICAgICAgIHNldERyYXduTWFnbml0dWRlLFxuICAgICAgICAgICAgb25EcmF3LFxuICAgICAgICAgICAgdHJhbnNsYXRpb24sXG4gICAgICAgICAgICBpc0ludGVyYWN0aXZlLFxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH0sIFttb2RlbCwgbWFwLCBuZXdDaXJjbGUsIHRyYW5zbGF0aW9uLCBpc0ludGVyYWN0aXZlXSlcbiAgdXNlTGlzdGVuVG8obW9kZWwsICdjaGFuZ2U6bGF0IGNoYW5nZTpsb24gY2hhbmdlOnJhZGl1cycsIGNhbGxiYWNrKVxuICBSZWFjdC51c2VFZmZlY3QoKCkgPT4ge1xuICAgIGlmIChtYXAgJiYgbmVlZHNSZWRyYXcoeyBtYXAsIGRyYXduTWFnbml0dWRlIH0pKSB7XG4gICAgICBjYWxsYmFjaygpXG4gICAgfVxuICB9LCBbY2FtZXJhTWFnbml0dWRlLCBkcmF3bk1hZ25pdHVkZSwgY2FsbGJhY2ssIG1hcF0pXG4gIFJlYWN0LnVzZUVmZmVjdCgoKSA9PiB7XG4gICAgY2FsbGJhY2soKVxuICB9LCBbY2FsbGJhY2tdKVxufVxuXG5jb25zdCB1c2VTdGFydE1hcERyYXdpbmcgPSAoe1xuICBtYXAsXG4gIG1vZGVsLFxuICBzZXROZXdDaXJjbGUsXG4gIG9uRHJhdyxcbn06IHtcbiAgbWFwOiBhbnlcbiAgbW9kZWw6IGFueVxuICBzZXROZXdDaXJjbGU6IChuZXdDaXJjbGU6IENpcmNsZSkgPT4gdm9pZFxuICBvbkRyYXc6IChuZXdDaXJjbGU6IENpcmNsZSkgPT4gdm9pZFxufSkgPT4ge1xuICBSZWFjdC51c2VFZmZlY3QoKCkgPT4ge1xuICAgIGlmIChtYXAgJiYgbW9kZWwpIHtcbiAgICAgIG1hcC5nZXRNYXAoKS5kcmF3SGVscGVyW2BzdGFydERyYXdpbmdDaXJjbGVgXSh7XG4gICAgICAgIGNhbGxiYWNrOiAoY2VudGVyOiBDZXNpdW0uQ2FydGVzaWFuMywgcmFkaXVzOiBudW1iZXIpID0+IHtcbiAgICAgICAgICBjb25zdCBjaXJjbGUgPSBjYXJ0ZXNpYW4zVG9DaXJjbGUoXG4gICAgICAgICAgICBjZW50ZXIsXG4gICAgICAgICAgICByYWRpdXMsXG4gICAgICAgICAgICBtYXAuZ2V0TWFwKCkuc2NlbmUuZ2xvYmUuZWxsaXBzb2lkXG4gICAgICAgICAgKVxuICAgICAgICAgIHNldE5ld0NpcmNsZShjaXJjbGUpXG4gICAgICAgICAgb25EcmF3KGNpcmNsZSlcbiAgICAgICAgfSxcbiAgICAgICAgbWF0ZXJpYWw6IENlc2l1bS5NYXRlcmlhbC5mcm9tVHlwZSgnQ29sb3InLCB7XG4gICAgICAgICAgY29sb3I6IENlc2l1bS5Db2xvci5mcm9tQWxwaGEoY29udHJhc3RpbmdDb2xvciwgMC4yKSxcbiAgICAgICAgfSksXG4gICAgICB9KVxuICAgIH1cbiAgfSwgW21hcCwgbW9kZWxdKVxufVxuXG5leHBvcnQgY29uc3QgQ2VzaXVtQ2lyY2xlRGlzcGxheSA9ICh7XG4gIG1hcCxcbiAgbW9kZWwsXG4gIG9uRHJhdyxcbiAgdHJhbnNsYXRpb24sXG4gIGlzSW50ZXJhY3RpdmUsXG59OiB7XG4gIG1hcDogYW55XG4gIG1vZGVsOiBhbnlcbiAgb25EcmF3PzogKG5ld0NpcmNsZTogQ2lyY2xlKSA9PiB2b2lkXG4gIHRyYW5zbGF0aW9uPzogVHJhbnNsYXRpb25cbiAgaXNJbnRlcmFjdGl2ZT86IGJvb2xlYW4gLy8gbm90ZTogJ2ludGVyYWN0aXZlJyBpcyBkaWZmZXJlbnQgZnJvbSBkcmF3aW5nXG59KSA9PiB7XG4gIC8vIFVzZSBzdGF0ZSB0byBzdG9yZSB0aGUgY2lyY2xlIGRyYXduIGJ5IHRoZSB1c2VyIGJlZm9yZSB0aGV5IGNsaWNrIEFwcGx5IG9yIENhbmNlbC5cbiAgLy8gV2hlbiB0aGUgdXNlciBjbGlja3MgRHJhdywgdGhleSBhcmUgYWxsb3dlZCB0byBlZGl0IHRoZSBleGlzdGluZyBjaXJjbGUgKGlmIGl0XG4gIC8vIGV4aXN0cyksIG9yIGRyYXcgYSBuZXcgY2lyY2xlLiBJZiB0aGV5IGRyYXcgYSBuZXcgY2lyY2xlLCBzYXZlIGl0IHRvIHN0YXRlIHRoZW4gc2hvd1xuICAvLyBpdCBpbnN0ZWFkIG9mIHRoZSBkcmF3IG1vZGVsIGJlY2F1c2Ugd2UgZG9uJ3Qgd2FudCB0byB1cGRhdGUgdGhlIGRyYXcgbW9kZWxcbiAgLy8gdW5sZXNzIHRoZSB1c2VyIGNsaWNrcyBBcHBseS5cbiAgY29uc3QgW25ld0NpcmNsZSwgc2V0TmV3Q2lyY2xlXSA9IFJlYWN0LnVzZVN0YXRlPENpcmNsZSB8IG51bGw+KG51bGwpXG4gIGlmIChvbkRyYXcpIHtcbiAgICB1c2VTdGFydE1hcERyYXdpbmcoeyBtYXAsIG1vZGVsLCBzZXROZXdDaXJjbGUsIG9uRHJhdyB9KVxuICB9XG4gIHVzZUxpc3RlblRvTW9kZWwoe1xuICAgIG1hcCxcbiAgICBtb2RlbCxcbiAgICBuZXdDaXJjbGUsXG4gICAgb25EcmF3LFxuICAgIHRyYW5zbGF0aW9uLFxuICAgIGlzSW50ZXJhY3RpdmUsXG4gIH0pXG4gIFJlYWN0LnVzZUVmZmVjdCgoKSA9PiB7XG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIGlmIChtb2RlbCAmJiBtYXApIHtcbiAgICAgICAgcmVtb3ZlT2xkRHJhd2luZyh7IG1hcCwgaWQ6IGdldElkRnJvbU1vZGVsRm9yRGlzcGxheSh7IG1vZGVsIH0pIH0pXG4gICAgICAgIG1hcC5nZXRNYXAoKS5kcmF3SGVscGVyLnN0b3BEcmF3aW5nKClcbiAgICAgIH1cbiAgICB9XG4gIH0sIFttYXAsIG1vZGVsXSlcbiAgcmV0dXJuIDw+PC8+XG59XG4iXX0=