import { Fragment as _Fragment, jsx as _jsx } from "react/jsx-runtime";
/**
 * Copyright (c) Codice Foundation
 *
 * This is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser
 * General Public License as published by the Free Software Foundation, either version 3 of the
 * License, or any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
 * even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details. A copy of the GNU Lesser General Public License
 * is distributed along with this program and can be found at
 * <http://www.gnu.org/licenses/lgpl.html>.
 *
 **/
import React from 'react';
import DistanceUtils from '../../../../js/DistanceUtils';
import { transform as projTransform } from 'ol/proj';
import { Vector as VectorSource } from 'ol/source';
import { Vector as VectorLayer } from 'ol/layer';
import Feature from 'ol/Feature';
import Style from 'ol/style/Style';
import { Stroke } from 'ol/style';
import MultiPolygon from 'ol/geom/MultiPolygon';
import _ from 'underscore';
import { multiLineString, buffer, bbox, polygon as turfPolygon, union, coordEach, featureCollection, } from '@turf/turf';
import { validateGeo } from '../../../../react-component/utils/validation';
import { useListenTo } from '../../../selection-checkbox/useBackbone.hook';
import { removeOldDrawing } from './drawing-and-display';
import ShapeUtils from '../../../../js/ShapeUtils';
import { getIdFromModelForDisplay } from '../drawing-and-display';
import { StartupDataStore } from '../../../../js/model/Startup/startup';
import { contrastingColor } from '../../../../react-component/location/location-color-selector';
export var translateFromOpenlayersCoordinates = function (coords) {
    return coords
        .map(function (value) {
        return value.map(function (point) {
            var mappedPoint = projTransform([
                DistanceUtils.coordinateRound(point[0]),
                DistanceUtils.coordinateRound(point[1]),
            ], StartupDataStore.Configuration.getProjection(), 'EPSG:4326');
            if (mappedPoint[1] > 90) {
                mappedPoint[1] = 89.9;
            }
            else if (mappedPoint[1] < -90) {
                mappedPoint[1] = -89.9;
            }
            return mappedPoint;
        });
    })
        .flatten();
};
var coordsToLineString = function (rawCoords) {
    var setArr = _.uniq(rawCoords);
    if (setArr.length < 3) {
        return;
    }
    var coords = setArr.map(function (item) {
        return projTransform([item[0], item[1]], 'EPSG:4326', StartupDataStore.Configuration.getProjection());
    });
    // Ensure that the first and last coordinate are the same
    if (!_.isEqual(coords[0], coords[coords.length - 1])) {
        coords.push(coords[0]);
    }
    return [coords];
};
var modelToPolygon = function (model) {
    var _a;
    var coords = model.get('polygon');
    if (coords && coords.length === 0) {
        return new MultiPolygon([]);
    }
    if (coords &&
        coords.length > 0 &&
        coords[0].toString() !== coords[coords.length - 1].toString()) {
        coords.push(coords[0]);
    }
    if (coords === undefined ||
        ((_a = validateGeo('polygon', JSON.stringify(coords))) === null || _a === void 0 ? void 0 : _a.error)) {
        return;
    }
    var isMultiPolygon = ShapeUtils.isArray3D(coords);
    var multiPolygon = isMultiPolygon ? coords : [coords];
    var polygons = [];
    multiPolygon.forEach(function (polygon) {
        var lineString = coordsToLineString(polygon);
        if (lineString) {
            polygons.push(lineString);
        }
    });
    return new MultiPolygon(polygons);
};
var adjustPolygonPoints = function (polygon) {
    var extent = polygon.getExtent();
    var lon1 = extent[0];
    var lon2 = extent[2];
    var width = Math.abs(lon1 - lon2);
    if (width > 180) {
        var adjusted = polygon.getCoordinates();
        adjusted.forEach(function (ring) {
            ring.forEach(function (coord) {
                if (coord[0] < 0) {
                    coord[0] += 360;
                }
            });
        });
        polygon.setCoordinates(adjusted);
    }
};
var adjustMultiPolygonPoints = function (polygons) {
    var adjusted = [];
    polygons.getPolygons().forEach(function (polygon) {
        adjustPolygonPoints(polygon);
        adjusted.push(polygon.getCoordinates());
    });
    polygons.setCoordinates(adjusted);
};
export var drawPolygon = function (_a) {
    var map = _a.map, model = _a.model, polygon = _a.polygon, id = _a.id, isInteractive = _a.isInteractive, translation = _a.translation;
    if (!polygon) {
        // Handles case where model changes to empty vars and we don't want to draw anymore
        return;
    }
    if (translation) {
        polygon.translate(translation.longitude, translation.latitude);
    }
    adjustMultiPolygonPoints(polygon);
    var coordinates = polygon.getCoordinates();
    var bufferWidth = DistanceUtils.getDistanceInMeters(model.get('polygonBufferWidth'), model.get('polygonBufferUnits')) || 1;
    var drawnPolygonSegments = coordinates.map(function (set) {
        return multiLineString([translateFromOpenlayersCoordinates(set)]).geometry
            .coordinates;
    });
    var bufferPolygonSegments = coordinates.map(function (set) {
        var _a;
        var polySegment = multiLineString([
            translateFromOpenlayersCoordinates(set),
        ]);
        var bufferedSegment = buffer(polySegment, bufferWidth, {
            units: 'meters',
        });
        if (!bufferedSegment) {
            return;
        }
        var extent = bbox(bufferedSegment);
        var width = Math.abs(extent[0] - extent[2]);
        // need to adjust the points again AFTER buffering, since buffering undoes the antimeridian adjustments
        if (width > 180) {
            coordEach(bufferedSegment, function (coord) {
                if (coord[0] < 0) {
                    coord[0] += 360;
                }
            });
        }
        var bufferPolygons = bufferedSegment.geometry.coordinates.map(function (set) {
            return turfPolygon([set]);
        });
        return (_a = bufferPolygons.reduce(function (a, b) { return union(featureCollection([a, b])); }, bufferPolygons[0])) === null || _a === void 0 ? void 0 : _a.geometry.coordinates;
    });
    var bufferGeometryRepresentation = new MultiPolygon(bufferPolygonSegments);
    var drawnGeometryRepresentation = new MultiPolygon(drawnPolygonSegments);
    var billboard = new Feature({
        geometry: bufferGeometryRepresentation,
    });
    billboard.setId(id);
    billboard.set('locationId', model.get('locationId'));
    var drawnPolygonFeature = new Feature({
        geometry: drawnGeometryRepresentation,
    });
    var color = model.get('color');
    var bufferPolygonIconStyle = new Style({
        stroke: new Stroke({
            color: isInteractive ? contrastingColor : color ? color : '#914500',
            width: isInteractive ? 6 : 4,
        }),
        zIndex: 1,
    });
    var drawnPolygonIconStyle = new Style({
        stroke: new Stroke({
            color: isInteractive ? contrastingColor : color ? color : '#914500',
            width: isInteractive ? 5 : 3,
            lineDash: [10, 5],
        }),
        zIndex: 0,
    });
    billboard.setStyle(bufferPolygonIconStyle);
    drawnPolygonFeature.setStyle(drawnPolygonIconStyle);
    var vectorSource = new VectorSource({
        features: [billboard, drawnPolygonFeature],
    });
    var vectorLayer = new VectorLayer({
        source: vectorSource,
    });
    var mapRef = map.getMap();
    removeOldDrawing({ map: mapRef, id: id });
    vectorLayer.set('id', id);
    mapRef.addLayer(vectorLayer);
};
var updatePrimitive = function (_a) {
    var map = _a.map, model = _a.model, id = _a.id, isInteractive = _a.isInteractive, translation = _a.translation;
    var polygon = modelToPolygon(model);
    if (polygon !== undefined) {
        drawPolygon({ map: map, model: model, polygon: polygon, id: id, isInteractive: isInteractive, translation: translation });
    }
};
var useListenToPolygonModel = function (_a) {
    var model = _a.model, map = _a.map, isInteractive = _a.isInteractive, translation = _a.translation;
    var callback = React.useMemo(function () {
        return function () {
            if (model && map) {
                updatePrimitive({
                    map: map,
                    model: model,
                    id: getIdFromModelForDisplay({ model: model }),
                    isInteractive: isInteractive,
                    translation: translation,
                });
            }
        };
    }, [model, map, isInteractive, translation]);
    useListenTo(model, 'change:polygon change:polygonBufferWidth change:polygonBufferUnits', callback);
    callback();
};
export var OpenlayersPolygonDisplay = function (_a) {
    var map = _a.map, model = _a.model, isInteractive = _a.isInteractive, translation = _a.translation;
    useListenToPolygonModel({ map: map, model: model, isInteractive: isInteractive, translation: translation });
    React.useEffect(function () {
        return function () {
            if (map && model) {
                removeOldDrawing({
                    map: map.getMap(),
                    id: getIdFromModelForDisplay({ model: model }),
                });
            }
        };
    }, [map, model]);
    return _jsx(_Fragment, {});
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9seWdvbi1kaXNwbGF5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vc3JjL21haW4vd2ViYXBwL2NvbXBvbmVudC92aXN1YWxpemF0aW9uL21hcHMvb3BlbmxheWVycy9wb2x5Z29uLWRpc3BsYXkudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7Ozs7OztJQWFJO0FBQ0osT0FBTyxLQUFLLE1BQU0sT0FBTyxDQUFBO0FBQ3pCLE9BQU8sYUFBYSxNQUFNLDhCQUE4QixDQUFBO0FBRXhELE9BQU8sRUFBRSxTQUFTLElBQUksYUFBYSxFQUFFLE1BQU0sU0FBUyxDQUFBO0FBQ3BELE9BQU8sRUFBRSxNQUFNLElBQUksWUFBWSxFQUFFLE1BQU0sV0FBVyxDQUFBO0FBQ2xELE9BQU8sRUFBRSxNQUFNLElBQUksV0FBVyxFQUFFLE1BQU0sVUFBVSxDQUFBO0FBQ2hELE9BQU8sT0FBTyxNQUFNLFlBQVksQ0FBQTtBQUNoQyxPQUFPLEtBQUssTUFBTSxnQkFBZ0IsQ0FBQTtBQUNsQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sVUFBVSxDQUFBO0FBRWpDLE9BQU8sWUFBWSxNQUFNLHNCQUFzQixDQUFBO0FBRS9DLE9BQU8sQ0FBQyxNQUFNLFlBQVksQ0FBQTtBQUMxQixPQUFPLEVBQ0wsZUFBZSxFQUNmLE1BQU0sRUFDTixJQUFJLEVBQ0osT0FBTyxJQUFJLFdBQVcsRUFDdEIsS0FBSyxFQUNMLFNBQVMsRUFDVCxpQkFBaUIsR0FDbEIsTUFBTSxZQUFZLENBQUE7QUFDbkIsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLDhDQUE4QyxDQUFBO0FBQzFFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSw4Q0FBOEMsQ0FBQTtBQUMxRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQTtBQUN4RCxPQUFPLFVBQVUsTUFBTSwyQkFBMkIsQ0FBQTtBQUNsRCxPQUFPLEVBQUUsd0JB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TUFBTSxDQUFDLElBQU0sd0JBQXdCLEdBQUcsVUFBQyxFQVV4QztRQVRDLEdBQUcsU0FBQSxFQUNILEtBQUssV0FBQSxFQUNMLGFBQWEsbUJBQUEsRUFDYixXQUFXLGlCQUFBO0lBT1gsdUJBQXVCLENBQUMsRUFBRSxHQUFHLEtBQUEsRUFBRSxLQUFLLE9BQUEsRUFBRSxhQUFhLGVBQUEsRUFBRSxXQUFXLGFBQUEsRUFBRSxDQUFDLENBQUE7SUFDbkUsS0FBSyxDQUFDLFNBQVMsQ0FBQztRQUNkLE9BQU87WUFDTCxJQUFJLEdBQUcsSUFBSSxLQUFLLEVBQUUsQ0FBQztnQkFDakIsZ0JBQWdCLENBQUM7b0JBQ2YsR0FBRyxFQUFFLEdBQUcsQ0FBQyxNQUFNLEVBQUU7b0JBQ2pCLEVBQUUsRUFBRSx3QkFBd0IsQ0FBQyxFQUFFLEtBQUssT0FBQSxFQUFFLENBQUM7aUJBQ3hDLENBQUMsQ0FBQTtZQUNKLENBQUM7UUFDSCxDQUFDLENBQUE7SUFDSCxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQTtJQUNoQixPQUFPLG1CQUFLLENBQUE7QUFDZCxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAoYykgQ29kaWNlIEZvdW5kYXRpb25cbiAqXG4gKiBUaGlzIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgTGVzc2VyXG4gKiBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieSB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZVxuICogTGljZW5zZSwgb3IgYW55IGxhdGVyIHZlcnNpb24uXG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dFxuICogZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuIFNlZSB0aGUgR05VXG4gKiBMZXNzZXIgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLiBBIGNvcHkgb2YgdGhlIEdOVSBMZXNzZXIgR2VuZXJhbCBQdWJsaWMgTGljZW5zZVxuICogaXMgZGlzdHJpYnV0ZWQgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0gYW5kIGNhbiBiZSBmb3VuZCBhdFxuICogPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy9sZ3BsLmh0bWw+LlxuICpcbiAqKi9cbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCdcbmltcG9ydCBEaXN0YW5jZVV0aWxzIGZyb20gJy4uLy4uLy4uLy4uL2pzL0Rpc3RhbmNlVXRpbHMnXG5pbXBvcnQgeyBDb29yZGluYXRlIH0gZnJvbSAnb2wvY29vcmRpbmF0ZSdcbmltcG9ydCB7IHRyYW5zZm9ybSBhcyBwcm9qVHJhbnNmb3JtIH0gZnJvbSAnb2wvcHJvaidcbmltcG9ydCB7IFZlY3RvciBhcyBWZWN0b3JTb3VyY2UgfSBmcm9tICdvbC9zb3VyY2UnXG5pbXBvcnQgeyBWZWN0b3IgYXMgVmVjdG9yTGF5ZXIgfSBmcm9tICdvbC9sYXllcidcbmltcG9ydCBGZWF0dXJlIGZyb20gJ29sL0ZlYXR1cmUnXG5pbXBvcnQgU3R5bGUgZnJvbSAnb2wvc3R5bGUvU3R5bGUnXG5pbXBvcnQgeyBTdHJva2UgfSBmcm9tICdvbC9zdHlsZSdcbmltcG9ydCBNYXAgZnJvbSAnb2wvTWFwJ1xuaW1wb3J0IE11bHRpUG9seWdvbiBmcm9tICdvbC9nZW9tL011bHRpUG9seWdvbidcbmltcG9ydCBQb2x5Z29uIGZyb20gJ29sL2dlb20vUG9seWdvbidcbmltcG9ydCBfIGZyb20gJ3VuZGVyc2NvcmUnXG5pbXBvcnQge1xuICBtdWx0aUxpbmVTdHJpbmcsXG4gIGJ1ZmZlcixcbiAgYmJveCxcbiAgcG9seWdvbiBhcyB0dXJmUG9seWdvbixcbiAgdW5pb24sXG4gIGNvb3JkRWFjaCxcbiAgZmVhdHVyZUNvbGxlY3Rpb24sXG59IGZyb20gJ0B0dXJmL3R1cmYnXG5pbXBvcnQgeyB2YWxpZGF0ZUdlbyB9IGZyb20gJy4uLy4uLy4uLy4uL3JlYWN0LWNvbXBvbmVudC91dGlscy92YWxpZGF0aW9uJ1xuaW1wb3J0IHsgdXNlTGlzdGVuVG8gfSBmcm9tICcuLi8uLi8uLi9zZWxlY3Rpb24tY2hlY2tib3gvdXNlQmFja2JvbmUuaG9vaydcbmltcG9ydCB7IHJlbW92ZU9sZERyYXdpbmcgfSBmcm9tICcuL2RyYXdpbmctYW5kLWRpc3BsYXknXG5pbXBvcnQgU2hhcGVVdGlscyBmcm9tICcuLi8uLi8uLi8uLi9qcy9TaGFwZVV0aWxzJ1xuaW1wb3J0IHsgZ2V0SWRGcm9tTW9kZWxGb3JEaXNwbGF5IH0gZnJvbSAnLi4vZHJhd2luZy1hbmQtZGlzcGxheSdcbmltcG9ydCB7IFN0YXJ0dXBEYXRhU3RvcmUgfSBmcm9tICcuLi8uLi8uLi8uLi9qcy9tb2RlbC9TdGFydHVwL3N0YXJ0dXAnXG5pbXBvcnQgeyBUcmFuc2xhdGlvbiB9IGZyb20gJy4uL2ludGVyYWN0aW9ucy5wcm92aWRlcidcbmltcG9ydCB7IGNvbnRyYXN0aW5nQ29sb3IgfSBmcm9tICcuLi8uLi8uLi8uLi9yZWFjdC1jb21wb25lbnQvbG9jYXRpb24vbG9jYXRpb24tY29sb3Itc2VsZWN0b3InXG5leHBvcnQgY29uc3QgdHJhbnNsYXRlRnJvbU9wZW5sYXllcnNDb29yZGluYXRlcyA9IChjb29yZHM6IGFueSkgPT4ge1xuICByZXR1cm4gY29vcmRzXG4gICAgLm1hcCgodmFsdWU6IGFueSkgPT5cbiAgICAgIHZhbHVlLm1hcCgocG9pbnQ6IGFueSkgPT4ge1xuICAgICAgICBjb25zdCBtYXBwZWRQb2ludCA9IHByb2pUcmFuc2Zvcm0oXG4gICAgICAgICAgW1xuICAgICAgICAgICAgRGlzdGFuY2VVdGlscy5jb29yZGluYXRlUm91bmQocG9pbnRbMF0pLFxuICAgICAgICAgICAgRGlzdGFuY2VVdGlscy5jb29yZGluYXRlUm91bmQocG9pbnRbMV0pLFxuICAgICAgICAgIF0sXG4gICAgICAgICAgU3RhcnR1cERhdGFTdG9yZS5Db25maWd1cmF0aW9uLmdldFByb2plY3Rpb24oKSxcbiAgICAgICAgICAnRVBTRzo0MzI2J1xuICAgICAgICApXG4gICAgICAgIGlmIChtYXBwZWRQb2ludFsxXSA+IDkwKSB7XG4gICAgICAgICAgbWFwcGVkUG9pbnRbMV0gPSA4OS45XG4gICAgICAgIH0gZWxzZSBpZiAobWFwcGVkUG9pbnRbMV0gPCAtOTApIHtcbiAgICAgICAgICBtYXBwZWRQb2ludFsxXSA9IC04OS45XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG1hcHBlZFBvaW50XG4gICAgICB9KVxuICAgIClcbiAgICAuZmxhdHRlbigpXG59XG5jb25zdCBjb29yZHNUb0xpbmVTdHJpbmcgPSAocmF3Q29vcmRzOiBhbnkpID0+IHtcbiAgY29uc3Qgc2V0QXJyID0gXy51bmlxKHJhd0Nvb3JkcylcbiAgaWYgKHNldEFyci5sZW5ndGggPCAzKSB7XG4gICAgcmV0dXJuXG4gIH1cbiAgY29uc3QgY29vcmRzID0gc2V0QXJyLm1hcCgoaXRlbTogYW55KSA9PlxuICAgIHByb2pUcmFuc2Zvcm0oXG4gICAgICBbaXRlbVswXSwgaXRlbVsxXV0sXG4gICAgICAnRVBTRzo0MzI2JyxcbiAgICAgIFN0YXJ0dXBEYXRhU3RvcmUuQ29uZmlndXJhdGlvbi5nZXRQcm9qZWN0aW9uKClcbiAgICApXG4gIClcbiAgLy8gRW5zdXJlIHRoYXQgdGhlIGZpcnN0IGFuZCBsYXN0IGNvb3JkaW5hdGUgYXJlIHRoZSBzYW1lXG4gIGlmICghXy5pc0VxdWFsKGNvb3Jkc1swXSwgY29vcmRzW2Nvb3Jkcy5sZW5ndGggLSAxXSkpIHtcbiAgICBjb29yZHMucHVzaChjb29yZHNbMF0pXG4gIH1cbiAgcmV0dXJuIFtjb29yZHNdXG59XG5jb25zdCBtb2RlbFRvUG9seWdvbiA9IChtb2RlbDogYW55KSA9PiB7XG4gIGNvbnN0IGNvb3JkcyA9IG1vZGVsLmdldCgncG9seWdvbicpXG5cbiAgaWYgKGNvb3JkcyAmJiBjb29yZHMubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIG5ldyBNdWx0aVBvbHlnb24oW10pXG4gIH1cblxuICBpZiAoXG4gICAgY29vcmRzICYmXG4gICAgY29vcmRzLmxlbmd0aCA+IDAgJiZcbiAgICBjb29yZHNbMF0udG9TdHJpbmcoKSAhPT0gY29vcmRzW2Nvb3Jkcy5sZW5ndGggLSAxXS50b1N0cmluZygpXG4gICkge1xuICAgIGNvb3Jkcy5wdXNoKGNvb3Jkc1swXSlcbiAgfVxuXG4gIGlmIChcbiAgICBjb29yZHMgPT09IHVuZGVmaW5lZCB8fFxuICAgIHZhbGlkYXRlR2VvKCdwb2x5Z29uJywgSlNPTi5zdHJpbmdpZnkoY29vcmRzKSk/LmVycm9yXG4gICkge1xuICAgIHJldHVyblxuICB9XG4gIGNvbnN0IGlzTXVsdGlQb2x5Z29uID0gU2hhcGVVdGlscy5pc0FycmF5M0QoY29vcmRzKVxuICBjb25zdCBtdWx0aVBvbHlnb24gPSBpc011bHRpUG9seWdvbiA/IGNvb3JkcyA6IFtjb29yZHNdXG4gIGNvbnN0IHBvbHlnb25zOiBDb29yZGluYXRlW11bXVtdID0gW11cbiAgbXVsdGlQb2x5Z29uLmZvckVhY2goKHBvbHlnb246IGFueSkgPT4ge1xuICAgIGNvbnN0IGxpbmVTdHJpbmcgPSBjb29yZHNUb0xpbmVTdHJpbmcocG9seWdvbilcbiAgICBpZiAobGluZVN0cmluZykge1xuICAgICAgcG9seWdvbnMucHVzaChsaW5lU3RyaW5nKVxuICAgIH1cbiAgfSlcbiAgcmV0dXJuIG5ldyBNdWx0aVBvbHlnb24ocG9seWdvbnMpXG59XG5jb25zdCBhZGp1c3RQb2x5Z29uUG9pbnRzID0gKHBvbHlnb246IFBvbHlnb24pID0+IHtcbiAgY29uc3QgZXh0ZW50ID0gcG9seWdvbi5nZXRFeHRlbnQoKVxuICBjb25zdCBsb24xID0gZXh0ZW50WzBdXG4gIGNvbnN0IGxvbjIgPSBleHRlbnRbMl1cbiAgY29uc3Qgd2lkdGggPSBNYXRoLmFicyhsb24xIC0gbG9uMilcbiAgaWYgKHdpZHRoID4gMTgwKSB7XG4gICAgY29uc3QgYWRqdXN0ZWQgPSBwb2x5Z29uLmdldENvb3JkaW5hdGVzKClcbiAgICBhZGp1c3RlZC5mb3JFYWNoKChyaW5nKSA9PiB7XG4gICAgICByaW5nLmZvckVhY2goKGNvb3JkKSA9PiB7XG4gICAgICAgIGlmIChjb29yZFswXSA8IDApIHtcbiAgICAgICAgICBjb29yZFswXSArPSAzNjBcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9KVxuICAgIHBvbHlnb24uc2V0Q29vcmRpbmF0ZXMoYWRqdXN0ZWQpXG4gIH1cbn1cbmNvbnN0IGFkanVzdE11bHRpUG9seWdvblBvaW50cyA9IChwb2x5Z29uczogTXVsdGlQb2x5Z29uKSA9PiB7XG4gIGNvbnN0IGFkanVzdGVkOiBDb29yZGluYXRlW11bXVtdID0gW11cbiAgcG9seWdvbnMuZ2V0UG9seWdvbnMoKS5mb3JFYWNoKChwb2x5Z29uKSA9PiB7XG4gICAgYWRqdXN0UG9seWdvblBvaW50cyhwb2x5Z29uKVxuICAgIGFkanVzdGVkLnB1c2gocG9seWdvbi5nZXRDb29yZGluYXRlcygpKVxuICB9KVxuICBwb2x5Z29ucy5zZXRDb29yZGluYXRlcyhhZGp1c3RlZClcbn1cbmV4cG9ydCBjb25zdCBkcmF3UG9seWdvbiA9ICh7XG4gIG1hcCxcbiAgbW9kZWwsXG4gIHBvbHlnb24sXG4gIGlkLFxuICBpc0ludGVyYWN0aXZlLFxuICB0cmFuc2xhdGlvbixcbn06IHtcbiAgbWFwOiBhbnlcbiAgbW9kZWw6IGFueVxuICBwb2x5Z29uOiBNdWx0aVBvbHlnb25cbiAgaWQ6IHN0cmluZ1xuICBpc0ludGVyYWN0aXZlPzogYm9vbGVhblxuICB0cmFuc2xhdGlvbj86IFRyYW5zbGF0aW9uXG59KSA9PiB7XG4gIGlmICghcG9seWdvbikge1xuICAgIC8vIEhhbmRsZXMgY2FzZSB3aGVyZSBtb2RlbCBjaGFuZ2VzIHRvIGVtcHR5IHZhcnMgYW5kIHdlIGRvbid0IHdhbnQgdG8gZHJhdyBhbnltb3JlXG4gICAgcmV0dXJuXG4gIH1cbiAgaWYgKHRyYW5zbGF0aW9uKSB7XG4gICAgcG9seWdvbi50cmFuc2xhdGUodHJhbnNsYXRpb24ubG9uZ2l0dWRlLCB0cmFuc2xhdGlvbi5sYXRpdHVkZSlcbiAgfVxuICBhZGp1c3RNdWx0aVBvbHlnb25Qb2ludHMocG9seWdvbilcbiAgY29uc3QgY29vcmRpbmF0ZXMgPSBwb2x5Z29uLmdldENvb3JkaW5hdGVzKClcbiAgY29uc3QgYnVmZmVyV2lkdGggPVxuICAgIERpc3RhbmNlVXRpbHMuZ2V0RGlzdGFuY2VJbk1ldGVycyhcbiAgICAgIG1vZGVsLmdldCgncG9seWdvbkJ1ZmZlcldpZHRoJyksXG4gICAgICBtb2RlbC5nZXQoJ3BvbHlnb25CdWZmZXJVbml0cycpXG4gICAgKSB8fCAxXG4gIGNvbnN0IGRyYXduUG9seWdvblNlZ21lbnRzID0gY29vcmRpbmF0ZXMubWFwKChzZXQpID0+IHtcbiAgICByZXR1cm4gbXVsdGlMaW5lU3RyaW5nKFt0cmFuc2xhdGVGcm9tT3BlbmxheWVyc0Nvb3JkaW5hdGVzKHNldCldKS5nZW9tZXRyeVxuICAgICAgLmNvb3JkaW5hdGVzXG4gIH0pXG4gIGNvbnN0IGJ1ZmZlclBvbHlnb25TZWdtZW50cyA9IGNvb3JkaW5hdGVzLm1hcCgoc2V0KSA9PiB7XG4gICAgY29uc3QgcG9seVNlZ21lbnQgPSBtdWx0aUxpbmVTdHJpbmcoW1xuICAgICAgdHJhbnNsYXRlRnJvbU9wZW5sYXllcnNDb29yZGluYXRlcyhzZXQpLFxuICAgIF0pXG4gICAgY29uc3QgYnVmZmVyZWRTZWdtZW50ID0gYnVmZmVyKHBvbHlTZWdtZW50LCBidWZmZXJXaWR0aCwge1xuICAgICAgdW5pdHM6ICdtZXRlcnMnLFxuICAgIH0pXG4gICAgaWYgKCFidWZmZXJlZFNlZ21lbnQpIHtcbiAgICAgIHJldHVyblxuICAgIH1cbiAgICBjb25zdCBleHRlbnQgPSBiYm94KGJ1ZmZlcmVkU2VnbWVudClcbiAgICBjb25zdCB3aWR0aCA9IE1hdGguYWJzKGV4dGVudFswXSAtIGV4dGVudFsyXSlcbiAgICAvLyBuZWVkIHRvIGFkanVzdCB0aGUgcG9pbnRzIGFnYWluIEFGVEVSIGJ1ZmZlcmluZywgc2luY2UgYnVmZmVyaW5nIHVuZG9lcyB0aGUgYW50aW1lcmlkaWFuIGFkanVzdG1lbnRzXG4gICAgaWYgKHdpZHRoID4gMTgwKSB7XG4gICAgICBjb29yZEVhY2goYnVmZmVyZWRTZWdtZW50LCAoY29vcmQpID0+IHtcbiAgICAgICAgaWYgKGNvb3JkWzBdIDwgMCkge1xuICAgICAgICAgIGNvb3JkWzBdICs9IDM2MFxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH1cbiAgICBjb25zdCBidWZmZXJQb2x5Z29ucyA9IGJ1ZmZlcmVkU2VnbWVudC5nZW9tZXRyeS5jb29yZGluYXRlcy5tYXAoXG4gICAgICAoc2V0OiBhbnkpID0+IHtcbiAgICAgICAgcmV0dXJuIHR1cmZQb2x5Z29uKFtzZXRdKVxuICAgICAgfVxuICAgIClcbiAgICByZXR1cm4gYnVmZmVyUG9seWdvbnMucmVkdWNlKFxuICAgICAgKGEsIGIpID0+IHVuaW9uKGZlYXR1cmVDb2xsZWN0aW9uKFthLCBiXSkpLFxuICAgICAgYnVmZmVyUG9seWdvbnNbMF1cbiAgICApPy5nZW9tZXRyeS5jb29yZGluYXRlc1xuICB9KVxuICBjb25zdCBidWZmZXJHZW9tZXRyeVJlcHJlc2VudGF0aW9uID0gbmV3IE11bHRpUG9seWdvbihcbiAgICBidWZmZXJQb2x5Z29uU2VnbWVudHMgYXMgYW55XG4gIClcbiAgY29uc3QgZHJhd25HZW9tZXRyeVJlcHJlc2VudGF0aW9uID0gbmV3IE11bHRpUG9seWdvbihcbiAgICBkcmF3blBvbHlnb25TZWdtZW50cyBhcyBhbnlcbiAgKVxuICBjb25zdCBiaWxsYm9hcmQgPSBuZXcgRmVhdHVyZSh7XG4gICAgZ2VvbWV0cnk6IGJ1ZmZlckdlb21ldHJ5UmVwcmVzZW50YXRpb24sXG4gIH0pXG4gIGJpbGxib2FyZC5zZXRJZChpZClcbiAgYmlsbGJvYXJkLnNldCgnbG9jYXRpb25JZCcsIG1vZGVsLmdldCgnbG9jYXRpb25JZCcpKVxuICBjb25zdCBkcmF3blBvbHlnb25GZWF0dXJlID0gbmV3IEZlYXR1cmUoe1xuICAgIGdlb21ldHJ5OiBkcmF3bkdlb21ldHJ5UmVwcmVzZW50YXRpb24sXG4gIH0pXG4gIGNvbnN0IGNvbG9yID0gbW9kZWwuZ2V0KCdjb2xvcicpXG4gIGNvbnN0IGJ1ZmZlclBvbHlnb25JY29uU3R5bGUgPSBuZXcgU3R5bGUoe1xuICAgIHN0cm9rZTogbmV3IFN0cm9rZSh7XG4gICAgICBjb2xvcjogaXNJbnRlcmFjdGl2ZSA/IGNvbnRyYXN0aW5nQ29sb3IgOiBjb2xvciA/IGNvbG9yIDogJyM5MTQ1MDAnLFxuICAgICAgd2lkdGg6IGlzSW50ZXJhY3RpdmUgPyA2IDogNCxcbiAgICB9KSxcbiAgICB6SW5kZXg6IDEsXG4gIH0pXG4gIGNvbnN0IGRyYXduUG9seWdvbkljb25TdHlsZSA9IG5ldyBTdHlsZSh7XG4gICAgc3Ryb2tlOiBuZXcgU3Ryb2tlKHtcbiAgICAgIGNvbG9yOiBpc0ludGVyYWN0aXZlID8gY29udHJhc3RpbmdDb2xvciA6IGNvbG9yID8gY29sb3IgOiAnIzkxNDUwMCcsXG4gICAgICB3aWR0aDogaXNJbnRlcmFjdGl2ZSA/IDUgOiAzLFxuICAgICAgbGluZURhc2g6IFsxMCwgNV0sXG4gICAgfSksXG4gICAgekluZGV4OiAwLFxuICB9KVxuICBiaWxsYm9hcmQuc2V0U3R5bGUoYnVmZmVyUG9seWdvbkljb25TdHlsZSlcbiAgZHJhd25Qb2x5Z29uRmVhdHVyZS5zZXRTdHlsZShkcmF3blBvbHlnb25JY29uU3R5bGUpXG4gIGNvbnN0IHZlY3RvclNvdXJjZSA9IG5ldyBWZWN0b3JTb3VyY2Uoe1xuICAgIGZlYXR1cmVzOiBbYmlsbGJvYXJkLCBkcmF3blBvbHlnb25GZWF0dXJlXSxcbiAgfSlcbiAgY29uc3QgdmVjdG9yTGF5ZXIgPSBuZXcgVmVjdG9yTGF5ZXIoe1xuICAgIHNvdXJjZTogdmVjdG9yU291cmNlLFxuICB9KVxuICBjb25zdCBtYXBSZWYgPSBtYXAuZ2V0TWFwKCkgYXMgTWFwXG4gIHJlbW92ZU9sZERyYXdpbmcoeyBtYXA6IG1hcFJlZiwgaWQgfSlcbiAgdmVjdG9yTGF5ZXIuc2V0KCdpZCcsIGlkKVxuICBtYXBSZWYuYWRkTGF5ZXIodmVjdG9yTGF5ZXIpXG59XG5jb25zdCB1cGRhdGVQcmltaXRpdmUgPSAoe1xuICBtYXAsXG4gIG1vZGVsLFxuICBpZCxcbiAgaXNJbnRlcmFjdGl2ZSxcbiAgdHJhbnNsYXRpb24sXG59OiB7XG4gIG1hcDogYW55XG4gIG1vZGVsOiBhbnlcbiAgaWQ6IHN0cmluZ1xuICBpc0ludGVyYWN0aXZlPzogYm9vbGVhblxuICB0cmFuc2xhdGlvbj86IFRyYW5zbGF0aW9uXG59KSA9PiB7XG4gIGNvbnN0IHBvbHlnb24gPSBtb2RlbFRvUG9seWdvbihtb2RlbClcbiAgaWYgKHBvbHlnb24gIT09IHVuZGVmaW5lZCkge1xuICAgIGRyYXdQb2x5Z29uKHsgbWFwLCBtb2RlbCwgcG9seWdvbiwgaWQsIGlzSW50ZXJhY3RpdmUsIHRyYW5zbGF0aW9uIH0pXG4gIH1cbn1cbmNvbnN0IHVzZUxpc3RlblRvUG9seWdvbk1vZGVsID0gKHtcbiAgbW9kZWwsXG4gIG1hcCxcbiAgaXNJbnRlcmFjdGl2ZSxcbiAgdHJhbnNsYXRpb24sXG59OiB7XG4gIG1vZGVsOiBhbnlcbiAgbWFwOiBhbnlcbiAgaXNJbnRlcmFjdGl2ZT86IGJvb2xlYW5cbiAgdHJhbnNsYXRpb24/OiBUcmFuc2xhdGlvblxufSkgPT4ge1xuICBjb25zdCBjYWxsYmFjayA9IFJlYWN0LnVzZU1lbW8oKCkgPT4ge1xuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICBpZiAobW9kZWwgJiYgbWFwKSB7XG4gICAgICAgIHVwZGF0ZVByaW1pdGl2ZSh7XG4gICAgICAgICAgbWFwLFxuICAgICAgICAgIG1vZGVsLFxuICAgICAgICAgIGlkOiBnZXRJZEZyb21Nb2RlbEZvckRpc3BsYXkoeyBtb2RlbCB9KSxcbiAgICAgICAgICBpc0ludGVyYWN0aXZlLFxuICAgICAgICAgIHRyYW5zbGF0aW9uLFxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH1cbiAgfSwgW21vZGVsLCBtYXAsIGlzSW50ZXJhY3RpdmUsIHRyYW5zbGF0aW9uXSlcbiAgdXNlTGlzdGVuVG8oXG4gICAgbW9kZWwsXG4gICAgJ2NoYW5nZTpwb2x5Z29uIGNoYW5nZTpwb2x5Z29uQnVmZmVyV2lkdGggY2hhbmdlOnBvbHlnb25CdWZmZXJVbml0cycsXG4gICAgY2FsbGJhY2tcbiAgKVxuICBjYWxsYmFjaygpXG59XG5leHBvcnQgY29uc3QgT3BlbmxheWVyc1BvbHlnb25EaXNwbGF5ID0gKHtcbiAgbWFwLFxuICBtb2RlbCxcbiAgaXNJbnRlcmFjdGl2ZSxcbiAgdHJhbnNsYXRpb24sXG59OiB7XG4gIG1hcDogYW55XG4gIG1vZGVsOiBhbnlcbiAgaXNJbnRlcmFjdGl2ZT86IGJvb2xlYW5cbiAgdHJhbnNsYXRpb24/OiBUcmFuc2xhdGlvblxufSkgPT4ge1xuICB1c2VMaXN0ZW5Ub1BvbHlnb25Nb2RlbCh7IG1hcCwgbW9kZWwsIGlzSW50ZXJhY3RpdmUsIHRyYW5zbGF0aW9uIH0pXG4gIFJlYWN0LnVzZUVmZmVjdCgoKSA9PiB7XG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIGlmIChtYXAgJiYgbW9kZWwpIHtcbiAgICAgICAgcmVtb3ZlT2xkRHJhd2luZyh7XG4gICAgICAgICAgbWFwOiBtYXAuZ2V0TWFwKCksXG4gICAgICAgICAgaWQ6IGdldElkRnJvbU1vZGVsRm9yRGlzcGxheSh7IG1vZGVsIH0pLFxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH1cbiAgfSwgW21hcCwgbW9kZWxdKVxuICByZXR1cm4gPD48Lz5cbn1cbiJdfQ==