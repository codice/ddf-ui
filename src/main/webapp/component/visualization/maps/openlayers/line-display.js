/**
 * Copyright (c) Codice Foundation
 *
 * This is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser
 * General Public License as published by the Free Software Foundation, either version 3 of the
 * License, or any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
 * even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details. A copy of the GNU Lesser General Public License
 * is distributed along with this program and can be found at
 * <http://www.gnu.org/licenses/lgpl.html>.
 *
 **/
import React from 'react';
import DistanceUtils from '../../../../js/DistanceUtils';
import ol from 'openlayers';
import _ from 'underscore';
import * as Turf from '@turf/turf';
import { validateGeo } from '../../../../react-component/utils/validation';
import { useListenTo } from '../../../selection-checkbox/useBackbone.hook';
import { removeOldDrawing } from './drawing-and-display';
import { getIdFromModelForDisplay } from '../drawing-and-display';
import { StartupDataStore } from '../../../../js/model/Startup/startup';
import { contrastingColor } from '../../../../react-component/location/location-color-selector';
export function translateFromOpenlayersCoordinates(coords) {
    var coordinates = [];
    coords.forEach(function (point) {
        point = ol.proj.transform([
            DistanceUtils.coordinateRound(point[0]),
            DistanceUtils.coordinateRound(point[1]),
        ], StartupDataStore.Configuration.getProjection(), 'EPSG:4326');
        if (point[1] > 90) {
            point[1] = 89.9;
        }
        else if (point[1] < -90) {
            point[1] = -89.9;
        }
        coordinates.push(point);
    });
    return coordinates;
}
export function translateToOpenlayersCoordinates(coords) {
    var coordinates = [];
    coords.forEach(function (item) {
        if (Array.isArray(item[0])) {
            coordinates.push(translateToOpenlayersCoordinates(item));
        }
        else {
            coordinates.push(ol.proj.transform([item[0], item[1]], 'EPSG:4326', StartupDataStore.Configuration.getProjection()));
        }
    });
    return coordinates;
}
var modelToLineString = function (model) {
    var line = model.get('line');
    var setArr = _.uniq(line);
    if (setArr.length < 2) {
        return;
    }
    return new ol.geom.LineString(translateToOpenlayersCoordinates(setArr));
};
var adjustLinePoints = function (line) {
    var extent = line.getExtent();
    var lon1 = extent[0];
    var lon2 = extent[2];
    var width = Math.abs(lon2 - lon1);
    if (width > 180) {
        var adjusted = line.getCoordinates();
        adjusted.forEach(function (coord) {
            if (coord[0] < 0) {
                coord[0] += 360;
            }
        });
        line.setCoordinates(adjusted);
    }
};
var adjustMultiLinePoints = function (lines) {
    var adjusted = [];
    lines.getLineStrings().forEach(function (line) {
        adjustLinePoints(line);
        adjusted.push(line.getCoordinates());
    });
    lines.setCoordinates(adjusted);
};
export var drawLine = function (_a) {
    var map = _a.map, model = _a.model, line = _a.line, id = _a.id, isInteractive = _a.isInteractive, translation = _a.translation;
    if (!line) {
        // Handles case where model changes to empty vars and we don't want to draw anymore
        return;
    }
    var lineWidth = DistanceUtils.getDistanceInMeters(model.get('lineWidth'), model.get('lineUnits')) || 1;
    if (translation) {
        line.translate(translation.longitude, translation.latitude);
    }
    adjustLinePoints(line);
    var turfLine = Turf.lineString(translateFromOpenlayersCoordinates(line.getCoordinates()));
    var bufferedLine = Turf.buffer(turfLine, lineWidth, { units: 'meters' });
    var geometryRepresentation = new ol.geom.MultiLineString(translateToOpenlayersCoordinates(bufferedLine.geometry.coordinates));
    var drawnGeometryRepresentation = new ol.geom.LineString(translateToOpenlayersCoordinates(turfLine.geometry.coordinates));
    // need to adjust the points again AFTER buffering, since buffering undoes the antimeridian adjustments
    adjustMultiLinePoints(geometryRepresentation);
    var billboard = new ol.Feature({
        geometry: geometryRepresentation,
    });
    billboard.setId(id);
    billboard.set('locationId', model.get('locationId'));
    var drawnLineFeature = new ol.Feature({
        geometry: drawnGeometryRepresentation,
    });
    var color = model.get('color');
    var iconStyle = new ol.style.Style({
        stroke: new ol.style.Stroke({
            color: isInteractive ? contrastingColor : color ? color : '#914500',
            width: isInteractive ? 6 : 4,
        }),
    });
    var drawnLineIconStyle = new ol.style.Style({
        stroke: new ol.style.Stroke({
            color: isInteractive ? contrastingColor : color ? color : '#914500',
            width: 2,
            lineDash: [10, 5],
        }),
    });
    billboard.setStyle(iconStyle);
    drawnLineFeature.setStyle(drawnLineIconStyle);
    var vectorSource = new ol.source.Vector({
        features: [billboard, drawnLineFeature],
    });
    var vectorLayer = new ol.layer.Vector({
        source: vectorSource,
    });
    vectorLayer.set('id', id);
    var mapRef = map.getMap();
    removeOldDrawing({ map: mapRef, id: id });
    map.getMap().addLayer(vectorLayer);
};
var updatePrimitive = function (_a) {
    var _b;
    var map = _a.map, model = _a.model, id = _a.id, isInteractive = _a.isInteractive, translation = _a.translation;
    var line = modelToLineString(model);
    // Make sure the current model has width and height before drawing
    if (line !== undefined &&
        !((_b = validateGeo('line', JSON.stringify(line.getCoordinates()))) === null || _b === void 0 ? void 0 : _b.error)) {
        drawLine({ map: map, model: model, line: line, id: id, isInteractive: isInteractive, translation: translation });
    }
};
var useListenToLineModel = function (_a) {
    var model = _a.model, map = _a.map, isInteractive = _a.isInteractive, translation = _a.translation;
    var callback = React.useMemo(function () {
        return function () {
            if (model && map) {
                updatePrimitive({
                    map: map,
                    model: model,
                    id: getIdFromModelForDisplay({ model: model }),
                    isInteractive: isInteractive,
                    translation: translation,
                });
            }
        };
    }, [model, map, isInteractive, translation]);
    useListenTo(model, 'change:line change:lineWidth change:lineUnits', callback);
    callback();
};
export var OpenlayersLineDisplay = function (_a) {
    var map = _a.map, model = _a.model, isInteractive = _a.isInteractive, translation = _a.translation;
    useListenToLineModel({ map: map, model: model, isInteractive: isInteractive, translation: translation });
    React.useEffect(function () {
        return function () {
            if (map && model) {
                removeOldDrawing({
                    map: map.getMap(),
                    id: getIdFromModelForDisplay({ model: model }),
                });
            }
        };
    }, [map, model]);
    return React.createElement(React.Fragment, null);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGluZS1kaXNwbGF5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vc3JjL21haW4vd2ViYXBwL2NvbXBvbmVudC92aXN1YWxpemF0aW9uL21hcHMvb3BlbmxheWVycy9saW5lLWRpc3BsYXkudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7O0lBYUk7QUFDSixPQUFPLEtBQUssTUFBTSxPQUFPLENBQUE7QUFDekIsT0FBTyxhQUFhLE1BQU0sOEJBQThCLENBQUE7QUFDeEQsT0FBTyxFQUFFLE1BQU0sWUFBWSxDQUFBO0FBQzNCLE9BQU8sQ0FBQyxNQUFNLFlBQVksQ0FBQTtBQUMxQixPQUFPLEtBQUssSUFBSSxNQUFNLFlBQVksQ0FBQTtBQUNsQyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sOENBQThDLENBQUE7QUFDMUUsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLDhDQUE4QyxDQUFBO0FBQzFFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHVCQUF1QixDQUFBO0FBQ3hELE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLHdCQUF3QixDQUFBO0FBQ2pFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHNDQUFzQyxDQUFBO0FBQ3ZFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDhEQUE4RCxDQUFBO0FBSS9GLE1BQU0sVUFBVSxrQ0FBa0MsQ0FBQyxNQUF1QjtJQUN4RSxJQUFNLFdBQVcsR0FBRyxFQUFxQixDQUFBO0lBQ3pDLE1BQU0sQ0FBQyxPQUFPLENBQUMsVUFBQyxLQUFLO1FBQ25CLEtBQUssR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FDdkI7WUFDRSxhQUFhLENBQUMsZUFBZSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN2QyxhQUFhLENBQUMsZUFBZSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUN4QyxFQUNELGdC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QVcsYUFBQSxFQUFFLENBQUMsQ0FBQTtJQUNoRSxLQUFLLENBQUMsU0FBUyxDQUFDO1FBQ2QsT0FBTztZQUNMLElBQUksR0FBRyxJQUFJLEtBQUssRUFBRTtnQkFDaEIsZ0JBQWdCLENBQUM7b0JBQ2YsR0FBRyxFQUFFLEdBQUcsQ0FBQyxNQUFNLEVBQUU7b0JBQ2pCLEVBQUUsRUFBRSx3QkFBd0IsQ0FBQyxFQUFFLEtBQUssT0FBQSxFQUFFLENBQUM7aUJBQ3hDLENBQUMsQ0FBQTthQUNIO1FBQ0gsQ0FBQyxDQUFBO0lBQ0gsQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUE7SUFDaEIsT0FBTyx5Q0FBSyxDQUFBO0FBQ2QsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgKGMpIENvZGljZSBGb3VuZGF0aW9uXG4gKlxuICogVGhpcyBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5IGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIExlc3NlclxuICogR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGVcbiAqIExpY2Vuc2UsIG9yIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLCBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXRcbiAqIGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YgTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiBTZWUgdGhlIEdOVVxuICogTGVzc2VyIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4gQSBjb3B5IG9mIHRoZSBHTlUgTGVzc2VyIEdlbmVyYWwgUHVibGljIExpY2Vuc2VcbiAqIGlzIGRpc3RyaWJ1dGVkIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtIGFuZCBjYW4gYmUgZm91bmQgYXRcbiAqIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvbGdwbC5odG1sPi5cbiAqXG4gKiovXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnXG5pbXBvcnQgRGlzdGFuY2VVdGlscyBmcm9tICcuLi8uLi8uLi8uLi9qcy9EaXN0YW5jZVV0aWxzJ1xuaW1wb3J0IG9sIGZyb20gJ29wZW5sYXllcnMnXG5pbXBvcnQgXyBmcm9tICd1bmRlcnNjb3JlJ1xuaW1wb3J0ICogYXMgVHVyZiBmcm9tICdAdHVyZi90dXJmJ1xuaW1wb3J0IHsgdmFsaWRhdGVHZW8gfSBmcm9tICcuLi8uLi8uLi8uLi9yZWFjdC1jb21wb25lbnQvdXRpbHMvdmFsaWRhdGlvbidcbmltcG9ydCB7IHVzZUxpc3RlblRvIH0gZnJvbSAnLi4vLi4vLi4vc2VsZWN0aW9uLWNoZWNrYm94L3VzZUJhY2tib25lLmhvb2snXG5pbXBvcnQgeyByZW1vdmVPbGREcmF3aW5nIH0gZnJvbSAnLi9kcmF3aW5nLWFuZC1kaXNwbGF5J1xuaW1wb3J0IHsgZ2V0SWRGcm9tTW9kZWxGb3JEaXNwbGF5IH0gZnJvbSAnLi4vZHJhd2luZy1hbmQtZGlzcGxheSdcbmltcG9ydCB7IFN0YXJ0dXBEYXRhU3RvcmUgfSBmcm9tICcuLi8uLi8uLi8uLi9qcy9tb2RlbC9TdGFydHVwL3N0YXJ0dXAnXG5pbXBvcnQgeyBjb250cmFzdGluZ0NvbG9yIH0gZnJvbSAnLi4vLi4vLi4vLi4vcmVhY3QtY29tcG9uZW50L2xvY2F0aW9uL2xvY2F0aW9uLWNvbG9yLXNlbGVjdG9yJ1xuaW1wb3J0IHsgVHJhbnNsYXRpb24gfSBmcm9tICcuLi9pbnRlcmFjdGlvbnMucHJvdmlkZXInXG50eXBlIENvb3JkaW5hdGVUeXBlID0gW251bWJlciwgbnVtYmVyXVxudHlwZSBDb29yZGluYXRlc1R5cGUgPSBBcnJheTxDb29yZGluYXRlVHlwZT5cbmV4cG9ydCBmdW5jdGlvbiB0cmFuc2xhdGVGcm9tT3BlbmxheWVyc0Nvb3JkaW5hdGVzKGNvb3JkczogQ29vcmRpbmF0ZXNUeXBlKSB7XG4gIGNvbnN0IGNvb3JkaW5hdGVzID0gW10gYXMgQ29vcmRpbmF0ZXNUeXBlXG4gIGNvb3Jkcy5mb3JFYWNoKChwb2ludCkgPT4ge1xuICAgIHBvaW50ID0gb2wucHJvai50cmFuc2Zvcm0oXG4gICAgICBbXG4gICAgICAgIERpc3RhbmNlVXRpbHMuY29vcmRpbmF0ZVJvdW5kKHBvaW50WzBdKSxcbiAgICAgICAgRGlzdGFuY2VVdGlscy5jb29yZGluYXRlUm91bmQocG9pbnRbMV0pLFxuICAgICAgXSxcbiAgICAgIFN0YXJ0dXBEYXRhU3RvcmUuQ29uZmlndXJhdGlvbi5nZXRQcm9qZWN0aW9uKCksXG4gICAgICAnRVBTRzo0MzI2J1xuICAgIClcbiAgICBpZiAocG9pbnRbMV0gPiA5MCkge1xuICAgICAgcG9pbnRbMV0gPSA4OS45XG4gICAgfSBlbHNlIGlmIChwb2ludFsxXSA8IC05MCkge1xuICAgICAgcG9pbnRbMV0gPSAtODkuOVxuICAgIH1cbiAgICBjb29yZGluYXRlcy5wdXNoKHBvaW50KVxuICB9KVxuICByZXR1cm4gY29vcmRpbmF0ZXNcbn1cbmV4cG9ydCBmdW5jdGlvbiB0cmFuc2xhdGVUb09wZW5sYXllcnNDb29yZGluYXRlcyhjb29yZHM6IENvb3JkaW5hdGVzVHlwZSkge1xuICBjb25zdCBjb29yZGluYXRlcyA9IFtdIGFzIENvb3JkaW5hdGVzVHlwZVxuICBjb29yZHMuZm9yRWFjaCgoaXRlbSkgPT4ge1xuICAgIGlmIChBcnJheS5pc0FycmF5KGl0ZW1bMF0pKSB7XG4gICAgICBjb29yZGluYXRlcy5wdXNoKFxuICAgICAgICB0cmFuc2xhdGVUb09wZW5sYXllcnNDb29yZGluYXRlcyhcbiAgICAgICAgICBpdGVtIGFzIHVua25vd24gYXMgQ29vcmRpbmF0ZXNUeXBlXG4gICAgICAgICkgYXMgdW5rbm93biBhcyBDb29yZGluYXRlVHlwZVxuICAgICAgKVxuICAgIH0gZWxzZSB7XG4gICAgICBjb29yZGluYXRlcy5wdXNoKFxuICAgICAgICBvbC5wcm9qLnRyYW5zZm9ybShcbiAgICAgICAgICBbaXRlbVswXSwgaXRlbVsxXV0sXG4gICAgICAgICAgJ0VQU0c6NDMyNicsXG4gICAgICAgICAgU3RhcnR1cERhdGFTdG9yZS5Db25maWd1cmF0aW9uLmdldFByb2plY3Rpb24oKVxuICAgICAgICApXG4gICAgICApXG4gICAgfVxuICB9KVxuICByZXR1cm4gY29vcmRpbmF0ZXNcbn1cbmNvbnN0IG1vZGVsVG9MaW5lU3RyaW5nID0gKG1vZGVsOiBhbnkpID0+IHtcbiAgY29uc3QgbGluZSA9IG1vZGVsLmdldCgnbGluZScpXG4gIGNvbnN0IHNldEFyciA9IF8udW5pcShsaW5lKVxuICBpZiAoc2V0QXJyLmxlbmd0aCA8IDIpIHtcbiAgICByZXR1cm5cbiAgfVxuICByZXR1cm4gbmV3IG9sLmdlb20uTGluZVN0cmluZyh0cmFuc2xhdGVUb09wZW5sYXllcnNDb29yZGluYXRlcyhzZXRBcnIpKVxufVxuY29uc3QgYWRqdXN0TGluZVBvaW50cyA9IChsaW5lOiBvbC5nZW9tLkxpbmVTdHJpbmcpID0+IHtcbiAgY29uc3QgZXh0ZW50ID0gbGluZS5nZXRFeHRlbnQoKVxuICBjb25zdCBsb24xID0gZXh0ZW50WzBdXG4gIGNvbnN0IGxvbjIgPSBleHRlbnRbMl1cbiAgY29uc3Qgd2lkdGggPSBNYXRoLmFicyhsb24yIC0gbG9uMSlcbiAgaWYgKHdpZHRoID4gMTgwKSB7XG4gICAgY29uc3QgYWRqdXN0ZWQgPSBsaW5lLmdldENvb3JkaW5hdGVzKClcbiAgICBhZGp1c3RlZC5mb3JFYWNoKChjb29yZCkgPT4ge1xuICAgICAgaWYgKGNvb3JkWzBdIDwgMCkge1xuICAgICAgICBjb29yZFswXSArPSAzNjBcbiAgICAgIH1cbiAgICB9KVxuICAgIGxpbmUuc2V0Q29vcmRpbmF0ZXMoYWRqdXN0ZWQpXG4gIH1cbn1cbmNvbnN0IGFkanVzdE11bHRpTGluZVBvaW50cyA9IChsaW5lczogb2wuZ2VvbS5NdWx0aUxpbmVTdHJpbmcpID0+IHtcbiAgY29uc3QgYWRqdXN0ZWQ6IG9sLkNvb3JkaW5hdGVbXVtdID0gW11cbiAgbGluZXMuZ2V0TGluZVN0cmluZ3MoKS5mb3JFYWNoKChsaW5lKSA9PiB7XG4gICAgYWRqdXN0TGluZVBvaW50cyhsaW5lKVxuICAgIGFkanVzdGVkLnB1c2gobGluZS5nZXRDb29yZGluYXRlcygpKVxuICB9KVxuICBsaW5lcy5zZXRDb29yZGluYXRlcyhhZGp1c3RlZClcbn1cbmV4cG9ydCBjb25zdCBkcmF3TGluZSA9ICh7XG4gIG1hcCxcbiAgbW9kZWwsXG4gIGxpbmUsXG4gIGlkLFxuICBpc0ludGVyYWN0aXZlLFxuICB0cmFuc2xhdGlvbixcbn06IHtcbiAgbWFwOiBhbnlcbiAgbW9kZWw6IGFueVxuICBsaW5lOiBvbC5nZW9tLkxpbmVTdHJpbmdcbiAgaWQ6IHN0cmluZ1xuICBpc0ludGVyYWN0aXZlPzogYm9vbGVhblxuICB0cmFuc2xhdGlvbj86IFRyYW5zbGF0aW9uXG59KSA9PiB7XG4gIGlmICghbGluZSkge1xuICAgIC8vIEhhbmRsZXMgY2FzZSB3aGVyZSBtb2RlbCBjaGFuZ2VzIHRvIGVtcHR5IHZhcnMgYW5kIHdlIGRvbid0IHdhbnQgdG8gZHJhdyBhbnltb3JlXG4gICAgcmV0dXJuXG4gIH1cbiAgY29uc3QgbGluZVdpZHRoID1cbiAgICBEaXN0YW5jZVV0aWxzLmdldERpc3RhbmNlSW5NZXRlcnMoXG4gICAgICBtb2RlbC5nZXQoJ2xpbmVXaWR0aCcpLFxuICAgICAgbW9kZWwuZ2V0KCdsaW5lVW5pdHMnKVxuICAgICkgfHwgMVxuICBpZiAodHJhbnNsYXRpb24pIHtcbiAgICBsaW5lLnRyYW5zbGF0ZSh0cmFuc2xhdGlvbi5sb25naXR1ZGUsIHRyYW5zbGF0aW9uLmxhdGl0dWRlKVxuICB9XG4gIGFkanVzdExpbmVQb2ludHMobGluZSlcbiAgY29uc3QgdHVyZkxpbmUgPSBUdXJmLmxpbmVTdHJpbmcoXG4gICAgdHJhbnNsYXRlRnJvbU9wZW5sYXllcnNDb29yZGluYXRlcyhsaW5lLmdldENvb3JkaW5hdGVzKCkpXG4gIClcbiAgY29uc3QgYnVmZmVyZWRMaW5lID0gVHVyZi5idWZmZXIodHVyZkxpbmUsIGxpbmVXaWR0aCwgeyB1bml0czogJ21ldGVycycgfSlcbiAgY29uc3QgZ2VvbWV0cnlSZXByZXNlbnRhdGlvbiA9IG5ldyBvbC5nZW9tLk11bHRpTGluZVN0cmluZyhcbiAgICB0cmFuc2xhdGVUb09wZW5sYXllcnNDb29yZGluYXRlcyhcbiAgICAgIGJ1ZmZlcmVkTGluZS5nZW9tZXRyeS5jb29yZGluYXRlcyBhcyBhbnlcbiAgICApIGFzIHVua25vd24gYXMgYW55XG4gIClcbiAgY29uc3QgZHJhd25HZW9tZXRyeVJlcHJlc2VudGF0aW9uID0gbmV3IG9sLmdlb20uTGluZVN0cmluZyhcbiAgICB0cmFuc2xhdGVUb09wZW5sYXllcnNDb29yZGluYXRlcyhcbiAgICAgIHR1cmZMaW5lLmdlb21ldHJ5LmNvb3JkaW5hdGVzIGFzIGFueVxuICAgICkgYXMgdW5rbm93biBhcyBhbnlcbiAgKVxuICAvLyBuZWVkIHRvIGFkanVzdCB0aGUgcG9pbnRzIGFnYWluIEFGVEVSIGJ1ZmZlcmluZywgc2luY2UgYnVmZmVyaW5nIHVuZG9lcyB0aGUgYW50aW1lcmlkaWFuIGFkanVzdG1lbnRzXG4gIGFkanVzdE11bHRpTGluZVBvaW50cyhnZW9tZXRyeVJlcHJlc2VudGF0aW9uKVxuICBjb25zdCBiaWxsYm9hcmQgPSBuZXcgb2wuRmVhdHVyZSh7XG4gICAgZ2VvbWV0cnk6IGdlb21ldHJ5UmVwcmVzZW50YXRpb24sXG4gIH0pXG4gIGJpbGxib2FyZC5zZXRJZChpZClcbiAgYmlsbGJvYXJkLnNldCgnbG9jYXRpb25JZCcsIG1vZGVsLmdldCgnbG9jYXRpb25JZCcpKVxuICBjb25zdCBkcmF3bkxpbmVGZWF0dXJlID0gbmV3IG9sLkZlYXR1cmUoe1xuICAgIGdlb21ldHJ5OiBkcmF3bkdlb21ldHJ5UmVwcmVzZW50YXRpb24sXG4gIH0pXG4gIGNvbnN0IGNvbG9yID0gbW9kZWwuZ2V0KCdjb2xvcicpXG4gIGNvbnN0IGljb25TdHlsZSA9IG5ldyBvbC5zdHlsZS5TdHlsZSh7XG4gICAgc3Ryb2tlOiBuZXcgb2wuc3R5bGUuU3Ryb2tlKHtcbiAgICAgIGNvbG9yOiBpc0ludGVyYWN0aXZlID8gY29udHJhc3RpbmdDb2xvciA6IGNvbG9yID8gY29sb3IgOiAnIzkxNDUwMCcsXG4gICAgICB3aWR0aDogaXNJbnRlcmFjdGl2ZSA/IDYgOiA0LFxuICAgIH0pLFxuICB9KVxuICBjb25zdCBkcmF3bkxpbmVJY29uU3R5bGUgPSBuZXcgb2wuc3R5bGUuU3R5bGUoe1xuICAgIHN0cm9rZTogbmV3IG9sLnN0eWxlLlN0cm9rZSh7XG4gICAgICBjb2xvcjogaXNJbnRlcmFjdGl2ZSA/IGNvbnRyYXN0aW5nQ29sb3IgOiBjb2xvciA/IGNvbG9yIDogJyM5MTQ1MDAnLFxuICAgICAgd2lkdGg6IDIsXG4gICAgICBsaW5lRGFzaDogWzEwLCA1XSxcbiAgICB9KSxcbiAgfSlcbiAgYmlsbGJvYXJkLnNldFN0eWxlKGljb25TdHlsZSlcbiAgZHJhd25MaW5lRmVhdHVyZS5zZXRTdHlsZShkcmF3bkxpbmVJY29uU3R5bGUpXG4gIGNvbnN0IHZlY3RvclNvdXJjZSA9IG5ldyBvbC5zb3VyY2UuVmVjdG9yKHtcbiAgICBmZWF0dXJlczogW2JpbGxib2FyZCwgZHJhd25MaW5lRmVhdHVyZV0sXG4gIH0pXG4gIGxldCB2ZWN0b3JMYXllciA9IG5ldyBvbC5sYXllci5WZWN0b3Ioe1xuICAgIHNvdXJjZTogdmVjdG9yU291cmNlLFxuICB9KVxuICB2ZWN0b3JMYXllci5zZXQoJ2lkJywgaWQpXG4gIGNvbnN0IG1hcFJlZiA9IG1hcC5nZXRNYXAoKSBhcyBvbC5NYXBcbiAgcmVtb3ZlT2xkRHJhd2luZyh7IG1hcDogbWFwUmVmLCBpZCB9KVxuICBtYXAuZ2V0TWFwKCkuYWRkTGF5ZXIodmVjdG9yTGF5ZXIpXG59XG5jb25zdCB1cGRhdGVQcmltaXRpdmUgPSAoe1xuICBtYXAsXG4gIG1vZGVsLFxuICBpZCxcbiAgaXNJbnRlcmFjdGl2ZSxcbiAgdHJhbnNsYXRpb24sXG59OiB7XG4gIG1hcDogYW55XG4gIG1vZGVsOiBhbnlcbiAgaWQ6IHN0cmluZ1xuICBpc0ludGVyYWN0aXZlPzogYm9vbGVhblxuICB0cmFuc2xhdGlvbj86IFRyYW5zbGF0aW9uXG59KSA9PiB7XG4gIGNvbnN0IGxpbmUgPSBtb2RlbFRvTGluZVN0cmluZyhtb2RlbClcbiAgLy8gTWFrZSBzdXJlIHRoZSBjdXJyZW50IG1vZGVsIGhhcyB3aWR0aCBhbmQgaGVpZ2h0IGJlZm9yZSBkcmF3aW5nXG4gIGlmIChcbiAgICBsaW5lICE9PSB1bmRlZmluZWQgJiZcbiAgICAhdmFsaWRhdGVHZW8oJ2xpbmUnLCBKU09OLnN0cmluZ2lmeShsaW5lLmdldENvb3JkaW5hdGVzKCkpKT8uZXJyb3JcbiAgKSB7XG4gICAgZHJhd0xpbmUoeyBtYXAsIG1vZGVsLCBsaW5lLCBpZCwgaXNJbnRlcmFjdGl2ZSwgdHJhbnNsYXRpb24gfSlcbiAgfVxufVxuY29uc3QgdXNlTGlzdGVuVG9MaW5lTW9kZWwgPSAoe1xuICBtb2RlbCxcbiAgbWFwLFxuICBpc0ludGVyYWN0aXZlLFxuICB0cmFuc2xhdGlvbixcbn06IHtcbiAgbW9kZWw6IGFueVxuICBtYXA6IGFueVxuICBpc0ludGVyYWN0aXZlPzogYm9vbGVhblxuICB0cmFuc2xhdGlvbj86IFRyYW5zbGF0aW9uXG59KSA9PiB7XG4gIGNvbnN0IGNhbGxiYWNrID0gUmVhY3QudXNlTWVtbygoKSA9PiB7XG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIGlmIChtb2RlbCAmJiBtYXApIHtcbiAgICAgICAgdXBkYXRlUHJpbWl0aXZlKHtcbiAgICAgICAgICBtYXAsXG4gICAgICAgICAgbW9kZWwsXG4gICAgICAgICAgaWQ6IGdldElkRnJvbU1vZGVsRm9yRGlzcGxheSh7IG1vZGVsIH0pLFxuICAgICAgICAgIGlzSW50ZXJhY3RpdmUsXG4gICAgICAgICAgdHJhbnNsYXRpb24sXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgfVxuICB9LCBbbW9kZWwsIG1hcCwgaXNJbnRlcmFjdGl2ZSwgdHJhbnNsYXRpb25dKVxuICB1c2VMaXN0ZW5Ubyhtb2RlbCwgJ2NoYW5nZTpsaW5lIGNoYW5nZTpsaW5lV2lkdGggY2hhbmdlOmxpbmVVbml0cycsIGNhbGxiYWNrKVxuICBjYWxsYmFjaygpXG59XG5leHBvcnQgY29uc3QgT3BlbmxheWVyc0xpbmVEaXNwbGF5ID0gKHtcbiAgbWFwLFxuICBtb2RlbCxcbiAgaXNJbnRlcmFjdGl2ZSxcbiAgdHJhbnNsYXRpb24sXG59OiB7XG4gIG1hcDogYW55XG4gIG1vZGVsOiBhbnlcbiAgaXNJbnRlcmFjdGl2ZT86IGJvb2xlYW5cbiAgdHJhbnNsYXRpb24/OiBUcmFuc2xhdGlvblxufSkgPT4ge1xuICB1c2VMaXN0ZW5Ub0xpbmVNb2RlbCh7IG1hcCwgbW9kZWwsIGlzSW50ZXJhY3RpdmUsIHRyYW5zbGF0aW9uIH0pXG4gIFJlYWN0LnVzZUVmZmVjdCgoKSA9PiB7XG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIGlmIChtYXAgJiYgbW9kZWwpIHtcbiAgICAgICAgcmVtb3ZlT2xkRHJhd2luZyh7XG4gICAgICAgICAgbWFwOiBtYXAuZ2V0TWFwKCksXG4gICAgICAgICAgaWQ6IGdldElkRnJvbU1vZGVsRm9yRGlzcGxheSh7IG1vZGVsIH0pLFxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH1cbiAgfSwgW21hcCwgbW9kZWxdKVxuICByZXR1cm4gPD48Lz5cbn1cbiJdfQ==