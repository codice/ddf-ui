import { __read } from "tslib";
import { jsx as _jsx, Fragment as _Fragment, jsxs as _jsxs } from "react/jsx-runtime";
import * as React from 'react';
import { Drawing } from '../../../singletons/drawing';
import { useLazyResultsFromSelectionInterface } from '../../../selection-interface/hooks';
import Geometry from './geometry';
import CalculateClusters from './calculate-clusters';
import Cluster from './cluster';
import ZoomToSelection from './zoom-to-selection';
import { SHAPE_ID_PREFIX } from '../drawing-and-display';
var Geometries = function (props) {
    var map = props.map, selectionInterface = props.selectionInterface, isClustering = props.isClustering;
    var lazyResults = useLazyResultsFromSelectionInterface({
        selectionInterface: selectionInterface,
    });
    var lazyResultsRef = React.useRef(lazyResults);
    lazyResultsRef.current = lazyResults;
    var _a = __read(React.useState([]), 2), clusters = _a[0], setClusters = _a[1];
    // possible since we debounce
    if (isClustering === false && clusters.length > 0) {
        setClusters([]);
    }
    React.useEffect(function () {
        var handleCtrlClick = function (id) {
            if (id.constructor === String) {
                lazyResultsRef.current.results[id].controlSelect();
            }
            else {
                ;
                id.map(function (subid) {
                    return lazyResultsRef.current.results[subid].controlSelect();
                });
            }
        };
        var handleClick = function (id) {
            if (id.constructor === String) {
                lazyResultsRef.current.results[id].select();
            }
            else {
                var resultIds = id;
                var shouldJustDeselect = resultIds.some(function (subid) { return lazyResultsRef.current.results[subid].isSelected; });
                lazyResultsRef.current.deselect();
                if (!shouldJustDeselect) {
                    resultIds.map(function (subid) {
                        return lazyResultsRef.current.results[subid].controlSelect();
                    });
                }
            }
        };
        var handleLeftClick = function (event, mapEvent) {
            if (mapEvent.mapTarget &&
                mapEvent.mapTarget !== 'userDrawing' &&
                !Drawing.isDrawing()) {
                // we get click events on normal drawn features from the location drawing
                if (mapEvent.mapTarget.constructor === String &&
                    mapEvent.mapTarget.startsWith(SHAPE_ID_PREFIX)) {
                    return;
                }
                if (event.shiftKey) {
                    handleCtrlClick(mapEvent.mapTarget);
                }
                else if (event.ctrlKey || event.metaKey) {
                    handleCtrlClick(mapEvent.mapTarget);
                }
                else {
                    handleClick(mapEvent.mapTarget);
                }
            }
        };
        map.onLeftClick(handleLeftClick);
        return function () { };
    }, []);
    var IndividualGeometries = React.useMemo(function () {
        return Object.values(lazyResults.results).map(function (lazyResult) {
            return (_jsx(Geometry, { lazyResult: lazyResult, map: map, clusters: clusters }, lazyResult['metacard.id']));
        });
    }, [lazyResults.results, clusters]);
    var Clusters = React.useMemo(function () {
        return clusters.map(function (cluster) {
            return _jsx(Cluster, { cluster: cluster, map: map }, cluster.id);
        });
    }, [clusters, lazyResults.results]);
    var CalculateClustersMemo = React.useMemo(function () {
        return (_jsx(CalculateClusters, { isClustering: isClustering, map: map, lazyResults: lazyResults.results, setClusters: setClusters }, "clusters"));
    }, [lazyResults.results, isClustering]);
    var ZoomToSelectionMemo = React.useMemo(function () {
        return _jsx(ZoomToSelection, { map: map, lazyResults: lazyResults });
    }, [lazyResults]);
    return (_jsxs(_Fragment, { children: [ZoomToSelectionMemo, CalculateClustersMemo, Clusters, IndividualGeometries] }));
};
export default Geometries;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VvbWV0cmllcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3NyYy9tYWluL3dlYmFwcC9jb21wb25lbnQvdmlzdWFsaXphdGlvbi9tYXBzL3JlYWN0L2dlb21ldHJpZXMudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsT0FBTyxLQUFLLEtBQUssTUFBTSxPQUFPLENBQUE7QUFFOUIsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLDZCQUE2QixDQUFBO0FBQ3JELE9BQU8sRUFBRSxvQ0FBb0MsRUFBRSxNQUFNLG9DQUFvQyxDQUFBO0FBQ3pGLE9BQU8sUUFBUSxNQUFNLFlBQVksQ0FBQTtBQUNqQyxPQUFPLGlCQUFpQixNQUFNLHNCQUFzQixDQUFBO0FBQ3BELE9BQU8sT0FBTyxNQUFNLFdBQVcsQ0FBQTtBQUUvQixPQUFPLGVBQWUsTUFBTSxxQkFBcUIsQ0FBQTtBQUNqRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sd0JBQXdCLENBQUE7QUFZeEQsSUFBTSxVQUFVLEdBQUcsVUFBQyxLQUFZO0lBQ3RCLElBQUEsR0FBRyxHQUF1QyxLQUFLLElBQTVDLEVBQUUsa0JBQWtCLEdBQW1CLEtBQUssbUJBQXhCLEVBQUUsWUFBWSxHQUFLLEtBQUssYUFBVixDQUFVO0lBQ3ZELElBQU0sV0FBVyxHQUFHLG9DQUFvQyxDQUFDO1FBQ3ZELGtCQUFrQixvQkFBQTtLQUNuQixDQUFDLENBQUE7SUFDRixJQUFNLGNBQWMsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFBO0lBQ2hELGNBQWMsQ0FBQyxPQUFPLEdBQUcsV0FBVyxDQUFBO0lBQzlCLElBQUEsS0FBQSxPQUEwQixLQUFLLENBQUMsUUFBUSxDQUFDLEVBQW1CLENBQUMsSUFBQSxFQUE1RCxRQUFRLFFBQUEsRUFBRSxXQUFXLFFBQXVDLENBQUE7SUFDbkUsNkJBQTZCO0lBQzdCLElBQUksWUFBWSxLQUFLLEtBQUssSUFBSSxR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bkIscUJBQXFCLEVBQ3JCLFFBQVEsRUFDUixvQkFBb0IsSUFDcEIsQ0FDSixDQUFBO0FBQ0gsQ0FBQyxDQUFBO0FBRUQsZUFBZSxVQUFVLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCdcblxuaW1wb3J0IHsgRHJhd2luZyB9IGZyb20gJy4uLy4uLy4uL3NpbmdsZXRvbnMvZHJhd2luZydcbmltcG9ydCB7IHVzZUxhenlSZXN1bHRzRnJvbVNlbGVjdGlvbkludGVyZmFjZSB9IGZyb20gJy4uLy4uLy4uL3NlbGVjdGlvbi1pbnRlcmZhY2UvaG9va3MnXG5pbXBvcnQgR2VvbWV0cnkgZnJvbSAnLi9nZW9tZXRyeSdcbmltcG9ydCBDYWxjdWxhdGVDbHVzdGVycyBmcm9tICcuL2NhbGN1bGF0ZS1jbHVzdGVycydcbmltcG9ydCBDbHVzdGVyIGZyb20gJy4vY2x1c3RlcidcbmltcG9ydCB7IExhenlRdWVyeVJlc3VsdCB9IGZyb20gJy4uLy4uLy4uLy4uL2pzL21vZGVsL0xhenlRdWVyeVJlc3VsdC9MYXp5UXVlcnlSZXN1bHQnXG5pbXBvcnQgWm9vbVRvU2VsZWN0aW9uIGZyb20gJy4vem9vbS10by1zZWxlY3Rpb24nXG5pbXBvcnQgeyBTSEFQRV9JRF9QUkVGSVggfSBmcm9tICcuLi9kcmF3aW5nLWFuZC1kaXNwbGF5J1xudHlwZSBQcm9wcyA9IHtcbiAgc2VsZWN0aW9uSW50ZXJmYWNlOiBhbnlcbiAgbWFwOiBhbnlcbiAgaXNDbHVzdGVyaW5nOiBib29sZWFuXG59XG5cbmV4cG9ydCB0eXBlIENsdXN0ZXJUeXBlID0ge1xuICByZXN1bHRzOiBMYXp5UXVlcnlSZXN1bHRbXVxuICBpZDogc3RyaW5nXG59XG5cbmNvbnN0IEdlb21ldHJpZXMgPSAocHJvcHM6IFByb3BzKSA9PiB7XG4gIGNvbnN0IHsgbWFwLCBzZWxlY3Rpb25JbnRlcmZhY2UsIGlzQ2x1c3RlcmluZyB9ID0gcHJvcHNcbiAgY29uc3QgbGF6eVJlc3VsdHMgPSB1c2VMYXp5UmVzdWx0c0Zyb21TZWxlY3Rpb25JbnRlcmZhY2Uoe1xuICAgIHNlbGVjdGlvbkludGVyZmFjZSxcbiAgfSlcbiAgY29uc3QgbGF6eVJlc3VsdHNSZWYgPSBSZWFjdC51c2VSZWYobGF6eVJlc3VsdHMpXG4gIGxhenlSZXN1bHRzUmVmLmN1cnJlbnQgPSBsYXp5UmVzdWx0c1xuICBjb25zdCBbY2x1c3RlcnMsIHNldENsdXN0ZXJzXSA9IFJlYWN0LnVzZVN0YXRlKFtdIGFzIENsdXN0ZXJUeXBlW10pXG4gIC8vIHBvc3NpYmxlIHNpbmNlIHdlIGRlYm91bmNlXG4gIGlmIChpc0NsdXN0ZXJpbmcgPT09IGZhbHNlICYmIGNsdXN0ZXJzLmxlbmd0aCA+IDApIHtcbiAgICBzZXRDbHVzdGVycyhbXSlcbiAgfVxuICBSZWFjdC51c2VFZmZlY3QoKCkgPT4ge1xuICAgIGNvbnN0IGhhbmRsZUN0cmxDbGljayA9IChpZDogc3RyaW5nIHwgc3RyaW5nW10pID0+IHtcbiAgICAgIGlmIChpZC5jb25zdHJ1Y3RvciA9PT0gU3RyaW5nKSB7XG4gICAgICAgIGxhenlSZXN1bHRzUmVmLmN1cnJlbnQucmVzdWx0c1tpZCBhcyBzdHJpbmddLmNvbnRyb2xTZWxlY3QoKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgOyhpZCBhcyBzdHJpbmdbXSkubWFwKChzdWJpZCkgPT4ge1xuICAgICAgICAgIHJldHVybiBsYXp5UmVzdWx0c1JlZi5jdXJyZW50LnJlc3VsdHNbc3ViaWQgYXMgc3RyaW5nXS5jb250cm9sU2VsZWN0KClcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgaGFuZGxlQ2xpY2sgPSAoaWQ6IHN0cmluZyB8IHN0cmluZ1tdKSA9PiB7XG4gICAgICBpZiAoaWQuY29uc3RydWN0b3IgPT09IFN0cmluZykge1xuICAgICAgICBsYXp5UmVzdWx0c1JlZi5jdXJyZW50LnJlc3VsdHNbaWQgYXMgc3RyaW5nXS5zZWxlY3QoKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgcmVzdWx0SWRzID0gaWQgYXMgc3RyaW5nW11cbiAgICAgICAgbGV0IHNob3VsZEp1c3REZXNlbGVjdCA9IHJlc3VsdElkcy5zb21lKFxuICAgICAgICAgIChzdWJpZCkgPT4gbGF6eVJlc3VsdHNSZWYuY3VycmVudC5yZXN1bHRzW3N1YmlkXS5pc1NlbGVjdGVkXG4gICAgICAgIClcbiAgICAgICAgbGF6eVJlc3VsdHNSZWYuY3VycmVudC5kZXNlbGVjdCgpXG4gICAgICAgIGlmICghc2hvdWxkSnVzdERlc2VsZWN0KSB7XG4gICAgICAgICAgcmVzdWx0SWRzLm1hcCgoc3ViaWQpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBsYXp5UmVzdWx0c1JlZi5jdXJyZW50LnJlc3VsdHNbXG4gICAgICAgICAgICAgIHN1YmlkIGFzIHN0cmluZ1xuICAgICAgICAgICAgXS5jb250cm9sU2VsZWN0KClcbiAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IGhhbmRsZUxlZnRDbGljayA9IChldmVudDogYW55LCBtYXBFdmVudDogYW55KSA9PiB7XG4gICAgICBpZiAoXG4gICAgICAgIG1hcEV2ZW50Lm1hcFRhcmdldCAmJlxuICAgICAgICBtYXBFdmVudC5tYXBUYXJnZXQgIT09ICd1c2VyRHJhd2luZycgJiZcbiAgICAgICAgIURyYXdpbmcuaXNEcmF3aW5nKClcbiAgICAgICkge1xuICAgICAgICAvLyB3ZSBnZXQgY2xpY2sgZXZlbnRzIG9uIG5vcm1hbCBkcmF3biBmZWF0dXJlcyBmcm9tIHRoZSBsb2NhdGlvbiBkcmF3aW5nXG4gICAgICAgIGlmIChcbiAgICAgICAgICBtYXBFdmVudC5tYXBUYXJnZXQuY29uc3RydWN0b3IgPT09IFN0cmluZyAmJlxuICAgICAgICAgIChtYXBFdmVudC5tYXBUYXJnZXQgYXMgc3RyaW5nKS5zdGFydHNXaXRoKFNIQVBFX0lEX1BSRUZJWClcbiAgICAgICAgKSB7XG4gICAgICAgICAgcmV0dXJuXG4gICAgICAgIH1cbiAgICAgICAgaWYgKGV2ZW50LnNoaWZ0S2V5KSB7XG4gICAgICAgICAgaGFuZGxlQ3RybENsaWNrKG1hcEV2ZW50Lm1hcFRhcmdldClcbiAgICAgICAgfSBlbHNlIGlmIChldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXkpIHtcbiAgICAgICAgICBoYW5kbGVDdHJsQ2xpY2sobWFwRXZlbnQubWFwVGFyZ2V0KVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGhhbmRsZUNsaWNrKG1hcEV2ZW50Lm1hcFRhcmdldClcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBtYXAub25MZWZ0Q2xpY2soaGFuZGxlTGVmdENsaWNrKVxuICAgIHJldHVybiAoKSA9PiB7fVxuICB9LCBbXSlcblxuICBjb25zdCBJbmRpdmlkdWFsR2VvbWV0cmllcyA9IFJlYWN0LnVzZU1lbW8oKCkgPT4ge1xuICAgIHJldHVybiBPYmplY3QudmFsdWVzKGxhenlSZXN1bHRzLnJlc3VsdHMpLm1hcCgobGF6eVJlc3VsdCkgPT4ge1xuICAgICAgcmV0dXJuIChcbiAgICAgICAgPEdlb21ldHJ5XG4gICAgICAgICAga2V5PXtsYXp5UmVzdWx0WydtZXRhY2FyZC5pZCddfVxuICAgICAgICAgIGxhenlSZXN1bHQ9e2xhenlSZXN1bHR9XG4gICAgICAgICAgbWFwPXttYXB9XG4gICAgICAgICAgY2x1c3RlcnM9e2NsdXN0ZXJzfVxuICAgICAgICAvPlxuICAgICAgKVxuICAgIH0pXG4gIH0sIFtsYXp5UmVzdWx0cy5yZXN1bHRzLCBjbHVzdGVyc10pXG5cbiAgY29uc3QgQ2x1c3RlcnMgPSBSZWFjdC51c2VNZW1vKCgpID0+IHtcbiAgICByZXR1cm4gY2x1c3RlcnMubWFwKChjbHVzdGVyKSA9PiB7XG4gICAgICByZXR1cm4gPENsdXN0ZXIga2V5PXtjbHVzdGVyLmlkfSBjbHVzdGVyPXtjbHVzdGVyfSBtYXA9e21hcH0gLz5cbiAgICB9KVxuICB9LCBbY2x1c3RlcnMsIGxhenlSZXN1bHRzLnJlc3VsdHNdKVxuXG4gIGNvbnN0IENhbGN1bGF0ZUNsdXN0ZXJzTWVtbyA9IFJlYWN0LnVzZU1lbW8oKCkgPT4ge1xuICAgIHJldHVybiAoXG4gICAgICA8Q2FsY3VsYXRlQ2x1c3RlcnNcbiAgICAgICAga2V5PVwiY2x1c3RlcnNcIlxuICAgICAgICBpc0NsdXN0ZXJpbmc9e2lzQ2x1c3RlcmluZ31cbiAgICAgICAgbWFwPXttYXB9XG4gICAgICAgIGxhenlSZXN1bHRzPXtsYXp5UmVzdWx0cy5yZXN1bHRzfVxuICAgICAgICBzZXRDbHVzdGVycz17c2V0Q2x1c3RlcnN9XG4gICAgICAvPlxuICAgIClcbiAgfSwgW2xhenlSZXN1bHRzLnJlc3VsdHMsIGlzQ2x1c3RlcmluZ10pXG5cbiAgY29uc3QgWm9vbVRvU2VsZWN0aW9uTWVtbyA9IFJlYWN0LnVzZU1lbW8oKCkgPT4ge1xuICAgIHJldHVybiA8Wm9vbVRvU2VsZWN0aW9uIG1hcD17bWFwfSBsYXp5UmVzdWx0cz17bGF6eVJlc3VsdHN9IC8+XG4gIH0sIFtsYXp5UmVzdWx0c10pXG5cbiAgcmV0dXJuIChcbiAgICA8PlxuICAgICAge1pvb21Ub1NlbGVjdGlvbk1lbW99XG4gICAgICB7Q2FsY3VsYXRlQ2x1c3RlcnNNZW1vfVxuICAgICAge0NsdXN0ZXJzfVxuICAgICAge0luZGl2aWR1YWxHZW9tZXRyaWVzfVxuICAgIDwvPlxuICApXG59XG5cbmV4cG9ydCBkZWZhdWx0IEdlb21ldHJpZXNcbiJdfQ==