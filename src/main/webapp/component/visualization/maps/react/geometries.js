import { __read } from "tslib";
import * as React from 'react';
import { hot } from 'react-hot-loader';
import { Drawing } from '../../../singletons/drawing';
import { useLazyResultsFromSelectionInterface } from '../../../selection-interface/hooks';
import Geometry from './geometry';
import CalculateClusters from './calculate-clusters';
import Cluster from './cluster';
import ZoomToSelection from './zoom-to-selection';
import { SHAPE_ID_PREFIX } from '../drawing-and-display';
var Geometries = function (props) {
    var map = props.map, selectionInterface = props.selectionInterface, isClustering = props.isClustering;
    var lazyResults = useLazyResultsFromSelectionInterface({
        selectionInterface: selectionInterface,
    });
    var lazyResultsRef = React.useRef(lazyResults);
    lazyResultsRef.current = lazyResults;
    var _a = __read(React.useState([]), 2), clusters = _a[0], setClusters = _a[1];
    // possible since we debounce
    if (isClustering === false && clusters.length > 0) {
        setClusters([]);
    }
    React.useEffect(function () {
        var handleCtrlClick = function (id) {
            if (id.constructor === String) {
                lazyResultsRef.current.results[id].controlSelect();
            }
            else {
                ;
                id.map(function (subid) {
                    return lazyResultsRef.current.results[subid].controlSelect();
                });
            }
        };
        var handleClick = function (id) {
            if (id.constructor === String) {
                lazyResultsRef.current.results[id].select();
            }
            else {
                var resultIds = id;
                var shouldJustDeselect = resultIds.some(function (subid) { return lazyResultsRef.current.results[subid].isSelected; });
                lazyResultsRef.current.deselect();
                if (!shouldJustDeselect) {
                    resultIds.map(function (subid) {
                        return lazyResultsRef.current.results[subid].controlSelect();
                    });
                }
            }
        };
        var handleLeftClick = function (event, mapEvent) {
            if (mapEvent.mapTarget &&
                mapEvent.mapTarget !== 'userDrawing' &&
                !Drawing.isDrawing()) {
                // we get click events on normal drawn features from the location drawing
                if (mapEvent.mapTarget.constructor === String &&
                    mapEvent.mapTarget.startsWith(SHAPE_ID_PREFIX)) {
                    return;
                }
                if (event.shiftKey) {
                    handleCtrlClick(mapEvent.mapTarget);
                }
                else if (event.ctrlKey || event.metaKey) {
                    handleCtrlClick(mapEvent.mapTarget);
                }
                else {
                    handleClick(mapEvent.mapTarget);
                }
            }
        };
        map.onLeftClick(handleLeftClick);
        return function () { };
    }, []);
    var IndividualGeometries = React.useMemo(function () {
        return Object.values(lazyResults.results).map(function (lazyResult) {
            return (React.createElement(Geometry, { key: lazyResult['metacard.id'], lazyResult: lazyResult, map: map, clusters: clusters }));
        });
    }, [lazyResults.results, clusters]);
    var Clusters = React.useMemo(function () {
        return clusters.map(function (cluster) {
            return React.createElement(Cluster, { key: cluster.id, cluster: cluster, map: map });
        });
    }, [clusters, lazyResults.results]);
    var CalculateClustersMemo = React.useMemo(function () {
        return (React.createElement(CalculateClusters, { key: "clusters", isClustering: isClustering, map: map, lazyResults: lazyResults.results, setClusters: setClusters }));
    }, [lazyResults.results, isClustering]);
    var ZoomToSelectionMemo = React.useMemo(function () {
        return React.createElement(ZoomToSelection, { map: map, lazyResults: lazyResults });
    }, [lazyResults]);
    return (React.createElement(React.Fragment, null,
        ZoomToSelectionMemo,
        CalculateClustersMemo,
        Clusters,
        IndividualGeometries));
};
export default hot(module)(Geometries);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VvbWV0cmllcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3NyYy9tYWluL3dlYmFwcC9jb21wb25lbnQvdmlzdWFsaXphdGlvbi9tYXBzL3JlYWN0L2dlb21ldHJpZXMudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEtBQUssS0FBSyxNQUFNLE9BQU8sQ0FBQTtBQUM5QixPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sa0JBQWtCLENBQUE7QUFDdEMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLDZCQUE2QixDQUFBO0FBQ3JELE9BQU8sRUFBRSxvQ0FBb0MsRUFBRSxNQUFNLG9DQUFvQyxDQUFBO0FBQ3pGLE9BQU8sUUFBUSxNQUFNLFlBQVksQ0FBQTtBQUNqQyxPQUFPLGlCQUFpQixNQUFNLHNCQUFzQixDQUFBO0FBQ3BELE9BQU8sT0FBTyxNQUFNLFdBQVcsQ0FBQTtBQUUvQixPQUFPLGVBQWUsTUFBTSxxQkFBcUIsQ0FBQTtBQUNqRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sd0JBQXdCLENBQUE7QUFZeEQsSUFBTSxVQUFVLEdBQUcsVUFBQyxLQUFZO0lBQ3RCLElBQUEsR0FBRyxHQUF1QyxLQUFLLElBQTVDLEVBQUUsa0JBQWtCLEdBQW1CLEtBQUssbUJBQXhCLEVBQUUsWUFBWSxHQUFLLEtBQUssYUFBVixDQUFVO0lBQ3ZELElBQU0sV0FBVyxHQUFHLG9DQUFvQyxDQUFDO1FBQ3ZELGtCQUFrQixvQkFBQTtLQUNuQixDQUFDLENBQUE7SUFDRixJQUFNLGNBQWMsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFBO0lBQ2hELGNBQWMsQ0FBQyxPQUFPLEdBQUcsV0FBVyxDQUFBO0lBQzlCLElBQUEsS0FBQSxPQUEwQixLQUFLLENBQUMsUUFBUSxDQUFDLEVBQW1CLENBQUMsSUFBQSxFQUE1RCxRQUFRLFFBQUEsRUFBRSxXQUFXLFFBQXVDLENBQUE7SUFD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QixDQUNKLENBQUE7QUFDSCxDQUFDLENBQUE7QUFFRCxlQUFlLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0J1xuaW1wb3J0IHsgaG90IH0gZnJvbSAncmVhY3QtaG90LWxvYWRlcidcbmltcG9ydCB7IERyYXdpbmcgfSBmcm9tICcuLi8uLi8uLi9zaW5nbGV0b25zL2RyYXdpbmcnXG5pbXBvcnQgeyB1c2VMYXp5UmVzdWx0c0Zyb21TZWxlY3Rpb25JbnRlcmZhY2UgfSBmcm9tICcuLi8uLi8uLi9zZWxlY3Rpb24taW50ZXJmYWNlL2hvb2tzJ1xuaW1wb3J0IEdlb21ldHJ5IGZyb20gJy4vZ2VvbWV0cnknXG5pbXBvcnQgQ2FsY3VsYXRlQ2x1c3RlcnMgZnJvbSAnLi9jYWxjdWxhdGUtY2x1c3RlcnMnXG5pbXBvcnQgQ2x1c3RlciBmcm9tICcuL2NsdXN0ZXInXG5pbXBvcnQgeyBMYXp5UXVlcnlSZXN1bHQgfSBmcm9tICcuLi8uLi8uLi8uLi9qcy9tb2RlbC9MYXp5UXVlcnlSZXN1bHQvTGF6eVF1ZXJ5UmVzdWx0J1xuaW1wb3J0IFpvb21Ub1NlbGVjdGlvbiBmcm9tICcuL3pvb20tdG8tc2VsZWN0aW9uJ1xuaW1wb3J0IHsgU0hBUEVfSURfUFJFRklYIH0gZnJvbSAnLi4vZHJhd2luZy1hbmQtZGlzcGxheSdcbnR5cGUgUHJvcHMgPSB7XG4gIHNlbGVjdGlvbkludGVyZmFjZTogYW55XG4gIG1hcDogYW55XG4gIGlzQ2x1c3RlcmluZzogYm9vbGVhblxufVxuXG5leHBvcnQgdHlwZSBDbHVzdGVyVHlwZSA9IHtcbiAgcmVzdWx0czogTGF6eVF1ZXJ5UmVzdWx0W11cbiAgaWQ6IHN0cmluZ1xufVxuXG5jb25zdCBHZW9tZXRyaWVzID0gKHByb3BzOiBQcm9wcykgPT4ge1xuICBjb25zdCB7IG1hcCwgc2VsZWN0aW9uSW50ZXJmYWNlLCBpc0NsdXN0ZXJpbmcgfSA9IHByb3BzXG4gIGNvbnN0IGxhenlSZXN1bHRzID0gdXNlTGF6eVJlc3VsdHNGcm9tU2VsZWN0aW9uSW50ZXJmYWNlKHtcbiAgICBzZWxlY3Rpb25JbnRlcmZhY2UsXG4gIH0pXG4gIGNvbnN0IGxhenlSZXN1bHRzUmVmID0gUmVhY3QudXNlUmVmKGxhenlSZXN1bHRzKVxuICBsYXp5UmVzdWx0c1JlZi5jdXJyZW50ID0gbGF6eVJlc3VsdHNcbiAgY29uc3QgW2NsdXN0ZXJzLCBzZXRDbHVzdGVyc10gPSBSZWFjdC51c2VTdGF0ZShbXSBhcyBDbHVzdGVyVHlwZVtdKVxuICAvLyBwb3NzaWJsZSBzaW5jZSB3ZSBkZWJvdW5jZVxuICBpZiAoaXNDbHVzdGVyaW5nID09PSBmYWxzZSAmJiBjbHVzdGVycy5sZW5ndGggPiAwKSB7XG4gICAgc2V0Q2x1c3RlcnMoW10pXG4gIH1cbiAgUmVhY3QudXNlRWZmZWN0KCgpID0+IHtcbiAgICBjb25zdCBoYW5kbGVDdHJsQ2xpY2sgPSAoaWQ6IHN0cmluZyB8IHN0cmluZ1tdKSA9PiB7XG4gICAgICBpZiAoaWQuY29uc3RydWN0b3IgPT09IFN0cmluZykge1xuICAgICAgICBsYXp5UmVzdWx0c1JlZi5jdXJyZW50LnJlc3VsdHNbaWQgYXMgc3RyaW5nXS5jb250cm9sU2VsZWN0KClcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIDsoaWQgYXMgc3RyaW5nW10pLm1hcCgoc3ViaWQpID0+IHtcbiAgICAgICAgICByZXR1cm4gbGF6eVJlc3VsdHNSZWYuY3VycmVudC5yZXN1bHRzW3N1YmlkIGFzIHN0cmluZ10uY29udHJvbFNlbGVjdCgpXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IGhhbmRsZUNsaWNrID0gKGlkOiBzdHJpbmcgfCBzdHJpbmdbXSkgPT4ge1xuICAgICAgaWYgKGlkLmNvbnN0cnVjdG9yID09PSBTdHJpbmcpIHtcbiAgICAgICAgbGF6eVJlc3VsdHNSZWYuY3VycmVudC5yZXN1bHRzW2lkIGFzIHN0cmluZ10uc2VsZWN0KClcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdElkcyA9IGlkIGFzIHN0cmluZ1tdXG4gICAgICAgIGxldCBzaG91bGRKdXN0RGVzZWxlY3QgPSByZXN1bHRJZHMuc29tZShcbiAgICAgICAgICAoc3ViaWQpID0+IGxhenlSZXN1bHRzUmVmLmN1cnJlbnQucmVzdWx0c1tzdWJpZF0uaXNTZWxlY3RlZFxuICAgICAgICApXG4gICAgICAgIGxhenlSZXN1bHRzUmVmLmN1cnJlbnQuZGVzZWxlY3QoKVxuICAgICAgICBpZiAoIXNob3VsZEp1c3REZXNlbGVjdCkge1xuICAgICAgICAgIHJlc3VsdElkcy5tYXAoKHN1YmlkKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gbGF6eVJlc3VsdHNSZWYuY3VycmVudC5yZXN1bHRzW1xuICAgICAgICAgICAgICBzdWJpZCBhcyBzdHJpbmdcbiAgICAgICAgICAgIF0uY29udHJvbFNlbGVjdCgpXG4gICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCBoYW5kbGVMZWZ0Q2xpY2sgPSAoZXZlbnQ6IGFueSwgbWFwRXZlbnQ6IGFueSkgPT4ge1xuICAgICAgaWYgKFxuICAgICAgICBtYXBFdmVudC5tYXBUYXJnZXQgJiZcbiAgICAgICAgbWFwRXZlbnQubWFwVGFyZ2V0ICE9PSAndXNlckRyYXdpbmcnICYmXG4gICAgICAgICFEcmF3aW5nLmlzRHJhd2luZygpXG4gICAgICApIHtcbiAgICAgICAgLy8gd2UgZ2V0IGNsaWNrIGV2ZW50cyBvbiBub3JtYWwgZHJhd24gZmVhdHVyZXMgZnJvbSB0aGUgbG9jYXRpb24gZHJhd2luZ1xuICAgICAgICBpZiAoXG4gICAgICAgICAgbWFwRXZlbnQubWFwVGFyZ2V0LmNvbnN0cnVjdG9yID09PSBTdHJpbmcgJiZcbiAgICAgICAgICAobWFwRXZlbnQubWFwVGFyZ2V0IGFzIHN0cmluZykuc3RhcnRzV2l0aChTSEFQRV9JRF9QUkVGSVgpXG4gICAgICAgICkge1xuICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG4gICAgICAgIGlmIChldmVudC5zaGlmdEtleSkge1xuICAgICAgICAgIGhhbmRsZUN0cmxDbGljayhtYXBFdmVudC5tYXBUYXJnZXQpXG4gICAgICAgIH0gZWxzZSBpZiAoZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5KSB7XG4gICAgICAgICAgaGFuZGxlQ3RybENsaWNrKG1hcEV2ZW50Lm1hcFRhcmdldClcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBoYW5kbGVDbGljayhtYXBFdmVudC5tYXBUYXJnZXQpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgbWFwLm9uTGVmdENsaWNrKGhhbmRsZUxlZnRDbGljaylcbiAgICByZXR1cm4gKCkgPT4ge31cbiAgfSwgW10pXG5cbiAgY29uc3QgSW5kaXZpZHVhbEdlb21ldHJpZXMgPSBSZWFjdC51c2VNZW1vKCgpID0+IHtcbiAgICByZXR1cm4gT2JqZWN0LnZhbHVlcyhsYXp5UmVzdWx0cy5yZXN1bHRzKS5tYXAoKGxhenlSZXN1bHQpID0+IHtcbiAgICAgIHJldHVybiAoXG4gICAgICAgIDxHZW9tZXRyeVxuICAgICAgICAgIGtleT17bGF6eVJlc3VsdFsnbWV0YWNhcmQuaWQnXX1cbiAgICAgICAgICBsYXp5UmVzdWx0PXtsYXp5UmVzdWx0fVxuICAgICAgICAgIG1hcD17bWFwfVxuICAgICAgICAgIGNsdXN0ZXJzPXtjbHVzdGVyc31cbiAgICAgICAgLz5cbiAgICAgIClcbiAgICB9KVxuICB9LCBbbGF6eVJlc3VsdHMucmVzdWx0cywgY2x1c3RlcnNdKVxuXG4gIGNvbnN0IENsdXN0ZXJzID0gUmVhY3QudXNlTWVtbygoKSA9PiB7XG4gICAgcmV0dXJuIGNsdXN0ZXJzLm1hcCgoY2x1c3RlcikgPT4ge1xuICAgICAgcmV0dXJuIDxDbHVzdGVyIGtleT17Y2x1c3Rlci5pZH0gY2x1c3Rlcj17Y2x1c3Rlcn0gbWFwPXttYXB9IC8+XG4gICAgfSlcbiAgfSwgW2NsdXN0ZXJzLCBsYXp5UmVzdWx0cy5yZXN1bHRzXSlcblxuICBjb25zdCBDYWxjdWxhdGVDbHVzdGVyc01lbW8gPSBSZWFjdC51c2VNZW1vKCgpID0+IHtcbiAgICByZXR1cm4gKFxuICAgICAgPENhbGN1bGF0ZUNsdXN0ZXJzXG4gICAgICAgIGtleT1cImNsdXN0ZXJzXCJcbiAgICAgICAgaXNDbHVzdGVyaW5nPXtpc0NsdXN0ZXJpbmd9XG4gICAgICAgIG1hcD17bWFwfVxuICAgICAgICBsYXp5UmVzdWx0cz17bGF6eVJlc3VsdHMucmVzdWx0c31cbiAgICAgICAgc2V0Q2x1c3RlcnM9e3NldENsdXN0ZXJzfVxuICAgICAgLz5cbiAgICApXG4gIH0sIFtsYXp5UmVzdWx0cy5yZXN1bHRzLCBpc0NsdXN0ZXJpbmddKVxuXG4gIGNvbnN0IFpvb21Ub1NlbGVjdGlvbk1lbW8gPSBSZWFjdC51c2VNZW1vKCgpID0+IHtcbiAgICByZXR1cm4gPFpvb21Ub1NlbGVjdGlvbiBtYXA9e21hcH0gbGF6eVJlc3VsdHM9e2xhenlSZXN1bHRzfSAvPlxuICB9LCBbbGF6eVJlc3VsdHNdKVxuXG4gIHJldHVybiAoXG4gICAgPD5cbiAgICAgIHtab29tVG9TZWxlY3Rpb25NZW1vfVxuICAgICAge0NhbGN1bGF0ZUNsdXN0ZXJzTWVtb31cbiAgICAgIHtDbHVzdGVyc31cbiAgICAgIHtJbmRpdmlkdWFsR2VvbWV0cmllc31cbiAgICA8Lz5cbiAgKVxufVxuXG5leHBvcnQgZGVmYXVsdCBob3QobW9kdWxlKShHZW9tZXRyaWVzKVxuIl19