import { __makeTemplateObject, __read } from "tslib";
import WithListenTo from './../../../react-component/backbone-container';
import * as React from 'react';
import { hot } from 'react-hot-loader';
import styled from 'styled-components';
import { useLazyResultsFromSelectionInterface } from '../../selection-interface/hooks';
import { useSelectedResults } from '../../../js/model/LazyQueryResult/hooks';
import Timeline from '../../timeline';
import moment from 'moment-timezone';
import useTimePrefs from '../../fields/useTimePrefs';
import IconHelper from '../../../js/IconHelper';
import useSnack from '../../hooks/useSnack';
import wreqr from '../../../js/wreqr';
import user from '../../singletons/user-instance';
import Extensions from '../../../extension-points';
import _ from 'lodash';
import { useConfiguration } from '../../../js/model/Startup/configuration.hooks';
import { StartupDataStore } from '../../../js/model/Startup/startup';
var maxDate = moment().tz(user.getTimeZone());
var TimelineWrapper = styled.div(templateObject_1 || (templateObject_1 = __makeTemplateObject(["\n  padding: 40px 40px 60px 40px;\n  height: 100%;\n\n  .MuiButton-label {\n    font-size: 0.875rem !important;\n  }\n"], ["\n  padding: 40px 40px 60px 40px;\n  height: 100%;\n\n  .MuiButton-label {\n    font-size: 0.875rem !important;\n  }\n"])));
var getDateAttributes = function (results) {
    var availableAttributes = Object.keys(results)
        .reduce(function (currentAvailable, key) {
        var result = results[key];
        // @ts-expect-error ts-migrate(2322) FIXME: Type 'string[]' is not assignable to type 'never[]... Remove this comment to see the full error message
        currentAvailable = _.union(currentAvailable, Object.keys(result.plain.metacard.properties));
        return currentAvailable;
    }, [])
        .sort();
    var dateAttributes = availableAttributes.reduce(function (list, attribute) {
        var _a;
        if (((_a = StartupDataStore.MetacardDefinitions.getAttributeMap()[attribute]) === null || _a === void 0 ? void 0 : _a.type) == 'DATE') {
            list.push(attribute);
        }
        return list;
    }, []);
    return dateAttributes;
};
var renderTooltip = function (timelineItems) {
    var itemsToExpand = 5;
    var uniqueMetacards = timelineItems.filter(function (item, index) { return timelineItems.indexOf(item) === index; });
    var results = uniqueMetacards.slice(0, itemsToExpand).map(function (item) {
        var data = item.data;
        var icon = IconHelper.getFullByMetacardObject(data.plain);
        var metacard = data.plain.metacard.properties;
        var ItemAddOn = Extensions.timelineItemAddOn({
            results: [data],
            isSingleItem: true,
        });
        var valCount = timelineItems.filter(function (i) { return i.id === item.id; }).length;
        return (React.createElement(React.Fragment, { key: metacard.id },
            React.createElement("span", { className: icon.class }),
            "\u00A0",
            ItemAddOn && (React.createElement(React.Fragment, null,
                ItemAddOn,
                "\u00A0")),
            React.createElement("span", null, "".concat(metacard.title || metacard.id).concat(valCount > 1 ? " (".concat(valCount, ")") : '')),
            React.createElement("br", null)));
    });
    var OtherItemsAddOn = null;
    if (uniqueMetacards.length > itemsToExpand) {
        OtherItemsAddOn = Extensions.timelineItemAddOn({
            results: uniqueMetacards
                .slice(itemsToExpand)
                .map(function (item) { return item.data; }),
            isSingleItem: false,
        });
    }
    var otherResults = (React.createElement(React.Fragment, null,
        React.createElement("br", null), "+".concat(uniqueMetacards.length - itemsToExpand, " other results"),
        OtherItemsAddOn && (React.createElement(React.Fragment, null,
            "\u00A0",
            OtherItemsAddOn))));
    return (React.createElement(React.Fragment, null,
        results,
        uniqueMetacards.length > itemsToExpand && otherResults));
};
var TimelineVisualization = function (props) {
    var selectionInterface = props.selectionInterface;
    var config = useConfiguration().config;
    useTimePrefs();
    var lazyResults = useLazyResultsFromSelectionInterface({
        selectionInterface: selectionInterface,
    });
    var selectedResults = useSelectedResults({
        lazyResults: lazyResults,
    });
    var results = lazyResults.results;
    var _a = __read(React.useState([]), 2), data = _a[0], setData = _a[1];
    var _b = __read(React.useState({}), 2), dateAttributeAliases = _b[0], setDateAttributeAliases = _b[1];
    var _c = __read(React.useState(0), 2), height = _c[0], setHeight = _c[1];
    var _d = __read(React.useState(false), 2), pause = _d[0], setPause = _d[1];
    var rootRef = React.useRef(null);
    var _e = __read(React.useState(false), 2), resized = _e[0], setResized = _e[1];
    var addSnack = useSnack();
    React.useEffect(function () {
        props.listenTo(wreqr.vent, 'resize', function () {
            if (rootRef.current) {
                // @ts-expect-error ts-migrate(2531) FIXME: Object is possibly 'null'.
                var rect = rootRef.current.getBoundingClientRect();
                setHeight(rect.height);
            }
            setResized(true);
        });
    }, []);
    React.useEffect(function () {
        if (resized) {
            setResized(false);
        }
    }, [resized]);
    React.useEffect(function () {
        var selectedIds = Object.values(selectedResults).map(function (result) { return result.plain.metacard.properties.id; });
        var possibleDateAttributes = getDateAttributes(results);
        var resultData = Object.values(results).map(function (result) {
            var metacard = result.plain.metacard.properties;
            var resultDateAttributes = {};
            possibleDateAttributes.forEach(function (dateAttribute) {
                var val = metacard[dateAttribute];
                if (val) {
                    resultDateAttributes[dateAttribute] = Array.isArray(val)
                        ? val.map(function (v) { return moment(v); })
                        : [moment(val)];
                }
            });
            var id = metacard.id;
            var resultDataPoint = {
                id: id,
                selected: selectedIds.includes(id),
                data: result,
                attributes: resultDateAttributes,
            };
            return resultDataPoint;
        });
        setData(resultData);
        if (Object.keys(possibleDateAttributes).length > 0) {
            var aliasMap_1 = {};
            possibleDateAttributes.forEach(function (dateAttribute) {
                aliasMap_1[dateAttribute] =
                    (config === null || config === void 0 ? void 0 : config.attributeAliases[dateAttribute]) || dateAttribute;
            });
            if (!_.isEqual(aliasMap_1, dateAttributeAliases)) {
                setDateAttributeAliases(aliasMap_1);
            }
        }
    }, [results, selectedResults, config]);
    var onSelect = function (selectedData) {
        var selectedIds = selectedData.map(function (d) { return d.id; });
        setPause(true);
        lazyResults.selectByIds(selectedIds);
        setPause(false);
    };
    if (pause) {
        return null;
    }
    return (React.createElement(TimelineWrapper, { "data-id": "timeline-container", ref: rootRef },
        React.createElement(Timeline, { min: moment('1975-01-01').tz(user.getTimeZone()), max: moment(maxDate), heightOffset: 250, onSelect: onSelect, data: data, dateAttributeAliases: dateAttributeAliases, renderTooltip: renderTooltip, format: user.getDateTimeFormat(), timezone: user.getTimeZone(), height: height, onCopy: function (copiedValue) {
                addSnack('Copied to clipboard: ' + copiedValue, {
                    alertProps: {
                        severity: 'success',
                    },
                });
            } })));
};
export default hot(module)(WithListenTo(TimelineVisualization));
var templateObject_1;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGltZWxpbmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9zcmMvbWFpbi93ZWJhcHAvY29tcG9uZW50L3Zpc3VhbGl6YXRpb24vdGltZWxpbmUvdGltZWxpbmUudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLFlBRU4sTUFBTSwrQ0FBK0MsQ0FBQTtBQUN0RCxPQUFPLEtBQUssS0FBSyxNQUFNLE9BQU8sQ0FBQTtBQUM5QixPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sa0JBQWtCLENBQUE7QUFDdEMsT0FBTyxNQUFNLE1BQU0sbUJBQW1CLENBQUE7QUFFdEMsT0FBTyxFQUFFLG9DQUFvQyxFQUFFLE1BQU0saUNBQWlDLENBQUE7QUFDdEYsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0seUNBQXlDLENBQUE7QUFDNUUsT0FBTyxRQUFRLE1BQU0sZ0JBQWdCLENBQUE7QUFFckMsT0FBTyxNQUFrQixNQUFNLGlCQUFpQixDQUFBO0FBQ2hELE9BQU8sWUFBWSxNQUFNLDJCQUEyQixDQUFBO0FBQ3BELE9BQU8sVUFBVSxNQUFNLHdCQUF3QixDQUFBO0FBQy9DLE9BQU8sUUFBUSxNQUFNLHNCQUFzQixDQUFBO0FBQzNDLE9BQU8sS0FBSyxNQUFNLG1CQUFtQixDQUFBO0FBQ3JDLE9BQU8sSUFBSSxNQUFNLGdDQUFnQyxDQUFBO0FBQ2pELE9BQU8sVUFBVSxNQUFNLDJCQUEyQixDQUFBO0FBQ2xELE9BQU8sQ0FBQyxNQUFNLFFBQVEsQ0FBQTtBQUN0QixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSwrQ0FBK0MsQ0FBQTtBQUNoRixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQTtBQUNwRSxJQUFNLE9BQU8sR0FBRyxNQUFNLEVBQUUsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUE7QUFJL0MsSUFBTSxlQUFlLEdBQUcsTUFBTSxDQUFDLEdB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LEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsRUFDaEQsR0FBRyxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFDcEIsWUFBWSxFQUFFLEdBQUcsRUFDakIsUUFBUSxFQUFFLFFBQVEsRUFDbEIsSUFBSSxFQUFFLElBQUksRUFDVixvQkFBb0IsRUFBRSxvQkFBb0IsRUFDMUMsYUFBYSxFQUFFLGFBQWEsRUFDNUIsTUFBTSxFQUFFLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxFQUNoQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFdBQVcsRUFBRSxFQUM1QixNQUFNLEVBQUUsTUFBTSxFQUNkLE1BQU0sRUFBRSxVQUFDLFdBQVc7Z0JBQ2xCLFFBQVEsQ0FBQyx1QkFBdUIsR0FBRyxXQUFXLEVBQUU7b0JBQzlDLFVBQVUsRUFBRTt3QkFDVixRQUFRLEVBQUUsU0FBUztxQkFDcEI7aUJBQ0YsQ0FBQyxDQUFBO1lBQ0osQ0FBQyxHQUNELENBQ2MsQ0FDbkIsQ0FBQTtBQUNILENBQUMsQ0FBQTtBQUNELGVBQWUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLFlBQVksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgV2l0aExpc3RlblRvLCB7XG4gIFdpdGhCYWNrYm9uZVByb3BzLFxufSBmcm9tICcuLy4uLy4uLy4uL3JlYWN0LWNvbXBvbmVudC9iYWNrYm9uZS1jb250YWluZXInXG5pbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCdcbmltcG9ydCB7IGhvdCB9IGZyb20gJ3JlYWN0LWhvdC1sb2FkZXInXG5pbXBvcnQgc3R5bGVkIGZyb20gJ3N0eWxlZC1jb21wb25lbnRzJ1xuaW1wb3J0IHsgTGF6eVF1ZXJ5UmVzdWx0IH0gZnJvbSAnLi4vLi4vLi4vanMvbW9kZWwvTGF6eVF1ZXJ5UmVzdWx0L0xhenlRdWVyeVJlc3VsdCdcbmltcG9ydCB7IHVzZUxhenlSZXN1bHRzRnJvbVNlbGVjdGlvbkludGVyZmFjZSB9IGZyb20gJy4uLy4uL3NlbGVjdGlvbi1pbnRlcmZhY2UvaG9va3MnXG5pbXBvcnQgeyB1c2VTZWxlY3RlZFJlc3VsdHMgfSBmcm9tICcuLi8uLi8uLi9qcy9tb2RlbC9MYXp5UXVlcnlSZXN1bHQvaG9va3MnXG5pbXBvcnQgVGltZWxpbmUgZnJvbSAnLi4vLi4vdGltZWxpbmUnXG5pbXBvcnQgeyBUaW1lbGluZUl0ZW0gfSBmcm9tICcuLi8uLi90aW1lbGluZS90aW1lbGluZSdcbmltcG9ydCBtb21lbnQsIHsgTW9tZW50IH0gZnJvbSAnbW9tZW50LXRpbWV6b25lJ1xuaW1wb3J0IHVzZVRpbWVQcmVmcyBmcm9tICcuLi8uLi9maWVsZHMvdXNlVGltZVByZWZzJ1xuaW1wb3J0IEljb25IZWxwZXIgZnJvbSAnLi4vLi4vLi4vanMvSWNvbkhlbHBlcidcbmltcG9ydCB1c2VTbmFjayBmcm9tICcuLi8uLi9ob29rcy91c2VTbmFjaydcbmltcG9ydCB3cmVxciBmcm9tICcuLi8uLi8uLi9qcy93cmVxcidcbmltcG9ydCB1c2VyIGZyb20gJy4uLy4uL3NpbmdsZXRvbnMvdXNlci1pbnN0YW5jZSdcbmltcG9ydCBFeHRlbnNpb25zIGZyb20gJy4uLy4uLy4uL2V4dGVuc2lvbi1wb2ludHMnXG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnXG5pbXBvcnQgeyB1c2VDb25maWd1cmF0aW9uIH0gZnJvbSAnLi4vLi4vLi4vanMvbW9kZWwvU3RhcnR1cC9jb25maWd1cmF0aW9uLmhvb2tzJ1xuaW1wb3J0IHsgU3RhcnR1cERhdGFTdG9yZSB9IGZyb20gJy4uLy4uLy4uL2pzL21vZGVsL1N0YXJ0dXAvc3RhcnR1cCdcbmNvbnN0IG1heERhdGUgPSBtb21lbnQoKS50eih1c2VyLmdldFRpbWVab25lKCkpXG50eXBlIFByb3BzID0ge1xuICBzZWxlY3Rpb25JbnRlcmZhY2U6IGFueVxufSAmIFdpdGhCYWNrYm9uZVByb3BzXG5jb25zdCBUaW1lbGluZVdyYXBwZXIgPSBzdHlsZWQuZGl2YFxuICBwYWRkaW5nOiA0MHB4IDQwcHggNjBweCA0MHB4O1xuICBoZWlnaHQ6IDEwMCU7XG5cbiAgLk11aUJ1dHRvbi1sYWJlbCB7XG4gICAgZm9udC1zaXplOiAwLjg3NXJlbSAhaW1wb3J0YW50O1xuICB9XG5gXG5jb25zdCBnZXREYXRlQXR0cmlidXRlcyA9IChyZXN1bHRzOiBhbnkpID0+IHtcbiAgY29uc3QgYXZhaWxhYmxlQXR0cmlidXRlcyA9IE9iamVjdC5rZXlzKHJlc3VsdHMpXG4gICAgLnJlZHVjZSgoY3VycmVudEF2YWlsYWJsZSwga2V5KSA9PiB7XG4gICAgICBjb25zdCByZXN1bHQgPSByZXN1bHRzW2tleV1cbiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgdHMtbWlncmF0ZSgyMzIyKSBGSVhNRTogVHlwZSAnc3RyaW5nW10nIGlzIG5vdCBhc3NpZ25hYmxlIHRvIHR5cGUgJ25ldmVyW10uLi4gUmVtb3ZlIHRoaXMgY29tbWVudCB0byBzZWUgdGhlIGZ1bGwgZXJyb3IgbWVzc2FnZVxuICAgICAgY3VycmVudEF2YWlsYWJsZSA9IF8udW5pb24oXG4gICAgICAgIGN1cnJlbnRBdmFpbGFibGUsXG4gICAgICAgIE9iamVjdC5rZXlzKHJlc3VsdC5wbGFpbi5tZXRhY2FyZC5wcm9wZXJ0aWVzKVxuICAgICAgKVxuICAgICAgcmV0dXJuIGN1cnJlbnRBdmFpbGFibGVcbiAgICB9LCBbXSlcbiAgICAuc29ydCgpXG4gIGxldCBkYXRlQXR0cmlidXRlcyA9IGF2YWlsYWJsZUF0dHJpYnV0ZXMucmVkdWNlKFxuICAgIChsaXN0OiBhbnksIGF0dHJpYnV0ZTogYW55KSA9PiB7XG4gICAgICBpZiAoXG4gICAgICAgIFN0YXJ0dXBEYXRhU3RvcmUuTWV0YWNhcmREZWZpbml0aW9ucy5nZXRBdHRyaWJ1dGVNYXAoKVthdHRyaWJ1dGVdXG4gICAgICAgICAgPy50eXBlID09ICdEQVRFJ1xuICAgICAgKSB7XG4gICAgICAgIGxpc3QucHVzaChhdHRyaWJ1dGUpXG4gICAgICB9XG4gICAgICByZXR1cm4gbGlzdFxuICAgIH0sXG4gICAgW11cbiAgKVxuICByZXR1cm4gZGF0ZUF0dHJpYnV0ZXNcbn1cbmNvbnN0IHJlbmRlclRvb2x0aXAgPSAodGltZWxpbmVJdGVtczogVGltZWxpbmVJdGVtW10pID0+IHtcbiAgY29uc3QgaXRlbXNUb0V4cGFuZCA9IDVcbiAgY29uc3QgdW5pcXVlTWV0YWNhcmRzID0gdGltZWxpbmVJdGVtcy5maWx0ZXIoXG4gICAgKGl0ZW0sIGluZGV4KSA9PiB0aW1lbGluZUl0ZW1zLmluZGV4T2YoaXRlbSkgPT09IGluZGV4XG4gIClcbiAgY29uc3QgcmVzdWx0cyA9IHVuaXF1ZU1ldGFjYXJkcy5zbGljZSgwLCBpdGVtc1RvRXhwYW5kKS5tYXAoKGl0ZW0pID0+IHtcbiAgICBjb25zdCBkYXRhID0gaXRlbS5kYXRhIGFzIExhenlRdWVyeVJlc3VsdFxuICAgIGNvbnN0IGljb24gPSBJY29uSGVscGVyLmdldEZ1bGxCeU1ldGFjYXJkT2JqZWN0KGRhdGEucGxhaW4pXG4gICAgY29uc3QgbWV0YWNhcmQgPSBkYXRhLnBsYWluLm1ldGFjYXJkLnByb3BlcnRpZXNcbiAgICBjb25zdCBJdGVtQWRkT24gPSBFeHRlbnNpb25zLnRpbWVsaW5lSXRlbUFkZE9uKHtcbiAgICAgIHJlc3VsdHM6IFtkYXRhXSxcbiAgICAgIGlzU2luZ2xlSXRlbTogdHJ1ZSxcbiAgICB9KVxuICAgIGNvbnN0IHZhbENvdW50ID0gdGltZWxpbmVJdGVtcy5maWx0ZXIoKGkpID0+IGkuaWQgPT09IGl0ZW0uaWQpLmxlbmd0aFxuICAgIHJldHVybiAoXG4gICAgICA8UmVhY3QuRnJhZ21lbnQga2V5PXttZXRhY2FyZC5pZH0+XG4gICAgICAgIDxzcGFuIGNsYXNzTmFtZT17aWNvbi5jbGFzc30gLz5cbiAgICAgICAgJm5ic3A7XG4gICAgICAgIHtJdGVtQWRkT24gJiYgKFxuICAgICAgICAgIDw+XG4gICAgICAgICAgICB7SXRlbUFkZE9ufVxuICAgICAgICAgICAgJm5ic3A7XG4gICAgICAgICAgPC8+XG4gICAgICAgICl9XG4gICAgICAgIDxzcGFuPntgJHttZXRhY2FyZC50aXRsZSB8fCBtZXRhY2FyZC5pZH0ke1xuICAgICAgICAgIHZhbENvdW50ID4gMSA/IGAgKCR7dmFsQ291bnR9KWAgOiAnJ1xuICAgICAgICB9YH08L3NwYW4+XG4gICAgICAgIDxiciAvPlxuICAgICAgPC9SZWFjdC5GcmFnbWVudD5cbiAgICApXG4gIH0pXG5cbiAgbGV0IE90aGVySXRlbXNBZGRPbiA9IG51bGxcbiAgaWYgKHVuaXF1ZU1ldGFjYXJkcy5sZW5ndGggPiBpdGVtc1RvRXhwYW5kKSB7XG4gICAgT3RoZXJJdGVtc0FkZE9uID0gRXh0ZW5zaW9ucy50aW1lbGluZUl0ZW1BZGRPbih7XG4gICAgICByZXN1bHRzOiB1bmlxdWVNZXRhY2FyZHNcbiAgICAgICAgLnNsaWNlKGl0ZW1zVG9FeHBhbmQpXG4gICAgICAgIC5tYXAoKGl0ZW0pID0+IGl0ZW0uZGF0YSBhcyBMYXp5UXVlcnlSZXN1bHQpLFxuICAgICAgaXNTaW5nbGVJdGVtOiBmYWxzZSxcbiAgICB9KVxuICB9XG5cbiAgY29uc3Qgb3RoZXJSZXN1bHRzID0gKFxuICAgIDxSZWFjdC5GcmFnbWVudD5cbiAgICAgIDxiciAvPlxuICAgICAge2ArJHt1bmlxdWVNZXRhY2FyZHMubGVuZ3RoIC0gaXRlbXNUb0V4cGFuZH0gb3RoZXIgcmVzdWx0c2B9XG4gICAgICB7T3RoZXJJdGVtc0FkZE9uICYmIChcbiAgICAgICAgPD5cbiAgICAgICAgICAmbmJzcDtcbiAgICAgICAgICB7T3RoZXJJdGVtc0FkZE9ufVxuICAgICAgICA8Lz5cbiAgICAgICl9XG4gICAgPC9SZWFjdC5GcmFnbWVudD5cbiAgKVxuICByZXR1cm4gKFxuICAgIDxSZWFjdC5GcmFnbWVudD5cbiAgICAgIHtyZXN1bHRzfVxuICAgICAge3VuaXF1ZU1ldGFjYXJkcy5sZW5ndGggPiBpdGVtc1RvRXhwYW5kICYmIG90aGVyUmVzdWx0c31cbiAgICA8L1JlYWN0LkZyYWdtZW50PlxuICApXG59XG5jb25zdCBUaW1lbGluZVZpc3VhbGl6YXRpb24gPSAocHJvcHM6IFByb3BzKSA9PiB7XG4gIGNvbnN0IHsgc2VsZWN0aW9uSW50ZXJmYWNlIH0gPSBwcm9wc1xuICBjb25zdCB7IGNvbmZpZyB9ID0gdXNlQ29uZmlndXJhdGlvbigpXG4gIHVzZVRpbWVQcmVmcygpXG4gIGNvbnN0IGxhenlSZXN1bHRzID0gdXNlTGF6eVJlc3VsdHNGcm9tU2VsZWN0aW9uSW50ZXJmYWNlKHtcbiAgICBzZWxlY3Rpb25JbnRlcmZhY2UsXG4gIH0pXG4gIGNvbnN0IHNlbGVjdGVkUmVzdWx0cyA9IHVzZVNlbGVjdGVkUmVzdWx0cyh7XG4gICAgbGF6eVJlc3VsdHMsXG4gIH0pXG4gIGNvbnN0IHsgcmVzdWx0cyB9ID0gbGF6eVJlc3VsdHNcbiAgY29uc3QgW2RhdGEsIHNldERhdGFdID0gUmVhY3QudXNlU3RhdGU8VGltZWxpbmVJdGVtW10+KFtdKVxuICBjb25zdCBbZGF0ZUF0dHJpYnV0ZUFsaWFzZXMsIHNldERhdGVBdHRyaWJ1dGVBbGlhc2VzXSA9IFJlYWN0LnVzZVN0YXRlKHt9KVxuICBjb25zdCBbaGVpZ2h0LCBzZXRIZWlnaHRdID0gUmVhY3QudXNlU3RhdGUoMClcbiAgY29uc3QgW3BhdXNlLCBzZXRQYXVzZV0gPSBSZWFjdC51c2VTdGF0ZShmYWxzZSlcbiAgY29uc3Qgcm9vdFJlZiA9IFJlYWN0LnVzZVJlZihudWxsKVxuICBjb25zdCBbcmVzaXplZCwgc2V0UmVzaXplZF0gPSBSZWFjdC51c2VTdGF0ZShmYWxzZSlcbiAgY29uc3QgYWRkU25hY2sgPSB1c2VTbmFjaygpXG4gIFJlYWN0LnVzZUVmZmVjdCgoKSA9PiB7XG4gICAgcHJvcHMubGlzdGVuVG8oKHdyZXFyIGFzIGFueSkudmVudCwgJ3Jlc2l6ZScsICgpID0+IHtcbiAgICAgIGlmIChyb290UmVmLmN1cnJlbnQpIHtcbiAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciB0cy1taWdyYXRlKDI1MzEpIEZJWE1FOiBPYmplY3QgaXMgcG9zc2libHkgJ251bGwnLlxuICAgICAgICBjb25zdCByZWN0ID0gcm9vdFJlZi5jdXJyZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpXG4gICAgICAgIHNldEhlaWdodChyZWN0LmhlaWdodClcbiAgICAgIH1cbiAgICAgIHNldFJlc2l6ZWQodHJ1ZSlcbiAgICB9KVxuICB9LCBbXSlcbiAgUmVhY3QudXNlRWZmZWN0KCgpID0+IHtcbiAgICBpZiAocmVzaXplZCkge1xuICAgICAgc2V0UmVzaXplZChmYWxzZSlcbiAgICB9XG4gIH0sIFtyZXNpemVkXSlcbiAgUmVhY3QudXNlRWZmZWN0KCgpID0+IHtcbiAgICBjb25zdCBzZWxlY3RlZElkcyA9IE9iamVjdC52YWx1ZXMoc2VsZWN0ZWRSZXN1bHRzKS5tYXAoXG4gICAgICAocmVzdWx0KSA9PiByZXN1bHQucGxhaW4ubWV0YWNhcmQucHJvcGVydGllcy5pZFxuICAgIClcbiAgICBjb25zdCBwb3NzaWJsZURhdGVBdHRyaWJ1dGVzID0gZ2V0RGF0ZUF0dHJpYnV0ZXMocmVzdWx0cylcbiAgICBjb25zdCByZXN1bHREYXRhOiBUaW1lbGluZUl0ZW1bXSA9IE9iamVjdC52YWx1ZXMocmVzdWx0cykubWFwKChyZXN1bHQpID0+IHtcbiAgICAgIGNvbnN0IG1ldGFjYXJkID0gcmVzdWx0LnBsYWluLm1ldGFjYXJkLnByb3BlcnRpZXNcbiAgICAgIGNvbnN0IHJlc3VsdERhdGVBdHRyaWJ1dGVzOiB7XG4gICAgICAgIFtrZXk6IHN0cmluZ106IE1vbWVudFtdXG4gICAgICB9ID0ge31cbiAgICAgIHBvc3NpYmxlRGF0ZUF0dHJpYnV0ZXMuZm9yRWFjaCgoZGF0ZUF0dHJpYnV0ZTogc3RyaW5nKSA9PiB7XG4gICAgICAgIGNvbnN0IHZhbCA9IG1ldGFjYXJkW2RhdGVBdHRyaWJ1dGVdXG4gICAgICAgIGlmICh2YWwpIHtcbiAgICAgICAgICByZXN1bHREYXRlQXR0cmlidXRlc1tkYXRlQXR0cmlidXRlXSA9IEFycmF5LmlzQXJyYXkodmFsKVxuICAgICAgICAgICAgPyB2YWwubWFwKCh2KSA9PiBtb21lbnQodikgYXMgTW9tZW50KVxuICAgICAgICAgICAgOiBbbW9tZW50KHZhbCkgYXMgTW9tZW50XVxuICAgICAgICB9XG4gICAgICB9KVxuICAgICAgY29uc3QgaWQgPSBtZXRhY2FyZC5pZFxuICAgICAgY29uc3QgcmVzdWx0RGF0YVBvaW50OiBUaW1lbGluZUl0ZW0gPSB7XG4gICAgICAgIGlkLFxuICAgICAgICBzZWxlY3RlZDogc2VsZWN0ZWRJZHMuaW5jbHVkZXMoaWQpLFxuICAgICAgICBkYXRhOiByZXN1bHQsXG4gICAgICAgIGF0dHJpYnV0ZXM6IHJlc3VsdERhdGVBdHRyaWJ1dGVzLFxuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc3VsdERhdGFQb2ludFxuICAgIH0pXG4gICAgc2V0RGF0YShyZXN1bHREYXRhKVxuICAgIGlmIChPYmplY3Qua2V5cyhwb3NzaWJsZURhdGVBdHRyaWJ1dGVzKS5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCBhbGlhc01hcDoge1xuICAgICAgICBba2V5OiBzdHJpbmddOiBzdHJpbmdcbiAgICAgIH0gPSB7fVxuICAgICAgcG9zc2libGVEYXRlQXR0cmlidXRlcy5mb3JFYWNoKChkYXRlQXR0cmlidXRlOiBhbnkpID0+IHtcbiAgICAgICAgYWxpYXNNYXBbZGF0ZUF0dHJpYnV0ZV0gPVxuICAgICAgICAgIGNvbmZpZz8uYXR0cmlidXRlQWxpYXNlc1tkYXRlQXR0cmlidXRlXSB8fCBkYXRlQXR0cmlidXRlXG4gICAgICB9KVxuICAgICAgaWYgKCFfLmlzRXF1YWwoYWxpYXNNYXAsIGRhdGVBdHRyaWJ1dGVBbGlhc2VzKSkge1xuICAgICAgICBzZXREYXRlQXR0cmlidXRlQWxpYXNlcyhhbGlhc01hcClcbiAgICAgIH1cbiAgICB9XG4gIH0sIFtyZXN1bHRzLCBzZWxlY3RlZFJlc3VsdHMsIGNvbmZpZ10pXG4gIGNvbnN0IG9uU2VsZWN0ID0gKHNlbGVjdGVkRGF0YTogVGltZWxpbmVJdGVtW10pID0+IHtcbiAgICBjb25zdCBzZWxlY3RlZElkcyA9IHNlbGVjdGVkRGF0YS5tYXAoKGQpID0+IGQuaWQpXG4gICAgc2V0UGF1c2UodHJ1ZSlcbiAgICBsYXp5UmVzdWx0cy5zZWxlY3RCeUlkcyhzZWxlY3RlZElkcylcbiAgICBzZXRQYXVzZShmYWxzZSlcbiAgfVxuICBpZiAocGF1c2UpIHtcbiAgICByZXR1cm4gbnVsbFxuICB9XG4gIHJldHVybiAoXG4gICAgPFRpbWVsaW5lV3JhcHBlciBkYXRhLWlkPVwidGltZWxpbmUtY29udGFpbmVyXCIgcmVmPXtyb290UmVmfT5cbiAgICAgIDxUaW1lbGluZVxuICAgICAgICBtaW49e21vbWVudCgnMTk3NS0wMS0wMScpLnR6KHVzZXIuZ2V0VGltZVpvbmUoKSl9XG4gICAgICAgIG1heD17bW9tZW50KG1heERhdGUpfVxuICAgICAgICBoZWlnaHRPZmZzZXQ9ezI1MH1cbiAgICAgICAgb25TZWxlY3Q9e29uU2VsZWN0fVxuICAgICAgICBkYXRhPXtkYXRhfVxuICAgICAgICBkYXRlQXR0cmlidXRlQWxpYXNlcz17ZGF0ZUF0dHJpYnV0ZUFsaWFzZXN9XG4gICAgICAgIHJlbmRlclRvb2x0aXA9e3JlbmRlclRvb2x0aXB9XG4gICAgICAgIGZvcm1hdD17dXNlci5nZXREYXRlVGltZUZvcm1hdCgpfVxuICAgICAgICB0aW1lem9uZT17dXNlci5nZXRUaW1lWm9uZSgpfVxuICAgICAgICBoZWlnaHQ9e2hlaWdodH1cbiAgICAgICAgb25Db3B5PXsoY29waWVkVmFsdWUpID0+IHtcbiAgICAgICAgICBhZGRTbmFjaygnQ29waWVkIHRvIGNsaXBib2FyZDogJyArIGNvcGllZFZhbHVlLCB7XG4gICAgICAgICAgICBhbGVydFByb3BzOiB7XG4gICAgICAgICAgICAgIHNldmVyaXR5OiAnc3VjY2VzcycsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0pXG4gICAgICAgIH19XG4gICAgICAvPlxuICAgIDwvVGltZWxpbmVXcmFwcGVyPlxuICApXG59XG5leHBvcnQgZGVmYXVsdCBob3QobW9kdWxlKShXaXRoTGlzdGVuVG8oVGltZWxpbmVWaXN1YWxpemF0aW9uKSlcbiJdfQ==