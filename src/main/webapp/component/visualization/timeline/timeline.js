import { __makeTemplateObject, __read } from "tslib";
import { jsx as _jsx, Fragment as _Fragment, jsxs as _jsxs } from "react/jsx-runtime";
import * as React from 'react';
import styled from 'styled-components';
import { useLazyResultsFromSelectionInterface } from '../../selection-interface/hooks';
import { useSelectedResults } from '../../../js/model/LazyQueryResult/hooks';
import Timeline from '../../timeline';
import moment from 'moment-timezone';
import useTimePrefs from '../../fields/useTimePrefs';
import IconHelper from '../../../js/IconHelper';
import useSnack from '../../hooks/useSnack';
import wreqr from '../../../js/wreqr';
import user from '../../singletons/user-instance';
import Extensions from '../../../extension-points';
import _ from 'lodash';
import { useConfiguration } from '../../../js/model/Startup/configuration.hooks';
import { StartupDataStore } from '../../../js/model/Startup/startup';
import _debounce from 'lodash.debounce';
var maxDate = moment().tz(user.getTimeZone());
var TimelineWrapper = styled.div(templateObject_1 || (templateObject_1 = __makeTemplateObject(["\n  padding: 40px 40px 60px 40px;\n  height: 100%;\n\n  .MuiButton-label {\n    font-size: 0.875rem !important;\n  }\n"], ["\n  padding: 40px 40px 60px 40px;\n  height: 100%;\n\n  .MuiButton-label {\n    font-size: 0.875rem !important;\n  }\n"])));
var getDateAttributes = function (results) {
    var availableAttributes = Object.keys(results)
        .reduce(function (currentAvailable, key) {
        var result = results[key];
        // @ts-expect-error ts-migrate(2322) FIXME: Type 'string[]' is not assignable to type 'never[]... Remove this comment to see the full error message
        currentAvailable = _.union(currentAvailable, Object.keys(result.plain.metacard.properties));
        return currentAvailable;
    }, [])
        .sort();
    var dateAttributes = availableAttributes.reduce(function (list, attribute) {
        var _a;
        if (((_a = StartupDataStore.MetacardDefinitions.getAttributeMap()[attribute]) === null || _a === void 0 ? void 0 : _a.type) == 'DATE') {
            list.push(attribute);
        }
        return list;
    }, []);
    return dateAttributes;
};
var renderTooltip = function (timelineItems) {
    var itemsToExpand = 5;
    var uniqueMetacards = timelineItems.filter(function (item, index) { return timelineItems.indexOf(item) === index; });
    var results = uniqueMetacards.slice(0, itemsToExpand).map(function (item) {
        var data = item.data;
        var icon = IconHelper.getFullByMetacardObject(data.plain);
        var metacard = data.plain.metacard.properties;
        var ItemAddOn = Extensions.timelineItemAddOn({
            results: [data],
            isSingleItem: true,
        });
        var valCount = timelineItems.filter(function (i) { return i.id === item.id; }).length;
        return (_jsxs(React.Fragment, { children: [_jsx("span", { className: icon.class }), "\u00A0", ItemAddOn && (_jsxs(_Fragment, { children: [ItemAddOn, "\u00A0"] })), _jsx("span", { children: "".concat(metacard.title || metacard.id).concat(valCount > 1 ? " (".concat(valCount, ")") : '') }), _jsx("br", {})] }, metacard.id));
    });
    var OtherItemsAddOn = null;
    if (uniqueMetacards.length > itemsToExpand) {
        OtherItemsAddOn = Extensions.timelineItemAddOn({
            results: uniqueMetacards
                .slice(itemsToExpand)
                .map(function (item) { return item.data; }),
            isSingleItem: false,
        });
    }
    var otherResults = (_jsxs(React.Fragment, { children: [_jsx("br", {}), "+".concat(uniqueMetacards.length - itemsToExpand, " other results"), OtherItemsAddOn && (_jsxs(_Fragment, { children: ["\u00A0", OtherItemsAddOn] }))] }));
    return (_jsxs(React.Fragment, { children: [results, uniqueMetacards.length > itemsToExpand && otherResults] }));
};
function useListenToResize(_a) {
    var callback = _a.callback;
    React.useEffect(function () {
        ;
        wreqr.vent.on('resize', callback);
        window.addEventListener('resize', callback);
        return function () {
            ;
            wreqr.vent.off('resize', callback);
            window.removeEventListener('resize', callback);
        };
    }, [callback]);
}
function useInitializeHeight(_a) {
    var updateHeightCallback = _a.updateHeightCallback;
    React.useEffect(function () {
        updateHeightCallback();
    }, [updateHeightCallback]);
}
var TimelineVisualization = function (props) {
    var selectionInterface = props.selectionInterface;
    var config = useConfiguration().config;
    useTimePrefs();
    var lazyResults = useLazyResultsFromSelectionInterface({
        selectionInterface: selectionInterface,
    });
    var selectedResults = useSelectedResults({
        lazyResults: lazyResults,
    });
    var results = lazyResults.results;
    var _a = __read(React.useState([]), 2), data = _a[0], setData = _a[1];
    var _b = __read(React.useState({}), 2), dateAttributeAliases = _b[0], setDateAttributeAliases = _b[1];
    var _c = __read(React.useState(0), 2), height = _c[0], setHeight = _c[1];
    var _d = __read(React.useState(false), 2), pause = _d[0], setPause = _d[1];
    var rootRef = React.useRef(null);
    var addSnack = useSnack();
    var updateHeightCallback = React.useCallback(_debounce(function () {
        if (rootRef.current) {
            var rect = rootRef.current.getBoundingClientRect();
            setHeight(rect.height);
        }
    }, 250), []);
    useInitializeHeight({
        updateHeightCallback: updateHeightCallback,
    });
    useListenToResize({
        callback: updateHeightCallback,
    });
    React.useEffect(function () {
        var selectedIds = Object.values(selectedResults).map(function (result) { return result.plain.metacard.properties.id; });
        var possibleDateAttributes = getDateAttributes(results);
        var resultData = Object.values(results).map(function (result) {
            var metacard = result.plain.metacard.properties;
            var resultDateAttributes = {};
            possibleDateAttributes.forEach(function (dateAttribute) {
                var val = metacard[dateAttribute];
                if (val) {
                    resultDateAttributes[dateAttribute] = Array.isArray(val)
                        ? val.map(function (v) { return moment(v); })
                        : [moment(val)];
                }
            });
            var id = metacard.id;
            var resultDataPoint = {
                id: id,
                selected: selectedIds.includes(id),
                data: result,
                attributes: resultDateAttributes,
            };
            return resultDataPoint;
        });
        setData(resultData);
        if (Object.keys(possibleDateAttributes).length > 0) {
            var aliasMap_1 = {};
            possibleDateAttributes.forEach(function (dateAttribute) {
                aliasMap_1[dateAttribute] =
                    (config === null || config === void 0 ? void 0 : config.attributeAliases[dateAttribute]) || dateAttribute;
            });
            if (!_.isEqual(aliasMap_1, dateAttributeAliases)) {
                setDateAttributeAliases(aliasMap_1);
            }
        }
    }, [results, selectedResults, config]);
    var onSelect = function (selectedData) {
        var selectedIds = selectedData.map(function (d) { return d.id; });
        setPause(true);
        lazyResults.selectByIds(selectedIds);
        setPause(false);
    };
    if (pause) {
        return null;
    }
    return (_jsx(TimelineWrapper, { "data-id": "timeline-container", ref: rootRef, children: _jsx(Timeline, { min: moment('1975-01-01').tz(user.getTimeZone()), max: moment(maxDate), heightOffset: 250, onSelect: onSelect, data: data, dateAttributeAliases: dateAttributeAliases, renderTooltip: renderTooltip, format: user.getDateTimeFormat(), timezone: user.getTimeZone(), height: height, onCopy: function (copiedValue) {
                addSnack('Copied to clipboard: ' + copiedValue, {
                    alertProps: {
                        severity: 'success',
                    },
                });
            } }) }));
};
export default TimelineVisualization;
var templateObject_1;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGltZWxpbmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9zcmMvbWFpbi93ZWJhcHAvY29tcG9uZW50L3Zpc3VhbGl6YXRpb24vdGltZWxpbmUvdGltZWxpbmUudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsT0FBTyxLQUFLLEtBQUssTUFBTSxPQUFPLENBQUE7QUFFOUIsT0FBTyxNQUFNLE1BQU0sbUJBQW1CLENBQUE7QUFFdEMsT0FBTyxFQUFFLG9DQUFvQyxFQUFFLE1BQU0saUNBQWlDLENBQUE7QUFDdEYsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0seUNBQXlDLENBQUE7QUFDNUUsT0FBTyxRQUFRLE1BQU0sZ0JBQWdCLENBQUE7QUFFckMsT0FBTyxNQUFrQixNQUFNLGlCQUFpQixDQUFBO0FBQ2hELE9BQU8sWUFBWSxNQUFNLDJCQUEyQixDQUFBO0FBQ3BELE9BQU8sVUFBVSxNQUFNLHdCQUF3QixDQUFBO0FBQy9DLE9BQU8sUUFBUSxNQUFNLHNCQUFzQixDQUFBO0FBQzNDLE9BQU8sS0FBSyxNQUFNLG1CQUFtQixDQUFBO0FBQ3JDLE9BQU8sSUFBSSxNQUFNLGdDQUFnQyxDQUFBO0FBQ2pELE9BQU8sVUFBVSxNQUFNLDJCQUEyQixDQUFBO0FBQ2xELE9BQU8sQ0FBQyxNQUFNLFFBQVEsQ0FBQTtBQUN0QixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSwrQ0FBK0MsQ0FBQTtBQUNoRixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQTtBQUNwRSxPQUFPLFNBQVMsTUFBTSxpQkFBaUIsQ0FBQTtBQUV2QyxJQUFNLE9BQU8sR0FBRyxNQUFNLEVBQUUsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUE7QUFJL0MsSUFBTSxlQUFlLEdBQUcsTUFBTSxDQUFDLEdBQUcsMkxBQUEsd0hBT2pDLElBQUEsQ0FBQTtBQUNELElBQU0saUJBQWlCLEdBQUcsVUFBQyxPQUFZO0lBQ3JDLElBQU0sbUJBQW1CLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUM7U0FDN0MsTUFBTSxDQUFDLFVBQUMsZ0JBQWdCLEVBQUUsR0FBRztRQUM1QixJQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUE7UUFDM0IsbUpBQW1KO1FBQ25KLGdCQUFnQixHQUFHLENBQUMsQ0FBQyxLQUFLLENBQ3hCLGdCQUFnQixFQUNoQixNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxDQUM5QyxDQUFBO1FBQ0QsT0FBTyxnQkFBZ0IsQ0FBQTtJQUN6QixDQUFDLEVBQUUsRUFBRSxDQUFDO1NBQ0wsSUFBSSxFQUFFLENBQUE7SUFDVCxJQUFJLGNBQWMsR0FBRyxtQkFBbUIsQ0FBQyxNQUFNLENBQzdDLFVBQUMsSUFBUyxFQUFFLFNBQWM7O1FBQ3hCLElBQ0UsQ0FBQSxNQUFBLGdCQUFnQixDQUFDLG1CQUFtQixDQUFDLGVBQWUsRUFBRSxDQUFDLFNBQVMsQ0FBQywwQ0FDN0QsSUFBSSxLQUFJLE1BQU0sRUFDbEIsQ0FBQztZQUNELElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUE7UUFDdEIsQ0FBQztRQUNELE9BQU8sSUFBSSxDQUFBO0lBQ2IsQ0FBQyxFQUNELEVBQUUsQ0FDSCxDQUFBO0lBQ0QsT0FBTyxjQUFjLENBQUE7QUFDdkIsQ0FBQyxDQUFBO0FBQ0QsSUFBTSxhQUFhLEdBQUcsVUFBQyxhQUE2QjtJQUNsRCxJQUFNLGFBQWEsR0FBRyxDQUFDLENBQUE7SUFDdkIsSUFBTSxlQUFlLEdBQUcsYUFBYSxDQUFDLE1BQU0sQ0FDMUMsVUFBQyxJQUFJLEVBQUUsS0FBSyxJQUFLLE9BQUEsYUFBYSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxLQUFLLEVBQXJDLENBQXFDLENBQ3ZELENBQUE7SUFDRCxJQUFNLE9BQU8sR0FBRyxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxhQUFhLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBQyxJQUFJO1FBQy9ELElBQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxJQUF1QixDQUFBO1FBQ3pDLElBQU0sSUFBSSxHQUFHLFVBQVUsQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUE7UUFDM0QsSUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFBO1FBQy9DLElBQU0sU0FBUyxHQUFHLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQztZQUM3QyxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUM7WUFDZixZQUFZLEVBQUUsSUFBSTtTQUNuQixDQUFDLENBQUE7UUFDRixJQUFNLFFBQVEsR0FBRyxhQUFhLENBQUMsTUFBTSxDQUFDLFVBQUMsQ0FBQyxJQUFLLE9BQUEsQ0FBQyxDQUFDLEVBQUUsS0FBSyxJQUFJLENBQUMsRUFBRSxFQUFoQixDQUFnQixDQUFDLENBQUMsTUFBTSxDQUFBO1FBQ3JFLE9BQU8sQ0FDTCxNQUFDLEtBQUssQ0FBQyxRQUFRLGVBQ2IsZUFBTSxTQUFTLEVBQUUsSUFBSSxDQUFDLEtBQUssR0FBSSxZQUU5QixTQUFTLElBQUksQ0FDWiw4QkFDRyxTQUFTLGNBRVQsQ0FDSixFQUNELHlCQUFPLFVBQUcsUUFBUSxDQUFDLEtBQUssSUFBSSxRQUFRLENBQUMsRUFBRSxTQUNyQyxRQUFRLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxZQUFLLFFBQVEsTUFBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQ3BDLEdBQVEsRUFDVixjQUFNLEtBWmEsUUFBUSxDQUFDLEVBQUUsQ0FhZixDQUNsQixDQUFBO0lBQ0gsQ0FBQyxDQUFDLENBQUE7SUFFRixJQUFJLGVBQWUsR0FBRyxJQUFJLENBQUE7SUFDMUIsSUFBSSxlQUFlLENBQUMsTUFBTSxHQUFHLGFBQWEsRUFBRSxDQUFDO1FBQzNDLGVBQWUsR0FBRyxVQUFVLENBQUMsaUJBQWlCLENBQUM7WUFDN0MsT0FBTyxFQUFFLGVBQWU7aUJBQ3JCLEtBQUssQ0FBQyxhQUFhLENBQUM7aUJBQ3BCLEdBQUcsQ0FBQyxVQUFDLElBQUksSUFBSyxPQUFBLElBQUksQ0FBQyxJQUF1QixFQUE1QixDQUE0QixDQUFDO1lBQzlDLFlBQVksRUFBRSxLQUFLO1NBQ3BCLENBQUMsQ0FBQTtJQUNKLENBQUM7SUFFRCxJQUFNLFlBQVksR0FBRyxDQUNuQixNQUFDLEtBQUssQ0FBQyxRQUFRLGVBQ2IsY0FBTSxFQUNMLFdBQUksZUFBZSxDQUFDLE1BQU0sR0FBRyxhQUFhLG1CQUFnQixFQUMxRCxlQUFlLElBQUksQ0FDbEIsd0NBRUcsZUFBZSxJQUNmLENBQ0osSUFDYyxDQUNsQixDQUFBO0lBQ0QsT0FBTyxDQUNMLE1BQUMsS0FBSyxDQUFDLFFBQVEsZUFDWixPQUFPLEVBQ1AsZUFBZSxDQUFDLE1BQU0sR0FBRyxhQUFhLElBQUksWUFBWSxJQUN4QyxDQUNsQixDQUFBO0FBQ0gsQ0FBQyxDQUFBO0FBRUQsU0FBUyxpQkFBaUIsQ0FBQyxFQUFzQztRQUFwQyxRQUFRLGNBQUE7SUFDbkMsS0FBSyxDQUFDLFNBQVMsQ0FBQztRQUNkLENBQUM7UUFBQyxLQUFhLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsUUFBUSxDQUFDLENBQUE7UUFDM0MsTUFBTSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQTtRQUMzQyxPQUFPO1lBQ0wsQ0FBQztZQUFDLEtBQWEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQTtZQUM1QyxNQUFNLENBQUMsbUJBQW1CLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFBO1FBQ2hELENBQUMsQ0FBQTtJQUNILENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUE7QUFDaEIsQ0FBQztBQUVELFNBQVMsbUJBQW1CLENBQUMsRUFJNUI7UUFIQyxvQkFBb0IsMEJBQUE7SUFJcEIsS0FBSyxDQUFDLFNBQVMsQ0FBQztRQUNkLG9CQUFvQixFQUFFLENBQUE7SUFDeEIsQ0FBQyxFQUFFLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxDQUFBO0FBQzVCLENBQUM7QUFFRCxJQUFNLHFCQUFxQixHQUFHLFVBQUMsS0FBWTtJQUNqQyxJQUFBLGtCQUFrQixHQUFLLEtBQUssbUJBQVYsQ0FBVTtJQUM1QixJQUFBLE1BQU0sR0FBSyxnQkFBZ0IsRUFBRSxPQUF2QixDQUF1QjtJQUNyQyxZQUFZLEVBQUUsQ0FBQTtJQUNkLElBQU0sV0FBVyxHQUFHLG9DQUFvQyxDQUFDO1FBQ3ZELGtCQUFrQixvQkFBQTtLQUNuQixDQUFDLENBQUE7SUFDRixJQUFNLGVBQWUsR0FBRyxrQkFBa0IsQ0FBQztRQUN6QyxXQUFXLGFBQUE7S0FDWixDQUFDLENBQUE7SUFDTSxJQUFBLE9BQU8sR0FBSyxXQUFXLFFBQWhCLENBQWdCO0lBQ3pCLElBQUEsS0FBQSxPQUFrQixLQUFLLENBQUMsUUFBUSxDQUFpQixFQUFFLENBQUMsSUFBQSxFQUFuRCxJQUFJLFFBQUEsRUFBRSxPQUFPLFFBQXNDLENBQUE7SUFDcEQsSUFBQSxLQUFBLE9BQWtELEtBQUssQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLElBQUEsRUFBbkUsb0JBQW9CLFFBQUEsRUFBRSx1QkFBdUIsUUFBc0IsQ0FBQTtJQUNwRSxJQUFBLEtBQUEsT0FBc0IsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBQSxFQUF0QyxNQUFNLFFBQUEsRUFBRSxTQUFTLFFBQXFCLENBQUE7SUFDdkMsSUFBQSxLQUFBLE9BQW9CLEtBQUssQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUEsRUFBeEMsS0FBSyxRQUFBLEVBQUUsUUFBUSxRQUF5QixDQUFBO0lBQy9DLElBQU0sT0FBTyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQWlCLElBQUksQ0FBQyxDQUFBO0lBQ2xELElBQU0sUUFBUSxHQUFHLFFBQVEsRUFBRSxDQUFBO0lBQzNCLElBQU0sb0JBQW9CLEdBQUcsS0FBSyxDQUFDLFdBQVcsQ0FDNUMsU0FBUyxDQUFDO1FBQ1IsSUFBSSxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDcEIsSUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxxQkFBcUIsRUFBRSxDQUFBO1lBQ3BELFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUE7UUFDeEIsQ0FBQztJQUNILENBQUMsRUFBRSxHQUFHLENBQUMsRUFDUCxFQUFFLENBQ0gsQ0FBQTtJQUNELG1CQUFtQixDQUFDO1FBQ2xCLG9CQUFvQixFQUFFLG9CQUFvQjtLQUMzQyxDQUFDLENBQUE7SUFDRixpQkFBaUIsQ0FBQztRQUNoQixRQUFRLEVBQUUsb0JBQW9CO0tBQy9CLENBQUMsQ0FBQTtJQUNGLEtBQUssQ0FBQyxTQUFTLENBQUM7UUFDZCxJQUFNLFdBQVcsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDLEdBQUcsQ0FDcEQsVUFBQyxNQUFNLElBQUssT0FBQSxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsRUFBRSxFQUFuQyxDQUFtQyxDQUNoRCxDQUFBO1FBQ0QsSUFBTSxzQkFBc0IsR0FBRyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsQ0FBQTtRQUN6RCxJQUFNLFVBQVUsR0FBbUIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBQyxNQUFNO1lBQ25FLElBQU0sUUFBUSxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQTtZQUNqRCxJQUFNLG9CQUFvQixHQUV0QixFQUFFLENBQUE7WUFDTixzQkFBc0IsQ0FBQyxPQUFPLENBQUMsVUFBQyxhQUFxQjtnQkFDbkQsSUFBTSxHQUFHLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxDQUFBO2dCQUNuQyxJQUFJLEdBQUcsRUFBRSxDQUFDO29CQUNSLG9CQUFvQixDQUFDLGFBQWEsQ0FBQyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDO3dCQUN0RCxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxVQUFDLENBQUMsSUFBSyxPQUFBLE1BQU0sQ0FBQyxDQUFDLENBQVcsRUFBbkIsQ0FBbUIsQ0FBQzt3QkFDckMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBVyxDQUFDLENBQUE7Z0JBQzdCLENBQUM7WUFDSCxDQUFDLENBQUMsQ0FBQTtZQUNGLElBQU0sRUFBRSxHQUFHLFFBQVEsQ0FBQyxFQUFFLENBQUE7WUFDdEIsSUFBTSxlQUFlLEdBQWlCO2dCQUNwQyxFQUFFLElBQUE7Z0JBQ0YsUUFBUSxFQUFFLFdBQVcsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDO2dCQUNsQyxJQUFJLEVBQUUsTUFBTTtnQkFDWixVQUFVLEVBQUUsb0JBQW9CO2FBQ2pDLENBQUE7WUFDRCxPQUFPLGVBQWUsQ0FBQTtRQUN4QixDQUFDLENBQUMsQ0FBQTtRQUNGLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQTtRQUNuQixJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDbkQsSUFBTSxVQUFRLEdBRVYsRUFBRSxDQUFBO1lBQ04sc0JBQXNCLENBQUMsT0FBTyxDQUFDLFVBQUMsYUFBa0I7Z0JBQ2hELFVBQVEsQ0FBQyxhQUFhLENBQUM7b0JBQ3JCLENBQUEsTUFBTSxhQUFOLE1BQU0sdUJBQU4sTUFBTSxDQUFFLGdCQUFnQixDQUFDLGFBQWEsQ0FBQyxLQUFJLGFBQWEsQ0FBQTtZQUM1RCxDQUFDLENBQUMsQ0FBQTtZQUNGLElBQUksQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVEsRUFBRSxvQkFBb0IsQ0FBQyxFQUFFLENBQUM7Z0JBQy9DLHVCQUF1QixDQUFDLFVBQVEsQ0FBQyxDQUFBO1lBQ25DLENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFBO0lBQ3RDLElBQU0sUUFBUSxHQUFHLFVBQUMsWUFBNEI7UUFDNUMsSUFBTSxXQUFXLEdBQUcsWUFBWSxDQUFDLEdBQUcsQ0FBQyxVQUFDLENBQUMsSUFBSyxPQUFBLENBQUMsQ0FBQyxFQUFFLEVBQUosQ0FBSSxDQUFDLENBQUE7UUFDakQsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ2QsV0FBVyxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQTtRQUNwQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUE7SUFDakIsQ0FBQyxDQUFBO0lBQ0QsSUFBSSxLQUFLLEVBQUUsQ0FBQztRQUNWLE9BQU8sSUFBSSxDQUFBO0lBQ2IsQ0FBQztJQUNELE9BQU8sQ0FDTCxLQUFDLGVBQWUsZUFBUyxvQkFBb0IsRUFBQyxHQUFHLEVBQUUsT0FBTyxZQUN4RCxLQUFDLFFBQVEsSUFDUCxHQUFHLEVBQUUsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsRUFDaEQsR0FBRyxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFDcEIsWUFBWSxFQUFFLEdBQUcsRUFDakIsUUFBUSxFQUFFLFFBQVEsRUFDbEIsSUFBSSxFQUFFLElBQUksRUFDVixvQkFBb0IsRUFBRSxvQkFBb0IsRUFDMUMsYUFBYSxFQUFFLGFBQWEsRUFDNUIsTUFBTSxFQUFFLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxFQUNoQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFdBQVcsRUFBRSxFQUM1QixNQUFNLEVBQUUsTUFBTSxFQUNkLE1BQU0sRUFBRSxVQUFDLFdBQVc7Z0JBQ2xCLFFBQVEsQ0FBQyx1QkFBdUIsR0FBRyxXQUFXLEVBQUU7b0JBQzlDLFVBQVUsRUFBRTt3QkFDVixRQUFRLEVBQUUsU0FBUztxQkFDcEI7aUJBQ0YsQ0FBQyxDQUFBO1lBQ0osQ0FBQyxHQUNELEdBQ2MsQ0FDbkIsQ0FBQTtBQUNILENBQUMsQ0FBQTtBQUNELGVBQWUscUJBQXFCLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCdcblxuaW1wb3J0IHN0eWxlZCBmcm9tICdzdHlsZWQtY29tcG9uZW50cydcbmltcG9ydCB7IExhenlRdWVyeVJlc3VsdCB9IGZyb20gJy4uLy4uLy4uL2pzL21vZGVsL0xhenlRdWVyeVJlc3VsdC9MYXp5UXVlcnlSZXN1bHQnXG5pbXBvcnQgeyB1c2VMYXp5UmVzdWx0c0Zyb21TZWxlY3Rpb25JbnRlcmZhY2UgfSBmcm9tICcuLi8uLi9zZWxlY3Rpb24taW50ZXJmYWNlL2hvb2tzJ1xuaW1wb3J0IHsgdXNlU2VsZWN0ZWRSZXN1bHRzIH0gZnJvbSAnLi4vLi4vLi4vanMvbW9kZWwvTGF6eVF1ZXJ5UmVzdWx0L2hvb2tzJ1xuaW1wb3J0IFRpbWVsaW5lIGZyb20gJy4uLy4uL3RpbWVsaW5lJ1xuaW1wb3J0IHsgVGltZWxpbmVJdGVtIH0gZnJvbSAnLi4vLi4vdGltZWxpbmUvdGltZWxpbmUnXG5pbXBvcnQgbW9tZW50LCB7IE1vbWVudCB9IGZyb20gJ21vbWVudC10aW1lem9uZSdcbmltcG9ydCB1c2VUaW1lUHJlZnMgZnJvbSAnLi4vLi4vZmllbGRzL3VzZVRpbWVQcmVmcydcbmltcG9ydCBJY29uSGVscGVyIGZyb20gJy4uLy4uLy4uL2pzL0ljb25IZWxwZXInXG5pbXBvcnQgdXNlU25hY2sgZnJvbSAnLi4vLi4vaG9va3MvdXNlU25hY2snXG5pbXBvcnQgd3JlcXIgZnJvbSAnLi4vLi4vLi4vanMvd3JlcXInXG5pbXBvcnQgdXNlciBmcm9tICcuLi8uLi9zaW5nbGV0b25zL3VzZXItaW5zdGFuY2UnXG5pbXBvcnQgRXh0ZW5zaW9ucyBmcm9tICcuLi8uLi8uLi9leHRlbnNpb24tcG9pbnRzJ1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJ1xuaW1wb3J0IHsgdXNlQ29uZmlndXJhdGlvbiB9IGZyb20gJy4uLy4uLy4uL2pzL21vZGVsL1N0YXJ0dXAvY29uZmlndXJhdGlvbi5ob29rcydcbmltcG9ydCB7IFN0YXJ0dXBEYXRhU3RvcmUgfSBmcm9tICcuLi8uLi8uLi9qcy9tb2RlbC9TdGFydHVwL3N0YXJ0dXAnXG5pbXBvcnQgX2RlYm91bmNlIGZyb20gJ2xvZGFzaC5kZWJvdW5jZSdcblxuY29uc3QgbWF4RGF0ZSA9IG1vbWVudCgpLnR6KHVzZXIuZ2V0VGltZVpvbmUoKSlcbnR5cGUgUHJvcHMgPSB7XG4gIHNlbGVjdGlvbkludGVyZmFjZTogYW55XG59XG5jb25zdCBUaW1lbGluZVdyYXBwZXIgPSBzdHlsZWQuZGl2YFxuICBwYWRkaW5nOiA0MHB4IDQwcHggNjBweCA0MHB4O1xuICBoZWlnaHQ6IDEwMCU7XG5cbiAgLk11aUJ1dHRvbi1sYWJlbCB7XG4gICAgZm9udC1zaXplOiAwLjg3NXJlbSAhaW1wb3J0YW50O1xuICB9XG5gXG5jb25zdCBnZXREYXRlQXR0cmlidXRlcyA9IChyZXN1bHRzOiBhbnkpID0+IHtcbiAgY29uc3QgYXZhaWxhYmxlQXR0cmlidXRlcyA9IE9iamVjdC5rZXlzKHJlc3VsdHMpXG4gICAgLnJlZHVjZSgoY3VycmVudEF2YWlsYWJsZSwga2V5KSA9PiB7XG4gICAgICBjb25zdCByZXN1bHQgPSByZXN1bHRzW2tleV1cbiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgdHMtbWlncmF0ZSgyMzIyKSBGSVhNRTogVHlwZSAnc3RyaW5nW10nIGlzIG5vdCBhc3NpZ25hYmxlIHRvIHR5cGUgJ25ldmVyW10uLi4gUmVtb3ZlIHRoaXMgY29tbWVudCB0byBzZWUgdGhlIGZ1bGwgZXJyb3IgbWVzc2FnZVxuICAgICAgY3VycmVudEF2YWlsYWJsZSA9IF8udW5pb24oXG4gICAgICAgIGN1cnJlbnRBdmFpbGFibGUsXG4gICAgICAgIE9iamVjdC5rZXlzKHJlc3VsdC5wbGFpbi5tZXRhY2FyZC5wcm9wZXJ0aWVzKVxuICAgICAgKVxuICAgICAgcmV0dXJuIGN1cnJlbnRBdmFpbGFibGVcbiAgICB9LCBbXSlcbiAgICAuc29ydCgpXG4gIGxldCBkYXRlQXR0cmlidXRlcyA9IGF2YWlsYWJsZUF0dHJpYnV0ZXMucmVkdWNlKFxuICAgIChsaXN0OiBhbnksIGF0dHJpYnV0ZTogYW55KSA9PiB7XG4gICAgICBpZiAoXG4gICAgICAgIFN0YXJ0dXBEYXRhU3RvcmUuTWV0YWNhcmREZWZpbml0aW9ucy5nZXRBdHRyaWJ1dGVNYXAoKVthdHRyaWJ1dGVdXG4gICAgICAgICAgPy50eXBlID09ICdEQVRFJ1xuICAgICAgKSB7XG4gICAgICAgIGxpc3QucHVzaChhdHRyaWJ1dGUpXG4gICAgICB9XG4gICAgICByZXR1cm4gbGlzdFxuICAgIH0sXG4gICAgW11cbiAgKVxuICByZXR1cm4gZGF0ZUF0dHJpYnV0ZXNcbn1cbmNvbnN0IHJlbmRlclRvb2x0aXAgPSAodGltZWxpbmVJdGVtczogVGltZWxpbmVJdGVtW10pID0+IHtcbiAgY29uc3QgaXRlbXNUb0V4cGFuZCA9IDVcbiAgY29uc3QgdW5pcXVlTWV0YWNhcmRzID0gdGltZWxpbmVJdGVtcy5maWx0ZXIoXG4gICAgKGl0ZW0sIGluZGV4KSA9PiB0aW1lbGluZUl0ZW1zLmluZGV4T2YoaXRlbSkgPT09IGluZGV4XG4gIClcbiAgY29uc3QgcmVzdWx0cyA9IHVuaXF1ZU1ldGFjYXJkcy5zbGljZSgwLCBpdGVtc1RvRXhwYW5kKS5tYXAoKGl0ZW0pID0+IHtcbiAgICBjb25zdCBkYXRhID0gaXRlbS5kYXRhIGFzIExhenlRdWVyeVJlc3VsdFxuICAgIGNvbnN0IGljb24gPSBJY29uSGVscGVyLmdldEZ1bGxCeU1ldGFjYXJkT2JqZWN0KGRhdGEucGxhaW4pXG4gICAgY29uc3QgbWV0YWNhcmQgPSBkYXRhLnBsYWluLm1ldGFjYXJkLnByb3BlcnRpZXNcbiAgICBjb25zdCBJdGVtQWRkT24gPSBFeHRlbnNpb25zLnRpbWVsaW5lSXRlbUFkZE9uKHtcbiAgICAgIHJlc3VsdHM6IFtkYXRhXSxcbiAgICAgIGlzU2luZ2xlSXRlbTogdHJ1ZSxcbiAgICB9KVxuICAgIGNvbnN0IHZhbENvdW50ID0gdGltZWxpbmVJdGVtcy5maWx0ZXIoKGkpID0+IGkuaWQgPT09IGl0ZW0uaWQpLmxlbmd0aFxuICAgIHJldHVybiAoXG4gICAgICA8UmVhY3QuRnJhZ21lbnQga2V5PXttZXRhY2FyZC5pZH0+XG4gICAgICAgIDxzcGFuIGNsYXNzTmFtZT17aWNvbi5jbGFzc30gLz5cbiAgICAgICAgJm5ic3A7XG4gICAgICAgIHtJdGVtQWRkT24gJiYgKFxuICAgICAgICAgIDw+XG4gICAgICAgICAgICB7SXRlbUFkZE9ufVxuICAgICAgICAgICAgJm5ic3A7XG4gICAgICAgICAgPC8+XG4gICAgICAgICl9XG4gICAgICAgIDxzcGFuPntgJHttZXRhY2FyZC50aXRsZSB8fCBtZXRhY2FyZC5pZH0ke1xuICAgICAgICAgIHZhbENvdW50ID4gMSA/IGAgKCR7dmFsQ291bnR9KWAgOiAnJ1xuICAgICAgICB9YH08L3NwYW4+XG4gICAgICAgIDxiciAvPlxuICAgICAgPC9SZWFjdC5GcmFnbWVudD5cbiAgICApXG4gIH0pXG5cbiAgbGV0IE90aGVySXRlbXNBZGRPbiA9IG51bGxcbiAgaWYgKHVuaXF1ZU1ldGFjYXJkcy5sZW5ndGggPiBpdGVtc1RvRXhwYW5kKSB7XG4gICAgT3RoZXJJdGVtc0FkZE9uID0gRXh0ZW5zaW9ucy50aW1lbGluZUl0ZW1BZGRPbih7XG4gICAgICByZXN1bHRzOiB1bmlxdWVNZXRhY2FyZHNcbiAgICAgICAgLnNsaWNlKGl0ZW1zVG9FeHBhbmQpXG4gICAgICAgIC5tYXAoKGl0ZW0pID0+IGl0ZW0uZGF0YSBhcyBMYXp5UXVlcnlSZXN1bHQpLFxuICAgICAgaXNTaW5nbGVJdGVtOiBmYWxzZSxcbiAgICB9KVxuICB9XG5cbiAgY29uc3Qgb3RoZXJSZXN1bHRzID0gKFxuICAgIDxSZWFjdC5GcmFnbWVudD5cbiAgICAgIDxiciAvPlxuICAgICAge2ArJHt1bmlxdWVNZXRhY2FyZHMubGVuZ3RoIC0gaXRlbXNUb0V4cGFuZH0gb3RoZXIgcmVzdWx0c2B9XG4gICAgICB7T3RoZXJJdGVtc0FkZE9uICYmIChcbiAgICAgICAgPD5cbiAgICAgICAgICAmbmJzcDtcbiAgICAgICAgICB7T3RoZXJJdGVtc0FkZE9ufVxuICAgICAgICA8Lz5cbiAgICAgICl9XG4gICAgPC9SZWFjdC5GcmFnbWVudD5cbiAgKVxuICByZXR1cm4gKFxuICAgIDxSZWFjdC5GcmFnbWVudD5cbiAgICAgIHtyZXN1bHRzfVxuICAgICAge3VuaXF1ZU1ldGFjYXJkcy5sZW5ndGggPiBpdGVtc1RvRXhwYW5kICYmIG90aGVyUmVzdWx0c31cbiAgICA8L1JlYWN0LkZyYWdtZW50PlxuICApXG59XG5cbmZ1bmN0aW9uIHVzZUxpc3RlblRvUmVzaXplKHsgY2FsbGJhY2sgfTogeyBjYWxsYmFjazogKCkgPT4gdm9pZCB9KSB7XG4gIFJlYWN0LnVzZUVmZmVjdCgoKSA9PiB7XG4gICAgOyh3cmVxciBhcyBhbnkpLnZlbnQub24oJ3Jlc2l6ZScsIGNhbGxiYWNrKVxuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCBjYWxsYmFjaylcbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgOyh3cmVxciBhcyBhbnkpLnZlbnQub2ZmKCdyZXNpemUnLCBjYWxsYmFjaylcbiAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdyZXNpemUnLCBjYWxsYmFjaylcbiAgICB9XG4gIH0sIFtjYWxsYmFja10pXG59XG5cbmZ1bmN0aW9uIHVzZUluaXRpYWxpemVIZWlnaHQoe1xuICB1cGRhdGVIZWlnaHRDYWxsYmFjayxcbn06IHtcbiAgdXBkYXRlSGVpZ2h0Q2FsbGJhY2s6ICgpID0+IHZvaWRcbn0pIHtcbiAgUmVhY3QudXNlRWZmZWN0KCgpID0+IHtcbiAgICB1cGRhdGVIZWlnaHRDYWxsYmFjaygpXG4gIH0sIFt1cGRhdGVIZWlnaHRDYWxsYmFja10pXG59XG5cbmNvbnN0IFRpbWVsaW5lVmlzdWFsaXphdGlvbiA9IChwcm9wczogUHJvcHMpID0+IHtcbiAgY29uc3QgeyBzZWxlY3Rpb25JbnRlcmZhY2UgfSA9IHByb3BzXG4gIGNvbnN0IHsgY29uZmlnIH0gPSB1c2VDb25maWd1cmF0aW9uKClcbiAgdXNlVGltZVByZWZzKClcbiAgY29uc3QgbGF6eVJlc3VsdHMgPSB1c2VMYXp5UmVzdWx0c0Zyb21TZWxlY3Rpb25JbnRlcmZhY2Uoe1xuICAgIHNlbGVjdGlvbkludGVyZmFjZSxcbiAgfSlcbiAgY29uc3Qgc2VsZWN0ZWRSZXN1bHRzID0gdXNlU2VsZWN0ZWRSZXN1bHRzKHtcbiAgICBsYXp5UmVzdWx0cyxcbiAgfSlcbiAgY29uc3QgeyByZXN1bHRzIH0gPSBsYXp5UmVzdWx0c1xuICBjb25zdCBbZGF0YSwgc2V0RGF0YV0gPSBSZWFjdC51c2VTdGF0ZTxUaW1lbGluZUl0ZW1bXT4oW10pXG4gIGNvbnN0IFtkYXRlQXR0cmlidXRlQWxpYXNlcywgc2V0RGF0ZUF0dHJpYnV0ZUFsaWFzZXNdID0gUmVhY3QudXNlU3RhdGUoe30pXG4gIGNvbnN0IFtoZWlnaHQsIHNldEhlaWdodF0gPSBSZWFjdC51c2VTdGF0ZSgwKVxuICBjb25zdCBbcGF1c2UsIHNldFBhdXNlXSA9IFJlYWN0LnVzZVN0YXRlKGZhbHNlKVxuICBjb25zdCByb290UmVmID0gUmVhY3QudXNlUmVmPEhUTUxEaXZFbGVtZW50PihudWxsKVxuICBjb25zdCBhZGRTbmFjayA9IHVzZVNuYWNrKClcbiAgY29uc3QgdXBkYXRlSGVpZ2h0Q2FsbGJhY2sgPSBSZWFjdC51c2VDYWxsYmFjayhcbiAgICBfZGVib3VuY2UoKCkgPT4ge1xuICAgICAgaWYgKHJvb3RSZWYuY3VycmVudCkge1xuICAgICAgICBjb25zdCByZWN0ID0gcm9vdFJlZi5jdXJyZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpXG4gICAgICAgIHNldEhlaWdodChyZWN0LmhlaWdodClcbiAgICAgIH1cbiAgICB9LCAyNTApLFxuICAgIFtdXG4gIClcbiAgdXNlSW5pdGlhbGl6ZUhlaWdodCh7XG4gICAgdXBkYXRlSGVpZ2h0Q2FsbGJhY2s6IHVwZGF0ZUhlaWdodENhbGxiYWNrLFxuICB9KVxuICB1c2VMaXN0ZW5Ub1Jlc2l6ZSh7XG4gICAgY2FsbGJhY2s6IHVwZGF0ZUhlaWdodENhbGxiYWNrLFxuICB9KVxuICBSZWFjdC51c2VFZmZlY3QoKCkgPT4ge1xuICAgIGNvbnN0IHNlbGVjdGVkSWRzID0gT2JqZWN0LnZhbHVlcyhzZWxlY3RlZFJlc3VsdHMpLm1hcChcbiAgICAgIChyZXN1bHQpID0+IHJlc3VsdC5wbGFpbi5tZXRhY2FyZC5wcm9wZXJ0aWVzLmlkXG4gICAgKVxuICAgIGNvbnN0IHBvc3NpYmxlRGF0ZUF0dHJpYnV0ZXMgPSBnZXREYXRlQXR0cmlidXRlcyhyZXN1bHRzKVxuICAgIGNvbnN0IHJlc3VsdERhdGE6IFRpbWVsaW5lSXRlbVtdID0gT2JqZWN0LnZhbHVlcyhyZXN1bHRzKS5tYXAoKHJlc3VsdCkgPT4ge1xuICAgICAgY29uc3QgbWV0YWNhcmQgPSByZXN1bHQucGxhaW4ubWV0YWNhcmQucHJvcGVydGllc1xuICAgICAgY29uc3QgcmVzdWx0RGF0ZUF0dHJpYnV0ZXM6IHtcbiAgICAgICAgW2tleTogc3RyaW5nXTogTW9tZW50W11cbiAgICAgIH0gPSB7fVxuICAgICAgcG9zc2libGVEYXRlQXR0cmlidXRlcy5mb3JFYWNoKChkYXRlQXR0cmlidXRlOiBzdHJpbmcpID0+IHtcbiAgICAgICAgY29uc3QgdmFsID0gbWV0YWNhcmRbZGF0ZUF0dHJpYnV0ZV1cbiAgICAgICAgaWYgKHZhbCkge1xuICAgICAgICAgIHJlc3VsdERhdGVBdHRyaWJ1dGVzW2RhdGVBdHRyaWJ1dGVdID0gQXJyYXkuaXNBcnJheSh2YWwpXG4gICAgICAgICAgICA/IHZhbC5tYXAoKHYpID0+IG1vbWVudCh2KSBhcyBNb21lbnQpXG4gICAgICAgICAgICA6IFttb21lbnQodmFsKSBhcyBNb21lbnRdXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgICBjb25zdCBpZCA9IG1ldGFjYXJkLmlkXG4gICAgICBjb25zdCByZXN1bHREYXRhUG9pbnQ6IFRpbWVsaW5lSXRlbSA9IHtcbiAgICAgICAgaWQsXG4gICAgICAgIHNlbGVjdGVkOiBzZWxlY3RlZElkcy5pbmNsdWRlcyhpZCksXG4gICAgICAgIGRhdGE6IHJlc3VsdCxcbiAgICAgICAgYXR0cmlidXRlczogcmVzdWx0RGF0ZUF0dHJpYnV0ZXMsXG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzdWx0RGF0YVBvaW50XG4gICAgfSlcbiAgICBzZXREYXRhKHJlc3VsdERhdGEpXG4gICAgaWYgKE9iamVjdC5rZXlzKHBvc3NpYmxlRGF0ZUF0dHJpYnV0ZXMpLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IGFsaWFzTWFwOiB7XG4gICAgICAgIFtrZXk6IHN0cmluZ106IHN0cmluZ1xuICAgICAgfSA9IHt9XG4gICAgICBwb3NzaWJsZURhdGVBdHRyaWJ1dGVzLmZvckVhY2goKGRhdGVBdHRyaWJ1dGU6IGFueSkgPT4ge1xuICAgICAgICBhbGlhc01hcFtkYXRlQXR0cmlidXRlXSA9XG4gICAgICAgICAgY29uZmlnPy5hdHRyaWJ1dGVBbGlhc2VzW2RhdGVBdHRyaWJ1dGVdIHx8IGRhdGVBdHRyaWJ1dGVcbiAgICAgIH0pXG4gICAgICBpZiAoIV8uaXNFcXVhbChhbGlhc01hcCwgZGF0ZUF0dHJpYnV0ZUFsaWFzZXMpKSB7XG4gICAgICAgIHNldERhdGVBdHRyaWJ1dGVBbGlhc2VzKGFsaWFzTWFwKVxuICAgICAgfVxuICAgIH1cbiAgfSwgW3Jlc3VsdHMsIHNlbGVjdGVkUmVzdWx0cywgY29uZmlnXSlcbiAgY29uc3Qgb25TZWxlY3QgPSAoc2VsZWN0ZWREYXRhOiBUaW1lbGluZUl0ZW1bXSkgPT4ge1xuICAgIGNvbnN0IHNlbGVjdGVkSWRzID0gc2VsZWN0ZWREYXRhLm1hcCgoZCkgPT4gZC5pZClcbiAgICBzZXRQYXVzZSh0cnVlKVxuICAgIGxhenlSZXN1bHRzLnNlbGVjdEJ5SWRzKHNlbGVjdGVkSWRzKVxuICAgIHNldFBhdXNlKGZhbHNlKVxuICB9XG4gIGlmIChwYXVzZSkge1xuICAgIHJldHVybiBudWxsXG4gIH1cbiAgcmV0dXJuIChcbiAgICA8VGltZWxpbmVXcmFwcGVyIGRhdGEtaWQ9XCJ0aW1lbGluZS1jb250YWluZXJcIiByZWY9e3Jvb3RSZWZ9PlxuICAgICAgPFRpbWVsaW5lXG4gICAgICAgIG1pbj17bW9tZW50KCcxOTc1LTAxLTAxJykudHoodXNlci5nZXRUaW1lWm9uZSgpKX1cbiAgICAgICAgbWF4PXttb21lbnQobWF4RGF0ZSl9XG4gICAgICAgIGhlaWdodE9mZnNldD17MjUwfVxuICAgICAgICBvblNlbGVjdD17b25TZWxlY3R9XG4gICAgICAgIGRhdGE9e2RhdGF9XG4gICAgICAgIGRhdGVBdHRyaWJ1dGVBbGlhc2VzPXtkYXRlQXR0cmlidXRlQWxpYXNlc31cbiAgICAgICAgcmVuZGVyVG9vbHRpcD17cmVuZGVyVG9vbHRpcH1cbiAgICAgICAgZm9ybWF0PXt1c2VyLmdldERhdGVUaW1lRm9ybWF0KCl9XG4gICAgICAgIHRpbWV6b25lPXt1c2VyLmdldFRpbWVab25lKCl9XG4gICAgICAgIGhlaWdodD17aGVpZ2h0fVxuICAgICAgICBvbkNvcHk9eyhjb3BpZWRWYWx1ZSkgPT4ge1xuICAgICAgICAgIGFkZFNuYWNrKCdDb3BpZWQgdG8gY2xpcGJvYXJkOiAnICsgY29waWVkVmFsdWUsIHtcbiAgICAgICAgICAgIGFsZXJ0UHJvcHM6IHtcbiAgICAgICAgICAgICAgc2V2ZXJpdHk6ICdzdWNjZXNzJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSlcbiAgICAgICAgfX1cbiAgICAgIC8+XG4gICAgPC9UaW1lbGluZVdyYXBwZXI+XG4gIClcbn1cbmV4cG9ydCBkZWZhdWx0IFRpbWVsaW5lVmlzdWFsaXphdGlvblxuIl19