import { __read } from "tslib";
import { jsx as _jsx, Fragment as _Fragment, jsxs as _jsxs } from "react/jsx-runtime";
/**
 * Copyright (c) Codice Foundation
 *
 * This is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser
 * General Public License as published by the Free Software Foundation, either version 3 of the
 * License, or any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
 * even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details. A copy of the GNU Lesser General Public License
 * is distributed along with this program and can be found at
 * <http://www.gnu.org/licenses/lgpl.html>.
 *
 **/
import * as React from 'react';
import Button from '@mui/material/Button';
import user from '../../singletons/user-instance';
import { AutoVariableSizeList } from 'react-window-components';
import Grid from '@mui/material/Grid';
import { Header } from './table-header';
import ResultItemRow from './result-item-row';
import Paper from '@mui/material/Paper';
import { Elevations } from '../../theme/theme';
import Divider from '@mui/material/Divider';
import { useLazyResultsFromSelectionInterface } from '../../selection-interface/hooks';
import { useStatusOfLazyResults } from '../../../js/model/LazyQueryResult/hooks';
import LinearProgress from '@mui/material/LinearProgress';
import { DarkDivider } from '../../dark-divider/dark-divider';
import { useTheme } from '@mui/material/styles';
import ViewAgendaIcon from '@mui/icons-material/ViewAgenda';
import TableChartIcon from '@mui/icons-material/TableChart';
import TransferList from '../../tabs/metacard/transfer-list';
import { useDialog } from '../../dialog';
import { TypedUserInstance } from '../../singletons/TypedUser';
import useTimePrefs from '../../fields/useTimePrefs';
import { useScrollToItemOnSelection } from './result-item.collection';
import { Memo } from '../../memo/memo';
import { LayoutContext } from '../../golden-layout/visual-settings.provider';
import { RESULTS_ATTRIBUTES_TABLE, getDefaultResultsShownTable, } from '../settings-helpers';
export var ResultsCommonControls = function (_a) {
    var getStartingLeft = _a.getStartingLeft, getStartingRight = _a.getStartingRight, onSave = _a.onSave;
    var dialogContext = useDialog();
    return (_jsx(_Fragment, { children: _jsx(Grid, { item: true, className: "ml-auto pr-8 ", children: _jsx(Button, { "data-id": "manage-attributes-button", onClick: function () {
                    dialogContext.setProps({
                        open: true,
                        disableEnforceFocus: true,
                        children: (_jsx("div", { style: {
                                minHeight: '60vh',
                            }, children: _jsx(TransferList, { startingLeft: getStartingLeft(), startingRight: getStartingRight(), onSave: function (active) {
                                    onSave(active);
                                } }) })),
                    });
                }, color: "primary", children: "Manage Attributes" }) }) }));
};
var TableVisual = function (_a) {
    var selectionInterface = _a.selectionInterface, mode = _a.mode, setMode = _a.setMode;
    var _b = React.useContext(LayoutContext), getValue = _b.getValue, setValue = _b.setValue;
    var lazyResults = useLazyResultsFromSelectionInterface({
        selectionInterface: selectionInterface,
    });
    var results = Object.values(lazyResults.results);
    var theme = useTheme();
    var _c = useStatusOfLazyResults({ lazyResults: lazyResults }), isSearching = _c.isSearching, status = _c.status;
    useTimePrefs();
    var headerRef = React.useRef(null);
    /**
     * Note that this scenario only plays out when the component is first created, so if this is open before a search is run it will already be mounted.
     *
     * This is solely to keep the illusion of responsiveness when switching from table mode to list mode (or dropping a new result visual in)
     */
    var _d = __read(React.useState(false), 2), isMounted = _d[0], setIsMounted = _d[1];
    var _e = useScrollToItemOnSelection({
        selectionInterface: selectionInterface,
    }), listRef = _e.listRef, setLastInteraction = _e.setLastInteraction;
    React.useEffect(function () {
        var mountedTimeout = setTimeout(function () {
            setIsMounted(true);
        }, 1000);
        return function () {
            clearTimeout(mountedTimeout);
        };
    }, []);
    var prefs = user.get('user').get('preferences');
    var columnsWidth = new Map(prefs.get('columnWidths'));
    var _f = __read(React.useState(columnsWidth), 2), headerColWidth = _f[0], setHeaderColWidth = _f[1];
    var setWidth = function (width) {
        setHeaderColWidth(width);
    };
    var _g = __read(React.useState(0), 2), maxActionWidth = _g[0], setMaxActionWidth = _g[1];
    var _h = __read(React.useState(0), 2), maxAddOnWidth = _h[0], setMaxAddOnWidth = _h[1];
    return (_jsxs(Grid, { container: true, className: "w-full h-full bg-inherit", direction: "column", wrap: "nowrap", children: [_jsx(Grid, { item: true, children: _jsxs(Grid, { container: true, className: "w-full pt-2 px-2", direction: "row", alignItems: "center", children: [_jsx(ResultsCommonControls, { getStartingLeft: function () {
                                return getValue(RESULTS_ATTRIBUTES_TABLE, getDefaultResultsShownTable());
                            }, getStartingRight: function () {
                                return TypedUserInstance.getResultsAttributesPossibleTable(getValue(RESULTS_ATTRIBUTES_TABLE));
                            }, onSave: function (active) { return setValue(RESULTS_ATTRIBUTES_TABLE, active); } }), _jsx(Grid, { item: true, className: "pr-2", children: _jsxs(Button, { "data-id": "list-button", onClick: function () {
                                    setMode('card');
                                }, style: {
                                    borderBottom: mode === 'card'
                                        ? "1px solid ".concat(theme.palette.primary.main)
                                        : '1px solid transparent',
                                }, children: [_jsx(ViewAgendaIcon, {}), "List"] }) }), _jsx(Grid, { item: true, children: _jsxs(Button, { "data-id": "table-button", onClick: function () {
                                    setMode('table');
                                }, style: {
                                    borderBottom: mode === 'table'
                                        ? "1px solid ".concat(theme.palette.primary.main)
                                        : '1px solid transparent',
                                }, children: [_jsx(TableChartIcon, {}), "Table"] }) })] }) }), _jsx(DarkDivider, { className: "w-full h-min my-2" }), _jsx(Grid, { item: true, className: "overflow-hidden bg-inherit w-full h-full p-2", children: _jsx(Paper, { elevation: Elevations.paper, className: "w-full h-full", children: isMounted ? (_jsxs(Grid, { container: true, className: "w-full h-full bg-inherit", direction: "column", wrap: "nowrap", children: [_jsx(Grid, { item: true, className: "bg-inherit", children: _jsx("div", { className: "w-auto overflow-auto scrollbars-hide bg-inherit", ref: headerRef, children: _jsx(Header, { lazyResults: lazyResults, setHeaderColWidth: setWidth, headerColWidth: headerColWidth, actionWidth: maxActionWidth, addOnWidth: maxAddOnWidth }) }) }), _jsx(Grid, { item: true, children: _jsx(Divider, { className: "w-full h-min" }) }), _jsx(Grid, { item: true, className: "w-full h-full overflow-hidden bg-inherit", children: _jsx(Memo, { dependencies: [
                                        listRef.current,
                                        lazyResults.results,
                                        isSearching,
                                        status,
                                        maxAddOnWidth,
                                    ], children: _jsx(AutoVariableSizeList, { outerElementProps: {
                                            onScroll: function (e) {
                                                if (headerRef.current) {
                                                    headerRef.current.scrollLeft = e.target.scrollLeft;
                                                }
                                            },
                                            onMouseEnter: function () {
                                                setLastInteraction(Date.now());
                                            },
                                            onMouseUp: function () {
                                                setLastInteraction(Date.now());
                                            },
                                        }, defaultSize: 76, overscanCount: 10, controlledMeasuring: true, items: results, Item: function (_a) {
                                            var itemRef = _a.itemRef, item = _a.item, measure = _a.measure, index = _a.index;
                                            return (_jsx("div", { ref: itemRef, className: "bg-inherit", children: _jsx(ResultItemRow, { lazyResult: item, measure: measure, index: index, results: results, selectionInterface: selectionInterface, headerColWidth: headerColWidth, actionWidth: maxActionWidth, setMaxActionWidth: function (width) {
                                                        return setMaxActionWidth(function (maxWidth) {
                                                            return Math.max(width, maxWidth);
                                                        });
                                                    }, addOnWidth: maxAddOnWidth, setMaxAddOnWidth: function (width) {
                                                        return setMaxAddOnWidth(function (maxWidth) {
                                                            return Math.max(width, maxWidth);
                                                        });
                                                    } }) }));
                                        }, Empty: function () {
                                            if (Object.values(status).length === 0) {
                                                return (_jsx("div", { className: "p-2", children: "Search has not yet been run." }));
                                            }
                                            if (isSearching) {
                                                return _jsx(LinearProgress, { variant: "indeterminate" });
                                            }
                                            return (_jsx("div", { className: "result-item-collection-empty p-2", children: "No Results Found" }));
                                        }, variableSizeListRef: listRef }) }) })] })) : (_jsx(LinearProgress, { variant: "indeterminate" })) }) })] }));
};
export default TableVisual;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFibGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9zcmMvbWFpbi93ZWJhcHAvY29tcG9uZW50L3Zpc3VhbGl6YXRpb24vcmVzdWx0cy12aXN1YWwvdGFibGUudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUE7Ozs7Ozs7Ozs7Ozs7SUFhSTtBQUNKLE9BQU8sS0FBSyxLQUFLLE1BQU0sT0FBTyxDQUFBO0FBQzlCLE9BQU8sTUFBTSxNQUFNLHNCQUFzQixDQUFBO0FBQ3pDLE9BQU8sSUFBSSxNQUFNLGdDQUFnQyxDQUFBO0FBRWpELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLHlCQUF5QixDQUFBO0FBQzlELE9BQU8sSUFBSSxNQUFNLG9CQUFvQixDQUFBO0FBQ3JDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQTtBQUN2QyxPQUFPLGFBQWEsTUFBTSxtQkFBbUIsQ0FBQTtBQUU3QyxPQUFPLEtBQUssTUFBTSxxQkFBcUIsQ0FBQTtBQUN2QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sbUJBQW1CLENBQUE7QUFDOUMsT0FBTyxPQUFPLE1BQU0sdUJBQXVCLENBQUE7QUFDM0MsT0FBTyxFQUFFLG9DQUFvQyxFQUFFLE1BQU0saUNBQWlDLENBQUE7QUFDdEYsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0seUNBQXlDLENBQUE7QUFDaEYsT0FBTyxjQUFjLE1BQU0sOEJBQThCLENBQUE7QUFDekQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGlDQUFpQyxDQUFBO0FBQzdELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQTtBQUMvQyxPQUFPLGNBQWMsTUFBTSxnQ0FBZ0MsQ0FBQTtBQUMzRCxPQUFPLGNBQWMsTUFBTSxnQ0FBZ0MsQ0FBQTtBQUMzRCxPQUFPLFlBQVksTUFBTSxtQ0FBbUMsQ0FBQTtBQUM1RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sY0FB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Q2hCLE9BQU8sS0FBQyxjQUFjLElBQUMsT0FBTyxFQUFDLGVBQWUsR0FBRyxDQUFBOzRDQUNuRCxDQUFDOzRDQUNELE9BQU8sQ0FDTCxjQUFLLFNBQVMsRUFBQyxrQ0FBa0MsaUNBRTNDLENBQ1AsQ0FBQTt3Q0FDSCxDQUFDLEVBQ0QsbUJBQW1CLEVBQUUsT0FBTyxHQUM1QixHQUNHLEdBQ0YsSUFDRixDQUNSLENBQUMsQ0FBQyxDQUFDLENBQ0YsS0FBQyxjQUFjLElBQUMsT0FBTyxFQUFDLGVBQWUsR0FBRyxDQUMzQyxHQUNLLEdBQ0gsSUFDRixDQUNSLENBQUE7QUFDSCxDQUFDLENBQUE7QUFDRCxlQUFlLFdBQVcsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSBDb2RpY2UgRm91bmRhdGlvblxuICpcbiAqIFRoaXMgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeSBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBMZXNzZXJcbiAqIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5IHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlXG4gKiBMaWNlbnNlLCBvciBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0XG4gKiBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gU2VlIHRoZSBHTlVcbiAqIExlc3NlciBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuIEEgY29weSBvZiB0aGUgR05VIExlc3NlciBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlXG4gKiBpcyBkaXN0cmlidXRlZCBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbSBhbmQgY2FuIGJlIGZvdW5kIGF0XG4gKiA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzL2xncGwuaHRtbD4uXG4gKlxuICoqL1xuaW1wb3J0ICogYXMgUmVhY3QgZnJvbSAncmVhY3QnXG5pbXBvcnQgQnV0dG9uIGZyb20gJ0BtdWkvbWF0ZXJpYWwvQnV0dG9uJ1xuaW1wb3J0IHVzZXIgZnJvbSAnLi4vLi4vc2luZ2xldG9ucy91c2VyLWluc3RhbmNlJ1xuXG5pbXBvcnQgeyBBdXRvVmFyaWFibGVTaXplTGlzdCB9IGZyb20gJ3JlYWN0LXdpbmRvdy1jb21wb25lbnRzJ1xuaW1wb3J0IEdyaWQgZnJvbSAnQG11aS9tYXRlcmlhbC9HcmlkJ1xuaW1wb3J0IHsgSGVhZGVyIH0gZnJvbSAnLi90YWJsZS1oZWFkZXInXG5pbXBvcnQgUmVzdWx0SXRlbVJvdyBmcm9tICcuL3Jlc3VsdC1pdGVtLXJvdydcbmltcG9ydCB7IExhenlRdWVyeVJlc3VsdCB9IGZyb20gJy4uLy4uLy4uL2pzL21vZGVsL0xhenlRdWVyeVJlc3VsdC9MYXp5UXVlcnlSZXN1bHQnXG5pbXBvcnQgUGFwZXIgZnJvbSAnQG11aS9tYXRlcmlhbC9QYXBlcidcbmltcG9ydCB7IEVsZXZhdGlvbnMgfSBmcm9tICcuLi8uLi90aGVtZS90aGVtZSdcbmltcG9ydCBEaXZpZGVyIGZyb20gJ0BtdWkvbWF0ZXJpYWwvRGl2aWRlcidcbmltcG9ydCB7IHVzZUxhenlSZXN1bHRzRnJvbVNlbGVjdGlvbkludGVyZmFjZSB9IGZyb20gJy4uLy4uL3NlbGVjdGlvbi1pbnRlcmZhY2UvaG9va3MnXG5pbXBvcnQgeyB1c2VTdGF0dXNPZkxhenlSZXN1bHRzIH0gZnJvbSAnLi4vLi4vLi4vanMvbW9kZWwvTGF6eVF1ZXJ5UmVzdWx0L2hvb2tzJ1xuaW1wb3J0IExpbmVhclByb2dyZXNzIGZyb20gJ0BtdWkvbWF0ZXJpYWwvTGluZWFyUHJvZ3Jlc3MnXG5pbXBvcnQgeyBEYXJrRGl2aWRlciB9IGZyb20gJy4uLy4uL2RhcmstZGl2aWRlci9kYXJrLWRpdmlkZXInXG5pbXBvcnQgeyB1c2VUaGVtZSB9IGZyb20gJ0BtdWkvbWF0ZXJpYWwvc3R5bGVzJ1xuaW1wb3J0IFZpZXdBZ2VuZGFJY29uIGZyb20gJ0BtdWkvaWNvbnMtbWF0ZXJpYWwvVmlld0FnZW5kYSdcbmltcG9ydCBUYWJsZUNoYXJ0SWNvbiBmcm9tICdAbXVpL2ljb25zLW1hdGVyaWFsL1RhYmxlQ2hhcnQnXG5pbXBvcnQgVHJhbnNmZXJMaXN0IGZyb20gJy4uLy4uL3RhYnMvbWV0YWNhcmQvdHJhbnNmZXItbGlzdCdcbmltcG9ydCB7IHVzZURpYWxvZyB9IGZyb20gJy4uLy4uL2RpYWxvZydcbmltcG9ydCB7IFR5cGVkVXNlckluc3RhbmNlIH0gZnJvbSAnLi4vLi4vc2luZ2xldG9ucy9UeXBlZFVzZXInXG5pbXBvcnQgdXNlVGltZVByZWZzIGZyb20gJy4uLy4uL2ZpZWxkcy91c2VUaW1lUHJlZnMnXG5pbXBvcnQgeyB1c2VTY3JvbGxUb0l0ZW1PblNlbGVjdGlvbiB9IGZyb20gJy4vcmVzdWx0LWl0ZW0uY29sbGVjdGlvbidcbmltcG9ydCB7IE1lbW8gfSBmcm9tICcuLi8uLi9tZW1vL21lbW8nXG5pbXBvcnQgeyBMYXlvdXRDb250ZXh0IH0gZnJvbSAnLi4vLi4vZ29sZGVuLWxheW91dC92aXN1YWwtc2V0dGluZ3MucHJvdmlkZXInXG5pbXBvcnQge1xuICBSRVNVTFRTX0FUVFJJQlVURVNfVEFCTEUsXG4gIGdldERlZmF1bHRSZXN1bHRzU2hvd25UYWJsZSxcbn0gZnJvbSAnLi4vc2V0dGluZ3MtaGVscGVycydcbnR5cGUgUHJvcHMgPSB7XG4gIHNlbGVjdGlvbkludGVyZmFjZTogYW55XG4gIG1vZGU6IGFueVxuICBzZXRNb2RlOiBhbnlcbn1cbnR5cGUgUmVzdWx0c0NvbW1vbkNvbnRyb2xzVHlwZSA9IHtcbiAgZ2V0U3RhcnRpbmdMZWZ0OiAoKSA9PiBzdHJpbmdbXVxuICBnZXRTdGFydGluZ1JpZ2h0OiAoKSA9PiBzdHJpbmdbXVxuICBvblNhdmU6IChhY3RpdmU6IHN0cmluZ1tdKSA9PiB2b2lkXG59XG5leHBvcnQgY29uc3QgUmVzdWx0c0NvbW1vbkNvbnRyb2xzID0gKHtcbiAgZ2V0U3RhcnRpbmdMZWZ0LFxuICBnZXRTdGFydGluZ1JpZ2h0LFxuICBvblNhdmUsXG59OiBSZXN1bHRzQ29tbW9uQ29udHJvbHNUeXBlKSA9PiB7XG4gIGNvbnN0IGRpYWxvZ0NvbnRleHQgPSB1c2VEaWFsb2coKVxuICByZXR1cm4gKFxuICAgIDw+XG4gICAgICA8R3JpZCBpdGVtIGNsYXNzTmFtZT1cIm1sLWF1dG8gcHItOCBcIj5cbiAgICAgICAgPEJ1dHRvblxuICAgICAgICAgIGRhdGEtaWQ9XCJtYW5hZ2UtYXR0cmlidXRlcy1idXR0b25cIlxuICAgICAgICAgIG9uQ2xpY2s9eygpID0+IHtcbiAgICAgICAgICAgIGRpYWxvZ0NvbnRleHQuc2V0UHJvcHMoe1xuICAgICAgICAgICAgICBvcGVuOiB0cnVlLFxuICAgICAgICAgICAgICBkaXNhYmxlRW5mb3JjZUZvY3VzOiB0cnVlLFxuICAgICAgICAgICAgICBjaGlsZHJlbjogKFxuICAgICAgICAgICAgICAgIDxkaXZcbiAgICAgICAgICAgICAgICAgIHN0eWxlPXt7XG4gICAgICAgICAgICAgICAgICAgIG1pbkhlaWdodDogJzYwdmgnLFxuICAgICAgICAgICAgICAgICAgfX1cbiAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICA8VHJhbnNmZXJMaXN0XG4gICAgICAgICAgICAgICAgICAgIHN0YXJ0aW5nTGVmdD17Z2V0U3RhcnRpbmdMZWZ0KCl9XG4gICAgICAgICAgICAgICAgICAgIHN0YXJ0aW5nUmlnaHQ9e2dldFN0YXJ0aW5nUmlnaHQoKX1cbiAgICAgICAgICAgICAgICAgICAgb25TYXZlPXsoYWN0aXZlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgb25TYXZlKGFjdGl2ZSlcbiAgICAgICAgICAgICAgICAgICAgfX1cbiAgICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICksXG4gICAgICAgICAgICB9KVxuICAgICAgICAgIH19XG4gICAgICAgICAgY29sb3I9XCJwcmltYXJ5XCJcbiAgICAgICAgPlxuICAgICAgICAgIE1hbmFnZSBBdHRyaWJ1dGVzXG4gICAgICAgIDwvQnV0dG9uPlxuICAgICAgPC9HcmlkPlxuICAgIDwvPlxuICApXG59XG5jb25zdCBUYWJsZVZpc3VhbCA9ICh7IHNlbGVjdGlvbkludGVyZmFjZSwgbW9kZSwgc2V0TW9kZSB9OiBQcm9wcykgPT4ge1xuICBjb25zdCB7IGdldFZhbHVlLCBzZXRWYWx1ZSB9ID0gUmVhY3QudXNlQ29udGV4dChMYXlvdXRDb250ZXh0KVxuICBjb25zdCBsYXp5UmVzdWx0cyA9IHVzZUxhenlSZXN1bHRzRnJvbVNlbGVjdGlvbkludGVyZmFjZSh7XG4gICAgc2VsZWN0aW9uSW50ZXJmYWNlLFxuICB9KVxuICBjb25zdCByZXN1bHRzID0gT2JqZWN0LnZhbHVlcyhsYXp5UmVzdWx0cy5yZXN1bHRzKVxuICBjb25zdCB0aGVtZSA9IHVzZVRoZW1lKClcbiAgY29uc3QgeyBpc1NlYXJjaGluZywgc3RhdHVzIH0gPSB1c2VTdGF0dXNPZkxhenlSZXN1bHRzKHsgbGF6eVJlc3VsdHMgfSlcbiAgdXNlVGltZVByZWZzKClcbiAgY29uc3QgaGVhZGVyUmVmID0gUmVhY3QudXNlUmVmPEhUTUxEaXZFbGVtZW50PihudWxsKVxuICAvKipcbiAgICogTm90ZSB0aGF0IHRoaXMgc2NlbmFyaW8gb25seSBwbGF5cyBvdXQgd2hlbiB0aGUgY29tcG9uZW50IGlzIGZpcnN0IGNyZWF0ZWQsIHNvIGlmIHRoaXMgaXMgb3BlbiBiZWZvcmUgYSBzZWFyY2ggaXMgcnVuIGl0IHdpbGwgYWxyZWFkeSBiZSBtb3VudGVkLlxuICAgKlxuICAgKiBUaGlzIGlzIHNvbGVseSB0byBrZWVwIHRoZSBpbGx1c2lvbiBvZiByZXNwb25zaXZlbmVzcyB3aGVuIHN3aXRjaGluZyBmcm9tIHRhYmxlIG1vZGUgdG8gbGlzdCBtb2RlIChvciBkcm9wcGluZyBhIG5ldyByZXN1bHQgdmlzdWFsIGluKVxuICAgKi9cbiAgY29uc3QgW2lzTW91bnRlZCwgc2V0SXNNb3VudGVkXSA9IFJlYWN0LnVzZVN0YXRlKGZhbHNlKVxuICBjb25zdCB7IGxpc3RSZWYsIHNldExhc3RJbnRlcmFjdGlvbiB9ID0gdXNlU2Nyb2xsVG9JdGVtT25TZWxlY3Rpb24oe1xuICAgIHNlbGVjdGlvbkludGVyZmFjZSxcbiAgfSlcblxuICBSZWFjdC51c2VFZmZlY3QoKCkgPT4ge1xuICAgIGNvbnN0IG1vdW50ZWRUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICBzZXRJc01vdW50ZWQodHJ1ZSlcbiAgICB9LCAxMDAwKVxuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICBjbGVhclRpbWVvdXQobW91bnRlZFRpbWVvdXQpXG4gICAgfVxuICB9LCBbXSlcblxuICBjb25zdCBwcmVmcyA9IHVzZXIuZ2V0KCd1c2VyJykuZ2V0KCdwcmVmZXJlbmNlcycpXG4gIGNvbnN0IGNvbHVtbnNXaWR0aCA9IG5ldyBNYXA8c3RyaW5nLCBzdHJpbmc+KHByZWZzLmdldCgnY29sdW1uV2lkdGhzJykpXG4gIGNvbnN0IFtoZWFkZXJDb2xXaWR0aCwgc2V0SGVhZGVyQ29sV2lkdGhdID0gUmVhY3QudXNlU3RhdGUoY29sdW1uc1dpZHRoKVxuXG4gIGNvbnN0IHNldFdpZHRoID0gKHdpZHRoOiBNYXA8c3RyaW5nLCBzdHJpbmc+KSA9PiB7XG4gICAgc2V0SGVhZGVyQ29sV2lkdGgod2lkdGgpXG4gIH1cblxuICBjb25zdCBbbWF4QWN0aW9uV2lkdGgsIHNldE1heEFjdGlvbldpZHRoXSA9IFJlYWN0LnVzZVN0YXRlKDApXG4gIGNvbnN0IFttYXhBZGRPbldpZHRoLCBzZXRNYXhBZGRPbldpZHRoXSA9IFJlYWN0LnVzZVN0YXRlKDApXG5cbiAgcmV0dXJuIChcbiAgICA8R3JpZFxuICAgICAgY29udGFpbmVyXG4gICAgICBjbGFzc05hbWU9XCJ3LWZ1bGwgaC1mdWxsIGJnLWluaGVyaXRcIlxuICAgICAgZGlyZWN0aW9uPVwiY29sdW1uXCJcbiAgICAgIHdyYXA9XCJub3dyYXBcIlxuICAgID5cbiAgICAgIDxHcmlkIGl0ZW0+XG4gICAgICAgIDxHcmlkXG4gICAgICAgICAgY29udGFpbmVyXG4gICAgICAgICAgY2xhc3NOYW1lPVwidy1mdWxsIHB0LTIgcHgtMlwiXG4gICAgICAgICAgZGlyZWN0aW9uPVwicm93XCJcbiAgICAgICAgICBhbGlnbkl0ZW1zPVwiY2VudGVyXCJcbiAgICAgICAgPlxuICAgICAgICAgIDxSZXN1bHRzQ29tbW9uQ29udHJvbHNcbiAgICAgICAgICAgIGdldFN0YXJ0aW5nTGVmdD17KCkgPT4ge1xuICAgICAgICAgICAgICByZXR1cm4gZ2V0VmFsdWUoXG4gICAgICAgICAgICAgICAgUkVTVUxUU19BVFRSSUJVVEVTX1RBQkxFLFxuICAgICAgICAgICAgICAgIGdldERlZmF1bHRSZXN1bHRzU2hvd25UYWJsZSgpXG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgIH19XG4gICAgICAgICAgICBnZXRTdGFydGluZ1JpZ2h0PXsoKSA9PiB7XG4gICAgICAgICAgICAgIHJldHVybiBUeXBlZFVzZXJJbnN0YW5jZS5nZXRSZXN1bHRzQXR0cmlidXRlc1Bvc3NpYmxlVGFibGUoXG4gICAgICAgICAgICAgICAgZ2V0VmFsdWUoUkVTVUxUU19BVFRSSUJVVEVTX1RBQkxFKVxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICB9fVxuICAgICAgICAgICAgb25TYXZlPXsoYWN0aXZlKSA9PiBzZXRWYWx1ZShSRVNVTFRTX0FUVFJJQlVURVNfVEFCTEUsIGFjdGl2ZSl9XG4gICAgICAgICAgLz5cbiAgICAgICAgICA8R3JpZCBpdGVtIGNsYXNzTmFtZT1cInByLTJcIj5cbiAgICAgICAgICAgIDxCdXR0b25cbiAgICAgICAgICAgICAgZGF0YS1pZD1cImxpc3QtYnV0dG9uXCJcbiAgICAgICAgICAgICAgb25DbGljaz17KCkgPT4ge1xuICAgICAgICAgICAgICAgIHNldE1vZGUoJ2NhcmQnKVxuICAgICAgICAgICAgICB9fVxuICAgICAgICAgICAgICBzdHlsZT17e1xuICAgICAgICAgICAgICAgIGJvcmRlckJvdHRvbTpcbiAgICAgICAgICAgICAgICAgIG1vZGUgPT09ICdjYXJkJ1xuICAgICAgICAgICAgICAgICAgICA/IGAxcHggc29saWQgJHt0aGVtZS5wYWxldHRlLnByaW1hcnkubWFpbn1gXG4gICAgICAgICAgICAgICAgICAgIDogJzFweCBzb2xpZCB0cmFuc3BhcmVudCcsXG4gICAgICAgICAgICAgIH19XG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgIDxWaWV3QWdlbmRhSWNvbiAvPlxuICAgICAgICAgICAgICBMaXN0XG4gICAgICAgICAgICA8L0J1dHRvbj5cbiAgICAgICAgICA8L0dyaWQ+XG4gICAgICAgICAgPEdyaWQgaXRlbT5cbiAgICAgICAgICAgIDxCdXR0b25cbiAgICAgICAgICAgICAgZGF0YS1pZD1cInRhYmxlLWJ1dHRvblwiXG4gICAgICAgICAgICAgIG9uQ2xpY2s9eygpID0+IHtcbiAgICAgICAgICAgICAgICBzZXRNb2RlKCd0YWJsZScpXG4gICAgICAgICAgICAgIH19XG4gICAgICAgICAgICAgIHN0eWxlPXt7XG4gICAgICAgICAgICAgICAgYm9yZGVyQm90dG9tOlxuICAgICAgICAgICAgICAgICAgbW9kZSA9PT0gJ3RhYmxlJ1xuICAgICAgICAgICAgICAgICAgICA/IGAxcHggc29saWQgJHt0aGVtZS5wYWxldHRlLnByaW1hcnkubWFpbn1gXG4gICAgICAgICAgICAgICAgICAgIDogJzFweCBzb2xpZCB0cmFuc3BhcmVudCcsXG4gICAgICAgICAgICAgIH19XG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgIDxUYWJsZUNoYXJ0SWNvbiAvPlxuICAgICAgICAgICAgICBUYWJsZVxuICAgICAgICAgICAgPC9CdXR0b24+XG4gICAgICAgICAgPC9HcmlkPlxuICAgICAgICA8L0dyaWQ+XG4gICAgICA8L0dyaWQ+XG4gICAgICA8RGFya0RpdmlkZXIgY2xhc3NOYW1lPVwidy1mdWxsIGgtbWluIG15LTJcIiAvPlxuXG4gICAgICA8R3JpZCBpdGVtIGNsYXNzTmFtZT1cIm92ZXJmbG93LWhpZGRlbiBiZy1pbmhlcml0IHctZnVsbCBoLWZ1bGwgcC0yXCI+XG4gICAgICAgIDxQYXBlciBlbGV2YXRpb249e0VsZXZhdGlvbnMucGFwZXJ9IGNsYXNzTmFtZT1cInctZnVsbCBoLWZ1bGxcIj5cbiAgICAgICAgICB7aXNNb3VudGVkID8gKFxuICAgICAgICAgICAgPEdyaWRcbiAgICAgICAgICAgICAgY29udGFpbmVyXG4gICAgICAgICAgICAgIGNsYXNzTmFtZT1cInctZnVsbCBoLWZ1bGwgYmctaW5oZXJpdFwiXG4gICAgICAgICAgICAgIGRpcmVjdGlvbj1cImNvbHVtblwiXG4gICAgICAgICAgICAgIHdyYXA9XCJub3dyYXBcIlxuICAgICAgICAgICAgPlxuICAgICAgICAgICAgICA8R3JpZCBpdGVtIGNsYXNzTmFtZT1cImJnLWluaGVyaXRcIj5cbiAgICAgICAgICAgICAgICA8ZGl2XG4gICAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJ3LWF1dG8gb3ZlcmZsb3ctYXV0byBzY3JvbGxiYXJzLWhpZGUgYmctaW5oZXJpdFwiXG4gICAgICAgICAgICAgICAgICByZWY9e2hlYWRlclJlZn1cbiAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICA8SGVhZGVyXG4gICAgICAgICAgICAgICAgICAgIGxhenlSZXN1bHRzPXtsYXp5UmVzdWx0c31cbiAgICAgICAgICAgICAgICAgICAgc2V0SGVhZGVyQ29sV2lkdGg9e3NldFdpZHRofVxuICAgICAgICAgICAgICAgICAgICBoZWFkZXJDb2xXaWR0aD17aGVhZGVyQ29sV2lkdGh9XG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbldpZHRoPXttYXhBY3Rpb25XaWR0aH1cbiAgICAgICAgICAgICAgICAgICAgYWRkT25XaWR0aD17bWF4QWRkT25XaWR0aH1cbiAgICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgIDwvR3JpZD5cbiAgICAgICAgICAgICAgPEdyaWQgaXRlbT5cbiAgICAgICAgICAgICAgICA8RGl2aWRlciBjbGFzc05hbWU9XCJ3LWZ1bGwgaC1taW5cIiAvPlxuICAgICAgICAgICAgICA8L0dyaWQ+XG4gICAgICAgICAgICAgIDxHcmlkIGl0ZW0gY2xhc3NOYW1lPVwidy1mdWxsIGgtZnVsbCBvdmVyZmxvdy1oaWRkZW4gYmctaW5oZXJpdFwiPlxuICAgICAgICAgICAgICAgIDxNZW1vXG4gICAgICAgICAgICAgICAgICBkZXBlbmRlbmNpZXM9e1tcbiAgICAgICAgICAgICAgICAgICAgbGlzdFJlZi5jdXJyZW50LFxuICAgICAgICAgICAgICAgICAgICBsYXp5UmVzdWx0cy5yZXN1bHRzLFxuICAgICAgICAgICAgICAgICAgICBpc1NlYXJjaGluZyxcbiAgICAgICAgICAgICAgICAgICAgc3RhdHVzLFxuICAgICAgICAgICAgICAgICAgICBtYXhBZGRPbldpZHRoLFxuICAgICAgICAgICAgICAgICAgXX1cbiAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICA8QXV0b1ZhcmlhYmxlU2l6ZUxpc3Q8TGF6eVF1ZXJ5UmVzdWx0LCBIVE1MRGl2RWxlbWVudD5cbiAgICAgICAgICAgICAgICAgICAgb3V0ZXJFbGVtZW50UHJvcHM9e3tcbiAgICAgICAgICAgICAgICAgICAgICBvblNjcm9sbDogKGUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChoZWFkZXJSZWYuY3VycmVudCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXJSZWYuY3VycmVudC5zY3JvbGxMZWZ0ID0gKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUudGFyZ2V0IGFzIGFueVxuICAgICAgICAgICAgICAgICAgICAgICAgICApLnNjcm9sbExlZnRcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgIG9uTW91c2VFbnRlcjogKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2V0TGFzdEludGVyYWN0aW9uKERhdGUubm93KCkpXG4gICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICBvbk1vdXNlVXA6ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNldExhc3RJbnRlcmFjdGlvbihEYXRlLm5vdygpKVxuICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIH19XG4gICAgICAgICAgICAgICAgICAgIGRlZmF1bHRTaXplPXs3Nn1cbiAgICAgICAgICAgICAgICAgICAgb3ZlcnNjYW5Db3VudD17MTB9XG4gICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZWRNZWFzdXJpbmc9e3RydWV9XG4gICAgICAgICAgICAgICAgICAgIGl0ZW1zPXtyZXN1bHRzfVxuICAgICAgICAgICAgICAgICAgICBJdGVtPXsoeyBpdGVtUmVmLCBpdGVtLCBtZWFzdXJlLCBpbmRleCB9KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgcmVmPXtpdGVtUmVmfSBjbGFzc05hbWU9XCJiZy1pbmhlcml0XCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgIDxSZXN1bHRJdGVtUm93XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGF6eVJlc3VsdD17aXRlbX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZWFzdXJlPXttZWFzdXJlfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4PXtpbmRleH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzPXtyZXN1bHRzfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGlvbkludGVyZmFjZT17c2VsZWN0aW9uSW50ZXJmYWNlfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlckNvbFdpZHRoPXtoZWFkZXJDb2xXaWR0aH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25XaWR0aD17bWF4QWN0aW9uV2lkdGh9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0TWF4QWN0aW9uV2lkdGg9eyh3aWR0aCkgPT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldE1heEFjdGlvbldpZHRoKChtYXhXaWR0aCkgPT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTWF0aC5tYXgod2lkdGgsIG1heFdpZHRoKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRPbldpZHRoPXttYXhBZGRPbldpZHRofVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldE1heEFkZE9uV2lkdGg9eyh3aWR0aCkgPT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldE1heEFkZE9uV2lkdGgoKG1heFdpZHRoKSA9PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNYXRoLm1heCh3aWR0aCwgbWF4V2lkdGgpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICB9fVxuICAgICAgICAgICAgICAgICAgICBFbXB0eT17KCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgIGlmIChPYmplY3QudmFsdWVzKHN0YXR1cykubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cInAtMlwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNlYXJjaCBoYXMgbm90IHlldCBiZWVuIHJ1bi5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgIGlmIChpc1NlYXJjaGluZykge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDxMaW5lYXJQcm9ncmVzcyB2YXJpYW50PVwiaW5kZXRlcm1pbmF0ZVwiIC8+XG4gICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cInJlc3VsdC1pdGVtLWNvbGxlY3Rpb24tZW1wdHkgcC0yXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgIE5vIFJlc3VsdHMgRm91bmRcbiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgfX1cbiAgICAgICAgICAgICAgICAgICAgdmFyaWFibGVTaXplTGlzdFJlZj17bGlzdFJlZn1cbiAgICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgPC9NZW1vPlxuICAgICAgICAgICAgICA8L0dyaWQ+XG4gICAgICAgICAgICA8L0dyaWQ+XG4gICAgICAgICAgKSA6IChcbiAgICAgICAgICAgIDxMaW5lYXJQcm9ncmVzcyB2YXJpYW50PVwiaW5kZXRlcm1pbmF0ZVwiIC8+XG4gICAgICAgICAgKX1cbiAgICAgICAgPC9QYXBlcj5cbiAgICAgIDwvR3JpZD5cbiAgICA8L0dyaWQ+XG4gIClcbn1cbmV4cG9ydCBkZWZhdWx0IFRhYmxlVmlzdWFsXG4iXX0=