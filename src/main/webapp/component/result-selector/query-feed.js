import { __assign, __makeTemplateObject, __read } from "tslib";
import { jsx as _jsx, jsxs as _jsxs, Fragment as _Fragment } from "react/jsx-runtime";
import * as React from 'react';
import Paper from '@mui/material/Paper';
import moment from 'moment-timezone';
import styled from 'styled-components';
import Button from '@mui/material/Button';
import { useLazyResultsStatusFromSelectionInterface } from '../selection-interface/hooks';
import Tooltip from '@mui/material/Tooltip';
import { Elevations } from '../theme/theme';
import FilterListIcon from '@mui/icons-material/FilterList';
import { fuzzyHits, fuzzyResultCount } from './fuzzy-results';
import WarningIcon from '@mui/icons-material/Warning';
import ErrorIcon from '@mui/icons-material/Error';
import { useMenuState } from '../menu-state/menu-state';
import Popover from '@mui/material/Popover';
var Cell = styled.td(templateObject_1 || (templateObject_1 = __makeTemplateObject(["\n  padding: 20px;\n  border: solid 1px rgba(120, 120, 120, 0.2);\n"], ["\n  padding: 20px;\n  border: solid 1px rgba(120, 120, 120, 0.2);\n"])));
var HeaderCell = styled.th(templateObject_2 || (templateObject_2 = __makeTemplateObject(["\n  padding: 20px;\n"], ["\n  padding: 20px;\n"])));
var CellValue = function (props) {
    var value = props.value, _a = props.warnings, warnings = _a === void 0 ? [] : _a, _b = props.errors, errors = _b === void 0 ? [] : _b, message = props.message, alwaysShowValue = props.alwaysShowValue, hasReturned = props.hasReturned, successful = props.successful;
    return (_jsxs(React.Fragment, { children: [(errors.length > 0 || !successful) && (_jsx(Tooltip, { title: _jsx(Paper, { elevation: Elevations.overlays, className: "p-2", children: (function () {
                        if (errors.length > 0) {
                            return errors.map(function (error) { return _jsx("div", { children: error }, error); });
                        }
                        else if (message) {
                            return message;
                        }
                        else {
                            return 'Something went wrong searching this source.';
                        }
                    })() }), children: _jsx(ErrorIcon, { style: { paddingRight: '5px' }, color: "error" }) })), warnings.length > 0 && (_jsx(Tooltip, { title: _jsx(Paper, { elevation: Elevations.overlays, className: "p-2", children: warnings.map(function (warning) { return (_jsx("div", { children: warning }, warning)); }) }), children: _jsx(WarningIcon, { style: { paddingRight: '5px' }, color: "warning" }) })), alwaysShowValue || (!message && hasReturned) ? value : null, !hasReturned && !alwaysShowValue && (_jsx("span", { className: "fa fa-circle-o-notch fa-spin", title: "Waiting for source to return" }))] }));
};
var QueryStatusRow = function (_a) {
    var status = _a.status, query = _a.query;
    var hasReturned = status.hasReturned;
    var successful = status.successful;
    var message = status.message;
    var warnings = status.warnings;
    var errors = status.errors;
    var id = status.id;
    return (_jsxs("tr", { "data-id": "source-".concat(id, "-row"), children: [_jsx(Cell, { "data-id": "source-id-label", children: _jsx(CellValue, { value: id, hasReturned: hasReturned, successful: successful, warnings: warnings, errors: errors, message: message, alwaysShowValue: true }) }), _jsx(Cell, { "data-id": "available-label", children: _jsx(CellValue, { value: "".concat(status.count, " hit").concat(status.count === 1 ? '' : 's'), hasReturned: hasReturned, successful: successful, warnings: warnings, errors: errors, message: message }) }), _jsx(Cell, { "data-id": "possible-label", children: _jsx(CellValue, { value: fuzzyHits(status.hits), hasReturned: hasReturned, successful: successful, warnings: warnings, errors: errors, message: message }) }), _jsx(Cell, { "data-id": "time-label", children: _jsx(CellValue, { value: status.elapsed / 1000, hasReturned: hasReturned, successful: successful, warnings: warnings, errors: errors, message: message }) }), _jsx(Cell, { className: "status-filter", children: _jsx(Tooltip, { title: "Click to search only this source.", children: _jsxs(Button, { "data-id": "filter-button", onClick: function () {
                            query.set('sources', [status.id]);
                            query.startSearchFromFirstPage();
                        }, color: "primary", children: [_jsx(FilterListIcon, { className: "Mui-text-text-primary" }), "Filter"] }) }) })] }));
};
var QueryStatus = function (_a) {
    var statusBySource = _a.statusBySource, query = _a.query;
    return (_jsxs("table", { children: [_jsxs("tr", { children: [_jsx(HeaderCell, { children: "Source" }), _jsx(HeaderCell, { "data-help": "This is the number of results available based on the current sorting.", children: "Available" }), _jsx(HeaderCell, { "data-help": "This is the total number of results (hits) that matched your search.", children: "Possible" }), _jsx(HeaderCell, { "data-help": "This is the time (in seconds) that it took for the search to run.", children: "Time (s)" }), _jsx(HeaderCell, { "data-help": "Locally filter results to be from a specific source.", children: "Filter" })] }), _jsx("tbody", { children: statusBySource.map(function (status) {
                    return (_jsx(QueryStatusRow, { status: status, query: query }, status.id));
                }) })] }));
};
var LastRan = function (_a) {
    var currentAsOf = _a.currentAsOf;
    var _b = __read(React.useState(moment(currentAsOf).fromNow()), 2), howLongAgo = _b[0], setHowLongAgo = _b[1];
    React.useEffect(function () {
        setHowLongAgo(moment(currentAsOf).fromNow());
        var intervalId = setInterval(function () {
            setHowLongAgo(moment(currentAsOf).fromNow());
        }, 60000);
        return function () {
            clearInterval(intervalId);
        };
    }, [currentAsOf]);
    return _jsxs("div", { style: { whiteSpace: 'nowrap' }, children: ["Current as of ", howLongAgo] });
};
var QueryFeed = function (_a) {
    var selectionInterface = _a.selectionInterface;
    var _b = useMenuState(), MuiButtonProps = _b.MuiButtonProps, MuiPopoverProps = _b.MuiPopoverProps;
    var _c = useLazyResultsStatusFromSelectionInterface({
        selectionInterface: selectionInterface,
    }), status = _c.status, currentAsOf = _c.currentAsOf, isSearching = _c.isSearching;
    var statusBySource = Object.values(status);
    var resultMessage = '', pending = false, failed = false, warnings = false, errors = false;
    if (statusBySource.length === 0) {
        resultMessage = 'Has not been run';
    }
    else {
        var sourcesThatHaveReturned = statusBySource.filter(function (status) { return status.hasReturned; });
        if (sourcesThatHaveReturned.length > 0) {
            var results = statusBySource.filter(function (status) { return status.hasReturned; });
            var available_1 = 0;
            var possible_1 = 0;
            results.forEach(function (result) {
                var _a, _b;
                available_1 += (_a = result === null || result === void 0 ? void 0 : result.count) !== null && _a !== void 0 ? _a : 0;
                possible_1 += (_b = result === null || result === void 0 ? void 0 : result.hits) !== null && _b !== void 0 ? _b : 0;
            });
            resultMessage = "".concat(available_1, " hit").concat(available_1 === 1 ? '' : 's', " out of ").concat(fuzzyResultCount(possible_1), " possible");
        }
        else {
            resultMessage = 'Searching...';
        }
        failed = sourcesThatHaveReturned.some(function (status) { return !status.successful; });
        warnings = sourcesThatHaveReturned.some(function (status) { return status.warnings && status.warnings.length > 0; });
        errors = sourcesThatHaveReturned.some(function (status) {
            return status.errors && status.errors.length > 0;
        });
        pending = isSearching;
    }
    return (_jsx(_Fragment, { children: _jsxs("div", { className: "flex flex-row items-center flex-nowrap", children: [_jsxs("div", { className: "leading-5", children: [_jsx("div", { "data-id": "results-count-label", title: resultMessage, className: " whitespace-nowrap", children: resultMessage }), _jsx(LastRan, { currentAsOf: currentAsOf })] }), _jsx("div", { children: _jsx("div", { children: _jsxs("div", { className: "relative", children: [_jsxs(Button, __assign({ "data-id": "heartbeat-button", title: "Show the full status for the search.", "data-help": "Show the full status for the search." }, MuiButtonProps, { children: [pending && (_jsx("i", { className: "fa fa-circle-o-notch fa-spin is-critical-animation", style: { paddingRight: '2px' } })), (errors || failed) && (_jsx(ErrorIcon, { fontSize: "inherit", color: "error" })), warnings && _jsx(WarningIcon, { fontSize: "inherit", color: "warning" }), _jsx("span", { className: "fa fa-heartbeat" })] })), _jsx(Popover, __assign({}, MuiPopoverProps, { children: _jsx(Paper, { "data-id": "query-status-container", style: { padding: '20px' }, className: "intrigue-table", children: _jsx(QueryStatus, { statusBySource: statusBySource, query: selectionInterface.getCurrentQuery() }) }) }))] }) }) })] }) }));
};
export default QueryFeed;
var templateObject_1, templateObject_2;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVlcnktZmVlZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9tYWluL3dlYmFwcC9jb21wb25lbnQvcmVzdWx0LXNlbGVjdG9yL3F1ZXJ5LWZlZWQudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsT0FBTyxLQUFLLEtBQUssTUFBTSxPQUFPLENBQUE7QUFFOUIsT0FBTyxLQUFLLE1BQU0scUJBQXFCLENBQUE7QUFDdkMsT0FBTyxNQUFNLE1BQU0saUJBQWlCLENBQUE7QUFDcEMsT0FBTyxNQUFNLE1BQU0sbUJBQW1CLENBQUE7QUFDdEMsT0FBTyxNQUFNLE1BQU0sc0JBQXNCLENBQUE7QUFFekMsT0FBTyxFQUFFLDBDQUEwQyxFQUFFLE1BQU0sOEJBQThCLENBQUE7QUFDekYsT0FBTyxPQUFPLE1BQU0sdUJBQXVCLENBQUE7QUFDM0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFBO0FBQzNDLE9BQU8sY0FBYyxNQUFNLGdDQUFnQyxDQUFBO0FBQzNELE9BQU8sRUFBRSxTQUFTLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQTtBQUM3RCxPQUFPLFdBQVcsTUFBTSw2QkFBNkIsQ0FBQTtBQUNyRCxPQUFPLFNBQVMsTUFBTSwyQkFBMkIsQ0FBQTtBQUNqRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sMEJBQTBCLENBQUE7QUFDdkQsT0FBTyxPQUFPLE1BQU0sdUJBQXVCLENBQUE7QUFNM0MsSUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLEVBQUUsd0lBQUEscUVBR3JCLElBQUEsQ0FBQTtBQUVELElBQU0sVUFBVSxHQUFHLE1BQU0sQ0FBQyxFQUFFLHlGQUFBLHNCQUUzQixJQUFBLENBQUE7QUFZRCxJQUFNLFNBQVMsR0FBRyxVQUFDLEtBQXFCO0lBRXBDLElBQUEsS0FBSyxHQU9ILEtBQUssTUFQRixFQUNMLEtBTUUsS0FBSyxTQU5NLEVBQWIsUUFBUSxtQkFBRyxF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LENBQUE7QUFFRCxlQUFlLFNBQVMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0J1xuXG5pbXBvcnQgUGFwZXIgZnJvbSAnQG11aS9tYXRlcmlhbC9QYXBlcidcbmltcG9ydCBtb21lbnQgZnJvbSAnbW9tZW50LXRpbWV6b25lJ1xuaW1wb3J0IHN0eWxlZCBmcm9tICdzdHlsZWQtY29tcG9uZW50cydcbmltcG9ydCBCdXR0b24gZnJvbSAnQG11aS9tYXRlcmlhbC9CdXR0b24nXG5pbXBvcnQgeyBTdGF0dXMgfSBmcm9tICcuLi8uLi9qcy9tb2RlbC9MYXp5UXVlcnlSZXN1bHQvc3RhdHVzJ1xuaW1wb3J0IHsgdXNlTGF6eVJlc3VsdHNTdGF0dXNGcm9tU2VsZWN0aW9uSW50ZXJmYWNlIH0gZnJvbSAnLi4vc2VsZWN0aW9uLWludGVyZmFjZS9ob29rcydcbmltcG9ydCBUb29sdGlwIGZyb20gJ0BtdWkvbWF0ZXJpYWwvVG9vbHRpcCdcbmltcG9ydCB7IEVsZXZhdGlvbnMgfSBmcm9tICcuLi90aGVtZS90aGVtZSdcbmltcG9ydCBGaWx0ZXJMaXN0SWNvbiBmcm9tICdAbXVpL2ljb25zLW1hdGVyaWFsL0ZpbHRlckxpc3QnXG5pbXBvcnQgeyBmdXp6eUhpdHMsIGZ1enp5UmVzdWx0Q291bnQgfSBmcm9tICcuL2Z1enp5LXJlc3VsdHMnXG5pbXBvcnQgV2FybmluZ0ljb24gZnJvbSAnQG11aS9pY29ucy1tYXRlcmlhbC9XYXJuaW5nJ1xuaW1wb3J0IEVycm9ySWNvbiBmcm9tICdAbXVpL2ljb25zLW1hdGVyaWFsL0Vycm9yJ1xuaW1wb3J0IHsgdXNlTWVudVN0YXRlIH0gZnJvbSAnLi4vbWVudS1zdGF0ZS9tZW51LXN0YXRlJ1xuaW1wb3J0IFBvcG92ZXIgZnJvbSAnQG11aS9tYXRlcmlhbC9Qb3BvdmVyJ1xuXG50eXBlIFByb3BzID0ge1xuICBzZWxlY3Rpb25JbnRlcmZhY2U6IGFueVxufVxuXG5jb25zdCBDZWxsID0gc3R5bGVkLnRkYFxuICBwYWRkaW5nOiAyMHB4O1xuICBib3JkZXI6IHNvbGlkIDFweCByZ2JhKDEyMCwgMTIwLCAxMjAsIDAuMik7XG5gXG5cbmNvbnN0IEhlYWRlckNlbGwgPSBzdHlsZWQudGhgXG4gIHBhZGRpbmc6IDIwcHg7XG5gXG5cbnR5cGUgQ2VsbFZhbHVlUHJvcHMgPSB7XG4gIHZhbHVlOiBzdHJpbmcgfCBudW1iZXJcbiAgaGFzUmV0dXJuZWQ6IGJvb2xlYW5cbiAgc3VjY2Vzc2Z1bDogYm9vbGVhblxuICBtZXNzYWdlOiBzdHJpbmdcbiAgd2FybmluZ3M6IHN0cmluZ1tdXG4gIGVycm9yczogc3RyaW5nW11cbiAgYWx3YXlzU2hvd1ZhbHVlPzogYm9vbGVhblxufVxuXG5jb25zdCBDZWxsVmFsdWUgPSAocHJvcHM6IENlbGxWYWx1ZVByb3BzKSA9PiB7XG4gIGNvbnN0IHtcbiAgICB2YWx1ZSxcbiAgICB3YXJuaW5ncyA9IFtdLFxuICAgIGVycm9ycyA9IFtdLFxuICAgIG1lc3NhZ2UsXG4gICAgYWx3YXlzU2hvd1ZhbHVlLFxuICAgIGhhc1JldHVybmVkLFxuICAgIHN1Y2Nlc3NmdWwsXG4gIH0gPSBwcm9wc1xuICByZXR1cm4gKFxuICAgIDxSZWFjdC5GcmFnbWVudD5cbiAgICAgIHsoZXJyb3JzLmxlbmd0aCA+IDAgfHwgIXN1Y2Nlc3NmdWwpICYmIChcbiAgICAgICAgPFRvb2x0aXBcbiAgICAgICAgICB0aXRsZT17XG4gICAgICAgICAgICA8UGFwZXIgZWxldmF0aW9uPXtFbGV2YXRpb25zLm92ZXJsYXlzfSBjbGFzc05hbWU9XCJwLTJcIj5cbiAgICAgICAgICAgICAgeygoKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGVycm9ycy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICByZXR1cm4gZXJyb3JzLm1hcCgoZXJyb3IpID0+IDxkaXYga2V5PXtlcnJvcn0+e2Vycm9yfTwvZGl2PilcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG1lc3NhZ2UpIHtcbiAgICAgICAgICAgICAgICAgIHJldHVybiBtZXNzYWdlXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgIHJldHVybiAnU29tZXRoaW5nIHdlbnQgd3Jvbmcgc2VhcmNoaW5nIHRoaXMgc291cmNlLidcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0pKCl9XG4gICAgICAgICAgICA8L1BhcGVyPlxuICAgICAgICAgIH1cbiAgICAgICAgPlxuICAgICAgICAgIDxFcnJvckljb24gc3R5bGU9e3sgcGFkZGluZ1JpZ2h0OiAnNXB4JyB9fSBjb2xvcj1cImVycm9yXCIgLz5cbiAgICAgICAgPC9Ub29sdGlwPlxuICAgICAgKX1cbiAgICAgIHt3YXJuaW5ncy5sZW5ndGggPiAwICYmIChcbiAgICAgICAgPFRvb2x0aXBcbiAgICAgICAgICB0aXRsZT17XG4gICAgICAgICAgICA8UGFwZXIgZWxldmF0aW9uPXtFbGV2YXRpb25zLm92ZXJsYXlzfSBjbGFzc05hbWU9XCJwLTJcIj5cbiAgICAgICAgICAgICAge3dhcm5pbmdzLm1hcCgod2FybmluZykgPT4gKFxuICAgICAgICAgICAgICAgIDxkaXYga2V5PXt3YXJuaW5nfT57d2FybmluZ308L2Rpdj5cbiAgICAgICAgICAgICAgKSl9XG4gICAgICAgICAgICA8L1BhcGVyPlxuICAgICAgICAgIH1cbiAgICAgICAgPlxuICAgICAgICAgIDxXYXJuaW5nSWNvbiBzdHlsZT17eyBwYWRkaW5nUmlnaHQ6ICc1cHgnIH19IGNvbG9yPVwid2FybmluZ1wiIC8+XG4gICAgICAgIDwvVG9vbHRpcD5cbiAgICAgICl9XG4gICAgICB7YWx3YXlzU2hvd1ZhbHVlIHx8ICghbWVzc2FnZSAmJiBoYXNSZXR1cm5lZCkgPyB2YWx1ZSA6IG51bGx9XG4gICAgICB7IWhhc1JldHVybmVkICYmICFhbHdheXNTaG93VmFsdWUgJiYgKFxuICAgICAgICA8c3BhblxuICAgICAgICAgIGNsYXNzTmFtZT1cImZhIGZhLWNpcmNsZS1vLW5vdGNoIGZhLXNwaW5cIlxuICAgICAgICAgIHRpdGxlPVwiV2FpdGluZyBmb3Igc291cmNlIHRvIHJldHVyblwiXG4gICAgICAgIC8+XG4gICAgICApfVxuICAgIDwvUmVhY3QuRnJhZ21lbnQ+XG4gIClcbn1cblxuY29uc3QgUXVlcnlTdGF0dXNSb3cgPSAoeyBzdGF0dXMsIHF1ZXJ5IH06IHsgc3RhdHVzOiBTdGF0dXM7IHF1ZXJ5OiBhbnkgfSkgPT4ge1xuICBsZXQgaGFzUmV0dXJuZWQgPSBzdGF0dXMuaGFzUmV0dXJuZWRcbiAgbGV0IHN1Y2Nlc3NmdWwgPSBzdGF0dXMuc3VjY2Vzc2Z1bFxuICBsZXQgbWVzc2FnZSA9IHN0YXR1cy5tZXNzYWdlXG5cbiAgbGV0IHdhcm5pbmdzID0gc3RhdHVzLndhcm5pbmdzXG4gIGxldCBlcnJvcnMgPSBzdGF0dXMuZXJyb3JzXG4gIGxldCBpZCA9IHN0YXR1cy5pZFxuXG4gIHJldHVybiAoXG4gICAgPHRyIGRhdGEtaWQ9e2Bzb3VyY2UtJHtpZH0tcm93YH0+XG4gICAgICA8Q2VsbCBkYXRhLWlkPVwic291cmNlLWlkLWxhYmVsXCI+XG4gICAgICAgIDxDZWxsVmFsdWVcbiAgICAgICAgICB2YWx1ZT17aWR9XG4gICAgICAgICAgaGFzUmV0dXJuZWQ9e2hhc1JldHVybmVkfVxuICAgICAgICAgIHN1Y2Nlc3NmdWw9e3N1Y2Nlc3NmdWx9XG4gICAgICAgICAgd2FybmluZ3M9e3dhcm5pbmdzfVxuICAgICAgICAgIGVycm9ycz17ZXJyb3JzfVxuICAgICAgICAgIG1lc3NhZ2U9e21lc3NhZ2V9XG4gICAgICAgICAgYWx3YXlzU2hvd1ZhbHVlXG4gICAgICAgIC8+XG4gICAgICA8L0NlbGw+XG4gICAgICA8Q2VsbCBkYXRhLWlkPVwiYXZhaWxhYmxlLWxhYmVsXCI+XG4gICAgICAgIDxDZWxsVmFsdWVcbiAgICAgICAgICB2YWx1ZT17YCR7c3RhdHVzLmNvdW50fSBoaXQke3N0YXR1cy5jb3VudCA9PT0gMSA/ICcnIDogJ3MnfWB9XG4gICAgICAgICAgaGFzUmV0dXJuZWQ9e2hhc1JldHVybmVkfVxuICAgICAgICAgIHN1Y2Nlc3NmdWw9e3N1Y2Nlc3NmdWx9XG4gICAgICAgICAgd2FybmluZ3M9e3dhcm5pbmdzfVxuICAgICAgICAgIGVycm9ycz17ZXJyb3JzfVxuICAgICAgICAgIG1lc3NhZ2U9e21lc3NhZ2V9XG4gICAgICAgIC8+XG4gICAgICA8L0NlbGw+XG4gICAgICA8Q2VsbCBkYXRhLWlkPVwicG9zc2libGUtbGFiZWxcIj5cbiAgICAgICAgPENlbGxWYWx1ZVxuICAgICAgICAgIHZhbHVlPXtmdXp6eUhpdHMoc3RhdHVzLmhpdHMpfVxuICAgICAgICAgIGhhc1JldHVybmVkPXtoYXNSZXR1cm5lZH1cbiAgICAgICAgICBzdWNjZXNzZnVsPXtzdWNjZXNzZnVsfVxuICAgICAgICAgIHdhcm5pbmdzPXt3YXJuaW5nc31cbiAgICAgICAgICBlcnJvcnM9e2Vycm9yc31cbiAgICAgICAgICBtZXNzYWdlPXttZXNzYWdlfVxuICAgICAgICAvPlxuICAgICAgPC9DZWxsPlxuICAgICAgPENlbGwgZGF0YS1pZD1cInRpbWUtbGFiZWxcIj5cbiAgICAgICAgPENlbGxWYWx1ZVxuICAgICAgICAgIHZhbHVlPXtzdGF0dXMuZWxhcHNlZCAvIDEwMDB9XG4gICAgICAgICAgaGFzUmV0dXJuZWQ9e2hhc1JldHVybmVkfVxuICAgICAgICAgIHN1Y2Nlc3NmdWw9e3N1Y2Nlc3NmdWx9XG4gICAgICAgICAgd2FybmluZ3M9e3dhcm5pbmdzfVxuICAgICAgICAgIGVycm9ycz17ZXJyb3JzfVxuICAgICAgICAgIG1lc3NhZ2U9e21lc3NhZ2V9XG4gICAgICAgIC8+XG4gICAgICA8L0NlbGw+XG4gICAgICA8Q2VsbCBjbGFzc05hbWU9XCJzdGF0dXMtZmlsdGVyXCI+XG4gICAgICAgIDxUb29sdGlwIHRpdGxlPVwiQ2xpY2sgdG8gc2VhcmNoIG9ubHkgdGhpcyBzb3VyY2UuXCI+XG4gICAgICAgICAgPEJ1dHRvblxuICAgICAgICAgICAgZGF0YS1pZD1cImZpbHRlci1idXR0b25cIlxuICAgICAgICAgICAgb25DbGljaz17KCkgPT4ge1xuICAgICAgICAgICAgICBxdWVyeS5zZXQoJ3NvdXJjZXMnLCBbc3RhdHVzLmlkXSlcbiAgICAgICAgICAgICAgcXVlcnkuc3RhcnRTZWFyY2hGcm9tRmlyc3RQYWdlKClcbiAgICAgICAgICAgIH19XG4gICAgICAgICAgICBjb2xvcj1cInByaW1hcnlcIlxuICAgICAgICAgID5cbiAgICAgICAgICAgIDxGaWx0ZXJMaXN0SWNvbiBjbGFzc05hbWU9XCJNdWktdGV4dC10ZXh0LXByaW1hcnlcIiAvPlxuICAgICAgICAgICAgRmlsdGVyXG4gICAgICAgICAgPC9CdXR0b24+XG4gICAgICAgIDwvVG9vbHRpcD5cbiAgICAgIDwvQ2VsbD5cbiAgICA8L3RyPlxuICApXG59XG5cbmNvbnN0IFF1ZXJ5U3RhdHVzID0gKHtcbiAgc3RhdHVzQnlTb3VyY2UsXG4gIHF1ZXJ5LFxufToge1xuICBzdGF0dXNCeVNvdXJjZTogU3RhdHVzW11cbiAgcXVlcnk6IGFueVxufSkgPT4ge1xuICByZXR1cm4gKFxuICAgIDx0YWJsZT5cbiAgICAgIDx0cj5cbiAgICAgICAgPEhlYWRlckNlbGw+U291cmNlPC9IZWFkZXJDZWxsPlxuICAgICAgICA8SGVhZGVyQ2VsbCBkYXRhLWhlbHA9XCJUaGlzIGlzIHRoZSBudW1iZXIgb2YgcmVzdWx0cyBhdmFpbGFibGUgYmFzZWQgb24gdGhlIGN1cnJlbnQgc29ydGluZy5cIj5cbiAgICAgICAgICBBdmFpbGFibGVcbiAgICAgICAgPC9IZWFkZXJDZWxsPlxuICAgICAgICA8SGVhZGVyQ2VsbCBkYXRhLWhlbHA9XCJUaGlzIGlzIHRoZSB0b3RhbCBudW1iZXIgb2YgcmVzdWx0cyAoaGl0cykgdGhhdCBtYXRjaGVkIHlvdXIgc2VhcmNoLlwiPlxuICAgICAgICAgIFBvc3NpYmxlXG4gICAgICAgIDwvSGVhZGVyQ2VsbD5cbiAgICAgICAgPEhlYWRlckNlbGwgZGF0YS1oZWxwPVwiVGhpcyBpcyB0aGUgdGltZSAoaW4gc2Vjb25kcykgdGhhdCBpdCB0b29rIGZvciB0aGUgc2VhcmNoIHRvIHJ1bi5cIj5cbiAgICAgICAgICBUaW1lIChzKVxuICAgICAgICA8L0hlYWRlckNlbGw+XG4gICAgICAgIDxIZWFkZXJDZWxsIGRhdGEtaGVscD1cIkxvY2FsbHkgZmlsdGVyIHJlc3VsdHMgdG8gYmUgZnJvbSBhIHNwZWNpZmljIHNvdXJjZS5cIj5cbiAgICAgICAgICBGaWx0ZXJcbiAgICAgICAgPC9IZWFkZXJDZWxsPlxuICAgICAgPC90cj5cbiAgICAgIDx0Ym9keT5cbiAgICAgICAge3N0YXR1c0J5U291cmNlLm1hcCgoc3RhdHVzKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxRdWVyeVN0YXR1c1JvdyBrZXk9e3N0YXR1cy5pZH0gc3RhdHVzPXtzdGF0dXN9IHF1ZXJ5PXtxdWVyeX0gLz5cbiAgICAgICAgICApXG4gICAgICAgIH0pfVxuICAgICAgPC90Ym9keT5cbiAgICA8L3RhYmxlPlxuICApXG59XG5cbmNvbnN0IExhc3RSYW4gPSAoeyBjdXJyZW50QXNPZiB9OiB7IGN1cnJlbnRBc09mOiBudW1iZXIgfSkgPT4ge1xuICBjb25zdCBbaG93TG9uZ0Fnbywgc2V0SG93TG9uZ0Fnb10gPSBSZWFjdC51c2VTdGF0ZShcbiAgICBtb21lbnQoY3VycmVudEFzT2YpLmZyb21Ob3coKVxuICApXG4gIFJlYWN0LnVzZUVmZmVjdCgoKSA9PiB7XG4gICAgc2V0SG93TG9uZ0Fnbyhtb21lbnQoY3VycmVudEFzT2YpLmZyb21Ob3coKSlcbiAgICBjb25zdCBpbnRlcnZhbElkID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICAgICAgc2V0SG93TG9uZ0Fnbyhtb21lbnQoY3VycmVudEFzT2YpLmZyb21Ob3coKSlcbiAgICB9LCA2MDAwMClcbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgY2xlYXJJbnRlcnZhbChpbnRlcnZhbElkKVxuICAgIH1cbiAgfSwgW2N1cnJlbnRBc09mXSlcbiAgcmV0dXJuIDxkaXYgc3R5bGU9e3sgd2hpdGVTcGFjZTogJ25vd3JhcCcgfX0+Q3VycmVudCBhcyBvZiB7aG93TG9uZ0Fnb308L2Rpdj5cbn1cblxuY29uc3QgUXVlcnlGZWVkID0gKHsgc2VsZWN0aW9uSW50ZXJmYWNlIH06IFByb3BzKSA9PiB7XG4gIGNvbnN0IHsgTXVpQnV0dG9uUHJvcHMsIE11aVBvcG92ZXJQcm9wcyB9ID0gdXNlTWVudVN0YXRlKClcbiAgY29uc3QgeyBzdGF0dXMsIGN1cnJlbnRBc09mLCBpc1NlYXJjaGluZyB9ID1cbiAgICB1c2VMYXp5UmVzdWx0c1N0YXR1c0Zyb21TZWxlY3Rpb25JbnRlcmZhY2Uoe1xuICAgICAgc2VsZWN0aW9uSW50ZXJmYWNlLFxuICAgIH0pXG5cbiAgY29uc3Qgc3RhdHVzQnlTb3VyY2UgPSBPYmplY3QudmFsdWVzKHN0YXR1cylcbiAgbGV0IHJlc3VsdE1lc3NhZ2UgPSAnJyxcbiAgICBwZW5kaW5nID0gZmFsc2UsXG4gICAgZmFpbGVkID0gZmFsc2UsXG4gICAgd2FybmluZ3MgPSBmYWxzZSxcbiAgICBlcnJvcnMgPSBmYWxzZVxuICBpZiAoc3RhdHVzQnlTb3VyY2UubGVuZ3RoID09PSAwKSB7XG4gICAgcmVzdWx0TWVzc2FnZSA9ICdIYXMgbm90IGJlZW4gcnVuJ1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IHNvdXJjZXNUaGF0SGF2ZVJldHVybmVkID0gc3RhdHVzQnlTb3VyY2UuZmlsdGVyKFxuICAgICAgKHN0YXR1cykgPT4gc3RhdHVzLmhhc1JldHVybmVkXG4gICAgKVxuXG4gICAgaWYgKHNvdXJjZXNUaGF0SGF2ZVJldHVybmVkLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IHJlc3VsdHMgPSBzdGF0dXNCeVNvdXJjZS5maWx0ZXIoKHN0YXR1cykgPT4gc3RhdHVzLmhhc1JldHVybmVkKVxuXG4gICAgICBsZXQgYXZhaWxhYmxlID0gMFxuICAgICAgbGV0IHBvc3NpYmxlID0gMFxuXG4gICAgICByZXN1bHRzLmZvckVhY2goKHJlc3VsdCkgPT4ge1xuICAgICAgICBhdmFpbGFibGUgKz0gcmVzdWx0Py5jb3VudCA/PyAwXG4gICAgICAgIHBvc3NpYmxlICs9IHJlc3VsdD8uaGl0cyA/PyAwXG4gICAgICB9KVxuXG4gICAgICByZXN1bHRNZXNzYWdlID0gYCR7YXZhaWxhYmxlfSBoaXQke1xuICAgICAgICBhdmFpbGFibGUgPT09IDEgPyAnJyA6ICdzJ1xuICAgICAgfSBvdXQgb2YgJHtmdXp6eVJlc3VsdENvdW50KHBvc3NpYmxlKX0gcG9zc2libGVgXG4gICAgfSBlbHNlIHtcbiAgICAgIHJlc3VsdE1lc3NhZ2UgPSAnU2VhcmNoaW5nLi4uJ1xuICAgIH1cblxuICAgIGZhaWxlZCA9IHNvdXJjZXNUaGF0SGF2ZVJldHVybmVkLnNvbWUoKHN0YXR1cykgPT4gIXN0YXR1cy5zdWNjZXNzZnVsKVxuICAgIHdhcm5pbmdzID0gc291cmNlc1RoYXRIYXZlUmV0dXJuZWQuc29tZShcbiAgICAgIChzdGF0dXMpID0+IHN0YXR1cy53YXJuaW5ncyAmJiBzdGF0dXMud2FybmluZ3MubGVuZ3RoID4gMFxuICAgIClcbiAgICBlcnJvcnMgPSBzb3VyY2VzVGhhdEhhdmVSZXR1cm5lZC5zb21lKChzdGF0dXMpID0+IHtcbiAgICAgIHJldHVybiBzdGF0dXMuZXJyb3JzICYmIHN0YXR1cy5lcnJvcnMubGVuZ3RoID4gMFxuICAgIH0pXG4gICAgcGVuZGluZyA9IGlzU2VhcmNoaW5nXG4gIH1cblxuICByZXR1cm4gKFxuICAgIDw+XG4gICAgICA8ZGl2IGNsYXNzTmFtZT1cImZsZXggZmxleC1yb3cgaXRlbXMtY2VudGVyIGZsZXgtbm93cmFwXCI+XG4gICAgICAgIDxkaXYgY2xhc3NOYW1lPVwibGVhZGluZy01XCI+XG4gICAgICAgICAgPGRpdlxuICAgICAgICAgICAgZGF0YS1pZD1cInJlc3VsdHMtY291bnQtbGFiZWxcIlxuICAgICAgICAgICAgdGl0bGU9e3Jlc3VsdE1lc3NhZ2V9XG4gICAgICAgICAgICBjbGFzc05hbWU9XCIgd2hpdGVzcGFjZS1ub3dyYXBcIlxuICAgICAgICAgID5cbiAgICAgICAgICAgIHtyZXN1bHRNZXNzYWdlfVxuICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgIDxMYXN0UmFuIGN1cnJlbnRBc09mPXtjdXJyZW50QXNPZn0gLz5cbiAgICAgICAgPC9kaXY+XG4gICAgICAgIDxkaXY+XG4gICAgICAgICAgPGRpdj5cbiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwicmVsYXRpdmVcIj5cbiAgICAgICAgICAgICAgPEJ1dHRvblxuICAgICAgICAgICAgICAgIGRhdGEtaWQ9XCJoZWFydGJlYXQtYnV0dG9uXCJcbiAgICAgICAgICAgICAgICB0aXRsZT1cIlNob3cgdGhlIGZ1bGwgc3RhdHVzIGZvciB0aGUgc2VhcmNoLlwiXG4gICAgICAgICAgICAgICAgZGF0YS1oZWxwPVwiU2hvdyB0aGUgZnVsbCBzdGF0dXMgZm9yIHRoZSBzZWFyY2guXCJcbiAgICAgICAgICAgICAgICB7Li4uTXVpQnV0dG9uUHJvcHN9XG4gICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICB7cGVuZGluZyAmJiAoXG4gICAgICAgICAgICAgICAgICA8aVxuICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9XCJmYSBmYS1jaXJjbGUtby1ub3RjaCBmYS1zcGluIGlzLWNyaXRpY2FsLWFuaW1hdGlvblwiXG4gICAgICAgICAgICAgICAgICAgIHN0eWxlPXt7IHBhZGRpbmdSaWdodDogJzJweCcgfX1cbiAgICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgKX1cbiAgICAgICAgICAgICAgICB7KGVycm9ycyB8fCBmYWlsZWQpICYmIChcbiAgICAgICAgICAgICAgICAgIDxFcnJvckljb24gZm9udFNpemU9XCJpbmhlcml0XCIgY29sb3I9XCJlcnJvclwiIC8+XG4gICAgICAgICAgICAgICAgKX1cbiAgICAgICAgICAgICAgICB7d2FybmluZ3MgJiYgPFdhcm5pbmdJY29uIGZvbnRTaXplPVwiaW5oZXJpdFwiIGNvbG9yPVwid2FybmluZ1wiIC8+fVxuICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT1cImZhIGZhLWhlYXJ0YmVhdFwiIC8+XG4gICAgICAgICAgICAgIDwvQnV0dG9uPlxuICAgICAgICAgICAgICA8UG9wb3ZlciB7Li4uTXVpUG9wb3ZlclByb3BzfT5cbiAgICAgICAgICAgICAgICA8UGFwZXJcbiAgICAgICAgICAgICAgICAgIGRhdGEtaWQ9XCJxdWVyeS1zdGF0dXMtY29udGFpbmVyXCJcbiAgICAgICAgICAgICAgICAgIHN0eWxlPXt7IHBhZGRpbmc6ICcyMHB4JyB9fVxuICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwiaW50cmlndWUtdGFibGVcIlxuICAgICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICAgIDxRdWVyeVN0YXR1c1xuICAgICAgICAgICAgICAgICAgICBzdGF0dXNCeVNvdXJjZT17c3RhdHVzQnlTb3VyY2V9XG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5PXtzZWxlY3Rpb25JbnRlcmZhY2UuZ2V0Q3VycmVudFF1ZXJ5KCl9XG4gICAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgIDwvUGFwZXI+XG4gICAgICAgICAgICAgIDwvUG9wb3Zlcj5cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgIDwvZGl2PlxuICAgICAgICA8L2Rpdj5cbiAgICAgIDwvZGl2PlxuICAgIDwvPlxuICApXG59XG5cbmV4cG9ydCBkZWZhdWx0IFF1ZXJ5RmVlZFxuIl19