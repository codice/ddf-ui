import { __assign, __makeTemplateObject, __read } from "tslib";
import * as React from 'react';
import { hot } from 'react-hot-loader';
import Paper from '@mui/material/Paper';
import moment from 'moment';
import styled from 'styled-components';
import Button from '@mui/material/Button';
import { useLazyResultsStatusFromSelectionInterface } from '../selection-interface/hooks';
import Tooltip from '@mui/material/Tooltip';
import { Elevations } from '../theme/theme';
import FilterListIcon from '@mui/icons-material/FilterList';
import { fuzzyHits, fuzzyResultCount } from './fuzzy-results';
import WarningIcon from '@mui/icons-material/Warning';
import ErrorIcon from '@mui/icons-material/Error';
import { useMenuState } from '../menu-state/menu-state';
import Popover from '@mui/material/Popover';
var Cell = styled.td(templateObject_1 || (templateObject_1 = __makeTemplateObject(["\n  padding: 20px;\n  border: solid 1px rgba(120, 120, 120, 0.2);\n"], ["\n  padding: 20px;\n  border: solid 1px rgba(120, 120, 120, 0.2);\n"])));
var HeaderCell = styled.th(templateObject_2 || (templateObject_2 = __makeTemplateObject(["\n  padding: 20px;\n"], ["\n  padding: 20px;\n"])));
var CellValue = function (props) {
    var value = props.value, _a = props.warnings, warnings = _a === void 0 ? [] : _a, _b = props.errors, errors = _b === void 0 ? [] : _b, message = props.message, alwaysShowValue = props.alwaysShowValue, hasReturned = props.hasReturned, successful = props.successful;
    return (React.createElement(React.Fragment, null,
        (errors.length > 0 || !successful) && (React.createElement(Tooltip, { title: React.createElement(Paper, { elevation: Elevations.overlays, className: "p-2" }, (function () {
                if (errors.length > 0) {
                    return errors.map(function (error) { return React.createElement("div", { key: error }, error); });
                }
                else if (message) {
                    return message;
                }
                else {
                    return 'Something went wrong searching this source.';
                }
            })()) },
            React.createElement(ErrorIcon, { style: { paddingRight: '5px' }, color: "error" }))),
        warnings.length > 0 && (React.createElement(Tooltip, { title: React.createElement(Paper, { elevation: Elevations.overlays, className: "p-2" }, warnings.map(function (warning) { return (React.createElement("div", { key: warning }, warning)); })) },
            React.createElement(WarningIcon, { style: { paddingRight: '5px' }, color: "warning" }))),
        alwaysShowValue || (!message && hasReturned) ? value : null,
        !hasReturned && !alwaysShowValue && (React.createElement("span", { className: "fa fa-circle-o-notch fa-spin", title: "Waiting for source to return" }))));
};
var QueryStatusRow = function (_a) {
    var status = _a.status, query = _a.query;
    var hasReturned = status.hasReturned;
    var successful = status.successful;
    var message = status.message;
    var warnings = status.warnings;
    var errors = status.errors;
    var id = status.id;
    return (React.createElement("tr", { "data-id": "source-".concat(id, "-row") },
        React.createElement(Cell, { "data-id": "source-id-label" },
            React.createElement(CellValue, { value: id, hasReturned: hasReturned, successful: successful, warnings: warnings, errors: errors, message: message, alwaysShowValue: true })),
        React.createElement(Cell, { "data-id": "available-label" },
            React.createElement(CellValue, { value: "".concat(status.count, " hit").concat(status.count === 1 ? '' : 's'), hasReturned: hasReturned, successful: successful, warnings: warnings, errors: errors, message: message })),
        React.createElement(Cell, { "data-id": "possible-label" },
            React.createElement(CellValue, { value: fuzzyHits(status.hits), hasReturned: hasReturned, successful: successful, warnings: warnings, errors: errors, message: message })),
        React.createElement(Cell, { "data-id": "time-label" },
            React.createElement(CellValue, { value: status.elapsed / 1000, hasReturned: hasReturned, successful: successful, warnings: warnings, errors: errors, message: message })),
        React.createElement(Cell, { className: "status-filter" },
            React.createElement(Tooltip, { title: "Click to search only this source." },
                React.createElement(Button, { "data-id": "filter-button", onClick: function () {
                        query.set('sources', [status.id]);
                        query.startSearchFromFirstPage();
                    }, color: "primary" },
                    React.createElement(FilterListIcon, { className: "Mui-text-text-primary" }),
                    "Filter")))));
};
var QueryStatus = function (_a) {
    var statusBySource = _a.statusBySource, query = _a.query;
    return (React.createElement("table", null,
        React.createElement("tr", null,
            React.createElement(HeaderCell, null, "Source"),
            React.createElement(HeaderCell, { "data-help": "This is the number of results available based on the current sorting." }, "Available"),
            React.createElement(HeaderCell, { "data-help": "This is the total number of results (hits) that matched your search." }, "Possible"),
            React.createElement(HeaderCell, { "data-help": "This is the time (in seconds) that it took for the search to run." }, "Time (s)"),
            React.createElement(HeaderCell, { "data-help": "Locally filter results to be from a specific source." }, "Filter")),
        React.createElement("tbody", null, statusBySource.map(function (status) {
            return (React.createElement(QueryStatusRow, { key: status.id, status: status, query: query }));
        }))));
};
var LastRan = function (_a) {
    var currentAsOf = _a.currentAsOf;
    var _b = __read(React.useState(moment(currentAsOf).fromNow()), 2), howLongAgo = _b[0], setHowLongAgo = _b[1];
    React.useEffect(function () {
        setHowLongAgo(moment(currentAsOf).fromNow());
        var intervalId = setInterval(function () {
            setHowLongAgo(moment(currentAsOf).fromNow());
        }, 60000);
        return function () {
            clearInterval(intervalId);
        };
    }, [currentAsOf]);
    return React.createElement("div", { style: { whiteSpace: 'nowrap' } },
        "Current as of ",
        howLongAgo);
};
var QueryFeed = function (_a) {
    var selectionInterface = _a.selectionInterface;
    var _b = useMenuState(), MuiButtonProps = _b.MuiButtonProps, MuiPopoverProps = _b.MuiPopoverProps;
    var _c = useLazyResultsStatusFromSelectionInterface({
        selectionInterface: selectionInterface,
    }), status = _c.status, currentAsOf = _c.currentAsOf, isSearching = _c.isSearching;
    var statusBySource = Object.values(status);
    var resultMessage = '', pending = false, failed = false, warnings = false, errors = false;
    if (statusBySource.length === 0) {
        resultMessage = 'Has not been run';
    }
    else {
        var sourcesThatHaveReturned = statusBySource.filter(function (status) { return status.hasReturned; });
        if (sourcesThatHaveReturned.length > 0) {
            var results = statusBySource.filter(function (status) { return status.hasReturned; });
            var available_1 = 0;
            var possible_1 = 0;
            results.forEach(function (result) {
                var _a, _b;
                available_1 += (_a = result === null || result === void 0 ? void 0 : result.count) !== null && _a !== void 0 ? _a : 0;
                possible_1 += (_b = result === null || result === void 0 ? void 0 : result.hits) !== null && _b !== void 0 ? _b : 0;
            });
            resultMessage = "".concat(available_1, " hit").concat(available_1 === 1 ? '' : 's', " out of ").concat(fuzzyResultCount(possible_1), " possible");
        }
        else {
            resultMessage = 'Searching...';
        }
        failed = sourcesThatHaveReturned.some(function (status) { return !status.successful; });
        warnings = sourcesThatHaveReturned.some(function (status) { return status.warnings && status.warnings.length > 0; });
        errors = sourcesThatHaveReturned.some(function (status) {
            return status.errors && status.errors.length > 0;
        });
        pending = isSearching;
    }
    return (React.createElement(React.Fragment, null,
        React.createElement("div", { className: "flex flex-row items-center flex-nowrap" },
            React.createElement("div", { className: "leading-5" },
                React.createElement("div", { "data-id": "results-count-label", title: resultMessage, className: " whitespace-nowrap" }, resultMessage),
                React.createElement(LastRan, { currentAsOf: currentAsOf })),
            React.createElement("div", null,
                React.createElement("div", null,
                    React.createElement("div", { className: "relative" },
                        React.createElement(Button, __assign({ "data-id": "heartbeat-button", title: "Show the full status for the search.", "data-help": "Show the full status for the search." }, MuiButtonProps),
                            pending && (React.createElement("i", { className: "fa fa-circle-o-notch fa-spin is-critical-animation", style: { paddingRight: '2px' } })),
                            (errors || failed) && (React.createElement(ErrorIcon, { fontSize: "inherit", color: "error" })),
                            warnings && React.createElement(WarningIcon, { fontSize: "inherit", color: "warning" }),
                            React.createElement("span", { className: "fa fa-heartbeat" })),
                        React.createElement(Popover, __assign({}, MuiPopoverProps),
                            React.createElement(Paper, { "data-id": "query-status-container", style: { padding: '20px' }, className: "intrigue-table" },
                                React.createElement(QueryStatus, { statusBySource: statusBySource, query: selectionInterface.getCurrentQuery() })))))))));
};
export default hot(module)(QueryFeed);
var templateObject_1, templateObject_2;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVlcnktZmVlZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9tYWluL3dlYmFwcC9jb21wb25lbnQvcmVzdWx0LXNlbGVjdG9yL3F1ZXJ5LWZlZWQudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEtBQUssS0FBSyxNQUFNLE9BQU8sQ0FBQTtBQUM5QixPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sa0JBQWtCLENBQUE7QUFDdEMsT0FBTyxLQUFLLE1BQU0scUJBQXFCLENBQUE7QUFDdkMsT0FBTyxNQUFNLE1BQU0sUUFBUSxDQUFBO0FBQzNCLE9BQU8sTUFBTSxNQUFNLG1CQUFtQixDQUFBO0FBQ3RDLE9BQU8sTUFBTSxNQUFNLHNCQUFzQixDQUFBO0FBRXpDLE9BQU8sRUFBRSwwQ0FBMEMsRUFBRSxNQUFNLDhCQUE4QixDQUFBO0FBQ3pGLE9BQU8sT0FBTyxNQUFNLHVCQUF1QixDQUFBO0FBQzNDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQTtBQUMzQyxPQUFPLGNBQWMsTUFBTSxnQ0FBZ0MsQ0FBQTtBQUMzRCxPQUFPLEVBQUUsU0FBUyxFQUFFLGdCQUFnQixFQUFFLE1BQU0saUJBQWlCLENBQUE7QUFDN0QsT0FBTyxXQUFXLE1BQU0sNkJBQTZCLENBQUE7QUFDckQsT0FBTyxTQUFTLE1BQU0sMkJBQTJCLENBQUE7QUFDakQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDBCQUEwQixDQUFBO0FBQ3ZELE9BQU8sT0FBTyxNQUFNLHVCQUF1QixDQUFBO0FBTTNDLElBQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxFQUFFLHdJQUFBLHFFQUdyQixJQUFBLENBQUE7QUFFRCxJQUFNLFVBQVUsR0FBRyxNQUFNLENBQUMsRUFBRSx5RkFBQSxzQkFFM0IsSUFBQSxDQUFBO0FBWUQsSUFBTSxTQUFTLEdBQUcsVUFBQyxLQUFxQjtJQUVwQyxJQUFBLEtBQUssR0FPSCxLQUFLLE1B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LENBQ0YsQ0FDRixDQUNMLENBQ0osQ0FBQTtBQUNILENBQUMsQ0FBQTtBQUVELGVBQWUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgUmVhY3QgZnJvbSAncmVhY3QnXG5pbXBvcnQgeyBob3QgfSBmcm9tICdyZWFjdC1ob3QtbG9hZGVyJ1xuaW1wb3J0IFBhcGVyIGZyb20gJ0BtdWkvbWF0ZXJpYWwvUGFwZXInXG5pbXBvcnQgbW9tZW50IGZyb20gJ21vbWVudCdcbmltcG9ydCBzdHlsZWQgZnJvbSAnc3R5bGVkLWNvbXBvbmVudHMnXG5pbXBvcnQgQnV0dG9uIGZyb20gJ0BtdWkvbWF0ZXJpYWwvQnV0dG9uJ1xuaW1wb3J0IHsgU3RhdHVzIH0gZnJvbSAnLi4vLi4vanMvbW9kZWwvTGF6eVF1ZXJ5UmVzdWx0L3N0YXR1cydcbmltcG9ydCB7IHVzZUxhenlSZXN1bHRzU3RhdHVzRnJvbVNlbGVjdGlvbkludGVyZmFjZSB9IGZyb20gJy4uL3NlbGVjdGlvbi1pbnRlcmZhY2UvaG9va3MnXG5pbXBvcnQgVG9vbHRpcCBmcm9tICdAbXVpL21hdGVyaWFsL1Rvb2x0aXAnXG5pbXBvcnQgeyBFbGV2YXRpb25zIH0gZnJvbSAnLi4vdGhlbWUvdGhlbWUnXG5pbXBvcnQgRmlsdGVyTGlzdEljb24gZnJvbSAnQG11aS9pY29ucy1tYXRlcmlhbC9GaWx0ZXJMaXN0J1xuaW1wb3J0IHsgZnV6enlIaXRzLCBmdXp6eVJlc3VsdENvdW50IH0gZnJvbSAnLi9mdXp6eS1yZXN1bHRzJ1xuaW1wb3J0IFdhcm5pbmdJY29uIGZyb20gJ0BtdWkvaWNvbnMtbWF0ZXJpYWwvV2FybmluZydcbmltcG9ydCBFcnJvckljb24gZnJvbSAnQG11aS9pY29ucy1tYXRlcmlhbC9FcnJvcidcbmltcG9ydCB7IHVzZU1lbnVTdGF0ZSB9IGZyb20gJy4uL21lbnUtc3RhdGUvbWVudS1zdGF0ZSdcbmltcG9ydCBQb3BvdmVyIGZyb20gJ0BtdWkvbWF0ZXJpYWwvUG9wb3ZlcidcblxudHlwZSBQcm9wcyA9IHtcbiAgc2VsZWN0aW9uSW50ZXJmYWNlOiBhbnlcbn1cblxuY29uc3QgQ2VsbCA9IHN0eWxlZC50ZGBcbiAgcGFkZGluZzogMjBweDtcbiAgYm9yZGVyOiBzb2xpZCAxcHggcmdiYSgxMjAsIDEyMCwgMTIwLCAwLjIpO1xuYFxuXG5jb25zdCBIZWFkZXJDZWxsID0gc3R5bGVkLnRoYFxuICBwYWRkaW5nOiAyMHB4O1xuYFxuXG50eXBlIENlbGxWYWx1ZVByb3BzID0ge1xuICB2YWx1ZTogc3RyaW5nIHwgbnVtYmVyXG4gIGhhc1JldHVybmVkOiBib29sZWFuXG4gIHN1Y2Nlc3NmdWw6IGJvb2xlYW5cbiAgbWVzc2FnZTogc3RyaW5nXG4gIHdhcm5pbmdzOiBzdHJpbmdbXVxuICBlcnJvcnM6IHN0cmluZ1tdXG4gIGFsd2F5c1Nob3dWYWx1ZT86IGJvb2xlYW5cbn1cblxuY29uc3QgQ2VsbFZhbHVlID0gKHByb3BzOiBDZWxsVmFsdWVQcm9wcykgPT4ge1xuICBjb25zdCB7XG4gICAgdmFsdWUsXG4gICAgd2FybmluZ3MgPSBbXSxcbiAgICBlcnJvcnMgPSBbXSxcbiAgICBtZXNzYWdlLFxuICAgIGFsd2F5c1Nob3dWYWx1ZSxcbiAgICBoYXNSZXR1cm5lZCxcbiAgICBzdWNjZXNzZnVsLFxuICB9ID0gcHJvcHNcbiAgcmV0dXJuIChcbiAgICA8UmVhY3QuRnJhZ21lbnQ+XG4gICAgICB7KGVycm9ycy5sZW5ndGggPiAwIHx8ICFzdWNjZXNzZnVsKSAmJiAoXG4gICAgICAgIDxUb29sdGlwXG4gICAgICAgICAgdGl0bGU9e1xuICAgICAgICAgICAgPFBhcGVyIGVsZXZhdGlvbj17RWxldmF0aW9ucy5vdmVybGF5c30gY2xhc3NOYW1lPVwicC0yXCI+XG4gICAgICAgICAgICAgIHsoKCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChlcnJvcnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIGVycm9ycy5tYXAoKGVycm9yKSA9PiA8ZGl2IGtleT17ZXJyb3J9PntlcnJvcn08L2Rpdj4pXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChtZXNzYWdlKSB7XG4gICAgICAgICAgICAgICAgICByZXR1cm4gbWVzc2FnZVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICByZXR1cm4gJ1NvbWV0aGluZyB3ZW50IHdyb25nIHNlYXJjaGluZyB0aGlzIHNvdXJjZS4nXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9KSgpfVxuICAgICAgICAgICAgPC9QYXBlcj5cbiAgICAgICAgICB9XG4gICAgICAgID5cbiAgICAgICAgICA8RXJyb3JJY29uIHN0eWxlPXt7IHBhZGRpbmdSaWdodDogJzVweCcgfX0gY29sb3I9XCJlcnJvclwiIC8+XG4gICAgICAgIDwvVG9vbHRpcD5cbiAgICAgICl9XG4gICAgICB7d2FybmluZ3MubGVuZ3RoID4gMCAmJiAoXG4gICAgICAgIDxUb29sdGlwXG4gICAgICAgICAgdGl0bGU9e1xuICAgICAgICAgICAgPFBhcGVyIGVsZXZhdGlvbj17RWxldmF0aW9ucy5vdmVybGF5c30gY2xhc3NOYW1lPVwicC0yXCI+XG4gICAgICAgICAgICAgIHt3YXJuaW5ncy5tYXAoKHdhcm5pbmcpID0+IChcbiAgICAgICAgICAgICAgICA8ZGl2IGtleT17d2FybmluZ30+e3dhcm5pbmd9PC9kaXY+XG4gICAgICAgICAgICAgICkpfVxuICAgICAgICAgICAgPC9QYXBlcj5cbiAgICAgICAgICB9XG4gICAgICAgID5cbiAgICAgICAgICA8V2FybmluZ0ljb24gc3R5bGU9e3sgcGFkZGluZ1JpZ2h0OiAnNXB4JyB9fSBjb2xvcj1cIndhcm5pbmdcIiAvPlxuICAgICAgICA8L1Rvb2x0aXA+XG4gICAgICApfVxuICAgICAge2Fsd2F5c1Nob3dWYWx1ZSB8fCAoIW1lc3NhZ2UgJiYgaGFzUmV0dXJuZWQpID8gdmFsdWUgOiBudWxsfVxuICAgICAgeyFoYXNSZXR1cm5lZCAmJiAhYWx3YXlzU2hvd1ZhbHVlICYmIChcbiAgICAgICAgPHNwYW5cbiAgICAgICAgICBjbGFzc05hbWU9XCJmYSBmYS1jaXJjbGUtby1ub3RjaCBmYS1zcGluXCJcbiAgICAgICAgICB0aXRsZT1cIldhaXRpbmcgZm9yIHNvdXJjZSB0byByZXR1cm5cIlxuICAgICAgICAvPlxuICAgICAgKX1cbiAgICA8L1JlYWN0LkZyYWdtZW50PlxuICApXG59XG5cbmNvbnN0IFF1ZXJ5U3RhdHVzUm93ID0gKHsgc3RhdHVzLCBxdWVyeSB9OiB7IHN0YXR1czogU3RhdHVzOyBxdWVyeTogYW55IH0pID0+IHtcbiAgbGV0IGhhc1JldHVybmVkID0gc3RhdHVzLmhhc1JldHVybmVkXG4gIGxldCBzdWNjZXNzZnVsID0gc3RhdHVzLnN1Y2Nlc3NmdWxcbiAgbGV0IG1lc3NhZ2UgPSBzdGF0dXMubWVzc2FnZVxuXG4gIGxldCB3YXJuaW5ncyA9IHN0YXR1cy53YXJuaW5nc1xuICBsZXQgZXJyb3JzID0gc3RhdHVzLmVycm9yc1xuICBsZXQgaWQgPSBzdGF0dXMuaWRcblxuICByZXR1cm4gKFxuICAgIDx0ciBkYXRhLWlkPXtgc291cmNlLSR7aWR9LXJvd2B9PlxuICAgICAgPENlbGwgZGF0YS1pZD1cInNvdXJjZS1pZC1sYWJlbFwiPlxuICAgICAgICA8Q2VsbFZhbHVlXG4gICAgICAgICAgdmFsdWU9e2lkfVxuICAgICAgICAgIGhhc1JldHVybmVkPXtoYXNSZXR1cm5lZH1cbiAgICAgICAgICBzdWNjZXNzZnVsPXtzdWNjZXNzZnVsfVxuICAgICAgICAgIHdhcm5pbmdzPXt3YXJuaW5nc31cbiAgICAgICAgICBlcnJvcnM9e2Vycm9yc31cbiAgICAgICAgICBtZXNzYWdlPXttZXNzYWdlfVxuICAgICAgICAgIGFsd2F5c1Nob3dWYWx1ZVxuICAgICAgICAvPlxuICAgICAgPC9DZWxsPlxuICAgICAgPENlbGwgZGF0YS1pZD1cImF2YWlsYWJsZS1sYWJlbFwiPlxuICAgICAgICA8Q2VsbFZhbHVlXG4gICAgICAgICAgdmFsdWU9e2Ake3N0YXR1cy5jb3VudH0gaGl0JHtzdGF0dXMuY291bnQgPT09IDEgPyAnJyA6ICdzJ31gfVxuICAgICAgICAgIGhhc1JldHVybmVkPXtoYXNSZXR1cm5lZH1cbiAgICAgICAgICBzdWNjZXNzZnVsPXtzdWNjZXNzZnVsfVxuICAgICAgICAgIHdhcm5pbmdzPXt3YXJuaW5nc31cbiAgICAgICAgICBlcnJvcnM9e2Vycm9yc31cbiAgICAgICAgICBtZXNzYWdlPXttZXNzYWdlfVxuICAgICAgICAvPlxuICAgICAgPC9DZWxsPlxuICAgICAgPENlbGwgZGF0YS1pZD1cInBvc3NpYmxlLWxhYmVsXCI+XG4gICAgICAgIDxDZWxsVmFsdWVcbiAgICAgICAgICB2YWx1ZT17ZnV6enlIaXRzKHN0YXR1cy5oaXRzKX1cbiAgICAgICAgICBoYXNSZXR1cm5lZD17aGFzUmV0dXJuZWR9XG4gICAgICAgICAgc3VjY2Vzc2Z1bD17c3VjY2Vzc2Z1bH1cbiAgICAgICAgICB3YXJuaW5ncz17d2FybmluZ3N9XG4gICAgICAgICAgZXJyb3JzPXtlcnJvcnN9XG4gICAgICAgICAgbWVzc2FnZT17bWVzc2FnZX1cbiAgICAgICAgLz5cbiAgICAgIDwvQ2VsbD5cbiAgICAgIDxDZWxsIGRhdGEtaWQ9XCJ0aW1lLWxhYmVsXCI+XG4gICAgICAgIDxDZWxsVmFsdWVcbiAgICAgICAgICB2YWx1ZT17c3RhdHVzLmVsYXBzZWQgLyAxMDAwfVxuICAgICAgICAgIGhhc1JldHVybmVkPXtoYXNSZXR1cm5lZH1cbiAgICAgICAgICBzdWNjZXNzZnVsPXtzdWNjZXNzZnVsfVxuICAgICAgICAgIHdhcm5pbmdzPXt3YXJuaW5nc31cbiAgICAgICAgICBlcnJvcnM9e2Vycm9yc31cbiAgICAgICAgICBtZXNzYWdlPXttZXNzYWdlfVxuICAgICAgICAvPlxuICAgICAgPC9DZWxsPlxuICAgICAgPENlbGwgY2xhc3NOYW1lPVwic3RhdHVzLWZpbHRlclwiPlxuICAgICAgICA8VG9vbHRpcCB0aXRsZT1cIkNsaWNrIHRvIHNlYXJjaCBvbmx5IHRoaXMgc291cmNlLlwiPlxuICAgICAgICAgIDxCdXR0b25cbiAgICAgICAgICAgIGRhdGEtaWQ9XCJmaWx0ZXItYnV0dG9uXCJcbiAgICAgICAgICAgIG9uQ2xpY2s9eygpID0+IHtcbiAgICAgICAgICAgICAgcXVlcnkuc2V0KCdzb3VyY2VzJywgW3N0YXR1cy5pZF0pXG4gICAgICAgICAgICAgIHF1ZXJ5LnN0YXJ0U2VhcmNoRnJvbUZpcnN0UGFnZSgpXG4gICAgICAgICAgICB9fVxuICAgICAgICAgICAgY29sb3I9XCJwcmltYXJ5XCJcbiAgICAgICAgICA+XG4gICAgICAgICAgICA8RmlsdGVyTGlzdEljb24gY2xhc3NOYW1lPVwiTXVpLXRleHQtdGV4dC1wcmltYXJ5XCIgLz5cbiAgICAgICAgICAgIEZpbHRlclxuICAgICAgICAgIDwvQnV0dG9uPlxuICAgICAgICA8L1Rvb2x0aXA+XG4gICAgICA8L0NlbGw+XG4gICAgPC90cj5cbiAgKVxufVxuXG5jb25zdCBRdWVyeVN0YXR1cyA9ICh7XG4gIHN0YXR1c0J5U291cmNlLFxuICBxdWVyeSxcbn06IHtcbiAgc3RhdHVzQnlTb3VyY2U6IFN0YXR1c1tdXG4gIHF1ZXJ5OiBhbnlcbn0pID0+IHtcbiAgcmV0dXJuIChcbiAgICA8dGFibGU+XG4gICAgICA8dHI+XG4gICAgICAgIDxIZWFkZXJDZWxsPlNvdXJjZTwvSGVhZGVyQ2VsbD5cbiAgICAgICAgPEhlYWRlckNlbGwgZGF0YS1oZWxwPVwiVGhpcyBpcyB0aGUgbnVtYmVyIG9mIHJlc3VsdHMgYXZhaWxhYmxlIGJhc2VkIG9uIHRoZSBjdXJyZW50IHNvcnRpbmcuXCI+XG4gICAgICAgICAgQXZhaWxhYmxlXG4gICAgICAgIDwvSGVhZGVyQ2VsbD5cbiAgICAgICAgPEhlYWRlckNlbGwgZGF0YS1oZWxwPVwiVGhpcyBpcyB0aGUgdG90YWwgbnVtYmVyIG9mIHJlc3VsdHMgKGhpdHMpIHRoYXQgbWF0Y2hlZCB5b3VyIHNlYXJjaC5cIj5cbiAgICAgICAgICBQb3NzaWJsZVxuICAgICAgICA8L0hlYWRlckNlbGw+XG4gICAgICAgIDxIZWFkZXJDZWxsIGRhdGEtaGVscD1cIlRoaXMgaXMgdGhlIHRpbWUgKGluIHNlY29uZHMpIHRoYXQgaXQgdG9vayBmb3IgdGhlIHNlYXJjaCB0byBydW4uXCI+XG4gICAgICAgICAgVGltZSAocylcbiAgICAgICAgPC9IZWFkZXJDZWxsPlxuICAgICAgICA8SGVhZGVyQ2VsbCBkYXRhLWhlbHA9XCJMb2NhbGx5IGZpbHRlciByZXN1bHRzIHRvIGJlIGZyb20gYSBzcGVjaWZpYyBzb3VyY2UuXCI+XG4gICAgICAgICAgRmlsdGVyXG4gICAgICAgIDwvSGVhZGVyQ2VsbD5cbiAgICAgIDwvdHI+XG4gICAgICA8dGJvZHk+XG4gICAgICAgIHtzdGF0dXNCeVNvdXJjZS5tYXAoKHN0YXR1cykgPT4ge1xuICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8UXVlcnlTdGF0dXNSb3cga2V5PXtzdGF0dXMuaWR9IHN0YXR1cz17c3RhdHVzfSBxdWVyeT17cXVlcnl9IC8+XG4gICAgICAgICAgKVxuICAgICAgICB9KX1cbiAgICAgIDwvdGJvZHk+XG4gICAgPC90YWJsZT5cbiAgKVxufVxuXG5jb25zdCBMYXN0UmFuID0gKHsgY3VycmVudEFzT2YgfTogeyBjdXJyZW50QXNPZjogbnVtYmVyIH0pID0+IHtcbiAgY29uc3QgW2hvd0xvbmdBZ28sIHNldEhvd0xvbmdBZ29dID0gUmVhY3QudXNlU3RhdGUoXG4gICAgbW9tZW50KGN1cnJlbnRBc09mKS5mcm9tTm93KClcbiAgKVxuICBSZWFjdC51c2VFZmZlY3QoKCkgPT4ge1xuICAgIHNldEhvd0xvbmdBZ28obW9tZW50KGN1cnJlbnRBc09mKS5mcm9tTm93KCkpXG4gICAgY29uc3QgaW50ZXJ2YWxJZCA9IHNldEludGVydmFsKCgpID0+IHtcbiAgICAgIHNldEhvd0xvbmdBZ28obW9tZW50KGN1cnJlbnRBc09mKS5mcm9tTm93KCkpXG4gICAgfSwgNjAwMDApXG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIGNsZWFySW50ZXJ2YWwoaW50ZXJ2YWxJZClcbiAgICB9XG4gIH0sIFtjdXJyZW50QXNPZl0pXG4gIHJldHVybiA8ZGl2IHN0eWxlPXt7IHdoaXRlU3BhY2U6ICdub3dyYXAnIH19PkN1cnJlbnQgYXMgb2Yge2hvd0xvbmdBZ299PC9kaXY+XG59XG5cbmNvbnN0IFF1ZXJ5RmVlZCA9ICh7IHNlbGVjdGlvbkludGVyZmFjZSB9OiBQcm9wcykgPT4ge1xuICBjb25zdCB7IE11aUJ1dHRvblByb3BzLCBNdWlQb3BvdmVyUHJvcHMgfSA9IHVzZU1lbnVTdGF0ZSgpXG4gIGNvbnN0IHsgc3RhdHVzLCBjdXJyZW50QXNPZiwgaXNTZWFyY2hpbmcgfSA9XG4gICAgdXNlTGF6eVJlc3VsdHNTdGF0dXNGcm9tU2VsZWN0aW9uSW50ZXJmYWNlKHtcbiAgICAgIHNlbGVjdGlvbkludGVyZmFjZSxcbiAgICB9KVxuXG4gIGNvbnN0IHN0YXR1c0J5U291cmNlID0gT2JqZWN0LnZhbHVlcyhzdGF0dXMpXG4gIGxldCByZXN1bHRNZXNzYWdlID0gJycsXG4gICAgcGVuZGluZyA9IGZhbHNlLFxuICAgIGZhaWxlZCA9IGZhbHNlLFxuICAgIHdhcm5pbmdzID0gZmFsc2UsXG4gICAgZXJyb3JzID0gZmFsc2VcbiAgaWYgKHN0YXR1c0J5U291cmNlLmxlbmd0aCA9PT0gMCkge1xuICAgIHJlc3VsdE1lc3NhZ2UgPSAnSGFzIG5vdCBiZWVuIHJ1bidcbiAgfSBlbHNlIHtcbiAgICBjb25zdCBzb3VyY2VzVGhhdEhhdmVSZXR1cm5lZCA9IHN0YXR1c0J5U291cmNlLmZpbHRlcihcbiAgICAgIChzdGF0dXMpID0+IHN0YXR1cy5oYXNSZXR1cm5lZFxuICAgIClcblxuICAgIGlmIChzb3VyY2VzVGhhdEhhdmVSZXR1cm5lZC5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCByZXN1bHRzID0gc3RhdHVzQnlTb3VyY2UuZmlsdGVyKChzdGF0dXMpID0+IHN0YXR1cy5oYXNSZXR1cm5lZClcblxuICAgICAgbGV0IGF2YWlsYWJsZSA9IDBcbiAgICAgIGxldCBwb3NzaWJsZSA9IDBcblxuICAgICAgcmVzdWx0cy5mb3JFYWNoKChyZXN1bHQpID0+IHtcbiAgICAgICAgYXZhaWxhYmxlICs9IHJlc3VsdD8uY291bnQgPz8gMFxuICAgICAgICBwb3NzaWJsZSArPSByZXN1bHQ/LmhpdHMgPz8gMFxuICAgICAgfSlcblxuICAgICAgcmVzdWx0TWVzc2FnZSA9IGAke2F2YWlsYWJsZX0gaGl0JHtcbiAgICAgICAgYXZhaWxhYmxlID09PSAxID8gJycgOiAncydcbiAgICAgIH0gb3V0IG9mICR7ZnV6enlSZXN1bHRDb3VudChwb3NzaWJsZSl9IHBvc3NpYmxlYFxuICAgIH0gZWxzZSB7XG4gICAgICByZXN1bHRNZXNzYWdlID0gJ1NlYXJjaGluZy4uLidcbiAgICB9XG5cbiAgICBmYWlsZWQgPSBzb3VyY2VzVGhhdEhhdmVSZXR1cm5lZC5zb21lKChzdGF0dXMpID0+ICFzdGF0dXMuc3VjY2Vzc2Z1bClcbiAgICB3YXJuaW5ncyA9IHNvdXJjZXNUaGF0SGF2ZVJldHVybmVkLnNvbWUoXG4gICAgICAoc3RhdHVzKSA9PiBzdGF0dXMud2FybmluZ3MgJiYgc3RhdHVzLndhcm5pbmdzLmxlbmd0aCA+IDBcbiAgICApXG4gICAgZXJyb3JzID0gc291cmNlc1RoYXRIYXZlUmV0dXJuZWQuc29tZSgoc3RhdHVzKSA9PiB7XG4gICAgICByZXR1cm4gc3RhdHVzLmVycm9ycyAmJiBzdGF0dXMuZXJyb3JzLmxlbmd0aCA+IDBcbiAgICB9KVxuICAgIHBlbmRpbmcgPSBpc1NlYXJjaGluZ1xuICB9XG5cbiAgcmV0dXJuIChcbiAgICA8PlxuICAgICAgPGRpdiBjbGFzc05hbWU9XCJmbGV4IGZsZXgtcm93IGl0ZW1zLWNlbnRlciBmbGV4LW5vd3JhcFwiPlxuICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cImxlYWRpbmctNVwiPlxuICAgICAgICAgIDxkaXZcbiAgICAgICAgICAgIGRhdGEtaWQ9XCJyZXN1bHRzLWNvdW50LWxhYmVsXCJcbiAgICAgICAgICAgIHRpdGxlPXtyZXN1bHRNZXNzYWdlfVxuICAgICAgICAgICAgY2xhc3NOYW1lPVwiIHdoaXRlc3BhY2Utbm93cmFwXCJcbiAgICAgICAgICA+XG4gICAgICAgICAgICB7cmVzdWx0TWVzc2FnZX1cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICA8TGFzdFJhbiBjdXJyZW50QXNPZj17Y3VycmVudEFzT2Z9IC8+XG4gICAgICAgIDwvZGl2PlxuICAgICAgICA8ZGl2PlxuICAgICAgICAgIDxkaXY+XG4gICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cInJlbGF0aXZlXCI+XG4gICAgICAgICAgICAgIDxCdXR0b25cbiAgICAgICAgICAgICAgICBkYXRhLWlkPVwiaGVhcnRiZWF0LWJ1dHRvblwiXG4gICAgICAgICAgICAgICAgdGl0bGU9XCJTaG93IHRoZSBmdWxsIHN0YXR1cyBmb3IgdGhlIHNlYXJjaC5cIlxuICAgICAgICAgICAgICAgIGRhdGEtaGVscD1cIlNob3cgdGhlIGZ1bGwgc3RhdHVzIGZvciB0aGUgc2VhcmNoLlwiXG4gICAgICAgICAgICAgICAgey4uLk11aUJ1dHRvblByb3BzfVxuICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAge3BlbmRpbmcgJiYgKFxuICAgICAgICAgICAgICAgICAgPGlcbiAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwiZmEgZmEtY2lyY2xlLW8tbm90Y2ggZmEtc3BpbiBpcy1jcml0aWNhbC1hbmltYXRpb25cIlxuICAgICAgICAgICAgICAgICAgICBzdHlsZT17eyBwYWRkaW5nUmlnaHQ6ICcycHgnIH19XG4gICAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgICl9XG4gICAgICAgICAgICAgICAgeyhlcnJvcnMgfHwgZmFpbGVkKSAmJiAoXG4gICAgICAgICAgICAgICAgICA8RXJyb3JJY29uIGZvbnRTaXplPVwiaW5oZXJpdFwiIGNvbG9yPVwiZXJyb3JcIiAvPlxuICAgICAgICAgICAgICAgICl9XG4gICAgICAgICAgICAgICAge3dhcm5pbmdzICYmIDxXYXJuaW5nSWNvbiBmb250U2l6ZT1cImluaGVyaXRcIiBjb2xvcj1cIndhcm5pbmdcIiAvPn1cbiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9XCJmYSBmYS1oZWFydGJlYXRcIiAvPlxuICAgICAgICAgICAgICA8L0J1dHRvbj5cbiAgICAgICAgICAgICAgPFBvcG92ZXIgey4uLk11aVBvcG92ZXJQcm9wc30+XG4gICAgICAgICAgICAgICAgPFBhcGVyXG4gICAgICAgICAgICAgICAgICBkYXRhLWlkPVwicXVlcnktc3RhdHVzLWNvbnRhaW5lclwiXG4gICAgICAgICAgICAgICAgICBzdHlsZT17eyBwYWRkaW5nOiAnMjBweCcgfX1cbiAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cImludHJpZ3VlLXRhYmxlXCJcbiAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICA8UXVlcnlTdGF0dXNcbiAgICAgICAgICAgICAgICAgICAgc3RhdHVzQnlTb3VyY2U9e3N0YXR1c0J5U291cmNlfVxuICAgICAgICAgICAgICAgICAgICBxdWVyeT17c2VsZWN0aW9uSW50ZXJmYWNlLmdldEN1cnJlbnRRdWVyeSgpfVxuICAgICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgICA8L1BhcGVyPlxuICAgICAgICAgICAgICA8L1BvcG92ZXI+XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgPC9kaXY+XG4gICAgICA8L2Rpdj5cbiAgICA8Lz5cbiAgKVxufVxuXG5leHBvcnQgZGVmYXVsdCBob3QobW9kdWxlKShRdWVyeUZlZWQpXG4iXX0=