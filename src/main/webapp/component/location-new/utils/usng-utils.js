/**
 * Copyright (c) Codice Foundation
 *
 * This is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser
 * General Public License as published by the Free Software Foundation, either version 3 of the
 * License, or any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
 * even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details. A copy of the GNU Lesser General Public License
 * is distributed along with this program and can be found at
 * <http://www.gnu.org/licenses/lgpl.html>.
 *
 **/
import wkx from 'wkx';
import * as usng from 'usng.js';
// @ts-expect-error ts-migrate(2554) FIXME: Expected 1 arguments, but got 0.
var converter = new usng.Converter();
import { computeCircle, toKilometers } from './geo-helper';
import errorMessages from './errors';
export function validateUsngGrid(grid) {
    return converter.isUSNG(grid) !== 0;
}
function gridIsBlank(grid) {
    return grid.length === 0;
}
// @ts-expect-error ts-migrate(7030) FIXME: Not all code paths return a value.
function inputIsBlank(usng) {
    switch (usng.shape) {
        case 'point':
            return gridIsBlank(usng.point);
        case 'circle':
            return gridIsBlank(usng.circle.point);
        case 'line':
            return usng.line.list.length === 0;
        case 'polygon':
            return usng.polygon.list.length === 0;
        case 'boundingbox':
            return gridIsBlank(usng.boundingbox);
    }
}
/*
 *  USNG/MGRS -> WKT conversion utils
 */
function usngGridToWktPoint(grid) {
    var LL = converter.USNGtoLL(grid, true);
    return new wkx.Point(LL.lon, LL.lat);
}
export function usngToWkt(usng) {
    var _a;
    if (inputIsBlank(usng)) {
        return null;
    }
    var wkt = null;
    var points = [];
    switch (usng.shape) {
        case 'point':
            wkt = usngGridToWktPoint(usng.point).toWkt();
            break;
        case 'circle':
            var distance = toKilometers(usng.circle.radius, usng.circle.units);
            wkt = (_a = computeCircle(usngGridToWktPoint(usng.circle.point), distance, 36)) === null || _a === void 0 ? void 0 : _a.toWkt();
            break;
        case 'line':
            if (usng.line.list.length > 0) {
                usng.line.list.map(function (grid) { return points.push(usngGridToWktPoint(grid)); });
                wkt = new wkx.LineString(points).toWkt();
            }
            break;
        case 'polygon':
            if (usng.polygon.list.length > 0) {
                usng.polygon.list.map(function (grid) {
                    return points.push(usngGridToWktPoint(grid));
                });
                var p1 = points[0];
                var p2 = points[points.length - 1];
                if (p1.x !== p2.x || p1.y !== p2.y) {
                    points.push(new wkx.Point(p1.x, p1.y));
                }
                wkt = new wkx.Polygon(points).toWkt();
            }
            break;
        case 'boundingbox':
            var grid = converter.isUSNG(usng.boundingbox);
            var bbox = converter.USNGtoLL(grid, false);
            var minLon = bbox.west;
            var minLat = bbox.south;
            var maxLon = bbox.east;
            var maxLat = bbox.north;
            var nw = new wkx.Point(minLon, maxLat);
            var ne = new wkx.Point(maxLon, maxLat);
            var se = new wkx.Point(maxLon, minLat);
            var sw = new wkx.Point(minLon, minLat);
            wkt = new wkx.Polygon([nw, ne, se, sw, nw]).toWkt();
            break;
    }
    return wkt;
}
/*
 *  USNG/MGRS validation utils
 */
export function validateUsng(usng) {
    if (inputIsBlank(usng)) {
        return { valid: true, error: null };
    }
    var valid = true;
    var error = null;
    switch (usng.shape) {
        case 'point':
            if (!validateUsngGrid(usng.point)) {
                valid = false;
                error = errorMessages.invalidUsngGrid;
            }
            break;
        case 'circle':
            var radius = parseFloat(usng.circle.radius);
            if (isNaN(radius) ||
                radius <= 0 ||
                toKilometers(radius, usng.circle.units) > 10000) {
                valid = false;
                error = errorMessages.invalidRadius;
            }
            else if (!validateUsngGrid(usng.circle.point)) {
                valid = false;
                error = errorMessages.invalidUsngGrid;
            }
            break;
        case 'line':
            if (!usng.line.list.every(validateUsngGrid)) {
                valid = false;
                error = errorMessages.invalidList;
            }
            else if (usng.line.list.length < 2) {
                valid = false;
                error = errorMessages.tooFewPointsLine;
            }
            break;
        case 'polygon':
            if (!usng.polygon.list.every(validateUsngGrid)) {
                valid = false;
                error = errorMessages.invalidList;
            }
            else if (usng.line.list.length < 3) {
                valid = false;
                error = errorMessages.tooFewPointsPolygon;
            }
            break;
        case 'boundingbox':
            if (!validateUsngGrid(usng.boundingbox)) {
                valid = false;
                error = errorMessages.invalidUsngGrid;
            }
            break;
    }
    return { valid: valid, error: error };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNuZy11dGlscy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3NyYy9tYWluL3dlYmFwcC9jb21wb25lbnQvbG9jYXRpb24tbmV3L3V0aWxzL3VzbmctdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7SUFhSTtBQUNKLE9BQU8sR0FBRyxNQUFNLEtBQUssQ0FBQTtBQUVyQixPQUFPLEtBQUssSUFBSSxNQUFNLFNBQVMsQ0FBQTtBQUMvQiw0RUFBNEU7QUFDNUUsSUFBTSxTQUFTLEdBQUcsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUE7QUFFdEMsT0FBTyxFQUFFLGFBQWEsRUFBRSxZQUFZLEVBQUUsTUFBTSxjQUFjLENBQUE7QUFDMUQsT0FBTyxhQUFhLE1BQU0sVUFBVSxDQUFBO0FBRXBDLE1BQU0sVUFBVSxnQkFBZ0IsQ0FBQyxJQUFTO0lBQ3hDLE9BQU8sU0FBUyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUE7QUFDckMsQ0FBQztBQUVELFNBQVMsV0FBVyxDQUFDLElBQVM7SUFDNUIsT0FBTyxJQUFJLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQTtBQUMxQixDQUFDO0FBRUQsOEVBQThFO0FBQzlFLFNBQVMsWUFBWSxDQUFDLElBQVM7SUFDN0IsUUFBUSxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDbkIsS0FBSyxPQUFPO1lBQ1YsT0FBTyxXQUFXLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBQ2hDLEtBQUssUUFBUTtZQUNYLE9BQU8sV0FBVyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUE7UUFDdkMsS0FBSyxNQUFNO1lBQ1QsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFBO1FBQ3BDLEtBQUssU0FBUztZQUNaLE9BQU8sSUFBSSxDQUFDLE9B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QyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO2dCQUNyQyxLQUFLLEdBQUcsS0FBSyxDQUFBO2dCQUNiLEtBQUssR0FBRyxhQUFhLENBQUMsZ0JBQWdCLENBQUE7WUFDeEMsQ0FBQztZQUNELE1BQUs7UUFDUCxLQUFLLFNBQVM7WUFDWixJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLGdCQUFnQixDQUFDLEVBQUUsQ0FBQztnQkFDL0MsS0FBSyxHQUFHLEtBQUssQ0FBQTtnQkFDYixLQUFLLEdBQUcsYUFBYSxDQUFDLFdBQVcsQ0FBQTtZQUNuQyxDQUFDO2lCQUFNLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO2dCQUNyQyxLQUFLLEdBQUcsS0FBSyxDQUFBO2dCQUNiLEtBQUssR0FBRyxhQUFhLENBQUMsbUJBQW1CLENBQUE7WUFDM0MsQ0FBQztZQUNELE1BQUs7UUFDUCxLQUFLLGFBQWE7WUFDaEIsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDO2dCQUN4QyxLQUFLLEdBQUcsS0FBSyxDQUFBO2dCQUNiLEtBQUssR0FBRyxhQUFhLENBQUMsZUFBZSxDQUFBO1lBQ3ZDLENBQUM7WUFDRCxNQUFLO0lBQ1QsQ0FBQztJQUNELE9BQU8sRUFBRSxLQUFLLE9BQUEsRUFBRSxLQUFLLE9BQUEsRUFBRSxDQUFBO0FBQ3pCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAoYykgQ29kaWNlIEZvdW5kYXRpb25cbiAqXG4gKiBUaGlzIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgTGVzc2VyXG4gKiBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieSB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZVxuICogTGljZW5zZSwgb3IgYW55IGxhdGVyIHZlcnNpb24uXG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dFxuICogZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuIFNlZSB0aGUgR05VXG4gKiBMZXNzZXIgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLiBBIGNvcHkgb2YgdGhlIEdOVSBMZXNzZXIgR2VuZXJhbCBQdWJsaWMgTGljZW5zZVxuICogaXMgZGlzdHJpYnV0ZWQgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0gYW5kIGNhbiBiZSBmb3VuZCBhdFxuICogPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy9sZ3BsLmh0bWw+LlxuICpcbiAqKi9cbmltcG9ydCB3a3ggZnJvbSAnd2t4J1xuXG5pbXBvcnQgKiBhcyB1c25nIGZyb20gJ3VzbmcuanMnXG4vLyBAdHMtZXhwZWN0LWVycm9yIHRzLW1pZ3JhdGUoMjU1NCkgRklYTUU6IEV4cGVjdGVkIDEgYXJndW1lbnRzLCBidXQgZ290IDAuXG5jb25zdCBjb252ZXJ0ZXIgPSBuZXcgdXNuZy5Db252ZXJ0ZXIoKVxuXG5pbXBvcnQgeyBjb21wdXRlQ2lyY2xlLCB0b0tpbG9tZXRlcnMgfSBmcm9tICcuL2dlby1oZWxwZXInXG5pbXBvcnQgZXJyb3JNZXNzYWdlcyBmcm9tICcuL2Vycm9ycydcblxuZXhwb3J0IGZ1bmN0aW9uIHZhbGlkYXRlVXNuZ0dyaWQoZ3JpZDogYW55KSB7XG4gIHJldHVybiBjb252ZXJ0ZXIuaXNVU05HKGdyaWQpICE9PSAwXG59XG5cbmZ1bmN0aW9uIGdyaWRJc0JsYW5rKGdyaWQ6IGFueSkge1xuICByZXR1cm4gZ3JpZC5sZW5ndGggPT09IDBcbn1cblxuLy8gQHRzLWV4cGVjdC1lcnJvciB0cy1taWdyYXRlKDcwMzApIEZJWE1FOiBOb3QgYWxsIGNvZGUgcGF0aHMgcmV0dXJuIGEgdmFsdWUuXG5mdW5jdGlvbiBpbnB1dElzQmxhbmsodXNuZzogYW55KSB7XG4gIHN3aXRjaCAodXNuZy5zaGFwZSkge1xuICAgIGNhc2UgJ3BvaW50JzpcbiAgICAgIHJldHVybiBncmlkSXNCbGFuayh1c25nLnBvaW50KVxuICAgIGNhc2UgJ2NpcmNsZSc6XG4gICAgICByZXR1cm4gZ3JpZElzQmxhbmsodXNuZy5jaXJjbGUucG9pbnQpXG4gICAgY2FzZSAnbGluZSc6XG4gICAgICByZXR1cm4gdXNuZy5saW5lLmxpc3QubGVuZ3RoID09PSAwXG4gICAgY2FzZSAncG9seWdvbic6XG4gICAgICByZXR1cm4gdXNuZy5wb2x5Z29uLmxpc3QubGVuZ3RoID09PSAwXG4gICAgY2FzZSAnYm91bmRpbmdib3gnOlxuICAgICAgcmV0dXJuIGdyaWRJc0JsYW5rKHVzbmcuYm91bmRpbmdib3gpXG4gIH1cbn1cblxuLypcbiAqICBVU05HL01HUlMgLT4gV0tUIGNvbnZlcnNpb24gdXRpbHNcbiAqL1xuZnVuY3Rpb24gdXNuZ0dyaWRUb1drdFBvaW50KGdyaWQ6IGFueSkge1xuICBjb25zdCBMTCA9IGNvbnZlcnRlci5VU05HdG9MTChncmlkLCB0cnVlKVxuICByZXR1cm4gbmV3IHdreC5Qb2ludChMTC5sb24sIExMLmxhdClcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHVzbmdUb1drdCh1c25nOiBhbnkpIHtcbiAgaWYgKGlucHV0SXNCbGFuayh1c25nKSkge1xuICAgIHJldHVybiBudWxsXG4gIH1cblxuICBsZXQgd2t0ID0gbnVsbFxuICBjb25zdCBwb2ludHM6IGFueSA9IFtdXG4gIHN3aXRjaCAodXNuZy5zaGFwZSkge1xuICAgIGNhc2UgJ3BvaW50JzpcbiAgICAgIHdrdCA9IHVzbmdHcmlkVG9Xa3RQb2ludCh1c25nLnBvaW50KS50b1drdCgpXG4gICAgICBicmVha1xuICAgIGNhc2UgJ2NpcmNsZSc6XG4gICAgICBjb25zdCBkaXN0YW5jZSA9IHRvS2lsb21ldGVycyh1c25nLmNpcmNsZS5yYWRpdXMsIHVzbmcuY2lyY2xlLnVuaXRzKVxuICAgICAgd2t0ID0gY29tcHV0ZUNpcmNsZShcbiAgICAgICAgdXNuZ0dyaWRUb1drdFBvaW50KHVzbmcuY2lyY2xlLnBvaW50KSxcbiAgICAgICAgZGlzdGFuY2UsXG4gICAgICAgIDM2XG4gICAgICApPy50b1drdCgpXG4gICAgICBicmVha1xuICAgIGNhc2UgJ2xpbmUnOlxuICAgICAgaWYgKHVzbmcubGluZS5saXN0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgdXNuZy5saW5lLmxpc3QubWFwKChncmlkOiBhbnkpID0+IHBvaW50cy5wdXNoKHVzbmdHcmlkVG9Xa3RQb2ludChncmlkKSkpXG4gICAgICAgIHdrdCA9IG5ldyB3a3guTGluZVN0cmluZyhwb2ludHMpLnRvV2t0KClcbiAgICAgIH1cbiAgICAgIGJyZWFrXG4gICAgY2FzZSAncG9seWdvbic6XG4gICAgICBpZiAodXNuZy5wb2x5Z29uLmxpc3QubGVuZ3RoID4gMCkge1xuICAgICAgICB1c25nLnBvbHlnb24ubGlzdC5tYXAoKGdyaWQ6IGFueSkgPT5cbiAgICAgICAgICBwb2ludHMucHVzaCh1c25nR3JpZFRvV2t0UG9pbnQoZ3JpZCkpXG4gICAgICAgIClcbiAgICAgICAgY29uc3QgcDEgPSBwb2ludHNbMF1cbiAgICAgICAgY29uc3QgcDIgPSBwb2ludHNbcG9pbnRzLmxlbmd0aCAtIDFdXG4gICAgICAgIGlmIChwMS54ICE9PSBwMi54IHx8IHAxLnkgIT09IHAyLnkpIHtcbiAgICAgICAgICBwb2ludHMucHVzaChuZXcgd2t4LlBvaW50KHAxLngsIHAxLnkpKVxuICAgICAgICB9XG4gICAgICAgIHdrdCA9IG5ldyB3a3guUG9seWdvbihwb2ludHMpLnRvV2t0KClcbiAgICAgIH1cbiAgICAgIGJyZWFrXG4gICAgY2FzZSAnYm91bmRpbmdib3gnOlxuICAgICAgY29uc3QgZ3JpZCA9IGNvbnZlcnRlci5pc1VTTkcodXNuZy5ib3VuZGluZ2JveClcbiAgICAgIGNvbnN0IGJib3ggPSBjb252ZXJ0ZXIuVVNOR3RvTEwoZ3JpZCwgZmFsc2UpXG4gICAgICBjb25zdCBtaW5Mb24gPSBiYm94Lndlc3RcbiAgICAgIGNvbnN0IG1pbkxhdCA9IGJib3guc291dGhcbiAgICAgIGNvbnN0IG1heExvbiA9IGJib3guZWFzdFxuICAgICAgY29uc3QgbWF4TGF0ID0gYmJveC5ub3J0aFxuICAgICAgY29uc3QgbncgPSBuZXcgd2t4LlBvaW50KG1pbkxvbiwgbWF4TGF0KVxuICAgICAgY29uc3QgbmUgPSBuZXcgd2t4LlBvaW50KG1heExvbiwgbWF4TGF0KVxuICAgICAgY29uc3Qgc2UgPSBuZXcgd2t4LlBvaW50KG1heExvbiwgbWluTGF0KVxuICAgICAgY29uc3Qgc3cgPSBuZXcgd2t4LlBvaW50KG1pbkxvbiwgbWluTGF0KVxuICAgICAgd2t0ID0gbmV3IHdreC5Qb2x5Z29uKFtudywgbmUsIHNlLCBzdywgbnddKS50b1drdCgpXG4gICAgICBicmVha1xuICB9XG4gIHJldHVybiB3a3Rcbn1cblxuLypcbiAqICBVU05HL01HUlMgdmFsaWRhdGlvbiB1dGlsc1xuICovXG5leHBvcnQgZnVuY3Rpb24gdmFsaWRhdGVVc25nKHVzbmc6IGFueSkge1xuICBpZiAoaW5wdXRJc0JsYW5rKHVzbmcpKSB7XG4gICAgcmV0dXJuIHsgdmFsaWQ6IHRydWUsIGVycm9yOiBudWxsIH1cbiAgfVxuXG4gIGxldCB2YWxpZCA9IHRydWVcbiAgbGV0IGVycm9yID0gbnVsbFxuICBzd2l0Y2ggKHVzbmcuc2hhcGUpIHtcbiAgICBjYXNlICdwb2ludCc6XG4gICAgICBpZiAoIXZhbGlkYXRlVXNuZ0dyaWQodXNuZy5wb2ludCkpIHtcbiAgICAgICAgdmFsaWQgPSBmYWxzZVxuICAgICAgICBlcnJvciA9IGVycm9yTWVzc2FnZXMuaW52YWxpZFVzbmdHcmlkXG4gICAgICB9XG4gICAgICBicmVha1xuICAgIGNhc2UgJ2NpcmNsZSc6XG4gICAgICBjb25zdCByYWRpdXMgPSBwYXJzZUZsb2F0KHVzbmcuY2lyY2xlLnJhZGl1cylcbiAgICAgIGlmIChcbiAgICAgICAgaXNOYU4ocmFkaXVzKSB8fFxuICAgICAgICByYWRpdXMgPD0gMCB8fFxuICAgICAgICB0b0tpbG9tZXRlcnMocmFkaXVzLCB1c25nLmNpcmNsZS51bml0cykgPiAxMDAwMFxuICAgICAgKSB7XG4gICAgICAgIHZhbGlkID0gZmFsc2VcbiAgICAgICAgZXJyb3IgPSBlcnJvck1lc3NhZ2VzLmludmFsaWRSYWRpdXNcbiAgICAgIH0gZWxzZSBpZiAoIXZhbGlkYXRlVXNuZ0dyaWQodXNuZy5jaXJjbGUucG9pbnQpKSB7XG4gICAgICAgIHZhbGlkID0gZmFsc2VcbiAgICAgICAgZXJyb3IgPSBlcnJvck1lc3NhZ2VzLmludmFsaWRVc25nR3JpZFxuICAgICAgfVxuICAgICAgYnJlYWtcbiAgICBjYXNlICdsaW5lJzpcbiAgICAgIGlmICghdXNuZy5saW5lLmxpc3QuZXZlcnkodmFsaWRhdGVVc25nR3JpZCkpIHtcbiAgICAgICAgdmFsaWQgPSBmYWxzZVxuICAgICAgICBlcnJvciA9IGVycm9yTWVzc2FnZXMuaW52YWxpZExpc3RcbiAgICAgIH0gZWxzZSBpZiAodXNuZy5saW5lLmxpc3QubGVuZ3RoIDwgMikge1xuICAgICAgICB2YWxpZCA9IGZhbHNlXG4gICAgICAgIGVycm9yID0gZXJyb3JNZXNzYWdlcy50b29GZXdQb2ludHNMaW5lXG4gICAgICB9XG4gICAgICBicmVha1xuICAgIGNhc2UgJ3BvbHlnb24nOlxuICAgICAgaWYgKCF1c25nLnBvbHlnb24ubGlzdC5ldmVyeSh2YWxpZGF0ZVVzbmdHcmlkKSkge1xuICAgICAgICB2YWxpZCA9IGZhbHNlXG4gICAgICAgIGVycm9yID0gZXJyb3JNZXNzYWdlcy5pbnZhbGlkTGlzdFxuICAgICAgfSBlbHNlIGlmICh1c25nLmxpbmUubGlzdC5sZW5ndGggPCAzKSB7XG4gICAgICAgIHZhbGlkID0gZmFsc2VcbiAgICAgICAgZXJyb3IgPSBlcnJvck1lc3NhZ2VzLnRvb0Zld1BvaW50c1BvbHlnb25cbiAgICAgIH1cbiAgICAgIGJyZWFrXG4gICAgY2FzZSAnYm91bmRpbmdib3gnOlxuICAgICAgaWYgKCF2YWxpZGF0ZVVzbmdHcmlkKHVzbmcuYm91bmRpbmdib3gpKSB7XG4gICAgICAgIHZhbGlkID0gZmFsc2VcbiAgICAgICAgZXJyb3IgPSBlcnJvck1lc3NhZ2VzLmludmFsaWRVc25nR3JpZFxuICAgICAgfVxuICAgICAgYnJlYWtcbiAgfVxuICByZXR1cm4geyB2YWxpZCwgZXJyb3IgfVxufVxuIl19