/**
 * Copyright (c) Codice Foundation
 *
 * This is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser
 * General Public License as published by the Free Software Foundation, either version 3 of the
 * License, or any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
 * even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details. A copy of the GNU Lesser General Public License
 * is distributed along with this program and can be found at
 * <http://www.gnu.org/licenses/lgpl.html>.
 *
 **/
import wkx from 'wkx';
import * as usng from 'usng.js';
// @ts-expect-error ts-migrate(2554) FIXME: Expected 1 arguments, but got 0.
var converter = new usng.Converter();
import { computeCircle, toKilometers } from './geo-helper';
import errorMessages from './errors';
export function validateUsngGrid(grid) {
    return converter.isUSNG(grid) !== 0;
}
function gridIsBlank(grid) {
    return grid.length === 0;
}
// @ts-expect-error ts-migrate(7030) FIXME: Not all code paths return a value.
function inputIsBlank(usng) {
    switch (usng.shape) {
        case 'point':
            return gridIsBlank(usng.point);
        case 'circle':
            return gridIsBlank(usng.circle.point);
        case 'line':
            return usng.line.list.length === 0;
        case 'polygon':
            return usng.polygon.list.length === 0;
        case 'boundingbox':
            return gridIsBlank(usng.boundingbox);
    }
}
/*
 *  USNG/MGRS -> WKT conversion utils
 */
function usngGridToWktPoint(grid) {
    var LL = converter.USNGtoLL(grid, true);
    return new wkx.Point(LL.lon, LL.lat);
}
export function usngToWkt(usng) {
    var _a;
    if (inputIsBlank(usng)) {
        return null;
    }
    var wkt = null;
    var points = [];
    switch (usng.shape) {
        case 'point':
            wkt = usngGridToWktPoint(usng.point).toWkt();
            break;
        case 'circle':
            var distance = toKilometers(usng.circle.radius, usng.circle.units);
            wkt = (_a = computeCircle(usngGridToWktPoint(usng.circle.point), distance, 36)) === null || _a === void 0 ? void 0 : _a.toWkt();
            break;
        case 'line':
            if (usng.line.list.length > 0) {
                usng.line.list.map(function (grid) { return points.push(usngGridToWktPoint(grid)); });
                wkt = new wkx.LineString(points).toWkt();
            }
            break;
        case 'polygon':
            if (usng.polygon.list.length > 0) {
                usng.polygon.list.map(function (grid) {
                    return points.push(usngGridToWktPoint(grid));
                });
                var p1 = points[0];
                var p2 = points[points.length - 1];
                if (p1.x !== p2.x || p1.y !== p2.y) {
                    points.push(new wkx.Point(p1.x, p1.y));
                }
                wkt = new wkx.Polygon(points).toWkt();
            }
            break;
        case 'boundingbox':
            var grid = converter.isUSNG(usng.boundingbox);
            var bbox = converter.USNGtoLL(grid, false);
            var minLon = bbox.west;
            var minLat = bbox.south;
            var maxLon = bbox.east;
            var maxLat = bbox.north;
            var nw = new wkx.Point(minLon, maxLat);
            var ne = new wkx.Point(maxLon, maxLat);
            var se = new wkx.Point(maxLon, minLat);
            var sw = new wkx.Point(minLon, minLat);
            wkt = new wkx.Polygon([nw, ne, se, sw, nw]).toWkt();
            break;
    }
    return wkt;
}
/*
 *  USNG/MGRS validation utils
 */
export function validateUsng(usng) {
    if (inputIsBlank(usng)) {
        return { valid: true, error: null };
    }
    var valid = true;
    var error = null;
    switch (usng.shape) {
        case 'point':
            if (!validateUsngGrid(usng.point)) {
                valid = false;
                error = errorMessages.invalidUsngGrid;
            }
            break;
        case 'circle':
            var radius = parseFloat(usng.circle.radius);
            if (isNaN(radius) ||
                radius <= 0 ||
                toKilometers(radius, usng.circle.units) > 10000) {
                valid = false;
                error = errorMessages.invalidRadius;
            }
            else if (!validateUsngGrid(usng.circle.point)) {
                valid = false;
                error = errorMessages.invalidUsngGrid;
            }
            break;
        case 'line':
            if (!usng.line.list.every(validateUsngGrid)) {
                valid = false;
                error = errorMessages.invalidList;
            }
            else if (usng.line.list.length < 2) {
                valid = false;
                error = errorMessages.tooFewPointsLine;
            }
            break;
        case 'polygon':
            if (!usng.polygon.list.every(validateUsngGrid)) {
                valid = false;
                error = errorMessages.invalidList;
            }
            else if (usng.line.list.length < 3) {
                valid = false;
                error = errorMessages.tooFewPointsPolygon;
            }
            break;
        case 'boundingbox':
            if (!validateUsngGrid(usng.boundingbox)) {
                valid = false;
                error = errorMessages.invalidUsngGrid;
            }
            break;
    }
    return { valid: valid, error: error };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNuZy11dGlscy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3NyYy9tYWluL3dlYmFwcC9jb21wb25lbnQvbG9jYXRpb24tbmV3L3V0aWxzL3VzbmctdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7SUFhSTtBQUNKLE9BQU8sR0FBRyxNQUFNLEtBQUssQ0FBQTtBQUVyQixPQUFPLEtBQUssSUFBSSxNQUFNLFNBQVMsQ0FBQTtBQUMvQiw0RUFBNEU7QUFDNUUsSUFBTSxTQUFTLEdBQUcsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUE7QUFFdEMsT0FBTyxFQUFFLGFBQWEsRUFBRSxZQUFZLEVBQUUsTUFBTSxjQUFjLENBQUE7QUFDMUQsT0FBTyxhQUFhLE1BQU0sVUFBVSxDQUFBO0FBRXBDLE1BQU0sVUFBVSxnQkFBZ0IsQ0FBQyxJQUFTO0lBQ3hDLE9BQU8sU0FBUyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUE7QUFDckMsQ0FBQztBQUVELFNBQVMsV0FBVyxDQUFDLElBQVM7SUFDNUIsT0FBTyxJQUFJLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQTtBQUMxQixDQUFDO0FBRUQsOEVBQThFO0FBQzlFLFNBQVMsWUFBWSxDQUFDLElBQVM7SUFDN0IsUUFBUSxJQUFJLENBQUMsS0FBSyxFQUFFO1FBQ2xCLEtBQUssT0FBTztZQUNWLE9BQU8sV0FBVyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUNoQyxLQUFLLFFBQVE7WUFDWCxPQUFPLFdBQVcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBQ3ZDLEtBQUssTUFBTTtZQUNULE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQTtRQUNwQyxLQUFLLFNBQVM7WUFDWixPQUFPLElBQUksQ0FBQyxPQUFPLENB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Q1AsS0FBSyxTQUFTO1lBQ1osSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFO2dCQUM5QyxLQUFLLEdBQUcsS0FBSyxDQUFBO2dCQUNiLEtBQUssR0FBRyxhQUFhLENBQUMsV0FBVyxDQUFBO2FBQ2xDO2lCQUFNLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDcEMsS0FBSyxHQUFHLEtBQUssQ0FBQTtnQkFDYixLQUFLLEdBQUcsYUFBYSxDQUFDLG1CQUFtQixDQUFBO2FBQzFDO1lBQ0QsTUFBSztRQUNQLEtBQUssYUFBYTtZQUNoQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFO2dCQUN2QyxLQUFLLEdBQUcsS0FBSyxDQUFBO2dCQUNiLEtBQUssR0FBRyxhQUFhLENBQUMsZUFBZSxDQUFBO2FBQ3RDO1lBQ0QsTUFBSztLQUNSO0lBQ0QsT0FBTyxFQUFFLEtBQUssT0FBQSxFQUFFLEtBQUssT0FBQSxFQUFFLENBQUE7QUFDekIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSBDb2RpY2UgRm91bmRhdGlvblxuICpcbiAqIFRoaXMgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeSBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBMZXNzZXJcbiAqIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5IHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlXG4gKiBMaWNlbnNlLCBvciBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0XG4gKiBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gU2VlIHRoZSBHTlVcbiAqIExlc3NlciBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuIEEgY29weSBvZiB0aGUgR05VIExlc3NlciBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlXG4gKiBpcyBkaXN0cmlidXRlZCBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbSBhbmQgY2FuIGJlIGZvdW5kIGF0XG4gKiA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzL2xncGwuaHRtbD4uXG4gKlxuICoqL1xuaW1wb3J0IHdreCBmcm9tICd3a3gnXG5cbmltcG9ydCAqIGFzIHVzbmcgZnJvbSAndXNuZy5qcydcbi8vIEB0cy1leHBlY3QtZXJyb3IgdHMtbWlncmF0ZSgyNTU0KSBGSVhNRTogRXhwZWN0ZWQgMSBhcmd1bWVudHMsIGJ1dCBnb3QgMC5cbmNvbnN0IGNvbnZlcnRlciA9IG5ldyB1c25nLkNvbnZlcnRlcigpXG5cbmltcG9ydCB7IGNvbXB1dGVDaXJjbGUsIHRvS2lsb21ldGVycyB9IGZyb20gJy4vZ2VvLWhlbHBlcidcbmltcG9ydCBlcnJvck1lc3NhZ2VzIGZyb20gJy4vZXJyb3JzJ1xuXG5leHBvcnQgZnVuY3Rpb24gdmFsaWRhdGVVc25nR3JpZChncmlkOiBhbnkpIHtcbiAgcmV0dXJuIGNvbnZlcnRlci5pc1VTTkcoZ3JpZCkgIT09IDBcbn1cblxuZnVuY3Rpb24gZ3JpZElzQmxhbmsoZ3JpZDogYW55KSB7XG4gIHJldHVybiBncmlkLmxlbmd0aCA9PT0gMFxufVxuXG4vLyBAdHMtZXhwZWN0LWVycm9yIHRzLW1pZ3JhdGUoNzAzMCkgRklYTUU6IE5vdCBhbGwgY29kZSBwYXRocyByZXR1cm4gYSB2YWx1ZS5cbmZ1bmN0aW9uIGlucHV0SXNCbGFuayh1c25nOiBhbnkpIHtcbiAgc3dpdGNoICh1c25nLnNoYXBlKSB7XG4gICAgY2FzZSAncG9pbnQnOlxuICAgICAgcmV0dXJuIGdyaWRJc0JsYW5rKHVzbmcucG9pbnQpXG4gICAgY2FzZSAnY2lyY2xlJzpcbiAgICAgIHJldHVybiBncmlkSXNCbGFuayh1c25nLmNpcmNsZS5wb2ludClcbiAgICBjYXNlICdsaW5lJzpcbiAgICAgIHJldHVybiB1c25nLmxpbmUubGlzdC5sZW5ndGggPT09IDBcbiAgICBjYXNlICdwb2x5Z29uJzpcbiAgICAgIHJldHVybiB1c25nLnBvbHlnb24ubGlzdC5sZW5ndGggPT09IDBcbiAgICBjYXNlICdib3VuZGluZ2JveCc6XG4gICAgICByZXR1cm4gZ3JpZElzQmxhbmsodXNuZy5ib3VuZGluZ2JveClcbiAgfVxufVxuXG4vKlxuICogIFVTTkcvTUdSUyAtPiBXS1QgY29udmVyc2lvbiB1dGlsc1xuICovXG5mdW5jdGlvbiB1c25nR3JpZFRvV2t0UG9pbnQoZ3JpZDogYW55KSB7XG4gIGNvbnN0IExMID0gY29udmVydGVyLlVTTkd0b0xMKGdyaWQsIHRydWUpXG4gIHJldHVybiBuZXcgd2t4LlBvaW50KExMLmxvbiwgTEwubGF0KVxufVxuXG5leHBvcnQgZnVuY3Rpb24gdXNuZ1RvV2t0KHVzbmc6IGFueSkge1xuICBpZiAoaW5wdXRJc0JsYW5rKHVzbmcpKSB7XG4gICAgcmV0dXJuIG51bGxcbiAgfVxuXG4gIGxldCB3a3QgPSBudWxsXG4gIGNvbnN0IHBvaW50czogYW55ID0gW11cbiAgc3dpdGNoICh1c25nLnNoYXBlKSB7XG4gICAgY2FzZSAncG9pbnQnOlxuICAgICAgd2t0ID0gdXNuZ0dyaWRUb1drdFBvaW50KHVzbmcucG9pbnQpLnRvV2t0KClcbiAgICAgIGJyZWFrXG4gICAgY2FzZSAnY2lyY2xlJzpcbiAgICAgIGNvbnN0IGRpc3RhbmNlID0gdG9LaWxvbWV0ZXJzKHVzbmcuY2lyY2xlLnJhZGl1cywgdXNuZy5jaXJjbGUudW5pdHMpXG4gICAgICB3a3QgPSBjb21wdXRlQ2lyY2xlKFxuICAgICAgICB1c25nR3JpZFRvV2t0UG9pbnQodXNuZy5jaXJjbGUucG9pbnQpLFxuICAgICAgICBkaXN0YW5jZSxcbiAgICAgICAgMzZcbiAgICAgICk/LnRvV2t0KClcbiAgICAgIGJyZWFrXG4gICAgY2FzZSAnbGluZSc6XG4gICAgICBpZiAodXNuZy5saW5lLmxpc3QubGVuZ3RoID4gMCkge1xuICAgICAgICB1c25nLmxpbmUubGlzdC5tYXAoKGdyaWQ6IGFueSkgPT4gcG9pbnRzLnB1c2godXNuZ0dyaWRUb1drdFBvaW50KGdyaWQpKSlcbiAgICAgICAgd2t0ID0gbmV3IHdreC5MaW5lU3RyaW5nKHBvaW50cykudG9Xa3QoKVxuICAgICAgfVxuICAgICAgYnJlYWtcbiAgICBjYXNlICdwb2x5Z29uJzpcbiAgICAgIGlmICh1c25nLnBvbHlnb24ubGlzdC5sZW5ndGggPiAwKSB7XG4gICAgICAgIHVzbmcucG9seWdvbi5saXN0Lm1hcCgoZ3JpZDogYW55KSA9PlxuICAgICAgICAgIHBvaW50cy5wdXNoKHVzbmdHcmlkVG9Xa3RQb2ludChncmlkKSlcbiAgICAgICAgKVxuICAgICAgICBjb25zdCBwMSA9IHBvaW50c1swXVxuICAgICAgICBjb25zdCBwMiA9IHBvaW50c1twb2ludHMubGVuZ3RoIC0gMV1cbiAgICAgICAgaWYgKHAxLnggIT09IHAyLnggfHwgcDEueSAhPT0gcDIueSkge1xuICAgICAgICAgIHBvaW50cy5wdXNoKG5ldyB3a3guUG9pbnQocDEueCwgcDEueSkpXG4gICAgICAgIH1cbiAgICAgICAgd2t0ID0gbmV3IHdreC5Qb2x5Z29uKHBvaW50cykudG9Xa3QoKVxuICAgICAgfVxuICAgICAgYnJlYWtcbiAgICBjYXNlICdib3VuZGluZ2JveCc6XG4gICAgICBjb25zdCBncmlkID0gY29udmVydGVyLmlzVVNORyh1c25nLmJvdW5kaW5nYm94KVxuICAgICAgY29uc3QgYmJveCA9IGNvbnZlcnRlci5VU05HdG9MTChncmlkLCBmYWxzZSlcbiAgICAgIGNvbnN0IG1pbkxvbiA9IGJib3gud2VzdFxuICAgICAgY29uc3QgbWluTGF0ID0gYmJveC5zb3V0aFxuICAgICAgY29uc3QgbWF4TG9uID0gYmJveC5lYXN0XG4gICAgICBjb25zdCBtYXhMYXQgPSBiYm94Lm5vcnRoXG4gICAgICBjb25zdCBudyA9IG5ldyB3a3guUG9pbnQobWluTG9uLCBtYXhMYXQpXG4gICAgICBjb25zdCBuZSA9IG5ldyB3a3guUG9pbnQobWF4TG9uLCBtYXhMYXQpXG4gICAgICBjb25zdCBzZSA9IG5ldyB3a3guUG9pbnQobWF4TG9uLCBtaW5MYXQpXG4gICAgICBjb25zdCBzdyA9IG5ldyB3a3guUG9pbnQobWluTG9uLCBtaW5MYXQpXG4gICAgICB3a3QgPSBuZXcgd2t4LlBvbHlnb24oW253LCBuZSwgc2UsIHN3LCBud10pLnRvV2t0KClcbiAgICAgIGJyZWFrXG4gIH1cbiAgcmV0dXJuIHdrdFxufVxuXG4vKlxuICogIFVTTkcvTUdSUyB2YWxpZGF0aW9uIHV0aWxzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB2YWxpZGF0ZVVzbmcodXNuZzogYW55KSB7XG4gIGlmIChpbnB1dElzQmxhbmsodXNuZykpIHtcbiAgICByZXR1cm4geyB2YWxpZDogdHJ1ZSwgZXJyb3I6IG51bGwgfVxuICB9XG5cbiAgbGV0IHZhbGlkID0gdHJ1ZVxuICBsZXQgZXJyb3IgPSBudWxsXG4gIHN3aXRjaCAodXNuZy5zaGFwZSkge1xuICAgIGNhc2UgJ3BvaW50JzpcbiAgICAgIGlmICghdmFsaWRhdGVVc25nR3JpZCh1c25nLnBvaW50KSkge1xuICAgICAgICB2YWxpZCA9IGZhbHNlXG4gICAgICAgIGVycm9yID0gZXJyb3JNZXNzYWdlcy5pbnZhbGlkVXNuZ0dyaWRcbiAgICAgIH1cbiAgICAgIGJyZWFrXG4gICAgY2FzZSAnY2lyY2xlJzpcbiAgICAgIGNvbnN0IHJhZGl1cyA9IHBhcnNlRmxvYXQodXNuZy5jaXJjbGUucmFkaXVzKVxuICAgICAgaWYgKFxuICAgICAgICBpc05hTihyYWRpdXMpIHx8XG4gICAgICAgIHJhZGl1cyA8PSAwIHx8XG4gICAgICAgIHRvS2lsb21ldGVycyhyYWRpdXMsIHVzbmcuY2lyY2xlLnVuaXRzKSA+IDEwMDAwXG4gICAgICApIHtcbiAgICAgICAgdmFsaWQgPSBmYWxzZVxuICAgICAgICBlcnJvciA9IGVycm9yTWVzc2FnZXMuaW52YWxpZFJhZGl1c1xuICAgICAgfSBlbHNlIGlmICghdmFsaWRhdGVVc25nR3JpZCh1c25nLmNpcmNsZS5wb2ludCkpIHtcbiAgICAgICAgdmFsaWQgPSBmYWxzZVxuICAgICAgICBlcnJvciA9IGVycm9yTWVzc2FnZXMuaW52YWxpZFVzbmdHcmlkXG4gICAgICB9XG4gICAgICBicmVha1xuICAgIGNhc2UgJ2xpbmUnOlxuICAgICAgaWYgKCF1c25nLmxpbmUubGlzdC5ldmVyeSh2YWxpZGF0ZVVzbmdHcmlkKSkge1xuICAgICAgICB2YWxpZCA9IGZhbHNlXG4gICAgICAgIGVycm9yID0gZXJyb3JNZXNzYWdlcy5pbnZhbGlkTGlzdFxuICAgICAgfSBlbHNlIGlmICh1c25nLmxpbmUubGlzdC5sZW5ndGggPCAyKSB7XG4gICAgICAgIHZhbGlkID0gZmFsc2VcbiAgICAgICAgZXJyb3IgPSBlcnJvck1lc3NhZ2VzLnRvb0Zld1BvaW50c0xpbmVcbiAgICAgIH1cbiAgICAgIGJyZWFrXG4gICAgY2FzZSAncG9seWdvbic6XG4gICAgICBpZiAoIXVzbmcucG9seWdvbi5saXN0LmV2ZXJ5KHZhbGlkYXRlVXNuZ0dyaWQpKSB7XG4gICAgICAgIHZhbGlkID0gZmFsc2VcbiAgICAgICAgZXJyb3IgPSBlcnJvck1lc3NhZ2VzLmludmFsaWRMaXN0XG4gICAgICB9IGVsc2UgaWYgKHVzbmcubGluZS5saXN0Lmxlbmd0aCA8IDMpIHtcbiAgICAgICAgdmFsaWQgPSBmYWxzZVxuICAgICAgICBlcnJvciA9IGVycm9yTWVzc2FnZXMudG9vRmV3UG9pbnRzUG9seWdvblxuICAgICAgfVxuICAgICAgYnJlYWtcbiAgICBjYXNlICdib3VuZGluZ2JveCc6XG4gICAgICBpZiAoIXZhbGlkYXRlVXNuZ0dyaWQodXNuZy5ib3VuZGluZ2JveCkpIHtcbiAgICAgICAgdmFsaWQgPSBmYWxzZVxuICAgICAgICBlcnJvciA9IGVycm9yTWVzc2FnZXMuaW52YWxpZFVzbmdHcmlkXG4gICAgICB9XG4gICAgICBicmVha1xuICB9XG4gIHJldHVybiB7IHZhbGlkLCBlcnJvciB9XG59XG4iXX0=