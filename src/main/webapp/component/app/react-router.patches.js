import { __assign, __extends, __read, __spreadArray } from "tslib";
import { jsx as _jsx } from "react/jsx-runtime";
import { UNSAFE_LocationContext, UNSAFE_NavigationContext, } from 'react-router-dom';
import React from 'react';
import { Subscribable } from '../../js/model/Base/base-classes';
import { useSubscribable } from '../../js/model/Base/base-classes.hooks';
import { GoldenLayoutWindowCommunicationEvents } from '../golden-layout/cross-window-communication';
/**
 * This module provides a solution for sharing React Router v6 context across multiple React roots, as well as golden-layout subwindows (popouts).
 * See https://github.com/remix-run/react-router/issues/10089 for more details.
 *
 * Problem:
 * - React Router v6 uses internal history/location objects that aren't shared between different Router instances
 * - Our application uses multiple React roots due to golden-layout integration
 * - Golden-layout doesn't have native React support, so we need to patch the contexts somehow
 * - We need the ability to also handle popouts, which have their own Router instances.
 */
var SubscribableNavigationContextClass = /** @class */ (function (_super) {
    __extends(SubscribableNavigationContextClass, _super);
    function SubscribableNavigationContextClass() {
        var _this = _super.apply(this, __spreadArray([], __read(arguments), false)) || this;
        _this.navigationContext = null;
        return _this;
    }
    SubscribableNavigationContextClass.prototype.updateNavigationContext = function (navigationContext) {
        this.navigationContext = navigationContext;
        this._notifySubscribers({ thing: 'update' });
    };
    return SubscribableNavigationContextClass;
}(Subscribable));
var SubscribableLocationContextClass = /** @class */ (function (_super) {
    __extends(SubscribableLocationContextClass, _super);
    function SubscribableLocationContextClass() {
        var _this = _super.apply(this, __spreadArray([], __read(arguments), false)) || this;
        _this.locationContext = null;
        return _this;
    }
    SubscribableLocationContextClass.prototype.updateLocationContext = function (locationContext) {
        this.locationContext = locationContext;
        this._notifySubscribers({ thing: 'update' });
    };
    return SubscribableLocationContextClass;
}(Subscribable));
var SubscribableNavigationContext = new SubscribableNavigationContextClass();
var SubscribableLocationContext = new SubscribableLocationContextClass();
/**
 * Component that syncs the current React Router context to our shared variables.  While we could alternatively use prop drilling by
 * accessing context and passing it to the new root, this is much simpler.
 *
 * This should be rendered within the Router component of the primary React root
 */
export var SyncReactRouterContextToVariables = function () {
    var navigationContext = React.useContext(UNSAFE_NavigationContext);
    var locationContext = React.useContext(UNSAFE_LocationContext);
    React.useEffect(function () {
        SubscribableNavigationContext.updateNavigationContext(navigationContext);
    }, [navigationContext]);
    React.useEffect(function () {
        SubscribableLocationContext.updateLocationContext(locationContext);
    }, [locationContext]);
    return null;
};
function useSharedNavigationContext() {
    var _a = __read(React.useState(SubscribableNavigationContext.navigationContext), 2), navigationContext = _a[0], setNavigationContext = _a[1];
    useSubscribable(SubscribableNavigationContext, 'update', function () {
        setNavigationContext(SubscribableNavigationContext.navigationContext);
    });
    return navigationContext;
}
function useSharedLocationContext() {
    var _a = __read(React.useState(SubscribableLocationContext.locationContext), 2), locationContext = _a[0], setLocationContext = _a[1];
    useSubscribable(SubscribableLocationContext, 'update', function () {
        setLocationContext(SubscribableLocationContext.locationContext);
    });
    return locationContext;
}
/**
 * Provider component that provides the shared Router context to its children
 * This should be used in secondary React roots to receive the shared context
 */
export var PatchReactRouterContext = function (_a) {
    var children = _a.children;
    var navigationContext = useSharedNavigationContext();
    var locationContext = useSharedLocationContext();
    if (!navigationContext || !locationContext) {
        throw new Error('Navigation or location context not found');
    }
    return (_jsx(UNSAFE_NavigationContext.Provider, { value: navigationContext, children: _jsx(UNSAFE_LocationContext.Provider, { value: locationContext, children: children }) }));
};
/**
 *  In subwindows (popouts) we want to redirect navigation events back to the main window through the event bus.
 */
function patchNavigationContextForGoldenLayoutSubwindows(_a) {
    var navigationContext = _a.navigationContext, goldenLayout = _a.goldenLayout;
    if (!navigationContext) {
        throw new Error('Navigation context not found');
    }
    var replaceWrapper = function (to, options) {
        goldenLayout.eventHub.emit(GoldenLayoutWindowCommunicationEvents.consumeNavigationChange, {
            replace: [to, __assign(__assign({}, options), { replace: true })],
        });
    };
    var pushWrapper = function (to, options) {
        goldenLayout.eventHub.emit(GoldenLayoutWindowCommunicationEvents.consumeNavigationChange, {
            push: [to, options],
        });
    };
    Object.defineProperty(navigationContext.navigator, 'replace', {
        value: replaceWrapper,
        writable: true,
    });
    Object.defineProperty(navigationContext.navigator, 'push', {
        value: pushWrapper,
        writable: true,
    });
    return navigationContext;
}
/**
 * Hook that provides the shared Router context for golden layout subwindows (popouts)
 */
function useSharedNavigationContextForGoldenLayoutSubwindows(_a) {
    var goldenLayout = _a.goldenLayout;
    var _b = __read(React.useState(patchNavigationContextForGoldenLayoutSubwindows({
        navigationContext: SubscribableNavigationContext.navigationContext,
        goldenLayout: goldenLayout,
    })), 2), navigationContext = _b[0], setNavigationContext = _b[1];
    useSubscribable(SubscribableNavigationContext, 'update', function () {
        setNavigationContext(patchNavigationContextForGoldenLayoutSubwindows({
            navigationContext: SubscribableNavigationContext.navigationContext,
            goldenLayout: goldenLayout,
        }));
    });
    return navigationContext;
}
/**
 * Provider component that patches the React Router context for golden layout subwindows (popouts), and also handles normal React roots when applicable.
 */
export var PatchReactRouterContextForGoldenLayoutSubwindows = function (_a) {
    var children = _a.children, goldenLayout = _a.goldenLayout;
    if (!goldenLayout || !goldenLayout.isSubWindow) {
        return _jsx(PatchReactRouterContext, { children: children });
    }
    var navigationContext = useSharedNavigationContextForGoldenLayoutSubwindows({
        goldenLayout: goldenLayout,
    });
    var locationContext = useSharedLocationContext();
    if (!navigationContext || !locationContext) {
        throw new Error('Navigation or location context not found');
    }
    return (_jsx(UNSAFE_NavigationContext.Provider, { value: navigationContext, children: _jsx(UNSAFE_LocationContext.Provider, { value: locationContext, children: children }) }));
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVhY3Qtcm91dGVyLnBhdGNoZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvbWFpbi93ZWJhcHAvY29tcG9uZW50L2FwcC9yZWFjdC1yb3V0ZXIucGF0Y2hlcy50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxPQUFPLEVBQ0wsc0JBQXNCLEVBQ3RCLHdCQUF3QixHQUN6QixNQUFNLGtCQUFrQixDQUFBO0FBQ3pCLE9BQU8sS0FBSyxNQUFNLE9BQU8sQ0FBQTtBQUN6QixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sa0NBQWtDLENBQUE7QUFDL0QsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHdDQUF3QyxDQUFBO0FBQ3hFLE9BQU8sRUFBRSxxQ0FBcUMsRUFBRSxNQUFNLDZDQUE2QyxDQUFBO0FBRW5HOzs7Ozs7Ozs7R0FTRztBQUVIO0lBQWlELHNEQUUvQztJQUZGOztRQUdFLHVCQUFpQixHQUNmLElBQUksQ0FBQTs7SUFPUixDQUFDO0lBTkMsb0VBQXVCLEdBQXZCLFVBQ0UsaUJBQXFFO1FBRXJFLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxpQkFBaUIsQ0FBQTtRQUMxQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQTtJQUM5QyxDQUFDO0lBQ0gseUNBQUM7QUFBRCxDQUFDLEFBWEQsQ0FBaUQsWUFBWSxHQVc1RDtBQUVEO0lBQStDLG9EQUU3QztJQUZGOztRQUdFLHFCQUFlLEdBQ2IsSUFBSSxDQUFBOztJQU9SLENBQUM7SUFOQyxnRUFBcUIsR0FBckIsVUFDRSxlQUFpRTtRQUVqRSxJQUFJLENBQUMsZUFBZSxHQUFHLGVBQWUsQ0FBQTtRQUN0QyxJQUFJLENBQUMsa0JBQWtCLENBQUMsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQTtJQUM5QyxDQUFDO0lBQ0gsdUNBQUM7QUFBRCxDQUFDLEFBWEQsQ0FBK0MsWUFBWSxH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LEVBTWhFO1FBTEMsUUFBUSxjQUFBLEVBQ1IsWUFBWSxrQkFBQTtJQUtaLElBQUksQ0FBQyxZQUFZLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDL0MsT0FBTyxLQUFDLHVCQUF1QixjQUFFLFFBQVEsR0FBMkIsQ0FBQTtJQUN0RSxDQUFDO0lBQ0QsSUFBTSxpQkFBaUIsR0FBRyxtREFBbUQsQ0FDM0U7UUFDRSxZQUFZLGNBQUE7S0FDYixDQUNGLENBQUE7SUFDRCxJQUFNLGVBQWUsR0FBRyx3QkFBd0IsRUFBRSxDQUFBO0lBQ2xELElBQUksQ0FBQyxpQkFBaUIsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBQzNDLE1BQU0sSUFBSSxLQUFLLENBQUMsMENBQTBDLENBQUMsQ0FBQTtJQUM3RCxDQUFDO0lBQ0QsT0FBTyxDQUNMLEtBQUMsd0JBQXdCLENBQUMsUUFBUSxJQUFDLEtBQUssRUFBRSxpQkFBaUIsWUFDekQsS0FBQyxzQkFBc0IsQ0FBQyxRQUFRLElBQUMsS0FBSyxFQUFFLGVBQWUsWUFDcEQsUUFBUSxHQUN1QixHQUNBLENBQ3JDLENBQUE7QUFDSCxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBVTlNBRkVfTG9jYXRpb25Db250ZXh0LFxuICBVTlNBRkVfTmF2aWdhdGlvbkNvbnRleHQsXG59IGZyb20gJ3JlYWN0LXJvdXRlci1kb20nXG5pbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnXG5pbXBvcnQgeyBTdWJzY3JpYmFibGUgfSBmcm9tICcuLi8uLi9qcy9tb2RlbC9CYXNlL2Jhc2UtY2xhc3NlcydcbmltcG9ydCB7IHVzZVN1YnNjcmliYWJsZSB9IGZyb20gJy4uLy4uL2pzL21vZGVsL0Jhc2UvYmFzZS1jbGFzc2VzLmhvb2tzJ1xuaW1wb3J0IHsgR29sZGVuTGF5b3V0V2luZG93Q29tbXVuaWNhdGlvbkV2ZW50cyB9IGZyb20gJy4uL2dvbGRlbi1sYXlvdXQvY3Jvc3Mtd2luZG93LWNvbW11bmljYXRpb24nXG5cbi8qKlxuICogVGhpcyBtb2R1bGUgcHJvdmlkZXMgYSBzb2x1dGlvbiBmb3Igc2hhcmluZyBSZWFjdCBSb3V0ZXIgdjYgY29udGV4dCBhY3Jvc3MgbXVsdGlwbGUgUmVhY3Qgcm9vdHMsIGFzIHdlbGwgYXMgZ29sZGVuLWxheW91dCBzdWJ3aW5kb3dzIChwb3BvdXRzKS5cbiAqIFNlZSBodHRwczovL2dpdGh1Yi5jb20vcmVtaXgtcnVuL3JlYWN0LXJvdXRlci9pc3N1ZXMvMTAwODkgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBQcm9ibGVtOlxuICogLSBSZWFjdCBSb3V0ZXIgdjYgdXNlcyBpbnRlcm5hbCBoaXN0b3J5L2xvY2F0aW9uIG9iamVjdHMgdGhhdCBhcmVuJ3Qgc2hhcmVkIGJldHdlZW4gZGlmZmVyZW50IFJvdXRlciBpbnN0YW5jZXNcbiAqIC0gT3VyIGFwcGxpY2F0aW9uIHVzZXMgbXVsdGlwbGUgUmVhY3Qgcm9vdHMgZHVlIHRvIGdvbGRlbi1sYXlvdXQgaW50ZWdyYXRpb25cbiAqIC0gR29sZGVuLWxheW91dCBkb2Vzbid0IGhhdmUgbmF0aXZlIFJlYWN0IHN1cHBvcnQsIHNvIHdlIG5lZWQgdG8gcGF0Y2ggdGhlIGNvbnRleHRzIHNvbWVob3dcbiAqIC0gV2UgbmVlZCB0aGUgYWJpbGl0eSB0byBhbHNvIGhhbmRsZSBwb3BvdXRzLCB3aGljaCBoYXZlIHRoZWlyIG93biBSb3V0ZXIgaW5zdGFuY2VzLlxuICovXG5cbmNsYXNzIFN1YnNjcmliYWJsZU5hdmlnYXRpb25Db250ZXh0Q2xhc3MgZXh0ZW5kcyBTdWJzY3JpYmFibGU8e1xuICB0aGluZzogJ3VwZGF0ZSdcbn0+IHtcbiAgbmF2aWdhdGlvbkNvbnRleHQ6IFJlYWN0LkNvbnRleHRUeXBlPHR5cGVvZiBVTlNBRkVfTmF2aWdhdGlvbkNvbnRleHQ+IHwgbnVsbCA9XG4gICAgbnVsbFxuICB1cGRhdGVOYXZpZ2F0aW9uQ29udGV4dChcbiAgICBuYXZpZ2F0aW9uQ29udGV4dDogUmVhY3QuQ29udGV4dFR5cGU8dHlwZW9mIFVOU0FGRV9OYXZpZ2F0aW9uQ29udGV4dD5cbiAgKSB7XG4gICAgdGhpcy5uYXZpZ2F0aW9uQ29udGV4dCA9IG5hdmlnYXRpb25Db250ZXh0XG4gICAgdGhpcy5fbm90aWZ5U3Vic2NyaWJlcnMoeyB0aGluZzogJ3VwZGF0ZScgfSlcbiAgfVxufVxuXG5jbGFzcyBTdWJzY3JpYmFibGVMb2NhdGlvbkNvbnRleHRDbGFzcyBleHRlbmRzIFN1YnNjcmliYWJsZTx7XG4gIHRoaW5nOiAndXBkYXRlJ1xufT4ge1xuICBsb2NhdGlvbkNvbnRleHQ6IFJlYWN0LkNvbnRleHRUeXBlPHR5cGVvZiBVTlNBRkVfTG9jYXRpb25Db250ZXh0PiB8IG51bGwgPVxuICAgIG51bGxcbiAgdXBkYXRlTG9jYXRpb25Db250ZXh0KFxuICAgIGxvY2F0aW9uQ29udGV4dDogUmVhY3QuQ29udGV4dFR5cGU8dHlwZW9mIFVOU0FGRV9Mb2NhdGlvbkNvbnRleHQ+XG4gICkge1xuICAgIHRoaXMubG9jYXRpb25Db250ZXh0ID0gbG9jYXRpb25Db250ZXh0XG4gICAgdGhpcy5fbm90aWZ5U3Vic2NyaWJlcnMoeyB0aGluZzogJ3VwZGF0ZScgfSlcbiAgfVxufVxuXG5sZXQgU3Vic2NyaWJhYmxlTmF2aWdhdGlvbkNvbnRleHQgPSBuZXcgU3Vic2NyaWJhYmxlTmF2aWdhdGlvbkNvbnRleHRDbGFzcygpXG5sZXQgU3Vic2NyaWJhYmxlTG9jYXRpb25Db250ZXh0ID0gbmV3IFN1YnNjcmliYWJsZUxvY2F0aW9uQ29udGV4dENsYXNzKClcblxuLyoqXG4gKiBDb21wb25lbnQgdGhhdCBzeW5jcyB0aGUgY3VycmVudCBSZWFjdCBSb3V0ZXIgY29udGV4dCB0byBvdXIgc2hhcmVkIHZhcmlhYmxlcy4gIFdoaWxlIHdlIGNvdWxkIGFsdGVybmF0aXZlbHkgdXNlIHByb3AgZHJpbGxpbmcgYnlcbiAqIGFjY2Vzc2luZyBjb250ZXh0IGFuZCBwYXNzaW5nIGl0IHRvIHRoZSBuZXcgcm9vdCwgdGhpcyBpcyBtdWNoIHNpbXBsZXIuXG4gKlxuICogVGhpcyBzaG91bGQgYmUgcmVuZGVyZWQgd2l0aGluIHRoZSBSb3V0ZXIgY29tcG9uZW50IG9mIHRoZSBwcmltYXJ5IFJlYWN0IHJvb3RcbiAqL1xuZXhwb3J0IGNvbnN0IFN5bmNSZWFjdFJvdXRlckNvbnRleHRUb1ZhcmlhYmxlcyA9ICgpID0+IHtcbiAgY29uc3QgbmF2aWdhdGlvbkNvbnRleHQgPSBSZWFjdC51c2VDb250ZXh0KFVOU0FGRV9OYXZpZ2F0aW9uQ29udGV4dClcbiAgY29uc3QgbG9jYXRpb25Db250ZXh0ID0gUmVhY3QudXNlQ29udGV4dChVTlNBRkVfTG9jYXRpb25Db250ZXh0KVxuXG4gIFJlYWN0LnVzZUVmZmVjdCgoKSA9PiB7XG4gICAgU3Vic2NyaWJhYmxlTmF2aWdhdGlvbkNvbnRleHQudXBkYXRlTmF2aWdhdGlvbkNvbnRleHQobmF2aWdhdGlvbkNvbnRleHQpXG4gIH0sIFtuYXZpZ2F0aW9uQ29udGV4dF0pXG4gIFJlYWN0LnVzZUVmZmVjdCgoKSA9PiB7XG4gICAgU3Vic2NyaWJhYmxlTG9jYXRpb25Db250ZXh0LnVwZGF0ZUxvY2F0aW9uQ29udGV4dChsb2NhdGlvbkNvbnRleHQpXG4gIH0sIFtsb2NhdGlvbkNvbnRleHRdKVxuXG4gIHJldHVybiBudWxsXG59XG5cbmZ1bmN0aW9uIHVzZVNoYXJlZE5hdmlnYXRpb25Db250ZXh0KCkge1xuICBjb25zdCBbbmF2aWdhdGlvbkNvbnRleHQsIHNldE5hdmlnYXRpb25Db250ZXh0XSA9XG4gICAgUmVhY3QudXNlU3RhdGU8UmVhY3QuQ29udGV4dFR5cGU8dHlwZW9mIFVOU0FGRV9OYXZpZ2F0aW9uQ29udGV4dD4gfCBudWxsPihcbiAgICAgIFN1YnNjcmliYWJsZU5hdmlnYXRpb25Db250ZXh0Lm5hdmlnYXRpb25Db250ZXh0XG4gICAgKVxuICB1c2VTdWJzY3JpYmFibGUoU3Vic2NyaWJhYmxlTmF2aWdhdGlvbkNvbnRleHQsICd1cGRhdGUnLCAoKSA9PiB7XG4gICAgc2V0TmF2aWdhdGlvbkNvbnRleHQoU3Vic2NyaWJhYmxlTmF2aWdhdGlvbkNvbnRleHQubmF2aWdhdGlvbkNvbnRleHQpXG4gIH0pXG4gIHJldHVybiBuYXZpZ2F0aW9uQ29udGV4dFxufVxuXG5mdW5jdGlvbiB1c2VTaGFyZWRMb2NhdGlvbkNvbnRleHQoKSB7XG4gIGNvbnN0IFtsb2NhdGlvbkNvbnRleHQsIHNldExvY2F0aW9uQ29udGV4dF0gPVxuICAgIFJlYWN0LnVzZVN0YXRlPFJlYWN0LkNvbnRleHRUeXBlPHR5cGVvZiBVTlNBRkVfTG9jYXRpb25Db250ZXh0PiB8IG51bGw+KFxuICAgICAgU3Vic2NyaWJhYmxlTG9jYXRpb25Db250ZXh0LmxvY2F0aW9uQ29udGV4dFxuICAgIClcbiAgdXNlU3Vic2NyaWJhYmxlKFN1YnNjcmliYWJsZUxvY2F0aW9uQ29udGV4dCwgJ3VwZGF0ZScsICgpID0+IHtcbiAgICBzZXRMb2NhdGlvbkNvbnRleHQoU3Vic2NyaWJhYmxlTG9jYXRpb25Db250ZXh0LmxvY2F0aW9uQ29udGV4dClcbiAgfSlcbiAgcmV0dXJuIGxvY2F0aW9uQ29udGV4dFxufVxuXG4vKipcbiAqIFByb3ZpZGVyIGNvbXBvbmVudCB0aGF0IHByb3ZpZGVzIHRoZSBzaGFyZWQgUm91dGVyIGNvbnRleHQgdG8gaXRzIGNoaWxkcmVuXG4gKiBUaGlzIHNob3VsZCBiZSB1c2VkIGluIHNlY29uZGFyeSBSZWFjdCByb290cyB0byByZWNlaXZlIHRoZSBzaGFyZWQgY29udGV4dFxuICovXG5leHBvcnQgY29uc3QgUGF0Y2hSZWFjdFJvdXRlckNvbnRleHQgPSAoe1xuICBjaGlsZHJlbixcbn06IHtcbiAgY2hpbGRyZW46IFJlYWN0LlJlYWN0Tm9kZVxufSkgPT4ge1xuICBjb25zdCBuYXZpZ2F0aW9uQ29udGV4dCA9IHVzZVNoYXJlZE5hdmlnYXRpb25Db250ZXh0KClcbiAgY29uc3QgbG9jYXRpb25Db250ZXh0ID0gdXNlU2hhcmVkTG9jYXRpb25Db250ZXh0KClcbiAgaWYgKCFuYXZpZ2F0aW9uQ29udGV4dCB8fCAhbG9jYXRpb25Db250ZXh0KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdOYXZpZ2F0aW9uIG9yIGxvY2F0aW9uIGNvbnRleHQgbm90IGZvdW5kJylcbiAgfVxuICByZXR1cm4gKFxuICAgIDxVTlNBRkVfTmF2aWdhdGlvbkNvbnRleHQuUHJvdmlkZXIgdmFsdWU9e25hdmlnYXRpb25Db250ZXh0fT5cbiAgICAgIDxVTlNBRkVfTG9jYXRpb25Db250ZXh0LlByb3ZpZGVyIHZhbHVlPXtsb2NhdGlvbkNvbnRleHR9PlxuICAgICAgICB7Y2hpbGRyZW59XG4gICAgICA8L1VOU0FGRV9Mb2NhdGlvbkNvbnRleHQuUHJvdmlkZXI+XG4gICAgPC9VTlNBRkVfTmF2aWdhdGlvbkNvbnRleHQuUHJvdmlkZXI+XG4gIClcbn1cblxuLyoqXG4gKiAgSW4gc3Vid2luZG93cyAocG9wb3V0cykgd2Ugd2FudCB0byByZWRpcmVjdCBuYXZpZ2F0aW9uIGV2ZW50cyBiYWNrIHRvIHRoZSBtYWluIHdpbmRvdyB0aHJvdWdoIHRoZSBldmVudCBidXMuXG4gKi9cbmZ1bmN0aW9uIHBhdGNoTmF2aWdhdGlvbkNvbnRleHRGb3JHb2xkZW5MYXlvdXRTdWJ3aW5kb3dzKHtcbiAgbmF2aWdhdGlvbkNvbnRleHQsXG4gIGdvbGRlbkxheW91dCxcbn06IHtcbiAgbmF2aWdhdGlvbkNvbnRleHQ6IFJlYWN0LkNvbnRleHRUeXBlPHR5cGVvZiBVTlNBRkVfTmF2aWdhdGlvbkNvbnRleHQ+IHwgbnVsbFxuICBnb2xkZW5MYXlvdXQ6IGFueVxufSkge1xuICBpZiAoIW5hdmlnYXRpb25Db250ZXh0KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdOYXZpZ2F0aW9uIGNvbnRleHQgbm90IGZvdW5kJylcbiAgfVxuICBjb25zdCByZXBsYWNlV3JhcHBlciA9ICh0bzogc3RyaW5nLCBvcHRpb25zPzogeyBzdGF0ZT86IGFueSB9KSA9PiB7XG4gICAgZ29sZGVuTGF5b3V0LmV2ZW50SHViLmVtaXQoXG4gICAgICBHb2xkZW5MYXlvdXRXaW5kb3dDb21tdW5pY2F0aW9uRXZlbnRzLmNvbnN1bWVOYXZpZ2F0aW9uQ2hhbmdlLFxuICAgICAge1xuICAgICAgICByZXBsYWNlOiBbdG8sIHsgLi4ub3B0aW9ucywgcmVwbGFjZTogdHJ1ZSB9XSxcbiAgICAgIH1cbiAgICApXG4gIH1cbiAgY29uc3QgcHVzaFdyYXBwZXIgPSAodG86IHN0cmluZywgb3B0aW9ucz86IHsgc3RhdGU/OiBhbnkgfSkgPT4ge1xuICAgIGdvbGRlbkxheW91dC5ldmVudEh1Yi5lbWl0KFxuICAgICAgR29sZGVuTGF5b3V0V2luZG93Q29tbXVuaWNhdGlvbkV2ZW50cy5jb25zdW1lTmF2aWdhdGlvbkNoYW5nZSxcbiAgICAgIHtcbiAgICAgICAgcHVzaDogW3RvLCBvcHRpb25zXSxcbiAgICAgIH1cbiAgICApXG4gIH1cbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG5hdmlnYXRpb25Db250ZXh0Lm5hdmlnYXRvciwgJ3JlcGxhY2UnLCB7XG4gICAgdmFsdWU6IHJlcGxhY2VXcmFwcGVyLFxuICAgIHdyaXRhYmxlOiB0cnVlLFxuICB9KVxuICBPYmplY3QuZGVmaW5lUHJvcGVydHkobmF2aWdhdGlvbkNvbnRleHQubmF2aWdhdG9yLCAncHVzaCcsIHtcbiAgICB2YWx1ZTogcHVzaFdyYXBwZXIsXG4gICAgd3JpdGFibGU6IHRydWUsXG4gIH0pXG4gIHJldHVybiBuYXZpZ2F0aW9uQ29udGV4dFxufVxuXG4vKipcbiAqIEhvb2sgdGhhdCBwcm92aWRlcyB0aGUgc2hhcmVkIFJvdXRlciBjb250ZXh0IGZvciBnb2xkZW4gbGF5b3V0IHN1YndpbmRvd3MgKHBvcG91dHMpXG4gKi9cbmZ1bmN0aW9uIHVzZVNoYXJlZE5hdmlnYXRpb25Db250ZXh0Rm9yR29sZGVuTGF5b3V0U3Vid2luZG93cyh7XG4gIGdvbGRlbkxheW91dCxcbn06IHtcbiAgZ29sZGVuTGF5b3V0OiBhbnlcbn0pIHtcbiAgY29uc3QgW25hdmlnYXRpb25Db250ZXh0LCBzZXROYXZpZ2F0aW9uQ29udGV4dF0gPVxuICAgIFJlYWN0LnVzZVN0YXRlPFJlYWN0LkNvbnRleHRUeXBlPHR5cGVvZiBVTlNBRkVfTmF2aWdhdGlvbkNvbnRleHQ+IHwgbnVsbD4oXG4gICAgICBwYXRjaE5hdmlnYXRpb25Db250ZXh0Rm9yR29sZGVuTGF5b3V0U3Vid2luZG93cyh7XG4gICAgICAgIG5hdmlnYXRpb25Db250ZXh0OiBTdWJzY3JpYmFibGVOYXZpZ2F0aW9uQ29udGV4dC5uYXZpZ2F0aW9uQ29udGV4dCxcbiAgICAgICAgZ29sZGVuTGF5b3V0LFxuICAgICAgfSlcbiAgICApXG4gIHVzZVN1YnNjcmliYWJsZShTdWJzY3JpYmFibGVOYXZpZ2F0aW9uQ29udGV4dCwgJ3VwZGF0ZScsICgpID0+IHtcbiAgICBzZXROYXZpZ2F0aW9uQ29udGV4dChcbiAgICAgIHBhdGNoTmF2aWdhdGlvbkNvbnRleHRGb3JHb2xkZW5MYXlvdXRTdWJ3aW5kb3dzKHtcbiAgICAgICAgbmF2aWdhdGlvbkNvbnRleHQ6IFN1YnNjcmliYWJsZU5hdmlnYXRpb25Db250ZXh0Lm5hdmlnYXRpb25Db250ZXh0LFxuICAgICAgICBnb2xkZW5MYXlvdXQsXG4gICAgICB9KVxuICAgIClcbiAgfSlcbiAgcmV0dXJuIG5hdmlnYXRpb25Db250ZXh0XG59XG5cbi8qKlxuICogUHJvdmlkZXIgY29tcG9uZW50IHRoYXQgcGF0Y2hlcyB0aGUgUmVhY3QgUm91dGVyIGNvbnRleHQgZm9yIGdvbGRlbiBsYXlvdXQgc3Vid2luZG93cyAocG9wb3V0cyksIGFuZCBhbHNvIGhhbmRsZXMgbm9ybWFsIFJlYWN0IHJvb3RzIHdoZW4gYXBwbGljYWJsZS5cbiAqL1xuZXhwb3J0IGNvbnN0IFBhdGNoUmVhY3RSb3V0ZXJDb250ZXh0Rm9yR29sZGVuTGF5b3V0U3Vid2luZG93cyA9ICh7XG4gIGNoaWxkcmVuLFxuICBnb2xkZW5MYXlvdXQsXG59OiB7XG4gIGNoaWxkcmVuOiBSZWFjdC5SZWFjdE5vZGVcbiAgZ29sZGVuTGF5b3V0OiBhbnlcbn0pID0+IHtcbiAgaWYgKCFnb2xkZW5MYXlvdXQgfHwgIWdvbGRlbkxheW91dC5pc1N1YldpbmRvdykge1xuICAgIHJldHVybiA8UGF0Y2hSZWFjdFJvdXRlckNvbnRleHQ+e2NoaWxkcmVufTwvUGF0Y2hSZWFjdFJvdXRlckNvbnRleHQ+XG4gIH1cbiAgY29uc3QgbmF2aWdhdGlvbkNvbnRleHQgPSB1c2VTaGFyZWROYXZpZ2F0aW9uQ29udGV4dEZvckdvbGRlbkxheW91dFN1YndpbmRvd3MoXG4gICAge1xuICAgICAgZ29sZGVuTGF5b3V0LFxuICAgIH1cbiAgKVxuICBjb25zdCBsb2NhdGlvbkNvbnRleHQgPSB1c2VTaGFyZWRMb2NhdGlvbkNvbnRleHQoKVxuICBpZiAoIW5hdmlnYXRpb25Db250ZXh0IHx8ICFsb2NhdGlvbkNvbnRleHQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ05hdmlnYXRpb24gb3IgbG9jYXRpb24gY29udGV4dCBub3QgZm91bmQnKVxuICB9XG4gIHJldHVybiAoXG4gICAgPFVOU0FGRV9OYXZpZ2F0aW9uQ29udGV4dC5Qcm92aWRlciB2YWx1ZT17bmF2aWdhdGlvbkNvbnRleHR9PlxuICAgICAgPFVOU0FGRV9Mb2NhdGlvbkNvbnRleHQuUHJvdmlkZXIgdmFsdWU9e2xvY2F0aW9uQ29udGV4dH0+XG4gICAgICAgIHtjaGlsZHJlbn1cbiAgICAgIDwvVU5TQUZFX0xvY2F0aW9uQ29udGV4dC5Qcm92aWRlcj5cbiAgICA8L1VOU0FGRV9OYXZpZ2F0aW9uQ29udGV4dC5Qcm92aWRlcj5cbiAgKVxufVxuIl19