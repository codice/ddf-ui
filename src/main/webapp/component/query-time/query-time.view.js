import { __assign } from "tslib";
/**
 * Copyright (c) Codice Foundation
 *
 * This is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser
 * General Public License as published by the Free Software Foundation, either version 3 of the
 * License, or any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
 * even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details. A copy of the GNU Lesser General Public License
 * is distributed along with this program and can be found at
 * <http://www.gnu.org/licenses/lgpl.html>.
 *
 **/
/* eslint-disable no-var */
import * as React from 'react';
import TextField from '@mui/material/TextField';
import MenuItem from '@mui/material/MenuItem';
import { hot } from 'react-hot-loader';
import Autocomplete from '@mui/material/Autocomplete';
import Chip from '@mui/material/Chip';
import Grid from '@mui/material/Grid';
import Swath from '../swath/swath';
import FilterInput from '../../react-component/filter/filter-input';
import Checkbox from '@mui/material/Checkbox';
import FormControlLabel from '@mui/material/FormControlLabel';
import { StartupDataStore } from '../../js/model/Startup/startup';
var getPossibleProperties = function () {
    return StartupDataStore.MetacardDefinitions.getSortedAttributes()
        .filter(function (definition) { return !definition.hidden && definition.type === 'DATE'; })
        .map(function (definition) { return ({
        label: definition.alias || definition.id,
        value: definition.id,
    }); });
};
var getDefaultPropertiesToApplyTo = function () {
    return (StartupDataStore.Configuration.getBasicSearchTemporalSelectionDefault() ||
        []).map(function (property) {
        return {
            label: StartupDataStore.MetacardDefinitions.getAlias(property),
            value: property,
        };
    });
};
var determinePropertiesToApplyTo = function (_a) {
    var value = _a.value;
    if (value.property) {
        return value.property
            .filter(function (prop) { return prop !== 'anyDate'; })
            .map(function (property) {
            return {
                label: StartupDataStore.MetacardDefinitions.getAlias(property),
                value: property,
            };
        });
    }
    else {
        return getDefaultPropertiesToApplyTo();
    }
};
var QueryTime = function (_a) {
    var value = _a.value, onChange = _a.onChange;
    React.useEffect(function () {
        if (value && value.property === undefined) {
            onChange(__assign(__assign({}, value), { property: determinePropertiesToApplyTo({ value: value }).map(function (val) { return val.value; }) }));
        }
    }, [value]);
    if (value && value.property === undefined) {
        return null; // the use effect above should fire to take care of setting a default
    }
    return (React.createElement(React.Fragment, null,
        React.createElement("div", null,
            React.createElement(FormControlLabel, { labelPlacement: "end", control: React.createElement(Checkbox, { color: "default", checked: value ? true : false, onChange: function (e) {
                        if (e.target.checked) {
                            onChange(__assign(__assign({}, value), { type: 'AFTER', property: getDefaultPropertiesToApplyTo().map(function (val) { return val.value; }) }));
                        }
                        else {
                            onChange(undefined);
                        }
                    } }), label: "Time" }),
            value ? (React.createElement(Grid, { container: true, alignItems: "stretch", direction: "column", wrap: "nowrap", className: "pt-2" },
                React.createElement(Grid, { item: true, className: "w-full pb-2" },
                    React.createElement(Autocomplete, { fullWidth: true, multiple: true, options: getPossibleProperties(), disableCloseOnSelect: true, getOptionLabel: function (option) { return option.label; }, isOptionEqualToValue: function (option, value) {
                            return option.value === value.value;
                        }, onChange: function (_e, newValue) {
                            onChange(__assign(__assign({}, value), { property: newValue.map(function (val) { return val.value; }) }));
                        }, size: "small", renderTags: function (tagValue, getTagProps) {
                            return tagValue.map(function (option, index) { return (React.createElement(Chip, __assign({ variant: "outlined", color: "default", label: option.label }, getTagProps({ index: index })))); });
                        }, value: determinePropertiesToApplyTo({ value: value }), renderInput: function (params) { return (React.createElement(TextField, __assign({}, params, { variant: "outlined" }))); } })),
                React.createElement(Grid, { container: true, alignItems: "stretch", direction: "row", wrap: "nowrap", className: "pt-2" },
                    React.createElement(Grid, { item: true },
                        React.createElement(Swath, { className: "w-1 h-full" })),
                    React.createElement(Grid, { container: true, direction: "column" },
                        React.createElement(Grid, { item: true, className: "w-full pl-2 pb-2" },
                            React.createElement(TextField, { fullWidth: true, variant: "outlined", size: "small", select: true, value: value.type, onChange: function (e) {
                                    onChange(__assign(__assign({}, value), { type: e.target.value }));
                                } },
                                React.createElement(MenuItem, { value: "AFTER" }, "After"),
                                React.createElement(MenuItem, { value: "BEFORE" }, "Before"),
                                React.createElement(MenuItem, { value: "DURING" }, "Between"),
                                React.createElement(MenuItem, { value: "RELATIVE" }, "Within the last"),
                                React.createElement(MenuItem, { value: "AROUND" }, "Around"))),
                        React.createElement(Grid, { item: true, className: "w-full pl-2" },
                            React.createElement(FilterInput, { filter: __assign(__assign({}, value), { property: value.property[0] }), setFilter: function (val) {
                                    onChange(__assign(__assign({}, value), { value: val.value }));
                                } })))))) : null)));
};
export default hot(module)(QueryTime);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVlcnktdGltZS52aWV3LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL21haW4vd2ViYXBwL2NvbXBvbmVudC9xdWVyeS10aW1lL3F1ZXJ5LXRpbWUudmlldy50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7Ozs7Ozs7O0lBYUk7QUFDSiwyQkFBMkI7QUFDM0IsT0FBTyxLQUFLLEtBQUssTUFBTSxPQUFPLENBQUE7QUFDOUIsT0FBTyxTQUFTLE1BQU0seUJBQXlCLENBQUE7QUFDL0MsT0FBTyxRQUFRLE1BQU0sd0JBQXdCLENBQUE7QUFDN0MsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGtCQUFrQixDQUFBO0FBQ3RDLE9BQU8sWUFBWSxNQUFNLDRCQUE0QixDQUFBO0FBQ3JELE9BQU8sSUFBSSxNQUFNLG9CQUFvQixDQUFBO0FBQ3JDLE9BQU8sSUFBSSxNQUFNLG9CQUFvQixDQUFBO0FBQ3JDLE9BQU8sS0FBSyxNQUFNLGdCQUFnQixDQUFBO0FBQ2xDLE9BQU8sV0FBVyxNQUFNLDJDQUEyQyxDQUFBO0FBQ25FLE9BQU8sUUFBUSxNQUFNLHdCQUF3QixDQUFBO0FBQzdDLE9BQU8sZ0JBQWdCLE1BQU0sZ0NBQWdDLENBQUE7QUFDN0QsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sZ0NBQWdDLENBQUE7QUFRakUsSUFBTSxxQkFBcUIsR0FBRztJQUM1QixPQUFPLGdCQUFnQixDQUFDLG1CQUFtQixDQUFDLG1CQUFtQixFQUFFO1NBQzlELE1BQU0sQ0FDTCxVQUFDLFVBQWUsSUFBSyxPQUFBLENBQUMsVUFBVSxDQUFDLE1BQU0sSUFBSSxVQUFVLENBQUMsSUFBSSxLQUFLLE1BQU0sRUFBaEQsQ0FBZ0QsQ0FDdEU7U0FDQSxHQUFHLENBQUMsVUFBQyxVQUFlLElBQUssT0FBQSxDQUFDO1FBQ3pCLEtBQUssRUFBRSxVQUFVLENBQUMsS0FBSyxJQUFJLFVBQVUsQ0FBQyxFQUFFO1FBQ3hDLEtB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Q0csQ0FDRixDQUNGLENBQ0YsQ0FDUixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQ0osQ0FDTCxDQUNKLENBQUE7QUFDSCxDQUFDLENBQUE7QUFFRCxlQUFlLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSBDb2RpY2UgRm91bmRhdGlvblxuICpcbiAqIFRoaXMgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeSBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBMZXNzZXJcbiAqIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5IHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlXG4gKiBMaWNlbnNlLCBvciBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0XG4gKiBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gU2VlIHRoZSBHTlVcbiAqIExlc3NlciBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuIEEgY29weSBvZiB0aGUgR05VIExlc3NlciBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlXG4gKiBpcyBkaXN0cmlidXRlZCBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbSBhbmQgY2FuIGJlIGZvdW5kIGF0XG4gKiA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzL2xncGwuaHRtbD4uXG4gKlxuICoqL1xuLyogZXNsaW50LWRpc2FibGUgbm8tdmFyICovXG5pbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCdcbmltcG9ydCBUZXh0RmllbGQgZnJvbSAnQG11aS9tYXRlcmlhbC9UZXh0RmllbGQnXG5pbXBvcnQgTWVudUl0ZW0gZnJvbSAnQG11aS9tYXRlcmlhbC9NZW51SXRlbSdcbmltcG9ydCB7IGhvdCB9IGZyb20gJ3JlYWN0LWhvdC1sb2FkZXInXG5pbXBvcnQgQXV0b2NvbXBsZXRlIGZyb20gJ0BtdWkvbWF0ZXJpYWwvQXV0b2NvbXBsZXRlJ1xuaW1wb3J0IENoaXAgZnJvbSAnQG11aS9tYXRlcmlhbC9DaGlwJ1xuaW1wb3J0IEdyaWQgZnJvbSAnQG11aS9tYXRlcmlhbC9HcmlkJ1xuaW1wb3J0IFN3YXRoIGZyb20gJy4uL3N3YXRoL3N3YXRoJ1xuaW1wb3J0IEZpbHRlcklucHV0IGZyb20gJy4uLy4uL3JlYWN0LWNvbXBvbmVudC9maWx0ZXIvZmlsdGVyLWlucHV0J1xuaW1wb3J0IENoZWNrYm94IGZyb20gJ0BtdWkvbWF0ZXJpYWwvQ2hlY2tib3gnXG5pbXBvcnQgRm9ybUNvbnRyb2xMYWJlbCBmcm9tICdAbXVpL21hdGVyaWFsL0Zvcm1Db250cm9sTGFiZWwnXG5pbXBvcnQgeyBTdGFydHVwRGF0YVN0b3JlIH0gZnJvbSAnLi4vLi4vanMvbW9kZWwvU3RhcnR1cC9zdGFydHVwJ1xuaW1wb3J0IHsgQmFzaWNGaWx0ZXJDbGFzcyB9IGZyb20gJy4uL2ZpbHRlci1idWlsZGVyL2ZpbHRlci5zdHJ1Y3R1cmUnXG5cbnR5cGUgUXVlcnlUaW1lUHJvcHMgPSB7XG4gIHZhbHVlOiB1bmRlZmluZWQgfCBCYXNpY0ZpbHRlckNsYXNzXG4gIG9uQ2hhbmdlOiAoZTogYW55KSA9PiB2b2lkXG59XG5cbmNvbnN0IGdldFBvc3NpYmxlUHJvcGVydGllcyA9ICgpID0+IHtcbiAgcmV0dXJuIFN0YXJ0dXBEYXRhU3RvcmUuTWV0YWNhcmREZWZpbml0aW9ucy5nZXRTb3J0ZWRBdHRyaWJ1dGVzKClcbiAgICAuZmlsdGVyKFxuICAgICAgKGRlZmluaXRpb246IGFueSkgPT4gIWRlZmluaXRpb24uaGlkZGVuICYmIGRlZmluaXRpb24udHlwZSA9PT0gJ0RBVEUnXG4gICAgKVxuICAgIC5tYXAoKGRlZmluaXRpb246IGFueSkgPT4gKHtcbiAgICAgIGxhYmVsOiBkZWZpbml0aW9uLmFsaWFzIHx8IGRlZmluaXRpb24uaWQsXG4gICAgICB2YWx1ZTogZGVmaW5pdGlvbi5pZCxcbiAgICB9KSkgYXMgW1xuICAgIHtcbiAgICAgIGxhYmVsOiBzdHJpbmdcbiAgICAgIHZhbHVlOiBzdHJpbmdcbiAgICB9XG4gIF1cbn1cblxuY29uc3QgZ2V0RGVmYXVsdFByb3BlcnRpZXNUb0FwcGx5VG8gPSAoKToge1xuICBsYWJlbDogc3RyaW5nXG4gIHZhbHVlOiBzdHJpbmdcbn1bXSA9PiB7XG4gIHJldHVybiAoXG4gICAgU3RhcnR1cERhdGFTdG9yZS5Db25maWd1cmF0aW9uLmdldEJhc2ljU2VhcmNoVGVtcG9yYWxTZWxlY3Rpb25EZWZhdWx0KCkgfHxcbiAgICBbXVxuICApLm1hcCgocHJvcGVydHk6IHN0cmluZykgPT4ge1xuICAgIHJldHVybiB7XG4gICAgICBsYWJlbDogU3RhcnR1cERhdGFTdG9yZS5NZXRhY2FyZERlZmluaXRpb25zLmdldEFsaWFzKHByb3BlcnR5KSxcbiAgICAgIHZhbHVlOiBwcm9wZXJ0eSxcbiAgICB9XG4gIH0pXG59XG5cbmNvbnN0IGRldGVybWluZVByb3BlcnRpZXNUb0FwcGx5VG8gPSAoe1xuICB2YWx1ZSxcbn06IHtcbiAgdmFsdWU6IEJhc2ljRmlsdGVyQ2xhc3Ncbn0pOiBBcnJheTx7IGxhYmVsOiBzdHJpbmc7IHZhbHVlOiBzdHJpbmcgfT4gPT4ge1xuICBpZiAodmFsdWUucHJvcGVydHkpIHtcbiAgICByZXR1cm4gdmFsdWUucHJvcGVydHlcbiAgICAgIC5maWx0ZXIoKHByb3ApID0+IHByb3AgIT09ICdhbnlEYXRlJylcbiAgICAgIC5tYXAoKHByb3BlcnR5KSA9PiB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgbGFiZWw6IFN0YXJ0dXBEYXRhU3RvcmUuTWV0YWNhcmREZWZpbml0aW9ucy5nZXRBbGlhcyhwcm9wZXJ0eSksXG4gICAgICAgICAgdmFsdWU6IHByb3BlcnR5LFxuICAgICAgICB9XG4gICAgICB9KVxuICB9IGVsc2Uge1xuICAgIHJldHVybiBnZXREZWZhdWx0UHJvcGVydGllc1RvQXBwbHlUbygpXG4gIH1cbn1cblxuY29uc3QgUXVlcnlUaW1lID0gKHsgdmFsdWUsIG9uQ2hhbmdlIH06IFF1ZXJ5VGltZVByb3BzKSA9PiB7XG4gIFJlYWN0LnVzZUVmZmVjdCgoKSA9PiB7XG4gICAgaWYgKHZhbHVlICYmIHZhbHVlLnByb3BlcnR5ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIG9uQ2hhbmdlKHtcbiAgICAgICAgLi4udmFsdWUsXG4gICAgICAgIHByb3BlcnR5OiBkZXRlcm1pbmVQcm9wZXJ0aWVzVG9BcHBseVRvKHsgdmFsdWUgfSkubWFwKFxuICAgICAgICAgICh2YWwpID0+IHZhbC52YWx1ZVxuICAgICAgICApLFxuICAgICAgfSlcbiAgICB9XG4gIH0sIFt2YWx1ZV0pXG4gIGlmICh2YWx1ZSAmJiB2YWx1ZS5wcm9wZXJ0eSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgcmV0dXJuIG51bGwgLy8gdGhlIHVzZSBlZmZlY3QgYWJvdmUgc2hvdWxkIGZpcmUgdG8gdGFrZSBjYXJlIG9mIHNldHRpbmcgYSBkZWZhdWx0XG4gIH1cbiAgcmV0dXJuIChcbiAgICA8PlxuICAgICAgPGRpdj5cbiAgICAgICAgPEZvcm1Db250cm9sTGFiZWxcbiAgICAgICAgICBsYWJlbFBsYWNlbWVudD1cImVuZFwiXG4gICAgICAgICAgY29udHJvbD17XG4gICAgICAgICAgICA8Q2hlY2tib3hcbiAgICAgICAgICAgICAgY29sb3I9XCJkZWZhdWx0XCJcbiAgICAgICAgICAgICAgY2hlY2tlZD17dmFsdWUgPyB0cnVlIDogZmFsc2V9XG4gICAgICAgICAgICAgIG9uQ2hhbmdlPXsoZSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChlLnRhcmdldC5jaGVja2VkKSB7XG4gICAgICAgICAgICAgICAgICBvbkNoYW5nZSh7XG4gICAgICAgICAgICAgICAgICAgIC4uLnZhbHVlLFxuICAgICAgICAgICAgICAgICAgICB0eXBlOiAnQUZURVInLFxuICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0eTogZ2V0RGVmYXVsdFByb3BlcnRpZXNUb0FwcGx5VG8oKS5tYXAoXG4gICAgICAgICAgICAgICAgICAgICAgKHZhbCkgPT4gdmFsLnZhbHVlXG4gICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICBvbkNoYW5nZSh1bmRlZmluZWQpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9fVxuICAgICAgICAgICAgLz5cbiAgICAgICAgICB9XG4gICAgICAgICAgbGFiZWw9XCJUaW1lXCJcbiAgICAgICAgLz5cbiAgICAgICAge3ZhbHVlID8gKFxuICAgICAgICAgIDxHcmlkXG4gICAgICAgICAgICBjb250YWluZXJcbiAgICAgICAgICAgIGFsaWduSXRlbXM9XCJzdHJldGNoXCJcbiAgICAgICAgICAgIGRpcmVjdGlvbj1cImNvbHVtblwiXG4gICAgICAgICAgICB3cmFwPVwibm93cmFwXCJcbiAgICAgICAgICAgIGNsYXNzTmFtZT1cInB0LTJcIlxuICAgICAgICAgID5cbiAgICAgICAgICAgIDxHcmlkIGl0ZW0gY2xhc3NOYW1lPVwidy1mdWxsIHBiLTJcIj5cbiAgICAgICAgICAgICAgPEF1dG9jb21wbGV0ZVxuICAgICAgICAgICAgICAgIGZ1bGxXaWR0aFxuICAgICAgICAgICAgICAgIG11bHRpcGxlXG4gICAgICAgICAgICAgICAgb3B0aW9ucz17Z2V0UG9zc2libGVQcm9wZXJ0aWVzKCl9XG4gICAgICAgICAgICAgICAgZGlzYWJsZUNsb3NlT25TZWxlY3RcbiAgICAgICAgICAgICAgICBnZXRPcHRpb25MYWJlbD17KG9wdGlvbikgPT4gb3B0aW9uLmxhYmVsfVxuICAgICAgICAgICAgICAgIGlzT3B0aW9uRXF1YWxUb1ZhbHVlPXsob3B0aW9uLCB2YWx1ZSkgPT5cbiAgICAgICAgICAgICAgICAgIG9wdGlvbi52YWx1ZSA9PT0gdmFsdWUudmFsdWVcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgb25DaGFuZ2U9eyhfZSwgbmV3VmFsdWUpID0+IHtcbiAgICAgICAgICAgICAgICAgIG9uQ2hhbmdlKHtcbiAgICAgICAgICAgICAgICAgICAgLi4udmFsdWUsXG4gICAgICAgICAgICAgICAgICAgIHByb3BlcnR5OiBuZXdWYWx1ZS5tYXAoKHZhbCkgPT4gdmFsLnZhbHVlKSxcbiAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgfX1cbiAgICAgICAgICAgICAgICBzaXplPVwic21hbGxcIlxuICAgICAgICAgICAgICAgIHJlbmRlclRhZ3M9eyh0YWdWYWx1ZSwgZ2V0VGFnUHJvcHMpID0+XG4gICAgICAgICAgICAgICAgICB0YWdWYWx1ZS5tYXAoKG9wdGlvbiwgaW5kZXgpID0+IChcbiAgICAgICAgICAgICAgICAgICAgPENoaXBcbiAgICAgICAgICAgICAgICAgICAgICB2YXJpYW50PVwib3V0bGluZWRcIlxuICAgICAgICAgICAgICAgICAgICAgIGNvbG9yPVwiZGVmYXVsdFwiXG4gICAgICAgICAgICAgICAgICAgICAgbGFiZWw9e29wdGlvbi5sYWJlbH1cbiAgICAgICAgICAgICAgICAgICAgICB7Li4uZ2V0VGFnUHJvcHMoeyBpbmRleCB9KX1cbiAgICAgICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgICAgICkpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhbHVlPXtkZXRlcm1pbmVQcm9wZXJ0aWVzVG9BcHBseVRvKHsgdmFsdWUgfSl9XG4gICAgICAgICAgICAgICAgcmVuZGVySW5wdXQ9eyhwYXJhbXMpID0+IChcbiAgICAgICAgICAgICAgICAgIDxUZXh0RmllbGQgey4uLnBhcmFtc30gdmFyaWFudD1cIm91dGxpbmVkXCIgLz5cbiAgICAgICAgICAgICAgICApfVxuICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgPC9HcmlkPlxuICAgICAgICAgICAgPEdyaWRcbiAgICAgICAgICAgICAgY29udGFpbmVyXG4gICAgICAgICAgICAgIGFsaWduSXRlbXM9XCJzdHJldGNoXCJcbiAgICAgICAgICAgICAgZGlyZWN0aW9uPVwicm93XCJcbiAgICAgICAgICAgICAgd3JhcD1cIm5vd3JhcFwiXG4gICAgICAgICAgICAgIGNsYXNzTmFtZT1cInB0LTJcIlxuICAgICAgICAgICAgPlxuICAgICAgICAgICAgICA8R3JpZCBpdGVtPlxuICAgICAgICAgICAgICAgIDxTd2F0aCBjbGFzc05hbWU9XCJ3LTEgaC1mdWxsXCIgLz5cbiAgICAgICAgICAgICAgPC9HcmlkPlxuICAgICAgICAgICAgICA8R3JpZCBjb250YWluZXIgZGlyZWN0aW9uPVwiY29sdW1uXCI+XG4gICAgICAgICAgICAgICAgPEdyaWQgaXRlbSBjbGFzc05hbWU9XCJ3LWZ1bGwgcGwtMiBwYi0yXCI+XG4gICAgICAgICAgICAgICAgICA8VGV4dEZpZWxkXG4gICAgICAgICAgICAgICAgICAgIGZ1bGxXaWR0aFxuICAgICAgICAgICAgICAgICAgICB2YXJpYW50PVwib3V0bGluZWRcIlxuICAgICAgICAgICAgICAgICAgICBzaXplPVwic21hbGxcIlxuICAgICAgICAgICAgICAgICAgICBzZWxlY3RcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU9e3ZhbHVlLnR5cGV9XG4gICAgICAgICAgICAgICAgICAgIG9uQ2hhbmdlPXsoZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgIG9uQ2hhbmdlKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLnZhbHVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogZS50YXJnZXQudmFsdWUsXG4gICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgfX1cbiAgICAgICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICAgICAgPE1lbnVJdGVtIHZhbHVlPVwiQUZURVJcIj5BZnRlcjwvTWVudUl0ZW0+XG4gICAgICAgICAgICAgICAgICAgIDxNZW51SXRlbSB2YWx1ZT1cIkJFRk9SRVwiPkJlZm9yZTwvTWVudUl0ZW0+XG4gICAgICAgICAgICAgICAgICAgIDxNZW51SXRlbSB2YWx1ZT1cIkRVUklOR1wiPkJldHdlZW48L01lbnVJdGVtPlxuICAgICAgICAgICAgICAgICAgICA8TWVudUl0ZW0gdmFsdWU9XCJSRUxBVElWRVwiPldpdGhpbiB0aGUgbGFzdDwvTWVudUl0ZW0+XG4gICAgICAgICAgICAgICAgICAgIDxNZW51SXRlbSB2YWx1ZT1cIkFST1VORFwiPkFyb3VuZDwvTWVudUl0ZW0+XG4gICAgICAgICAgICAgICAgICA8L1RleHRGaWVsZD5cbiAgICAgICAgICAgICAgICA8L0dyaWQ+XG4gICAgICAgICAgICAgICAgPEdyaWQgaXRlbSBjbGFzc05hbWU9XCJ3LWZ1bGwgcGwtMlwiPlxuICAgICAgICAgICAgICAgICAgPEZpbHRlcklucHV0XG4gICAgICAgICAgICAgICAgICAgIGZpbHRlcj17eyAuLi52YWx1ZSwgcHJvcGVydHk6IHZhbHVlLnByb3BlcnR5WzBdIH19XG4gICAgICAgICAgICAgICAgICAgIHNldEZpbHRlcj17KHZhbDogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgb25DaGFuZ2Uoe1xuICAgICAgICAgICAgICAgICAgICAgICAgLi4udmFsdWUsXG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdmFsLnZhbHVlLFxuICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgIH19XG4gICAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgIDwvR3JpZD5cbiAgICAgICAgICAgICAgPC9HcmlkPlxuICAgICAgICAgICAgPC9HcmlkPlxuICAgICAgICAgIDwvR3JpZD5cbiAgICAgICAgKSA6IG51bGx9XG4gICAgICA8L2Rpdj5cbiAgICA8Lz5cbiAgKVxufVxuXG5leHBvcnQgZGVmYXVsdCBob3QobW9kdWxlKShRdWVyeVRpbWUpXG4iXX0=