import { __assign } from "tslib";
import { jsx as _jsx, Fragment as _Fragment } from "react/jsx-runtime";
/**
 * Copyright (c) Codice Foundation
 *
 * This is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser
 * General Public License as published by the Free Software Foundation, either version 3 of the
 * License, or any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
 * even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details. A copy of the GNU Lesser General Public License
 * is distributed along with this program and can be found at
 * <http://www.gnu.org/licenses/lgpl.html>.
 *
 **/
import * as React from 'react';
import { useRef } from 'react';
import { DateInput } from '@blueprintjs/datetime';
import { DateHelpers, DefaultMaxDate, DefaultMinDate, ISO_8601_FORMAT_ZONED, } from './date-helpers';
import { MuiOutlinedInputBorderClasses } from '../theme/theme';
import useTimePrefs from './useTimePrefs';
import user from '../singletons/user-instance';
import { EnterKeySubmitProps } from '../custom-events/enter-key-submit';
import moment from 'moment-timezone';
var validateDate = function (_a) {
    var value = _a.value, onChange = _a.onChange, isNullable = _a.isNullable;
    if (value === null && isNullable)
        return;
    var date = moment(value, ISO_8601_FORMAT_ZONED);
    if (!date.isValid()) {
        var newDate = DateHelpers.General.withPrecision(new Date());
        onChange(newDate.toISOString());
    }
};
export var DateField = React.forwardRef(function (_a, ref) {
    var value = _a.value, onChange = _a.onChange, BPDateProps = _a.BPDateProps, isNullable = _a.isNullable;
    var blueprintDateRef = useRef(null);
    React.useImperativeHandle(ref, function () { return blueprintDateRef.current; }, []);
    useTimePrefs(function () {
        var shiftedDate = DateHelpers.Blueprint.DateProps.generateValue(value);
        var unshiftedDate = DateHelpers.Blueprint.converters.UntimeshiftFromDatePicker(shiftedDate);
        onChange(unshiftedDate.toISOString());
    });
    React.useEffect(function () {
        validateDate({ onChange: onChange, value: value, isNullable: isNullable });
    }, []);
    return (_jsx(_Fragment, { children: _jsx(DateInput, __assign({ ref: blueprintDateRef, className: MuiOutlinedInputBorderClasses, minDate: DefaultMinDate, maxDate: DefaultMaxDate, closeOnSelection: false, fill: true, formatDate: DateHelpers.Blueprint.commonProps.formatDate, onChange: DateHelpers.Blueprint.DateProps.generateOnChange(function (value) {
                onChange(value);
            }), parseDate: DateHelpers.Blueprint.commonProps.parseDate, placeholder: DateHelpers.General.getDateFormat(), shortcuts: true, timePrecision: DateHelpers.General.getTimePrecision(), outOfRangeMessage: "Out of range", timePickerProps: {
                useAmPm: user.getAmPmDisplay(),
            }, inputProps: __assign({}, EnterKeySubmitProps), popoverProps: {
                boundary: 'viewport',
                position: 'bottom',
                onClose: function () {
                    setTimeout(function () {
                        var _a;
                        (_a = blueprintDateRef.current) === null || _a === void 0 ? void 0 : _a.setState({ isOpen: false });
                    }, 0);
                },
            } }, (value
            ? {
                value: DateHelpers.Blueprint.DateProps.generateValue(value),
            }
            : {}), BPDateProps)) }));
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9tYWluL3dlYmFwcC9jb21wb25lbnQvZmllbGRzL2RhdGUudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUE7Ozs7Ozs7Ozs7Ozs7SUFhSTtBQUNKLE9BQU8sS0FBSyxLQUFLLE1BQU0sT0FBTyxDQUFBO0FBQzlCLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxPQUFPLENBQUE7QUFDOUIsT0FBTyxFQUFFLFNBQVMsRUFBa0IsTUFBTSx1QkFBdUIsQ0FBQTtBQUVqRSxPQUFPLEVBQ0wsV0FBVyxFQUNYLGNBQWMsRUFDZCxjQUFjLEVBQ2QscUJBQXFCLEdBQ3RCLE1BQU0sZ0JBQWdCLENBQUE7QUFDdkIsT0FBTyxFQUFFLDZCQUE2QixFQUFFLE1BQU0sZ0JBQWdCLENBQUE7QUFDOUQsT0FBTyxZQUFZLE1BQU0sZ0JBQWdCLENBQUE7QUFFekMsT0FBTyxJQUFJLE1BQU0sNkJBQTZCLENBQUE7QUFDOUMsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sbUNBQW1DLENBQUE7QUFFdkUsT0FBTyxNQUFNLE1BQU0saUJBQWlCLENBQUE7QUFZcEMsSUFBTSxZQUFZLEdBQUcsVUFBQyxFQUErQztRQUE3QyxLQUFLLFdBQUEsRUFBRSxRQUFRLGNBQUEsRUFBRSxVQUFVLGdCQUFBO0lBQ2pELElBQUksS0FBSyxLQUFLLElBQUksSUFBSSxVQUFVO1FBQUUsT0FBTTtJQUV4QyxJQUFNLElBQUksR0FBRyxNQUFNLENBQUMsS0FBSyxFQUFFLHFCQUFxQixDQUFDLENBQUE7SUFDakQsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDO1FBQ3BCLElBQU0sT0FBTyxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsQ0FBQTtRQUM3RCxRQUFRLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUE7SUFDakMsQ0FBQztBQUNILENBQUMsQ0FBQTtBQUVELE1BQU0sQ0FBQyxJQUFNLFNBQVMsR0FBRyxLQUFLLENBQUMsVUFBVSxDQUN2QyxVQUFDLEVBQTRDLEVBQUUsR0FBRztRQUEvQyxLQUFLLFdBQUEsRUFBRSxRQUFRLGNBQUEsRUFBRSxXQUFXLGlCQUFBLEVBQUUsVUFBVSxnQkFBQTtJQUN6QyxJQUFNLGdCQUFnQixHQUFHLE1BQU0sQ0FBWSxJQUFJLENBQUMsQ0FBQTtJQUVoRCxLQUFLLENBQUMsbUJBQW1CLENBQUMsR0FBRyxFQUFFLGNBQU0sT0FBQSxnQkFBZ0IsQ0FBQyxPQUFRLEVBQXpCLENBQXlCLEVBQUUsRUFBRSxDQUFDLENBQUE7SUFFbkUsWUFBWSxDQUFDO1FBQ1gsSUFBTSxXQUFXLEdBQUcsV0FBVyxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBQ3hFLElBQU0sYUFBYSxHQUNqQixXQUFXLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyx5QkFBeUIsQ0FBQyxXQUFXLENBQUMsQ0FBQTtRQUN6RSxRQUFRLENBQUMsYUFBYSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUE7SUFDdkMsQ0FBQyxDQUFDLENBQUE7SUFDRixLQUFLLENBQUMsU0FBUyxDQUFDO1FBQ2QsWUFBWSxDQUFDLEVBQUUsUUFBUSxVQUFBLEVBQUUsS0FBSyxPQUFBLEVBQUUsVUFBVSxZQUFBLEVBQUUsQ0FBQyxDQUFBO0lBQy9DLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQTtJQUVOLE9BQU8sQ0FDTCw0QkFDRSxLQUFDLFNBQVMsYUFDUixHQUFHLEVBQUUsZ0JBQWdCLEVBQ3JCLFNBQVMsRUFBRSw2QkFBNkIsRUFDeEMsT0FBTyxFQUFFLGNBQWMsRUFDdkIsT0FBTyxFQUFFLGNBQWMsRUFDdkIsZ0JBQWdCLEVBQUUsS0FBSyxFQUN2QixJQUFJLFFBQ0osVUFBVSxFQUFFLFdBQVcsQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLFVBQVUsRUFDeEQsUUFBUSxFQUFFLFdBQVcsQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLGdCQUFnQixDQUN4RCxVQUFDLEtBQUs7Z0JBQ0osUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFBO1lBQ2pCLENBQUMsQ0FDRixFQUNELFNBQVMsRUFBRSxXQUFXLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxTQUFTLEVBQ3RELFdBQVcsRUFBRSxXQUFXLENBQUMsT0FBTyxDQUFDLGFBQWEsRUFBRSxFQUNoRCxTQUFTLFFBQ1QsYUFBYSxFQUFFLFdBQVcsQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLEVBQUUsRUFDckQsaUJBQWlCLEVBQUMsY0FBYyxFQUNoQyxlQUFlLEVBQUU7Z0JBQ2YsT0FBTyxFQUFFLElBQUksQ0FBQyxjQUFjLEVBQUU7YUFDL0IsRUFDRCxVQUFVLGVBQ0wsbUJBQW1CLEdBRXhCLFlBQVksRUFBRTtnQkFDWixRQUFRLEVBQUUsVUFBVTtnQkFDcEIsUUFBUSxFQUFFLFFBQVE7Z0JBQ2xCLE9BQU8sRUFBRTtvQkFDUCxVQUFVLENBQUM7O3dCQUNULE1BQUEsZ0JBQWdCLENBQUMsT0FBTywwQ0FBRSxRQUFRLENBQUMsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQTtvQkFDdkQsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFBO2dCQUNQLENBQUM7YUFDRixJQUNHLENBQUMsS0FBSztZQUNSLENBQUMsQ0FBQztnQkFDRSxLQUFLLEVBQUUsV0FBVyxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQzthQUM1RDtZQUNILENBQUMsQ0FBQyxFQUFFLENBQUMsRUFDSCxXQUFXLEVBQ2YsR0FDRCxDQUNKLENBQUE7QUFDSCxDQUFDLENBQ0YsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSBDb2RpY2UgRm91bmRhdGlvblxuICpcbiAqIFRoaXMgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeSBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBMZXNzZXJcbiAqIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5IHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlXG4gKiBMaWNlbnNlLCBvciBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0XG4gKiBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gU2VlIHRoZSBHTlVcbiAqIExlc3NlciBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuIEEgY29weSBvZiB0aGUgR05VIExlc3NlciBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlXG4gKiBpcyBkaXN0cmlidXRlZCBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbSBhbmQgY2FuIGJlIGZvdW5kIGF0XG4gKiA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzL2xncGwuaHRtbD4uXG4gKlxuICoqL1xuaW1wb3J0ICogYXMgUmVhY3QgZnJvbSAncmVhY3QnXG5pbXBvcnQgeyB1c2VSZWYgfSBmcm9tICdyZWFjdCdcbmltcG9ydCB7IERhdGVJbnB1dCwgRGF0ZUlucHV0UHJvcHMgfSBmcm9tICdAYmx1ZXByaW50anMvZGF0ZXRpbWUnXG5cbmltcG9ydCB7XG4gIERhdGVIZWxwZXJzLFxuICBEZWZhdWx0TWF4RGF0ZSxcbiAgRGVmYXVsdE1pbkRhdGUsXG4gIElTT184NjAxX0ZPUk1BVF9aT05FRCxcbn0gZnJvbSAnLi9kYXRlLWhlbHBlcnMnXG5pbXBvcnQgeyBNdWlPdXRsaW5lZElucHV0Qm9yZGVyQ2xhc3NlcyB9IGZyb20gJy4uL3RoZW1lL3RoZW1lJ1xuaW1wb3J0IHVzZVRpbWVQcmVmcyBmcm9tICcuL3VzZVRpbWVQcmVmcydcblxuaW1wb3J0IHVzZXIgZnJvbSAnLi4vc2luZ2xldG9ucy91c2VyLWluc3RhbmNlJ1xuaW1wb3J0IHsgRW50ZXJLZXlTdWJtaXRQcm9wcyB9IGZyb20gJy4uL2N1c3RvbS1ldmVudHMvZW50ZXIta2V5LXN1Ym1pdCdcblxuaW1wb3J0IG1vbWVudCBmcm9tICdtb21lbnQtdGltZXpvbmUnXG5cbnR5cGUgRGF0ZUZpZWxkUHJvcHMgPSB7XG4gIHZhbHVlOiBzdHJpbmdcbiAgb25DaGFuZ2U6ICh2YWx1ZTogc3RyaW5nKSA9PiB2b2lkXG4gIC8qKlxuICAgKiBPdmVycmlkZSBpZiB5b3UgYWJzb2x1dGVseSBtdXN0XG4gICAqL1xuICBCUERhdGVQcm9wcz86IFBhcnRpYWw8RGF0ZUlucHV0UHJvcHM+XG4gIGlzTnVsbGFibGU/OiBib29sZWFuXG59XG5cbmNvbnN0IHZhbGlkYXRlRGF0ZSA9ICh7IHZhbHVlLCBvbkNoYW5nZSwgaXNOdWxsYWJsZSB9OiBEYXRlRmllbGRQcm9wcykgPT4ge1xuICBpZiAodmFsdWUgPT09IG51bGwgJiYgaXNOdWxsYWJsZSkgcmV0dXJuXG5cbiAgY29uc3QgZGF0ZSA9IG1vbWVudCh2YWx1ZSwgSVNPXzg2MDFfRk9STUFUX1pPTkVEKVxuICBpZiAoIWRhdGUuaXNWYWxpZCgpKSB7XG4gICAgY29uc3QgbmV3RGF0ZSA9IERhdGVIZWxwZXJzLkdlbmVyYWwud2l0aFByZWNpc2lvbihuZXcgRGF0ZSgpKVxuICAgIG9uQ2hhbmdlKG5ld0RhdGUudG9JU09TdHJpbmcoKSlcbiAgfVxufVxuXG5leHBvcnQgY29uc3QgRGF0ZUZpZWxkID0gUmVhY3QuZm9yd2FyZFJlZjxEYXRlSW5wdXQsIERhdGVGaWVsZFByb3BzPihcbiAgKHsgdmFsdWUsIG9uQ2hhbmdlLCBCUERhdGVQcm9wcywgaXNOdWxsYWJsZSB9LCByZWYpID0+IHtcbiAgICBjb25zdCBibHVlcHJpbnREYXRlUmVmID0gdXNlUmVmPERhdGVJbnB1dD4obnVsbClcblxuICAgIFJlYWN0LnVzZUltcGVyYXRpdmVIYW5kbGUocmVmLCAoKSA9PiBibHVlcHJpbnREYXRlUmVmLmN1cnJlbnQhLCBbXSlcblxuICAgIHVzZVRpbWVQcmVmcygoKSA9PiB7XG4gICAgICBjb25zdCBzaGlmdGVkRGF0ZSA9IERhdGVIZWxwZXJzLkJsdWVwcmludC5EYXRlUHJvcHMuZ2VuZXJhdGVWYWx1ZSh2YWx1ZSlcbiAgICAgIGNvbnN0IHVuc2hpZnRlZERhdGUgPVxuICAgICAgICBEYXRlSGVscGVycy5CbHVlcHJpbnQuY29udmVydGVycy5VbnRpbWVzaGlmdEZyb21EYXRlUGlja2VyKHNoaWZ0ZWREYXRlKVxuICAgICAgb25DaGFuZ2UodW5zaGlmdGVkRGF0ZS50b0lTT1N0cmluZygpKVxuICAgIH0pXG4gICAgUmVhY3QudXNlRWZmZWN0KCgpID0+IHtcbiAgICAgIHZhbGlkYXRlRGF0ZSh7IG9uQ2hhbmdlLCB2YWx1ZSwgaXNOdWxsYWJsZSB9KVxuICAgIH0sIFtdKVxuXG4gICAgcmV0dXJuIChcbiAgICAgIDw+XG4gICAgICAgIDxEYXRlSW5wdXRcbiAgICAgICAgICByZWY9e2JsdWVwcmludERhdGVSZWZ9XG4gICAgICAgICAgY2xhc3NOYW1lPXtNdWlPdXRsaW5lZElucHV0Qm9yZGVyQ2xhc3Nlc31cbiAgICAgICAgICBtaW5EYXRlPXtEZWZhdWx0TWluRGF0ZX1cbiAgICAgICAgICBtYXhEYXRlPXtEZWZhdWx0TWF4RGF0ZX1cbiAgICAgICAgICBjbG9zZU9uU2VsZWN0aW9uPXtmYWxzZX1cbiAgICAgICAgICBmaWxsXG4gICAgICAgICAgZm9ybWF0RGF0ZT17RGF0ZUhlbHBlcnMuQmx1ZXByaW50LmNvbW1vblByb3BzLmZvcm1hdERhdGV9XG4gICAgICAgICAgb25DaGFuZ2U9e0RhdGVIZWxwZXJzLkJsdWVwcmludC5EYXRlUHJvcHMuZ2VuZXJhdGVPbkNoYW5nZShcbiAgICAgICAgICAgICh2YWx1ZSkgPT4ge1xuICAgICAgICAgICAgICBvbkNoYW5nZSh2YWx1ZSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICApfVxuICAgICAgICAgIHBhcnNlRGF0ZT17RGF0ZUhlbHBlcnMuQmx1ZXByaW50LmNvbW1vblByb3BzLnBhcnNlRGF0ZX1cbiAgICAgICAgICBwbGFjZWhvbGRlcj17RGF0ZUhlbHBlcnMuR2VuZXJhbC5nZXREYXRlRm9ybWF0KCl9XG4gICAgICAgICAgc2hvcnRjdXRzXG4gICAgICAgICAgdGltZVByZWNpc2lvbj17RGF0ZUhlbHBlcnMuR2VuZXJhbC5nZXRUaW1lUHJlY2lzaW9uKCl9XG4gICAgICAgICAgb3V0T2ZSYW5nZU1lc3NhZ2U9XCJPdXQgb2YgcmFuZ2VcIlxuICAgICAgICAgIHRpbWVQaWNrZXJQcm9wcz17e1xuICAgICAgICAgICAgdXNlQW1QbTogdXNlci5nZXRBbVBtRGlzcGxheSgpLFxuICAgICAgICAgIH19XG4gICAgICAgICAgaW5wdXRQcm9wcz17e1xuICAgICAgICAgICAgLi4uRW50ZXJLZXlTdWJtaXRQcm9wcyxcbiAgICAgICAgICB9fVxuICAgICAgICAgIHBvcG92ZXJQcm9wcz17e1xuICAgICAgICAgICAgYm91bmRhcnk6ICd2aWV3cG9ydCcsXG4gICAgICAgICAgICBwb3NpdGlvbjogJ2JvdHRvbScsXG4gICAgICAgICAgICBvbkNsb3NlOiAoKSA9PiB7XG4gICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgIGJsdWVwcmludERhdGVSZWYuY3VycmVudD8uc2V0U3RhdGUoeyBpc09wZW46IGZhbHNlIH0pXG4gICAgICAgICAgICAgIH0sIDApXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH19XG4gICAgICAgICAgey4uLih2YWx1ZVxuICAgICAgICAgICAgPyB7XG4gICAgICAgICAgICAgICAgdmFsdWU6IERhdGVIZWxwZXJzLkJsdWVwcmludC5EYXRlUHJvcHMuZ2VuZXJhdGVWYWx1ZSh2YWx1ZSksXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIDoge30pfVxuICAgICAgICAgIHsuLi5CUERhdGVQcm9wc31cbiAgICAgICAgLz5cbiAgICAgIDwvPlxuICAgIClcbiAgfVxuKVxuIl19