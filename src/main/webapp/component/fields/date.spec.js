import { __read } from "tslib";
import { jsx as _jsx } from "react/jsx-runtime";
import React from 'react';
import { DateField } from './date';
import moment from 'moment-timezone';
import { expect } from 'chai';
import user from '../singletons/user-instance';
import { DateHelpers, ISO_8601_FORMAT_ZONED } from './date-helpers';
import Common from '../../js/Common';
import { fireEvent, render } from '@testing-library/react';
/**
 * Useful for seeing if updates are called correctly.
 */
var UncontrolledDateField = function (_a) {
    var startingValue = _a.startingValue;
    var _b = __read(React.useState(startingValue), 2), value = _b[0], setValue = _b[1];
    return (_jsx(DateField, { value: value, onChange: function (update) {
            setValue(update);
        }, BPDateProps: {
            inputProps: {
                name: 'test',
            },
        } }));
};
// rely on static data when possible, but in these we can use the DateHelpers (a must for shifted date timezone testing)
var data = {
    date1: {
        timezone: 'America/St_Johns',
        originalISO: '2021-01-15T06:53:54.316Z',
        originalDate: new Date('2021-01-15T06:53:54.316Z'),
        utcISOMinutes: '2021-01-15T06:53:00.000Z',
        userFormatISO: {
            millisecond: '2021-01-15T03:23:54.316-03:30',
            second: '2021-01-15T03:23:54-03:30',
            minute: '2021-01-15T03:23-03:30',
        },
        userFormat24: {
            millisecond: '15 Jan 2021 03:23:54.316 -03:30',
            second: '15 Jan 2021 03:23:54 -03:30',
            minute: '15 Jan 2021 03:23 -03:30',
        },
        userFormat12: {
            millisecond: '15 Jan 2021 03:23:54.316 am -03:30',
            second: '15 Jan 2021 03:23:54 am -03:30',
            minute: '15 Jan 2021 03:23 am -03:30',
        },
    },
    date2: {
        timezone: 'America/St_Johns',
        userSuppliedInput: '15 Jan 2021 03:24:54.316 -02:30',
        parsedOutput: '15 Jan 2021 02:24:54.316 -03:30',
    },
    date3: {
        timezone: 'Etc/UTC',
        maxFuture: moment().add(10, 'years').toISOString(),
        disallowedFuture: moment().add(11, 'years').toISOString(),
    },
    // this is useful for testing daylist savings (date 1 is pre, this is post)
    date4: {
        timezone: 'America/St_Johns',
        originalISO: '2021-04-15T05:53:54.316Z',
    },
};
describe('verify date field works', function () {
    before(function () {
        user.get('user').get('preferences').set('timeZone', data.date1.timezone);
    });
    after(function () {
        user.get('user').get('preferences').set('timeZone', 'Etc/UTC');
    });
    beforeEach(function () {
        user
            .get('user')
            .get('preferences')
            .set('dateTimeFormat', Common.getDateTimeFormats()['ISO']['millisecond']);
    });
    afterEach(function () {
        user
            .get('user')
            .get('preferences')
            .set('dateTimeFormat', Common.getDateTimeFormats()['ISO']['millisecond']);
    });
    var verifyDateRender = function (format, precision, expected) {
        return function () {
            user
                .get('user')
                .get('preferences')
                .set('dateTimeFormat', Common.getDateTimeFormats()[format][precision]);
            var getAllByRole = render(_jsx(DateField, { value: data.date1.originalISO, onChange: function () { } })).getAllByRole;
            var inputs = getAllByRole('textbox');
            expect(inputs[0].value).to.equal(expected);
        };
    };
    it('should render with ISO format and millisecond precision', verifyDateRender('ISO', 'millisecond', data.date1.userFormatISO.millisecond));
    it('should render with ISO format and second precision', verifyDateRender('ISO', 'second', data.date1.userFormatISO.second));
    it('should render with ISO format and minute precision', verifyDateRender('ISO', 'minute', data.date1.userFormatISO.minute));
    it('should render with 24hr format and millisecond precision', verifyDateRender('24', 'millisecond', data.date1.userFormat24.millisecond));
    it('should render with 24hr format and second precision', verifyDateRender('24', 'second', data.date1.userFormat24.second));
    it('should render with 24hr format and minute precision', verifyDateRender('24', 'minute', data.date1.userFormat24.minute));
    it('should render with 12hr format and millisecond precision', verifyDateRender('12', 'millisecond', data.date1.userFormat12.millisecond));
    it('should render with 12hr format and second precision', verifyDateRender('12', 'second', data.date1.userFormat12.second));
    it('should render with 12hr format and minute precision', verifyDateRender('12', 'minute', data.date1.userFormat12.minute));
    it("should parse with user's pref timezone", function () {
        // gist is user enters a time in a diff time from their pref, on blur we adjust it to their preference
        user
            .get('user')
            .get('preferences')
            .set('dateTimeFormat', Common.getDateTimeFormats()['24']['millisecond']);
        var getAllByRole = render(_jsx(UncontrolledDateField, { startingValue: data.date1.originalISO })).getAllByRole;
        // fire event
        var inputs = getAllByRole('textbox');
        fireEvent.change(inputs[0], {
            target: { value: data.date2.userSuppliedInput },
        });
        expect(inputs[0].value).to.equal(data.date2.parsedOutput);
    });
    it("should generate appropriately shifted ISO strings on change (DST)", function () {
        var ref = React.createRef();
        render(_jsx(DateField, { value: new Date().toISOString(), onChange: function (updatedValue) {
                expect(updatedValue).to.equal(data.date4.originalISO);
            }, ref: ref }));
        if (ref.current) {
            var handleDateChange = Reflect.get(ref.current, 'handleDateChange');
            handleDateChange(DateHelpers.Blueprint.converters.TimeshiftForDatePicker(data.date4.originalISO, ISO_8601_FORMAT_ZONED), true);
        }
    });
    it("should generate appropriately shifted ISO strings on change", function () {
        var ref = React.createRef();
        render(_jsx(DateField, { value: new Date().toISOString(), onChange: function (updatedValue) {
                expect(updatedValue).to.equal(data.date1.originalISO);
            } }));
        if (ref.current) {
            var handleDateChange = Reflect.get(ref.current, 'handleDateChange');
            handleDateChange(DateHelpers.Blueprint.converters.TimeshiftForDatePicker(data.date1.originalISO, ISO_8601_FORMAT_ZONED), true);
        }
    });
    it("should not allow dates beyond max future", function () {
        var getAllByRole = render(_jsx(DateField, { value: new Date().toISOString(), onChange: function (updatedValue) {
                expect(updatedValue).to.not.equal(data.date3.maxFuture);
            } })).getAllByRole;
        var inputs = getAllByRole('textbox');
        fireEvent.change(inputs[0], {
            target: { value: data.date3.disallowedFuture },
        });
    });
    it("should allow dates up to max future", function () {
        var getAllByRole = render(_jsx(DateField, { value: new Date().toISOString(), onChange: function (updatedValue) {
                expect(updatedValue).to.equal(data.date3.maxFuture);
            } })).getAllByRole;
        var inputs = getAllByRole('textbox');
        fireEvent.change(inputs[0], {
            target: { value: data.date3.maxFuture },
        });
    });
    it('calls onChange with updated value when precision changes', function (done) {
        var value = data.date1.userFormatISO.millisecond;
        render(_jsx(DateField, { value: value, onChange: function (updatedValue) {
                value = updatedValue;
            } }));
        user
            .get('user')
            .get('preferences')
            .set('dateTimeFormat', Common.getDateTimeFormats()['ISO']['minute']);
        // wait for the value to update
        setTimeout(function () {
            expect(value).to.equal(data.date1.utcISOMinutes);
            done();
        }, 100);
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0ZS5zcGVjLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL21haW4vd2ViYXBwL2NvbXBvbmVudC9maWVsZHMvZGF0ZS5zcGVjLnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLE9BQU8sS0FBSyxNQUFNLE9BQU8sQ0FBQTtBQUV6QixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sUUFBUSxDQUFBO0FBQ2xDLE9BQU8sTUFBTSxNQUFNLGlCQUFpQixDQUFBO0FBQ3BDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxNQUFNLENBQUE7QUFFN0IsT0FBTyxJQUFJLE1BQU0sNkJBQTZCLENBQUE7QUFDOUMsT0FBTyxFQUFFLFdBQVcsRUFBRSxxQkFBcUIsRUFBRSxNQUFNLGdCQUFnQixDQUFBO0FBQ25FLE9BQU8sTUFBTSxNQUFNLGlCQUFpQixDQUFBO0FBRXBDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLE1BQU0sd0JBQXdCLENBQUE7QUFFMUQ7O0dBRUc7QUFDSCxJQUFNLHFCQUFxQixHQUFHLFVBQUMsRUFJOUI7UUFIQyxhQUFhLG1CQUFBO0lBSVAsSUFBQSxLQUFBLE9BQW9CLEtBQUssQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLElBQUEsRUFBaEQsS0FBSyxRQUFBLEVBQUUsUUFBUSxRQUFpQyxDQUFBO0lBQ3ZELE9BQU8sQ0FDTCxLQUFDLFNBQVMsSUFDUixLQUFLLEVBQUUsS0FBSyxFQUNaLFFBQVEsRUFBRSxVQUFDLE1BQU07WUFDZixRQUFRLENBQUMsTUFBTSxDQUFDLENBQUE7UUFDbEIsQ0FBQyxFQUNELFdBQVcsRUFBRTtZQUNYLFVBQVUsRUFBRTtnQkFDVixJQUFJLEVBQUUsTUFBTTthQUNiO1NBQ0YsR0FDRCxDQUNILENBQUE7QUFDSCxDQUFDLENBQUE7QUFFRCx3SEFBd0g7QUFDeEgsSUFBTSxJQUFJLEdBQUc7SUFDWCxLQUFLLEVBQUU7UUFDTCxRQUFRLEVBQUUsa0JBQWtC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SCxhQVBtQixDQU9uQjtRQUNELElBQU0sTUFBTSxHQUFHLFlBQVksQ0FBQyxTQUFTLENBQXVCLENBQUE7UUFDNUQsU0FBUyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDMUIsTUFBTSxFQUFFLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxFQUFFO1NBQ3hDLENBQUMsQ0FBQTtJQUNKLENBQUMsQ0FBQyxDQUFBO0lBQ0YsRUFBRSxDQUFDLDBEQUEwRCxFQUFFLFVBQUMsSUFBSTtRQUNsRSxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUE7UUFDaEQsTUFBTSxDQUNKLEtBQUMsU0FBUyxJQUNSLEtBQUssRUFBRSxLQUFLLEVBQ1osUUFBUSxFQUFFLFVBQUMsWUFBWTtnQkFDckIsS0FBSyxHQUFHLFlBQVksQ0FBQTtZQUN0QixDQUFDLEdBQ0QsQ0FDSCxDQUFBO1FBQ0QsSUFBSTthQUNELEdBQUcsQ0FBQyxNQUFNLENBQUM7YUFDWCxHQUFHLENBQUMsYUFBYSxDQUFDO2FBQ2xCLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxNQUFNLENBQUMsa0JBQWtCLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFBO1FBQ3RFLCtCQUErQjtRQUMvQixVQUFVLENBQUM7WUFDVCxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxDQUFBO1lBQ2hELElBQUksRUFBRSxDQUFBO1FBQ1IsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFBO0lBQ1QsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCdcblxuaW1wb3J0IHsgRGF0ZUZpZWxkIH0gZnJvbSAnLi9kYXRlJ1xuaW1wb3J0IG1vbWVudCBmcm9tICdtb21lbnQtdGltZXpvbmUnXG5pbXBvcnQgeyBleHBlY3QgfSBmcm9tICdjaGFpJ1xuXG5pbXBvcnQgdXNlciBmcm9tICcuLi9zaW5nbGV0b25zL3VzZXItaW5zdGFuY2UnXG5pbXBvcnQgeyBEYXRlSGVscGVycywgSVNPXzg2MDFfRk9STUFUX1pPTkVEIH0gZnJvbSAnLi9kYXRlLWhlbHBlcnMnXG5pbXBvcnQgQ29tbW9uIGZyb20gJy4uLy4uL2pzL0NvbW1vbidcbmltcG9ydCB7IERhdGVJbnB1dCwgVGltZVByZWNpc2lvbiB9IGZyb20gJ0BibHVlcHJpbnRqcy9kYXRldGltZSdcbmltcG9ydCB7IGZpcmVFdmVudCwgcmVuZGVyIH0gZnJvbSAnQHRlc3RpbmctbGlicmFyeS9yZWFjdCdcblxuLyoqXG4gKiBVc2VmdWwgZm9yIHNlZWluZyBpZiB1cGRhdGVzIGFyZSBjYWxsZWQgY29ycmVjdGx5LlxuICovXG5jb25zdCBVbmNvbnRyb2xsZWREYXRlRmllbGQgPSAoe1xuICBzdGFydGluZ1ZhbHVlLFxufToge1xuICBzdGFydGluZ1ZhbHVlOiBzdHJpbmdcbn0pID0+IHtcbiAgY29uc3QgW3ZhbHVlLCBzZXRWYWx1ZV0gPSBSZWFjdC51c2VTdGF0ZShzdGFydGluZ1ZhbHVlKVxuICByZXR1cm4gKFxuICAgIDxEYXRlRmllbGRcbiAgICAgIHZhbHVlPXt2YWx1ZX1cbiAgICAgIG9uQ2hhbmdlPXsodXBkYXRlKSA9PiB7XG4gICAgICAgIHNldFZhbHVlKHVwZGF0ZSlcbiAgICAgIH19XG4gICAgICBCUERhdGVQcm9wcz17e1xuICAgICAgICBpbnB1dFByb3BzOiB7XG4gICAgICAgICAgbmFtZTogJ3Rlc3QnLFxuICAgICAgICB9LFxuICAgICAgfX1cbiAgICAvPlxuICApXG59XG5cbi8vIHJlbHkgb24gc3RhdGljIGRhdGEgd2hlbiBwb3NzaWJsZSwgYnV0IGluIHRoZXNlIHdlIGNhbiB1c2UgdGhlIERhdGVIZWxwZXJzIChhIG11c3QgZm9yIHNoaWZ0ZWQgZGF0ZSB0aW1lem9uZSB0ZXN0aW5nKVxuY29uc3QgZGF0YSA9IHtcbiAgZGF0ZTE6IHtcbiAgICB0aW1lem9uZTogJ0FtZXJpY2EvU3RfSm9obnMnLFxuICAgIG9yaWdpbmFsSVNPOiAnMjAyMS0wMS0xNVQwNjo1Mzo1NC4zMTZaJyxcbiAgICBvcmlnaW5hbERhdGU6IG5ldyBEYXRlKCcyMDIxLTAxLTE1VDA2OjUzOjU0LjMxNlonKSxcbiAgICB1dGNJU09NaW51dGVzOiAnMjAyMS0wMS0xNVQwNjo1MzowMC4wMDBaJyxcbiAgICB1c2VyRm9ybWF0SVNPOiB7XG4gICAgICBtaWxsaXNlY29uZDogJzIwMjEtMDEtMTVUMDM6MjM6NTQuMzE2LTAzOjMwJyxcbiAgICAgIHNlY29uZDogJzIwMjEtMDEtMTVUMDM6MjM6NTQtMDM6MzAnLFxuICAgICAgbWludXRlOiAnMjAyMS0wMS0xNVQwMzoyMy0wMzozMCcsXG4gICAgfSxcbiAgICB1c2VyRm9ybWF0MjQ6IHtcbiAgICAgIG1pbGxpc2Vjb25kOiAnMTUgSmFuIDIwMjEgMDM6MjM6NTQuMzE2IC0wMzozMCcsXG4gICAgICBzZWNvbmQ6ICcxNSBKYW4gMjAyMSAwMzoyMzo1NCAtMDM6MzAnLFxuICAgICAgbWludXRlOiAnMTUgSmFuIDIwMjEgMDM6MjMgLTAzOjMwJyxcbiAgICB9LFxuICAgIHVzZXJGb3JtYXQxMjoge1xuICAgICAgbWlsbGlzZWNvbmQ6ICcxNSBKYW4gMjAyMSAwMzoyMzo1NC4zMTYgYW0gLTAzOjMwJyxcbiAgICAgIHNlY29uZDogJzE1IEphbiAyMDIxIDAzOjIzOjU0IGFtIC0wMzozMCcsXG4gICAgICBtaW51dGU6ICcxNSBKYW4gMjAyMSAwMzoyMyBhbSAtMDM6MzAnLFxuICAgIH0sXG4gIH0sXG4gIGRhdGUyOiB7XG4gICAgdGltZXpvbmU6ICdBbWVyaWNhL1N0X0pvaG5zJyxcbiAgICB1c2VyU3VwcGxpZWRJbnB1dDogJzE1IEphbiAyMDIxIDAzOjI0OjU0LjMxNiAtMDI6MzAnLFxuICAgIHBhcnNlZE91dHB1dDogJzE1IEphbiAyMDIxIDAyOjI0OjU0LjMxNiAtMDM6MzAnLFxuICB9LFxuICBkYXRlMzoge1xuICAgIHRpbWV6b25lOiAnRXRjL1VUQycsXG4gICAgbWF4RnV0dXJlOiBtb21lbnQoKS5hZGQoMTAsICd5ZWFycycpLnRvSVNPU3RyaW5nKCksXG4gICAgZGlzYWxsb3dlZEZ1dHVyZTogbW9tZW50KCkuYWRkKDExLCAneWVhcnMnKS50b0lTT1N0cmluZygpLFxuICB9LFxuICAvLyB0aGlzIGlzIHVzZWZ1bCBmb3IgdGVzdGluZyBkYXlsaXN0IHNhdmluZ3MgKGRhdGUgMSBpcyBwcmUsIHRoaXMgaXMgcG9zdClcbiAgZGF0ZTQ6IHtcbiAgICB0aW1lem9uZTogJ0FtZXJpY2EvU3RfSm9obnMnLFxuICAgIG9yaWdpbmFsSVNPOiAnMjAyMS0wNC0xNVQwNTo1Mzo1NC4zMTZaJyxcbiAgfSxcbn1cbmRlc2NyaWJlKCd2ZXJpZnkgZGF0ZSBmaWVsZCB3b3JrcycsICgpID0+IHtcbiAgYmVmb3JlKCgpID0+IHtcbiAgICB1c2VyLmdldCgndXNlcicpLmdldCgncHJlZmVyZW5jZXMnKS5zZXQoJ3RpbWVab25lJywgZGF0YS5kYXRlMS50aW1lem9uZSlcbiAgfSlcbiAgYWZ0ZXIoKCkgPT4ge1xuICAgIHVzZXIuZ2V0KCd1c2VyJykuZ2V0KCdwcmVmZXJlbmNlcycpLnNldCgndGltZVpvbmUnLCAnRXRjL1VUQycpXG4gIH0pXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIHVzZXJcbiAgICAgIC5nZXQoJ3VzZXInKVxuICAgICAgLmdldCgncHJlZmVyZW5jZXMnKVxuICAgICAgLnNldCgnZGF0ZVRpbWVGb3JtYXQnLCBDb21tb24uZ2V0RGF0ZVRpbWVGb3JtYXRzKClbJ0lTTyddWydtaWxsaXNlY29uZCddKVxuICB9KVxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIHVzZXJcbiAgICAgIC5nZXQoJ3VzZXInKVxuICAgICAgLmdldCgncHJlZmVyZW5jZXMnKVxuICAgICAgLnNldCgnZGF0ZVRpbWVGb3JtYXQnLCBDb21tb24uZ2V0RGF0ZVRpbWVGb3JtYXRzKClbJ0lTTyddWydtaWxsaXNlY29uZCddKVxuICB9KVxuICBjb25zdCB2ZXJpZnlEYXRlUmVuZGVyID0gKFxuICAgIGZvcm1hdDogc3RyaW5nLFxuICAgIHByZWNpc2lvbjogVGltZVByZWNpc2lvbixcbiAgICBleHBlY3RlZDogc3RyaW5nXG4gICkgPT4ge1xuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICB1c2VyXG4gICAgICAgIC5nZXQoJ3VzZXInKVxuICAgICAgICAuZ2V0KCdwcmVmZXJlbmNlcycpXG4gICAgICAgIC5zZXQoJ2RhdGVUaW1lRm9ybWF0JywgQ29tbW9uLmdldERhdGVUaW1lRm9ybWF0cygpW2Zvcm1hdF1bcHJlY2lzaW9uXSlcbiAgICAgIGNvbnN0IHsgZ2V0QWxsQnlSb2xlIH0gPSByZW5kZXIoXG4gICAgICAgIDxEYXRlRmllbGQgdmFsdWU9e2RhdGEuZGF0ZTEub3JpZ2luYWxJU099IG9uQ2hhbmdlPXsoKSA9PiB7fX0gLz5cbiAgICAgIClcbiAgICAgIGNvbnN0IGlucHV0cyA9IGdldEFsbEJ5Um9sZSgndGV4dGJveCcpIGFzIEhUTUxJbnB1dEVsZW1lbnRbXVxuICAgICAgZXhwZWN0KGlucHV0c1swXS52YWx1ZSkudG8uZXF1YWwoZXhwZWN0ZWQpXG4gICAgfVxuICB9XG4gIGl0KFxuICAgICdzaG91bGQgcmVuZGVyIHdpdGggSVNPIGZvcm1hdCBhbmQgbWlsbGlzZWNvbmQgcHJlY2lzaW9uJyxcbiAgICB2ZXJpZnlEYXRlUmVuZGVyKCdJU08nLCAnbWlsbGlzZWNvbmQnLCBkYXRhLmRhdGUxLnVzZXJGb3JtYXRJU08ubWlsbGlzZWNvbmQpXG4gIClcbiAgaXQoXG4gICAgJ3Nob3VsZCByZW5kZXIgd2l0aCBJU08gZm9ybWF0IGFuZCBzZWNvbmQgcHJlY2lzaW9uJyxcbiAgICB2ZXJpZnlEYXRlUmVuZGVyKCdJU08nLCAnc2Vjb25kJywgZGF0YS5kYXRlMS51c2VyRm9ybWF0SVNPLnNlY29uZClcbiAgKVxuICBpdChcbiAgICAnc2hvdWxkIHJlbmRlciB3aXRoIElTTyBmb3JtYXQgYW5kIG1pbnV0ZSBwcmVjaXNpb24nLFxuICAgIHZlcmlmeURhdGVSZW5kZXIoJ0lTTycsICdtaW51dGUnLCBkYXRhLmRhdGUxLnVzZXJGb3JtYXRJU08ubWludXRlKVxuICApXG4gIGl0KFxuICAgICdzaG91bGQgcmVuZGVyIHdpdGggMjRociBmb3JtYXQgYW5kIG1pbGxpc2Vjb25kIHByZWNpc2lvbicsXG4gICAgdmVyaWZ5RGF0ZVJlbmRlcignMjQnLCAnbWlsbGlzZWNvbmQnLCBkYXRhLmRhdGUxLnVzZXJGb3JtYXQyNC5taWxsaXNlY29uZClcbiAgKVxuICBpdChcbiAgICAnc2hvdWxkIHJlbmRlciB3aXRoIDI0aHIgZm9ybWF0IGFuZCBzZWNvbmQgcHJlY2lzaW9uJyxcbiAgICB2ZXJpZnlEYXRlUmVuZGVyKCcyNCcsICdzZWNvbmQnLCBkYXRhLmRhdGUxLnVzZXJGb3JtYXQyNC5zZWNvbmQpXG4gIClcbiAgaXQoXG4gICAgJ3Nob3VsZCByZW5kZXIgd2l0aCAyNGhyIGZvcm1hdCBhbmQgbWludXRlIHByZWNpc2lvbicsXG4gICAgdmVyaWZ5RGF0ZVJlbmRlcignMjQnLCAnbWludXRlJywgZGF0YS5kYXRlMS51c2VyRm9ybWF0MjQubWludXRlKVxuICApXG4gIGl0KFxuICAgICdzaG91bGQgcmVuZGVyIHdpdGggMTJociBmb3JtYXQgYW5kIG1pbGxpc2Vjb25kIHByZWNpc2lvbicsXG4gICAgdmVyaWZ5RGF0ZVJlbmRlcignMTInLCAnbWlsbGlzZWNvbmQnLCBkYXRhLmRhdGUxLnVzZXJGb3JtYXQxMi5taWxsaXNlY29uZClcbiAgKVxuICBpdChcbiAgICAnc2hvdWxkIHJlbmRlciB3aXRoIDEyaHIgZm9ybWF0IGFuZCBzZWNvbmQgcHJlY2lzaW9uJyxcbiAgICB2ZXJpZnlEYXRlUmVuZGVyKCcxMicsICdzZWNvbmQnLCBkYXRhLmRhdGUxLnVzZXJGb3JtYXQxMi5zZWNvbmQpXG4gIClcbiAgaXQoXG4gICAgJ3Nob3VsZCByZW5kZXIgd2l0aCAxMmhyIGZvcm1hdCBhbmQgbWludXRlIHByZWNpc2lvbicsXG4gICAgdmVyaWZ5RGF0ZVJlbmRlcignMTInLCAnbWludXRlJywgZGF0YS5kYXRlMS51c2VyRm9ybWF0MTIubWludXRlKVxuICApXG4gIGl0KGBzaG91bGQgcGFyc2Ugd2l0aCB1c2VyJ3MgcHJlZiB0aW1lem9uZWAsICgpID0+IHtcbiAgICAvLyBnaXN0IGlzIHVzZXIgZW50ZXJzIGEgdGltZSBpbiBhIGRpZmYgdGltZSBmcm9tIHRoZWlyIHByZWYsIG9uIGJsdXIgd2UgYWRqdXN0IGl0IHRvIHRoZWlyIHByZWZlcmVuY2VcbiAgICB1c2VyXG4gICAgICAuZ2V0KCd1c2VyJylcbiAgICAgIC5nZXQoJ3ByZWZlcmVuY2VzJylcbiAgICAgIC5zZXQoJ2RhdGVUaW1lRm9ybWF0JywgQ29tbW9uLmdldERhdGVUaW1lRm9ybWF0cygpWycyNCddWydtaWxsaXNlY29uZCddKVxuXG4gICAgY29uc3QgeyBnZXRBbGxCeVJvbGUgfSA9IHJlbmRlcihcbiAgICAgIDxVbmNvbnRyb2xsZWREYXRlRmllbGQgc3RhcnRpbmdWYWx1ZT17ZGF0YS5kYXRlMS5vcmlnaW5hbElTT30gLz5cbiAgICApXG4gICAgLy8gZmlyZSBldmVudFxuICAgIGNvbnN0IGlucHV0cyA9IGdldEFsbEJ5Um9sZSgndGV4dGJveCcpIGFzIEhUTUxJbnB1dEVsZW1lbnRbXVxuICAgIGZpcmVFdmVudC5jaGFuZ2UoaW5wdXRzWzBdLCB7XG4gICAgICB0YXJnZXQ6IHsgdmFsdWU6IGRhdGEuZGF0ZTIudXNlclN1cHBsaWVkSW5wdXQgfSxcbiAgICB9KVxuICAgIGV4cGVjdChpbnB1dHNbMF0udmFsdWUpLnRvLmVxdWFsKGRhdGEuZGF0ZTIucGFyc2VkT3V0cHV0KVxuICB9KVxuICBpdChgc2hvdWxkIGdlbmVyYXRlIGFwcHJvcHJpYXRlbHkgc2hpZnRlZCBJU08gc3RyaW5ncyBvbiBjaGFuZ2UgKERTVClgLCAoKSA9PiB7XG4gICAgY29uc3QgcmVmID0gUmVhY3QuY3JlYXRlUmVmPERhdGVJbnB1dD4oKVxuICAgIHJlbmRlcihcbiAgICAgIDxEYXRlRmllbGRcbiAgICAgICAgdmFsdWU9e25ldyBEYXRlKCkudG9JU09TdHJpbmcoKX1cbiAgICAgICAgb25DaGFuZ2U9eyh1cGRhdGVkVmFsdWUpID0+IHtcbiAgICAgICAgICBleHBlY3QodXBkYXRlZFZhbHVlKS50by5lcXVhbChkYXRhLmRhdGU0Lm9yaWdpbmFsSVNPKVxuICAgICAgICB9fVxuICAgICAgICByZWY9e3JlZn1cbiAgICAgIC8+XG4gICAgKVxuICAgIGlmIChyZWYuY3VycmVudCkge1xuICAgICAgY29uc3QgaGFuZGxlRGF0ZUNoYW5nZSA9IFJlZmxlY3QuZ2V0KHJlZi5jdXJyZW50LCAnaGFuZGxlRGF0ZUNoYW5nZScpXG4gICAgICBoYW5kbGVEYXRlQ2hhbmdlKFxuICAgICAgICBEYXRlSGVscGVycy5CbHVlcHJpbnQuY29udmVydGVycy5UaW1lc2hpZnRGb3JEYXRlUGlja2VyKFxuICAgICAgICAgIGRhdGEuZGF0ZTQub3JpZ2luYWxJU08sXG4gICAgICAgICAgSVNPXzg2MDFfRk9STUFUX1pPTkVEXG4gICAgICAgICksXG4gICAgICAgIHRydWVcbiAgICAgIClcbiAgICB9XG4gIH0pXG4gIGl0KGBzaG91bGQgZ2VuZXJhdGUgYXBwcm9wcmlhdGVseSBzaGlmdGVkIElTTyBzdHJpbmdzIG9uIGNoYW5nZWAsICgpID0+IHtcbiAgICBjb25zdCByZWYgPSBSZWFjdC5jcmVhdGVSZWY8RGF0ZUlucHV0PigpXG4gICAgcmVuZGVyKFxuICAgICAgPERhdGVGaWVsZFxuICAgICAgICB2YWx1ZT17bmV3IERhdGUoKS50b0lTT1N0cmluZygpfVxuICAgICAgICBvbkNoYW5nZT17KHVwZGF0ZWRWYWx1ZSkgPT4ge1xuICAgICAgICAgIGV4cGVjdCh1cGRhdGVkVmFsdWUpLnRvLmVxdWFsKGRhdGEuZGF0ZTEub3JpZ2luYWxJU08pXG4gICAgICAgIH19XG4gICAgICAvPlxuICAgIClcbiAgICBpZiAocmVmLmN1cnJlbnQpIHtcbiAgICAgIGNvbnN0IGhhbmRsZURhdGVDaGFuZ2UgPSBSZWZsZWN0LmdldChyZWYuY3VycmVudCwgJ2hhbmRsZURhdGVDaGFuZ2UnKVxuICAgICAgaGFuZGxlRGF0ZUNoYW5nZShcbiAgICAgICAgRGF0ZUhlbHBlcnMuQmx1ZXByaW50LmNvbnZlcnRlcnMuVGltZXNoaWZ0Rm9yRGF0ZVBpY2tlcihcbiAgICAgICAgICBkYXRhLmRhdGUxLm9yaWdpbmFsSVNPLFxuICAgICAgICAgIElTT184NjAxX0ZPUk1BVF9aT05FRFxuICAgICAgICApLFxuICAgICAgICB0cnVlXG4gICAgICApXG4gICAgfVxuICB9KVxuICBpdChgc2hvdWxkIG5vdCBhbGxvdyBkYXRlcyBiZXlvbmQgbWF4IGZ1dHVyZWAsICgpID0+IHtcbiAgICBjb25zdCB7IGdldEFsbEJ5Um9sZSB9ID0gcmVuZGVyKFxuICAgICAgPERhdGVGaWVsZFxuICAgICAgICB2YWx1ZT17bmV3IERhdGUoKS50b0lTT1N0cmluZygpfVxuICAgICAgICBvbkNoYW5nZT17KHVwZGF0ZWRWYWx1ZSkgPT4ge1xuICAgICAgICAgIGV4cGVjdCh1cGRhdGVkVmFsdWUpLnRvLm5vdC5lcXVhbChkYXRhLmRhdGUzLm1heEZ1dHVyZSlcbiAgICAgICAgfX1cbiAgICAgIC8+XG4gICAgKVxuICAgIGNvbnN0IGlucHV0cyA9IGdldEFsbEJ5Um9sZSgndGV4dGJveCcpIGFzIEhUTUxJbnB1dEVsZW1lbnRbXVxuICAgIGZpcmVFdmVudC5jaGFuZ2UoaW5wdXRzWzBdLCB7XG4gICAgICB0YXJnZXQ6IHsgdmFsdWU6IGRhdGEuZGF0ZTMuZGlzYWxsb3dlZEZ1dHVyZSB9LFxuICAgIH0pXG4gIH0pXG4gIGl0KGBzaG91bGQgYWxsb3cgZGF0ZXMgdXAgdG8gbWF4IGZ1dHVyZWAsICgpID0+IHtcbiAgICBjb25zdCB7IGdldEFsbEJ5Um9sZSB9ID0gcmVuZGVyKFxuICAgICAgPERhdGVGaWVsZFxuICAgICAgICB2YWx1ZT17bmV3IERhdGUoKS50b0lTT1N0cmluZygpfVxuICAgICAgICBvbkNoYW5nZT17KHVwZGF0ZWRWYWx1ZSkgPT4ge1xuICAgICAgICAgIGV4cGVjdCh1cGRhdGVkVmFsdWUpLnRvLmVxdWFsKGRhdGEuZGF0ZTMubWF4RnV0dXJlKVxuICAgICAgICB9fVxuICAgICAgLz5cbiAgICApXG4gICAgY29uc3QgaW5wdXRzID0gZ2V0QWxsQnlSb2xlKCd0ZXh0Ym94JykgYXMgSFRNTElucHV0RWxlbWVudFtdXG4gICAgZmlyZUV2ZW50LmNoYW5nZShpbnB1dHNbMF0sIHtcbiAgICAgIHRhcmdldDogeyB2YWx1ZTogZGF0YS5kYXRlMy5tYXhGdXR1cmUgfSxcbiAgICB9KVxuICB9KVxuICBpdCgnY2FsbHMgb25DaGFuZ2Ugd2l0aCB1cGRhdGVkIHZhbHVlIHdoZW4gcHJlY2lzaW9uIGNoYW5nZXMnLCAoZG9uZSkgPT4ge1xuICAgIGxldCB2YWx1ZSA9IGRhdGEuZGF0ZTEudXNlckZvcm1hdElTTy5taWxsaXNlY29uZFxuICAgIHJlbmRlcihcbiAgICAgIDxEYXRlRmllbGRcbiAgICAgICAgdmFsdWU9e3ZhbHVlfVxuICAgICAgICBvbkNoYW5nZT17KHVwZGF0ZWRWYWx1ZSkgPT4ge1xuICAgICAgICAgIHZhbHVlID0gdXBkYXRlZFZhbHVlXG4gICAgICAgIH19XG4gICAgICAvPlxuICAgIClcbiAgICB1c2VyXG4gICAgICAuZ2V0KCd1c2VyJylcbiAgICAgIC5nZXQoJ3ByZWZlcmVuY2VzJylcbiAgICAgIC5zZXQoJ2RhdGVUaW1lRm9ybWF0JywgQ29tbW9uLmdldERhdGVUaW1lRm9ybWF0cygpWydJU08nXVsnbWludXRlJ10pXG4gICAgLy8gd2FpdCBmb3IgdGhlIHZhbHVlIHRvIHVwZGF0ZVxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgZXhwZWN0KHZhbHVlKS50by5lcXVhbChkYXRhLmRhdGUxLnV0Y0lTT01pbnV0ZXMpXG4gICAgICBkb25lKClcbiAgICB9LCAxMDApXG4gIH0pXG59KVxuIl19